[2025-05-05 11:17:21] [INFO] --- 登録API処理開始 ---
[2025-05-05 11:17:21] [INFO] リクエスト元IPアドレス: 153.189.181.175
[2025-05-05 11:17:21] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQxMDQ0OSwiaWF0IjoxNzQ2NDA2ODQ5LCJhbXIiOlsibGluZXNzbyIsIm1mYSJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.PhI_W2nnXXP11fv-LPnN0lKHvdUJ8iGu6Dhb6dyk07GcY_hncD9Iioa9sHnuNn6SUnaSyKzXEo-s5gdFK1zrZQ","room_number":"fg#04","user_name":"くらひで","check_in":"2025-05-05","check_out":"2025-05-06","check_out_time":"11:00"}
[2025-05-05 11:17:21] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQxMDQ0OSwiaWF0IjoxNzQ2NDA2ODQ5LCJhbXIiOlsibGluZXNzbyIsIm1mYSJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.PhI_W2nnXXP11fv-LPnN0lKHvdUJ8iGu6Dhb6dyk07GcY_hncD9Iioa9sHnuNn6SUnaSyKzXEo-s5gdFK1zrZQ
    [room_number] => fg#04
    [user_name] => くらひで
    [check_in] => 2025-05-05
    [check_out] => 2025-05-06
    [check_out_time] => 11:00
)

[2025-05-05 11:17:21] [INFO] 処理パラメータ: room=fg#04, user=くらひで, checkIn=2025-05-05, checkOut=2025-05-06
[2025-05-05 11:17:21] [INFO] IDトークンを検証: eyJraWQiOiJhMmE0NTlh...
[2025-05-05 11:17:21] [DEBUG] トークン検証開始: eyJraWQiOiJhMmE0NTlh...
[2025-05-05 11:17:21] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1746410449
    [iat] => 1746406849
    [amr] => Array
        (
            [0] => linesso
            [1] => mfa
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-05 11:17:21] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-05 11:17:21] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-05 11:17:21] [INFO] データベース接続を開始します
[2025-05-05 11:17:21] [INFO] データベース接続成功
[2025-05-05 11:17:21] [ERROR] 処理中に例外が発生: SQLSTATE[42S02]: Base table or view not found: 1146 Table 'LAA1207717-fgsquare.room_registrations' doesn't exist
#0 /home/users/2/but.jp-test-mijeos/web/fgsquare/register/api/register.php(196): PDOStatement->execute()
#1 {main}
[2025-05-05 11:23:48] [INFO] --- テーブル作成処理開始 ---
[2025-05-05 11:23:48] [INFO] データベース接続開始: ホスト=mysql320.phy.lolipop.lan, データベース=LAA1207717-fgsquare
[2025-05-05 11:23:48] [INFO] データベース接続成功
[2025-05-05 11:24:17] [INFO] --- テーブル作成処理開始 ---
[2025-05-05 11:24:17] [INFO] データベース接続開始: ホスト=mysql320.phy.lolipop.lan, データベース=LAA1207717-fgsquare
[2025-05-05 11:24:17] [INFO] データベース接続成功
[2025-05-05 11:24:30] [INFO] --- テーブル作成処理開始 ---
[2025-05-05 11:24:30] [INFO] データベース接続開始: ホスト=mysql320.phy.lolipop.lan, データベース=LAA1207717-fgsquare
[2025-05-05 11:24:30] [INFO] データベース接続成功
[2025-05-05 11:25:03] [INFO] --- テーブル作成処理開始 ---
[2025-05-05 11:25:03] [INFO] データベース接続開始: ホスト=mysql320.phy.lolipop.lan, データベース=LAA1207717-fgsquare
[2025-05-05 11:25:03] [INFO] データベース接続成功
[2025-05-05 11:41:14] [INFO] --- 登録API処理開始 ---
[2025-05-05 11:41:14] [INFO] リクエスト元IPアドレス: 153.189.181.175
[2025-05-05 11:41:14] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQxMDQ0OSwiaWF0IjoxNzQ2NDA2ODQ5LCJhbXIiOlsibGluZXNzbyIsIm1mYSJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.PhI_W2nnXXP11fv-LPnN0lKHvdUJ8iGu6Dhb6dyk07GcY_hncD9Iioa9sHnuNn6SUnaSyKzXEo-s5gdFK1zrZQ","room_number":"fg#01","user_name":"くらひで","check_in":"2025-05-05","check_out":"2025-05-06","check_out_time":"11:00"}
[2025-05-05 11:41:14] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQxMDQ0OSwiaWF0IjoxNzQ2NDA2ODQ5LCJhbXIiOlsibGluZXNzbyIsIm1mYSJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.PhI_W2nnXXP11fv-LPnN0lKHvdUJ8iGu6Dhb6dyk07GcY_hncD9Iioa9sHnuNn6SUnaSyKzXEo-s5gdFK1zrZQ
    [room_number] => fg#01
    [user_name] => くらひで
    [check_in] => 2025-05-05
    [check_out] => 2025-05-06
    [check_out_time] => 11:00
)

[2025-05-05 11:41:14] [INFO] 処理パラメータ: room=fg#01, user=くらひで, checkIn=2025-05-05, checkOut=2025-05-06
[2025-05-05 11:41:14] [INFO] IDトークンを検証: eyJraWQiOiJhMmE0NTlh...
[2025-05-05 11:41:14] [DEBUG] トークン検証開始: eyJraWQiOiJhMmE0NTlh...
[2025-05-05 11:41:14] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1746410449
    [iat] => 1746406849
    [amr] => Array
        (
            [0] => linesso
            [1] => mfa
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-05 11:41:14] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-05 11:41:14] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-05 11:41:14] [INFO] データベース接続を開始します
[2025-05-05 11:41:14] [INFO] データベース接続成功
[2025-05-05 11:41:14] [ERROR] 処理中に例外が発生: SQLSTATE[42S02]: Base table or view not found: 1146 Table 'LAA1207717-fgsquare.room_registrations' doesn't exist
#0 /home/users/2/but.jp-test-mijeos/web/fgsquare/register/api/register.php(196): PDOStatement->execute()
#1 {main}
[2025-05-05 11:43:20] [INFO] --- 登録API処理開始 ---
[2025-05-05 11:43:20] [INFO] リクエスト元IPアドレス: 153.189.181.175
[2025-05-05 11:43:20] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQxMDQ0OSwiaWF0IjoxNzQ2NDA2ODQ5LCJhbXIiOlsibGluZXNzbyIsIm1mYSJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.PhI_W2nnXXP11fv-LPnN0lKHvdUJ8iGu6Dhb6dyk07GcY_hncD9Iioa9sHnuNn6SUnaSyKzXEo-s5gdFK1zrZQ","room_number":"fg#03","user_name":"くらひで","check_in":"2025-05-05","check_out":"2025-05-06","check_out_time":"11:00"}
[2025-05-05 11:43:20] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQxMDQ0OSwiaWF0IjoxNzQ2NDA2ODQ5LCJhbXIiOlsibGluZXNzbyIsIm1mYSJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.PhI_W2nnXXP11fv-LPnN0lKHvdUJ8iGu6Dhb6dyk07GcY_hncD9Iioa9sHnuNn6SUnaSyKzXEo-s5gdFK1zrZQ
    [room_number] => fg#03
    [user_name] => くらひで
    [check_in] => 2025-05-05
    [check_out] => 2025-05-06
    [check_out_time] => 11:00
)

[2025-05-05 11:43:20] [INFO] 処理パラメータ: room=fg#03, user=くらひで, checkIn=2025-05-05, checkOut=2025-05-06
[2025-05-05 11:43:20] [INFO] IDトークンを検証: eyJraWQiOiJhMmE0NTlh...
[2025-05-05 11:43:20] [DEBUG] トークン検証開始: eyJraWQiOiJhMmE0NTlh...
[2025-05-05 11:43:20] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1746410449
    [iat] => 1746406849
    [amr] => Array
        (
            [0] => linesso
            [1] => mfa
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-05 11:43:20] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-05 11:43:20] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-05 11:43:20] [INFO] データベース接続を開始します
[2025-05-05 11:43:20] [INFO] データベース接続成功
[2025-05-05 11:47:12] [INFO] --- 登録API処理開始 ---
[2025-05-05 11:47:12] [INFO] リクエスト元IPアドレス: 153.189.181.175
[2025-05-05 11:47:12] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQxMDQ0OSwiaWF0IjoxNzQ2NDA2ODQ5LCJhbXIiOlsibGluZXNzbyIsIm1mYSJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.PhI_W2nnXXP11fv-LPnN0lKHvdUJ8iGu6Dhb6dyk07GcY_hncD9Iioa9sHnuNn6SUnaSyKzXEo-s5gdFK1zrZQ","room_number":"fg#05","user_name":"くらひで","check_in":"2025-05-05","check_out":"2025-05-06","check_out_time":"11:00"}
[2025-05-05 11:47:12] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQxMDQ0OSwiaWF0IjoxNzQ2NDA2ODQ5LCJhbXIiOlsibGluZXNzbyIsIm1mYSJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.PhI_W2nnXXP11fv-LPnN0lKHvdUJ8iGu6Dhb6dyk07GcY_hncD9Iioa9sHnuNn6SUnaSyKzXEo-s5gdFK1zrZQ
    [room_number] => fg#05
    [user_name] => くらひで
    [check_in] => 2025-05-05
    [check_out] => 2025-05-06
    [check_out_time] => 11:00
)

[2025-05-05 11:47:12] [INFO] 処理パラメータ: room=fg#05, user=くらひで, checkIn=2025-05-05, checkOut=2025-05-06
[2025-05-05 11:47:12] [INFO] IDトークンを検証: eyJraWQiOiJhMmE0NTlh...
[2025-05-05 11:47:12] [DEBUG] トークン検証開始: eyJraWQiOiJhMmE0NTlh...
[2025-05-05 11:47:12] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1746410449
    [iat] => 1746406849
    [amr] => Array
        (
            [0] => linesso
            [1] => mfa
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-05 11:47:12] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-05 11:47:12] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-05 11:47:12] [INFO] データベース接続を開始します
[2025-05-05 11:47:12] [INFO] データベース接続成功
[2025-05-05 11:47:12] [INFO] トランザクション開始
[2025-05-05 11:47:12] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-05 11:47:12] [DEBUG] パラメータバインド: roomNumber=fg#05
[2025-05-05 11:47:12] [INFO] 部屋検索クエリ実行完了
[2025-05-05 11:47:12] [INFO] 部屋検索結果: 部屋あり ID=5, アクティブ=1
[2025-05-05 11:47:12] [DEBUG] 既存登録確認SQL: 
            SELECT id 
            FROM line_room_links 
            WHERE line_user_id = :userId 
            AND check_out_date >= CURDATE()
        
[2025-05-05 11:47:12] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-05 11:47:12] [INFO] 既存登録検索クエリ実行完了
[2025-05-05 11:47:12] [INFO] 既存登録検索結果: 登録なし
[2025-05-05 11:47:12] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active, created_at, updated_at)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1, NOW(), NOW())
            
[2025-05-05 11:47:12] [DEBUG] 出力バッファをフラッシュします
[2025-05-05 11:47:12] [INFO] 処理完了
[2025-05-05 11:50:56] [INFO] --- 登録API処理開始 ---
[2025-05-05 11:50:56] [INFO] リクエスト元IPアドレス: 153.189.181.175
[2025-05-05 11:50:56] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQxMDQ0OSwiaWF0IjoxNzQ2NDA2ODQ5LCJhbXIiOlsibGluZXNzbyIsIm1mYSJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.PhI_W2nnXXP11fv-LPnN0lKHvdUJ8iGu6Dhb6dyk07GcY_hncD9Iioa9sHnuNn6SUnaSyKzXEo-s5gdFK1zrZQ","room_number":"fg#06","user_name":"くらひで","check_in":"2025-05-05","check_out":"2025-05-06","check_out_time":"11:00"}
[2025-05-05 11:50:56] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQxMDQ0OSwiaWF0IjoxNzQ2NDA2ODQ5LCJhbXIiOlsibGluZXNzbyIsIm1mYSJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.PhI_W2nnXXP11fv-LPnN0lKHvdUJ8iGu6Dhb6dyk07GcY_hncD9Iioa9sHnuNn6SUnaSyKzXEo-s5gdFK1zrZQ
    [room_number] => fg#06
    [user_name] => くらひで
    [check_in] => 2025-05-05
    [check_out] => 2025-05-06
    [check_out_time] => 11:00
)

[2025-05-05 11:50:56] [INFO] 処理パラメータ: room=fg#06, user=くらひで, checkIn=2025-05-05, checkOut=2025-05-06
[2025-05-05 11:50:56] [INFO] IDトークンを検証: eyJraWQiOiJhMmE0NTlh...
[2025-05-05 11:50:56] [DEBUG] トークン検証開始: eyJraWQiOiJhMmE0NTlh...
[2025-05-05 11:50:56] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1746410449
    [iat] => 1746406849
    [amr] => Array
        (
            [0] => linesso
            [1] => mfa
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-05 11:50:56] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-05 11:50:56] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-05 11:50:56] [INFO] データベース接続を開始します
[2025-05-05 11:50:56] [INFO] データベース接続成功
[2025-05-05 11:50:56] [INFO] トランザクション開始
[2025-05-05 11:50:56] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-05 11:50:56] [DEBUG] パラメータバインド: roomNumber=fg#06
[2025-05-05 11:50:56] [INFO] 部屋検索クエリ実行完了
[2025-05-05 11:50:56] [INFO] 部屋検索結果: 部屋あり ID=6, アクティブ=1
[2025-05-05 11:50:56] [DEBUG] 既存登録確認SQL: 
            SELECT id 
            FROM line_room_links 
            WHERE line_user_id = :userId 
            AND check_out_date >= CURDATE()
        
[2025-05-05 11:50:56] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-05 11:50:56] [INFO] 既存登録検索クエリ実行完了
[2025-05-05 11:50:56] [INFO] 既存登録検索結果: 登録なし
[2025-05-05 11:50:56] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate)
            
[2025-05-05 11:50:56] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-05 11:50:56] [DEBUG] 出力バッファをフラッシュします
[2025-05-05 11:50:56] [INFO] 処理完了
[2025-05-05 11:57:56] [INFO] --- 登録API処理開始 ---
[2025-05-05 11:57:56] [INFO] リクエスト元IPアドレス: 153.189.181.175
[2025-05-05 11:57:56] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQxMDQ0OSwiaWF0IjoxNzQ2NDA2ODQ5LCJhbXIiOlsibGluZXNzbyIsIm1mYSJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.PhI_W2nnXXP11fv-LPnN0lKHvdUJ8iGu6Dhb6dyk07GcY_hncD9Iioa9sHnuNn6SUnaSyKzXEo-s5gdFK1zrZQ","room_number":"fg#07","user_name":"くらひで","check_in":"2025-05-05","check_out":"2025-05-06","check_out_time":"11:00"}
[2025-05-05 11:57:56] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQxMDQ0OSwiaWF0IjoxNzQ2NDA2ODQ5LCJhbXIiOlsibGluZXNzbyIsIm1mYSJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.PhI_W2nnXXP11fv-LPnN0lKHvdUJ8iGu6Dhb6dyk07GcY_hncD9Iioa9sHnuNn6SUnaSyKzXEo-s5gdFK1zrZQ
    [room_number] => fg#07
    [user_name] => くらひで
    [check_in] => 2025-05-05
    [check_out] => 2025-05-06
    [check_out_time] => 11:00
)

[2025-05-05 11:57:56] [INFO] 処理パラメータ: room=fg#07, user=くらひで, checkIn=2025-05-05, checkOut=2025-05-06
[2025-05-05 11:57:56] [INFO] IDトークンを検証: eyJraWQiOiJhMmE0NTlh...
[2025-05-05 11:57:56] [DEBUG] トークン検証開始: eyJraWQiOiJhMmE0NTlh...
[2025-05-05 11:57:56] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1746410449
    [iat] => 1746406849
    [amr] => Array
        (
            [0] => linesso
            [1] => mfa
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-05 11:57:56] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-05 11:57:56] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-05 11:57:56] [INFO] データベース接続を開始します
[2025-05-05 11:57:56] [INFO] データベース接続成功
[2025-05-05 11:57:56] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-05 11:57:56] [INFO] line_room_linksテーブルが存在します
[2025-05-05 11:57:56] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-05 11:57:56] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token
[2025-05-05 11:57:56] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-05 11:57:56] [INFO] line_room_linksテーブルのレコード数: 1
[2025-05-05 11:57:56] [INFO] 最新のレコード: {"id":1,"line_user_id":"U9e1f5c66b4a26fd0c33c890ad826b192","room_number":"fg#02","user_name":"\u5009\u7530\u67da\u6709","check_in_date":"2025-05-04","check_out_date":"2025-05-05","access_token":null,"is_active":1,"created_at":"2025-05-04 13:47:51","updated_at":"2025-05-05 01:44:25"}
[2025-05-05 11:57:56] [INFO] トランザクション開始
[2025-05-05 11:57:56] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-05 11:57:56] [DEBUG] パラメータバインド: roomNumber=fg#07
[2025-05-05 11:57:56] [INFO] 部屋検索クエリ実行完了
[2025-05-05 11:57:56] [INFO] 部屋検索結果: 部屋あり ID=7, アクティブ=1
[2025-05-05 11:57:56] [DEBUG] 既存登録確認SQL: 
            SELECT id 
            FROM line_room_links 
            WHERE line_user_id = :userId 
            AND check_out_date >= CURDATE()
        
[2025-05-05 11:57:56] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-05 11:57:56] [INFO] 既存登録検索クエリ実行完了
[2025-05-05 11:57:56] [INFO] 既存登録検索結果: 登録なし
[2025-05-05 11:57:56] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate)
            
[2025-05-05 11:57:56] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-05 11:57:56] [DEBUG] プリペアドステートメント作成成功
[2025-05-05 11:57:56] [DEBUG] 出力バッファをフラッシュします
[2025-05-05 11:57:56] [INFO] 処理完了
[2025-05-05 12:01:31] [INFO] --- 登録API処理開始 ---
[2025-05-05 12:01:31] [INFO] リクエスト元IPアドレス: 153.189.181.175
[2025-05-05 12:01:31] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQxMDQ0OSwiaWF0IjoxNzQ2NDA2ODQ5LCJhbXIiOlsibGluZXNzbyIsIm1mYSJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.PhI_W2nnXXP11fv-LPnN0lKHvdUJ8iGu6Dhb6dyk07GcY_hncD9Iioa9sHnuNn6SUnaSyKzXEo-s5gdFK1zrZQ","room_number":"fg#08","user_name":"くらひで","check_in":"2025-05-05","check_out":"2025-05-06","check_out_time":"11:00"}
[2025-05-05 12:01:31] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQxMDQ0OSwiaWF0IjoxNzQ2NDA2ODQ5LCJhbXIiOlsibGluZXNzbyIsIm1mYSJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.PhI_W2nnXXP11fv-LPnN0lKHvdUJ8iGu6Dhb6dyk07GcY_hncD9Iioa9sHnuNn6SUnaSyKzXEo-s5gdFK1zrZQ
    [room_number] => fg#08
    [user_name] => くらひで
    [check_in] => 2025-05-05
    [check_out] => 2025-05-06
    [check_out_time] => 11:00
)

[2025-05-05 12:01:31] [INFO] 処理パラメータ: room=fg#08, user=くらひで, checkIn=2025-05-05, checkOut=2025-05-06
[2025-05-05 12:01:31] [INFO] IDトークンを検証: eyJraWQiOiJhMmE0NTlh...
[2025-05-05 12:01:31] [DEBUG] トークン検証開始: eyJraWQiOiJhMmE0NTlh...
[2025-05-05 12:01:31] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1746410449
    [iat] => 1746406849
    [amr] => Array
        (
            [0] => linesso
            [1] => mfa
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-05 12:01:31] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-05 12:01:31] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-05 12:01:31] [INFO] データベース接続を開始します
[2025-05-05 12:01:31] [INFO] データベース接続成功
[2025-05-05 12:01:31] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-05 12:01:31] [INFO] line_room_linksテーブルが存在します
[2025-05-05 12:01:31] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-05 12:01:31] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token
[2025-05-05 12:01:31] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-05 12:01:31] [INFO] line_room_linksテーブルのレコード数: 1
[2025-05-05 12:01:31] [INFO] 最新のレコード: {"id":1,"line_user_id":"U9e1f5c66b4a26fd0c33c890ad826b192","room_number":"fg#02","user_name":"\u5009\u7530\u67da\u6709","check_in_date":"2025-05-04","check_out_date":"2025-05-05","access_token":null,"is_active":1,"created_at":"2025-05-04 13:47:51","updated_at":"2025-05-05 01:44:25"}
[2025-05-05 12:01:31] [INFO] トランザクション開始
[2025-05-05 12:01:31] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-05 12:01:31] [DEBUG] パラメータバインド: roomNumber=fg#08
[2025-05-05 12:01:31] [INFO] 部屋検索クエリ実行完了
[2025-05-05 12:01:31] [INFO] 部屋検索結果: 部屋あり ID=8, アクティブ=1
[2025-05-05 12:01:31] [DEBUG] 既存登録確認SQL: 
            SELECT id 
            FROM line_room_links 
            WHERE line_user_id = :userId 
            AND check_out_date >= CURDATE()
        
[2025-05-05 12:01:31] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-05 12:01:31] [INFO] 既存登録検索クエリ実行完了
[2025-05-05 12:01:31] [INFO] 既存登録検索結果: 登録なし
[2025-05-05 12:01:31] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate)
            
[2025-05-05 12:01:31] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-05 12:01:31] [DEBUG] プリペアドステートメント作成成功
[2025-05-05 12:01:31] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-05, checkOut=2025-05-06
[2025-05-05 12:01:31] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#08, userName=くらひで, checkInDate=2025-05-05, checkOutDate=2025-05-06
[2025-05-05 12:01:31] [INFO] SQLを実行します
[2025-05-05 12:01:31] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#08","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-05","check_out_date":"2025-05-06"}
[2025-05-05 12:01:31] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-05 12:01:31] [DEBUG] 直接クエリ実行結果: 成功
[2025-05-05 12:01:31] [INFO] 直接クエリで新規登録ID: 2
[2025-05-05 12:01:31] [INFO] トランザクションコミット成功
[2025-05-05 12:01:31] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"2","registration_type":"new"}
[2025-05-05 12:01:31] [DEBUG] 出力バッファをフラッシュします
[2025-05-05 12:01:31] [INFO] 処理完了
[2025-05-05 12:06:38] [INFO] --- 登録API処理開始 ---
[2025-05-05 12:06:38] [INFO] リクエスト元IPアドレス: 153.189.181.175
[2025-05-05 12:06:38] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQxMDQ0OSwiaWF0IjoxNzQ2NDA2ODQ5LCJhbXIiOlsibGluZXNzbyIsIm1mYSJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.PhI_W2nnXXP11fv-LPnN0lKHvdUJ8iGu6Dhb6dyk07GcY_hncD9Iioa9sHnuNn6SUnaSyKzXEo-s5gdFK1zrZQ","room_number":"fg#09","user_name":"くらひで","check_in":"2025-05-05","check_out":"2025-05-06","check_out_time":"11:00"}
[2025-05-05 12:06:38] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQxMDQ0OSwiaWF0IjoxNzQ2NDA2ODQ5LCJhbXIiOlsibGluZXNzbyIsIm1mYSJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.PhI_W2nnXXP11fv-LPnN0lKHvdUJ8iGu6Dhb6dyk07GcY_hncD9Iioa9sHnuNn6SUnaSyKzXEo-s5gdFK1zrZQ
    [room_number] => fg#09
    [user_name] => くらひで
    [check_in] => 2025-05-05
    [check_out] => 2025-05-06
    [check_out_time] => 11:00
)

[2025-05-05 12:06:38] [INFO] 処理パラメータ: room=fg#09, user=くらひで, checkIn=2025-05-05, checkOut=2025-05-06
[2025-05-05 12:06:38] [INFO] IDトークンを検証: eyJraWQiOiJhMmE0NTlh...
[2025-05-05 12:06:38] [DEBUG] トークン検証開始: eyJraWQiOiJhMmE0NTlh...
[2025-05-05 12:06:38] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1746410449
    [iat] => 1746406849
    [amr] => Array
        (
            [0] => linesso
            [1] => mfa
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-05 12:06:38] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-05 12:06:38] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-05 12:06:38] [INFO] データベース接続を開始します
[2025-05-05 12:06:38] [INFO] データベース接続成功
[2025-05-05 12:06:38] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-05 12:06:38] [INFO] line_room_linksテーブルが存在します
[2025-05-05 12:06:38] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-05 12:06:38] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token
[2025-05-05 12:06:38] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-05 12:06:38] [INFO] line_room_linksテーブルのレコード数: 2
[2025-05-05 12:06:38] [INFO] 最新のレコード: {"id":2,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#08","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-05","check_out_date":"2025-05-06","access_token":null,"is_active":1,"created_at":"2025-05-05 12:01:31","updated_at":"2025-05-05 12:01:31"}
[2025-05-05 12:06:38] [INFO] トランザクション開始
[2025-05-05 12:06:38] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-05 12:06:38] [DEBUG] パラメータバインド: roomNumber=fg#09
[2025-05-05 12:06:38] [INFO] 部屋検索クエリ実行完了
[2025-05-05 12:06:38] [INFO] 部屋検索結果: 部屋あり ID=9, アクティブ=1
[2025-05-05 12:06:38] [DEBUG] 既存登録確認SQL: 
            SELECT id 
            FROM line_room_links 
            WHERE line_user_id = :userId 
            AND check_out_date >= CURDATE()
        
[2025-05-05 12:06:38] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-05 12:06:38] [INFO] 既存登録検索クエリ実行完了
[2025-05-05 12:06:38] [INFO] 既存登録検索結果: 登録あり ID=2
[2025-05-05 12:06:38] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate
                WHERE id = :id
            
[2025-05-05 12:06:38] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-05 12:06:38] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-05-05, checkOut=2025-05-06
[2025-05-05 12:06:38] [DEBUG] パラメータバインド: id=2, roomNumber=fg#09, userName=くらひで, checkInDate=2025-05-05, checkOutDate=2025-05-06
[2025-05-05 12:06:38] [INFO] 更新クエリ実行完了: 成功
[2025-05-05 12:06:38] [INFO] 既存登録を更新: id=2
[2025-05-05 12:06:38] [INFO] トランザクションコミット成功
[2025-05-05 12:06:38] [INFO] 成功レスポンス準備完了: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":2,"registration_type":"update"}
[2025-05-05 12:06:38] [DEBUG] 出力バッファをフラッシュします
[2025-05-05 12:06:38] [INFO] 処理完了
[2025-05-05 12:13:59] [INFO] --- 登録API処理開始 ---
[2025-05-05 12:13:59] [INFO] リクエスト元IPアドレス: 153.189.181.175
[2025-05-05 12:13:59] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQxMDQ0OSwiaWF0IjoxNzQ2NDA2ODQ5LCJhbXIiOlsibGluZXNzbyIsIm1mYSJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.PhI_W2nnXXP11fv-LPnN0lKHvdUJ8iGu6Dhb6dyk07GcY_hncD9Iioa9sHnuNn6SUnaSyKzXEo-s5gdFK1zrZQ","room_number":"fg#01","user_name":"くらひで","check_in":"2025-05-05","check_out":"2025-05-06","check_out_time":"11:00"}
[2025-05-05 12:13:59] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQxMDQ0OSwiaWF0IjoxNzQ2NDA2ODQ5LCJhbXIiOlsibGluZXNzbyIsIm1mYSJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.PhI_W2nnXXP11fv-LPnN0lKHvdUJ8iGu6Dhb6dyk07GcY_hncD9Iioa9sHnuNn6SUnaSyKzXEo-s5gdFK1zrZQ
    [room_number] => fg#01
    [user_name] => くらひで
    [check_in] => 2025-05-05
    [check_out] => 2025-05-06
    [check_out_time] => 11:00
)

[2025-05-05 12:13:59] [INFO] 処理パラメータ: room=fg#01, user=くらひで, checkIn=2025-05-05, checkOut=2025-05-06
[2025-05-05 12:13:59] [INFO] IDトークンを検証: eyJraWQiOiJhMmE0NTlh...
[2025-05-05 12:13:59] [DEBUG] トークン検証開始: eyJraWQiOiJhMmE0NTlh...
[2025-05-05 12:13:59] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1746410449
    [iat] => 1746406849
    [amr] => Array
        (
            [0] => linesso
            [1] => mfa
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-05 12:13:59] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-05 12:13:59] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-05 12:13:59] [INFO] データベース接続を開始します
[2025-05-05 12:13:59] [INFO] データベース接続成功
[2025-05-05 12:13:59] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-05 12:13:59] [INFO] line_room_linksテーブルが存在します
[2025-05-05 12:13:59] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-05 12:13:59] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token
[2025-05-05 12:13:59] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-05 12:13:59] [INFO] line_room_linksテーブルのレコード数: 2
[2025-05-05 12:13:59] [INFO] 最新のレコード: {"id":2,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#09","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-05","check_out_date":"2025-05-06","access_token":null,"is_active":1,"created_at":"2025-05-05 12:01:31","updated_at":"2025-05-05 12:06:38"}
[2025-05-05 12:13:59] [INFO] トランザクション開始
[2025-05-05 12:13:59] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-05 12:13:59] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-05 12:13:59] [INFO] 部屋検索クエリ実行完了
[2025-05-05 12:13:59] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-05 12:13:59] [DEBUG] 既存登録確認SQL: 
            SELECT id 
            FROM line_room_links 
            WHERE line_user_id = :userId 
            AND check_out_date >= CURDATE()
        
[2025-05-05 12:13:59] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-05 12:13:59] [INFO] 既存登録検索クエリ実行完了
[2025-05-05 12:13:59] [INFO] 既存登録検索結果: 登録あり ID=2
[2025-05-05 12:13:59] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate
                WHERE id = :id
            
[2025-05-05 12:13:59] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-05 12:13:59] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-05-05, checkOut=2025-05-06
[2025-05-05 12:13:59] [DEBUG] パラメータバインド: id=2, roomNumber=fg#01, userName=くらひで, checkInDate=2025-05-05, checkOutDate=2025-05-06
[2025-05-05 12:13:59] [INFO] 更新クエリ実行完了: 成功
[2025-05-05 12:13:59] [INFO] 既存登録を更新: id=2
[2025-05-05 12:13:59] [INFO] トランザクションコミット成功
[2025-05-05 12:13:59] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":2,"registration_type":"update"}
[2025-05-05 12:13:59] [INFO] JSONレスポンスを送信完了
[2025-05-05 12:13:59] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":2,"registration_type":"update"}
2025-05-05 12:13:59 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#01 - 期間: 2025-05-05 から 2025-05-06
[2025-05-05 12:13:59] [DEBUG] 出力バッファに162バイトのデータがあります
[2025-05-05 12:13:59] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":2,"registration_type":"update"}
[2025-05-05 12:13:59] [DEBUG] 出力バッファをフラッシュします
[2025-05-05 12:13:59] [INFO] 処理完了
[2025-05-05 17:39:44] [INFO] --- 登録API処理開始 ---
[2025-05-05 17:39:44] [INFO] リクエスト元IPアドレス: 153.189.181.175
[2025-05-05 17:39:44] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI5MjkxZTZiNmEzOGM3ZDhhZjY4YzUyNjZmYWEyODIwOGQ2ZGQ1OTg0NWZhYTAyNGU1NDFiZGIzOWZlMTM1ZDRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTk0MDYzZGY4MWFkYTdhZDczNGJjNmY5OTlhYTU4ZDJhIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQzNzkyMCwiaWF0IjoxNzQ2NDM0MzIwLCJhbXIiOlsibGluZXFyIl0sIm5hbWUiOiLljZfpm7IiLCJwaWN0dXJlIjoiaHR0cHM6Ly9wcm9maWxlLmxpbmUtc2Nkbi5uZXQvMGhXNzhpendNSENCZ0ZFQmo0MDBCM1R6bFZCblZ5UGc1UWZYSkdmQ0pFVjM4dmNCdExNWDhYZVNZU0FYd3JJMDFPYWlKQ2RpSkZWaTk4In0.Q_XBtfvczNoDhJw2QqIG5iU9g4EAcHFUCcEwIi3NS3nWQHrEDtjTDGudy-4kYRosHt_pPCzHdUk0qAj8yHeWGQ","room_number":"fg#13","user_name":"南雲","check_in":"2025-05-05","check_out":"2025-05-06","check_out_time":"11:00"}
[2025-05-05 17:39:44] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI5MjkxZTZiNmEzOGM3ZDhhZjY4YzUyNjZmYWEyODIwOGQ2ZGQ1OTg0NWZhYTAyNGU1NDFiZGIzOWZlMTM1ZDRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTk0MDYzZGY4MWFkYTdhZDczNGJjNmY5OTlhYTU4ZDJhIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQzNzkyMCwiaWF0IjoxNzQ2NDM0MzIwLCJhbXIiOlsibGluZXFyIl0sIm5hbWUiOiLljZfpm7IiLCJwaWN0dXJlIjoiaHR0cHM6Ly9wcm9maWxlLmxpbmUtc2Nkbi5uZXQvMGhXNzhpendNSENCZ0ZFQmo0MDBCM1R6bFZCblZ5UGc1UWZYSkdmQ0pFVjM4dmNCdExNWDhYZVNZU0FYd3JJMDFPYWlKQ2RpSkZWaTk4In0.Q_XBtfvczNoDhJw2QqIG5iU9g4EAcHFUCcEwIi3NS3nWQHrEDtjTDGudy-4kYRosHt_pPCzHdUk0qAj8yHeWGQ
    [room_number] => fg#13
    [user_name] => 南雲
    [check_in] => 2025-05-05
    [check_out] => 2025-05-06
    [check_out_time] => 11:00
)

[2025-05-05 17:39:44] [INFO] 処理パラメータ: room=fg#13, user=南雲, checkIn=2025-05-05, checkOut=2025-05-06
[2025-05-05 17:39:44] [INFO] IDトークンを検証: eyJraWQiOiI5MjkxZTZi...
[2025-05-05 17:39:44] [DEBUG] トークン検証開始: eyJraWQiOiI5MjkxZTZi...
[2025-05-05 17:39:44] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U94063df81ada7ad734bc6f999aa58d2a
    [aud] => 2007363986
    [exp] => 1746437920
    [iat] => 1746434320
    [amr] => Array
        (
            [0] => lineqr
        )

    [name] => 南雲
    [picture] => https://profile.line-scdn.net/0hW78izwMHCBgFEBj400B3TzlVBnVyPg5QfXJGfCJEV38vcBtLMX8XeSYSAXwrI01OaiJCdiJFVi98
)

[2025-05-05 17:39:44] [INFO] トークン検証成功: ユーザーID U94063df81ada7ad734bc6f999aa58d2a
[2025-05-05 17:39:44] [INFO] IDトークン検証成功: userId=U94063df81ada7ad734bc6f999aa58d2a
[2025-05-05 17:39:44] [INFO] データベース接続を開始します
[2025-05-05 17:39:44] [INFO] データベース接続成功
[2025-05-05 17:39:44] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-05 17:39:44] [INFO] line_room_linksテーブルが存在します
[2025-05-05 17:39:44] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-05 17:39:44] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token
[2025-05-05 17:39:44] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-05 17:39:44] [INFO] line_room_linksテーブルのレコード数: 2
[2025-05-05 17:39:44] [INFO] 最新のレコード: {"id":2,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-05","check_out_date":"2025-05-06","access_token":null,"is_active":1,"created_at":"2025-05-05 12:01:31","updated_at":"2025-05-05 12:13:59"}
[2025-05-05 17:39:44] [INFO] トランザクション開始
[2025-05-05 17:39:44] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-05 17:39:44] [DEBUG] パラメータバインド: roomNumber=fg#13
[2025-05-05 17:39:44] [INFO] 部屋検索クエリ実行完了
[2025-05-05 17:39:44] [INFO] 部屋検索結果: 部屋あり ID=13, アクティブ=1
[2025-05-05 17:39:44] [DEBUG] 既存登録確認SQL: 
            SELECT id 
            FROM line_room_links 
            WHERE line_user_id = :userId 
            AND check_out_date >= CURDATE()
        
[2025-05-05 17:39:44] [DEBUG] パラメータバインド: userId=U94063df81ada7ad734bc6f999aa58d2a
[2025-05-05 17:39:44] [INFO] 既存登録検索クエリ実行完了
[2025-05-05 17:39:44] [INFO] 既存登録検索結果: 登録なし
[2025-05-05 17:39:44] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate)
            
[2025-05-05 17:39:44] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-05 17:39:44] [DEBUG] プリペアドステートメント作成成功
[2025-05-05 17:39:44] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-05, checkOut=2025-05-06
[2025-05-05 17:39:44] [DEBUG] パラメータバインド完了: userId=U94063df81ada7ad734bc6f999aa58d2a, roomNumber=fg#13, userName=南雲, checkInDate=2025-05-05, checkOutDate=2025-05-06
[2025-05-05 17:39:44] [INFO] SQLを実行します
[2025-05-05 17:39:44] [DEBUG] 挿入予定の値: {"line_user_id":"U94063df81ada7ad734bc6f999aa58d2a","room_number":"fg#13","user_name":"\u5357\u96f2","check_in_date":"2025-05-05","check_out_date":"2025-05-06"}
[2025-05-05 17:39:44] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-05 17:39:44] [DEBUG] 直接クエリ実行結果: 成功
[2025-05-05 17:39:44] [INFO] 直接クエリで新規登録ID: 3
[2025-05-05 17:39:44] [INFO] トランザクションコミット成功
[2025-05-05 17:39:44] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"3","registration_type":"new"}
[2025-05-05 17:39:44] [INFO] JSONレスポンスを送信完了
[2025-05-05 17:39:44] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に登録されました","registration_id":"3","registration_type":"new"}
2025-05-05 17:39:44 - ユーザーID: U94063df81ada7ad734bc6f999aa58d2a - 部屋番号新規登録 - 部屋: fg#13 - 期間: 2025-05-05 から 2025-05-06
[2025-05-05 17:39:44] [DEBUG] 出力バッファに167バイトのデータがあります
[2025-05-05 17:39:44] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"3","registration_type":"new"}
[2025-05-05 17:39:44] [DEBUG] 出力バッファをフラッシュします
[2025-05-05 17:39:44] [INFO] 処理完了
[2025-05-05 21:41:31] [INFO] --- 登録API処理開始 ---
[2025-05-05 21:41:31] [INFO] リクエスト元IPアドレス: 153.189.181.175
[2025-05-05 21:41:31] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI5NWU5MTE5ZjY1M2VhZTA5NWJiM2Q4NzFkNmJhOGZmNDY0NjdhYTMxNDU3NWE0NTQzNjE1ZjA1MWQ0YjczNWE2IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTMzZjVmOWFhZDcxZTgxYTU5MTdkZGM3Y2Q4M2JiOGY4IiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQ1MjI0OSwiaWF0IjoxNzQ2NDQ4NjQ5LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi5re75baL57SY5Y-ySGlyb2Z1bWkgQml6IiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoWDBhTE5Ja3FCeDljTlJGcGZySjRTR0J3Q1hJckd3RlhKRmNZS1NwbUN5bHpBMFFjWTFGQUtuaGlDaTUzQmtRYVkxcEtleW8wVUgxMSJ9.RipZrIbmLPGuO7UjvPXMDPgJgl4mw8_vp7I8RbWf7Vn1zOQXSxQQfi3LVL9z1wkbcS_g0AC-n1yseI0Yg_7TqQ","room_number":"fg#12","user_name":"添嶋紘史Hirofumi Biz","check_in":"2025-05-05","check_out":"2025-05-06","check_out_time":"11:00"}
[2025-05-05 21:41:31] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI5NWU5MTE5ZjY1M2VhZTA5NWJiM2Q4NzFkNmJhOGZmNDY0NjdhYTMxNDU3NWE0NTQzNjE1ZjA1MWQ0YjczNWE2IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTMzZjVmOWFhZDcxZTgxYTU5MTdkZGM3Y2Q4M2JiOGY4IiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NjQ1MjI0OSwiaWF0IjoxNzQ2NDQ4NjQ5LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi5re75baL57SY5Y-ySGlyb2Z1bWkgQml6IiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoWDBhTE5Ja3FCeDljTlJGcGZySjRTR0J3Q1hJckd3RlhKRmNZS1NwbUN5bHpBMFFjWTFGQUtuaGlDaTUzQmtRYVkxcEtleW8wVUgxMSJ9.RipZrIbmLPGuO7UjvPXMDPgJgl4mw8_vp7I8RbWf7Vn1zOQXSxQQfi3LVL9z1wkbcS_g0AC-n1yseI0Yg_7TqQ
    [room_number] => fg#12
    [user_name] => 添嶋紘史Hirofumi Biz
    [check_in] => 2025-05-05
    [check_out] => 2025-05-06
    [check_out_time] => 11:00
)

[2025-05-05 21:41:31] [INFO] 処理パラメータ: room=fg#12, user=添嶋紘史Hirofumi Biz, checkIn=2025-05-05, checkOut=2025-05-06
[2025-05-05 21:41:31] [INFO] IDトークンを検証: eyJraWQiOiI5NWU5MTE5...
[2025-05-05 21:41:31] [DEBUG] トークン検証開始: eyJraWQiOiI5NWU5MTE5...
[2025-05-05 21:41:31] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U33f5f9aad71e81a5917ddc7cd83bb8f8
    [aud] => 2007363986
    [exp] => 1746452249
    [iat] => 1746448649
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => 添嶋紘史Hirofumi Biz
    [picture] => https://profile.line-scdn.net/0hX0aLNIkqBx9cNRFpfrJ4SGBwCXIrGwFXJFcYKSpmCylzA0QcY1FAKnhiCi53BkQaY1pKeyo0UH11
)

[2025-05-05 21:41:31] [INFO] トークン検証成功: ユーザーID U33f5f9aad71e81a5917ddc7cd83bb8f8
[2025-05-05 21:41:31] [INFO] IDトークン検証成功: userId=U33f5f9aad71e81a5917ddc7cd83bb8f8
[2025-05-05 21:41:31] [INFO] データベース接続を開始します
[2025-05-05 21:41:31] [INFO] データベース接続成功
[2025-05-05 21:41:31] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-05 21:41:31] [INFO] line_room_linksテーブルが存在します
[2025-05-05 21:41:31] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-05 21:41:31] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token
[2025-05-05 21:41:31] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-05 21:41:31] [INFO] line_room_linksテーブルのレコード数: 3
[2025-05-05 21:41:31] [INFO] 最新のレコード: {"id":3,"line_user_id":"U94063df81ada7ad734bc6f999aa58d2a","room_number":"fg#13","user_name":"\u5357\u96f2","check_in_date":"2025-05-05","check_out_date":"2025-05-06","access_token":null,"is_active":1,"created_at":"2025-05-05 17:39:44","updated_at":"2025-05-05 17:39:44"}
[2025-05-05 21:41:31] [INFO] トランザクション開始
[2025-05-05 21:41:31] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-05 21:41:31] [DEBUG] パラメータバインド: roomNumber=fg#12
[2025-05-05 21:41:31] [INFO] 部屋検索クエリ実行完了
[2025-05-05 21:41:31] [INFO] 部屋検索結果: 部屋あり ID=12, アクティブ=1
[2025-05-05 21:41:31] [DEBUG] 既存登録確認SQL: 
            SELECT id 
            FROM line_room_links 
            WHERE line_user_id = :userId 
            AND check_out_date >= CURDATE()
        
[2025-05-05 21:41:31] [DEBUG] パラメータバインド: userId=U33f5f9aad71e81a5917ddc7cd83bb8f8
[2025-05-05 21:41:31] [INFO] 既存登録検索クエリ実行完了
[2025-05-05 21:41:31] [INFO] 既存登録検索結果: 登録なし
[2025-05-05 21:41:31] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate)
            
[2025-05-05 21:41:31] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-05 21:41:31] [DEBUG] プリペアドステートメント作成成功
[2025-05-05 21:41:31] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-05, checkOut=2025-05-06
[2025-05-05 21:41:31] [DEBUG] パラメータバインド完了: userId=U33f5f9aad71e81a5917ddc7cd83bb8f8, roomNumber=fg#12, userName=添嶋紘史Hirofumi Biz, checkInDate=2025-05-05, checkOutDate=2025-05-06
[2025-05-05 21:41:31] [INFO] SQLを実行します
[2025-05-05 21:41:31] [DEBUG] 挿入予定の値: {"line_user_id":"U33f5f9aad71e81a5917ddc7cd83bb8f8","room_number":"fg#12","user_name":"\u6dfb\u5d8b\u7d18\u53f2Hirofumi Biz","check_in_date":"2025-05-05","check_out_date":"2025-05-06"}
[2025-05-05 21:41:31] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-05 21:41:31] [DEBUG] 直接クエリ実行結果: 成功
[2025-05-05 21:41:31] [INFO] 直接クエリで新規登録ID: 4
[2025-05-05 21:41:31] [INFO] トランザクションコミット成功
[2025-05-05 21:41:31] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"4","registration_type":"new"}
[2025-05-05 21:41:31] [INFO] JSONレスポンスを送信完了
[2025-05-05 21:41:31] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に登録されました","registration_id":"4","registration_type":"new"}
2025-05-05 21:41:31 - ユーザーID: U33f5f9aad71e81a5917ddc7cd83bb8f8 - 部屋番号新規登録 - 部屋: fg#12 - 期間: 2025-05-05 から 2025-05-06
[2025-05-05 21:41:31] [DEBUG] 出力バッファに167バイトのデータがあります
[2025-05-05 21:41:31] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"4","registration_type":"new"}
[2025-05-05 21:41:31] [DEBUG] 出力バッファをフラッシュします
[2025-05-05 21:41:31] [INFO] 処理完了
[2025-05-13 10:53:07] [INFO] --- 登録API処理開始 ---
[2025-05-13 10:53:07] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-13 10:53:07] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiIxZjA2N2VlYzU5OWI3NGJmNGUyOGMyNDNjN2ZiYTY0NjNhMDM1OTMzNTUzZTMxZjdhMzg4ZTE0ZDQ0ZmE0OGUzIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWVmZjVjNTJmM2UwMDc3ZTZiZjY5NWQ1OTQxNDE0MmVjIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzEwNDcyMSwiaWF0IjoxNzQ3MTAxMTIxLCJhbXIiOlsibGluZXFyIl0sIm5hbWUiOiJ3YXNobyIsInBpY3R1cmUiOiJodHRwczovL3Byb2ZpbGUubGluZS1zY2RuLm5ldC8wbTAzOWIyODlkNzI1MThjNmMxZTA0MGVmYWNlZDc4YTU5ZWEzYzA4ODI1ZTA1In0.7uxlwtY5oO0swt3kCfT3CUwLOgAcIOcDgbjs0205DxOP5lfNRnil91hxqWW4KyznsqWCcyyiGFLPpbkCt6xs3A","room_number":"fg#11","user_name":"washo","check_in":"2025-05-13","check_out":"2025-05-14","check_out_time":"11:00"}
[2025-05-13 10:53:07] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiIxZjA2N2VlYzU5OWI3NGJmNGUyOGMyNDNjN2ZiYTY0NjNhMDM1OTMzNTUzZTMxZjdhMzg4ZTE0ZDQ0ZmE0OGUzIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWVmZjVjNTJmM2UwMDc3ZTZiZjY5NWQ1OTQxNDE0MmVjIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzEwNDcyMSwiaWF0IjoxNzQ3MTAxMTIxLCJhbXIiOlsibGluZXFyIl0sIm5hbWUiOiJ3YXNobyIsInBpY3R1cmUiOiJodHRwczovL3Byb2ZpbGUubGluZS1zY2RuLm5ldC8wbTAzOWIyODlkNzI1MThjNmMxZTA0MGVmYWNlZDc4YTU5ZWEzYzA4ODI1ZTA1In0.7uxlwtY5oO0swt3kCfT3CUwLOgAcIOcDgbjs0205DxOP5lfNRnil91hxqWW4KyznsqWCcyyiGFLPpbkCt6xs3A
    [room_number] => fg#11
    [user_name] => washo
    [check_in] => 2025-05-13
    [check_out] => 2025-05-14
    [check_out_time] => 11:00
)

[2025-05-13 10:53:07] [INFO] forceフラグ: false
[2025-05-13 10:53:07] [INFO] 処理パラメータ: room=fg#11, user=washo, checkIn=2025-05-13, checkOut=2025-05-14
[2025-05-13 10:53:07] [INFO] IDトークンを検証: eyJraWQiOiIxZjA2N2Vl...
[2025-05-13 10:53:07] [DEBUG] トークン検証開始: eyJraWQiOiIxZjA2N2Vl...
[2025-05-13 10:53:07] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => Ueff5c52f3e0077e6bf695d59414142ec
    [aud] => 2007363986
    [exp] => 1747104721
    [iat] => 1747101121
    [amr] => Array
        (
            [0] => lineqr
        )

    [name] => washo
    [picture] => https://profile.line-scdn.net/0m039b289d72518c6c1e040efaced78a59ea3c08825e05
)

[2025-05-13 10:53:07] [INFO] トークン検証成功: ユーザーID Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-13 10:53:07] [INFO] IDトークン検証成功: userId=Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-13 10:53:07] [INFO] データベース接続を開始します
[2025-05-13 10:53:07] [INFO] データベース接続成功
[2025-05-13 10:53:07] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-13 10:53:07] [INFO] line_room_linksテーブルが存在します
[2025-05-13 10:53:07] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-13 10:53:07] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-13 10:53:07] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=36 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-13 10:53:07] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-13 10:53:07] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#10","order_session_id":"250513083517216749868","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-09","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-13 08:35:17"}
[2025-05-13 10:53:07] [INFO] トランザクション開始
[2025-05-13 10:53:07] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-13 10:53:07] [DEBUG] パラメータバインド: roomNumber=fg#11
[2025-05-13 10:53:07] [INFO] 部屋検索クエリ実行完了
[2025-05-13 10:53:07] [INFO] 部屋検索結果: 部屋あり ID=11, アクティブ=1
[2025-05-13 10:53:07] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-13 10:53:07] [DEBUG] パラメータバインド: userId=Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-13 10:53:07] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-13 10:53:07] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-13 10:53:07] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-13 10:53:07] [INFO] 非アクティブ化した登録数: 1
[2025-05-13 10:53:07] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-13 10:53:07] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-13 10:53:07] [DEBUG] プリペアドステートメント作成成功
[2025-05-13 10:53:07] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-13, checkOut=2025-05-08
[2025-05-13 10:53:07] [DEBUG] パラメータバインド完了: userId=Ueff5c52f3e0077e6bf695d59414142ec, roomNumber=fg#11, userName=washo, checkInDate=2025-05-13, checkOutDate=2025-05-08
[2025-05-13 10:53:07] [INFO] SQLを実行します
[2025-05-13 10:53:07] [DEBUG] 挿入予定の値: {"line_user_id":"Ueff5c52f3e0077e6bf695d59414142ec","room_number":"fg#11","user_name":"washo","check_in_date":"2025-05-13","check_out_date":"2025-05-08"}
[2025-05-13 10:53:07] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-13 10:53:07] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'Ueff5c52f3e0077e6bf695d59414142ec' for key 'line_room_links.line_user_id'
[2025-05-13 10:53:07] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'Ueff5c52f3e0077e6bf695d59414142ec' for key 'line_room_links.line_user_id'
[2025-05-13 10:53:07] [ERROR] エラーコード: 23000
[2025-05-13 10:53:07] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'Ueff5c52f3e0077e6bf695d59414142ec' for key 'line_room_links.line_user_id'
)

[2025-05-13 10:53:07] [ERROR] SQLステート: 23000
[2025-05-13 10:53:07] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-13 10:53:07] [ERROR] スタックトレース: #0 {main}
[2025-05-13 10:53:07] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-13 10:53:07] [ERROR] スタックトレース: #0 {main}
[2025-05-13 10:53:07] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-13 10:53:07] [INFO] エラーJSONレスポンスを送信完了
[2025-05-13 10:53:07] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-13 10:53:07] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-13 10:53:07] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-13 10:53:07] [DEBUG] 出力バッファをフラッシュします
[2025-05-13 10:53:07] [INFO] 処理完了
[2025-05-13 10:53:07] [INFO] --- 登録API処理開始 ---
[2025-05-13 10:53:07] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-13 10:53:07] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiIxZjA2N2VlYzU5OWI3NGJmNGUyOGMyNDNjN2ZiYTY0NjNhMDM1OTMzNTUzZTMxZjdhMzg4ZTE0ZDQ0ZmE0OGUzIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWVmZjVjNTJmM2UwMDc3ZTZiZjY5NWQ1OTQxNDE0MmVjIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzEwNDcyMSwiaWF0IjoxNzQ3MTAxMTIxLCJhbXIiOlsibGluZXFyIl0sIm5hbWUiOiJ3YXNobyIsInBpY3R1cmUiOiJodHRwczovL3Byb2ZpbGUubGluZS1zY2RuLm5ldC8wbTAzOWIyODlkNzI1MThjNmMxZTA0MGVmYWNlZDc4YTU5ZWEzYzA4ODI1ZTA1In0.7uxlwtY5oO0swt3kCfT3CUwLOgAcIOcDgbjs0205DxOP5lfNRnil91hxqWW4KyznsqWCcyyiGFLPpbkCt6xs3A","room_number":"fg#11","user_name":"washo","check_in":"2025-05-13","check_out":"2025-05-14","check_out_time":"11:00","force":true}
[2025-05-13 10:53:07] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiIxZjA2N2VlYzU5OWI3NGJmNGUyOGMyNDNjN2ZiYTY0NjNhMDM1OTMzNTUzZTMxZjdhMzg4ZTE0ZDQ0ZmE0OGUzIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWVmZjVjNTJmM2UwMDc3ZTZiZjY5NWQ1OTQxNDE0MmVjIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzEwNDcyMSwiaWF0IjoxNzQ3MTAxMTIxLCJhbXIiOlsibGluZXFyIl0sIm5hbWUiOiJ3YXNobyIsInBpY3R1cmUiOiJodHRwczovL3Byb2ZpbGUubGluZS1zY2RuLm5ldC8wbTAzOWIyODlkNzI1MThjNmMxZTA0MGVmYWNlZDc4YTU5ZWEzYzA4ODI1ZTA1In0.7uxlwtY5oO0swt3kCfT3CUwLOgAcIOcDgbjs0205DxOP5lfNRnil91hxqWW4KyznsqWCcyyiGFLPpbkCt6xs3A
    [room_number] => fg#11
    [user_name] => washo
    [check_in] => 2025-05-13
    [check_out] => 2025-05-14
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-13 10:53:07] [INFO] forceフラグ: true
[2025-05-13 10:53:07] [INFO] 処理パラメータ: room=fg#11, user=washo, checkIn=2025-05-13, checkOut=2025-05-14
[2025-05-13 10:53:07] [INFO] IDトークンを検証: eyJraWQiOiIxZjA2N2Vl...
[2025-05-13 10:53:07] [DEBUG] トークン検証開始: eyJraWQiOiIxZjA2N2Vl...
[2025-05-13 10:53:07] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => Ueff5c52f3e0077e6bf695d59414142ec
    [aud] => 2007363986
    [exp] => 1747104721
    [iat] => 1747101121
    [amr] => Array
        (
            [0] => lineqr
        )

    [name] => washo
    [picture] => https://profile.line-scdn.net/0m039b289d72518c6c1e040efaced78a59ea3c08825e05
)

[2025-05-13 10:53:07] [INFO] トークン検証成功: ユーザーID Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-13 10:53:07] [INFO] IDトークン検証成功: userId=Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-13 10:53:07] [INFO] データベース接続を開始します
[2025-05-13 10:53:07] [INFO] データベース接続成功
[2025-05-13 10:53:07] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-13 10:53:07] [INFO] line_room_linksテーブルが存在します
[2025-05-13 10:53:07] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-13 10:53:07] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-13 10:53:07] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=38 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-13 10:53:07] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-13 10:53:07] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#10","order_session_id":"250513083517216749868","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-09","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-13 08:35:17"}
[2025-05-13 10:53:07] [INFO] トランザクション開始
[2025-05-13 10:53:07] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-13 10:53:07] [DEBUG] パラメータバインド: roomNumber=fg#11
[2025-05-13 10:53:07] [INFO] 部屋検索クエリ実行完了
[2025-05-13 10:53:07] [INFO] 部屋検索結果: 部屋あり ID=11, アクティブ=1
[2025-05-13 10:53:07] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-13 10:53:07] [DEBUG] パラメータバインド: userId=Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-13 10:53:07] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-13 10:53:07] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-13 10:53:07] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-13 10:53:07] [INFO] 非アクティブ化した登録数: 1
[2025-05-13 10:53:07] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-13 10:53:07] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-13 10:53:07] [DEBUG] プリペアドステートメント作成成功
[2025-05-13 10:53:07] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-13, checkOut=2025-05-08
[2025-05-13 10:53:07] [DEBUG] パラメータバインド完了: userId=Ueff5c52f3e0077e6bf695d59414142ec, roomNumber=fg#11, userName=washo, checkInDate=2025-05-13, checkOutDate=2025-05-08
[2025-05-13 10:53:07] [INFO] SQLを実行します
[2025-05-13 10:53:07] [DEBUG] 挿入予定の値: {"line_user_id":"Ueff5c52f3e0077e6bf695d59414142ec","room_number":"fg#11","user_name":"washo","check_in_date":"2025-05-13","check_out_date":"2025-05-08"}
[2025-05-13 10:53:07] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-13 10:53:07] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'Ueff5c52f3e0077e6bf695d59414142ec' for key 'line_room_links.line_user_id'
[2025-05-13 10:53:07] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'Ueff5c52f3e0077e6bf695d59414142ec' for key 'line_room_links.line_user_id'
[2025-05-13 10:53:07] [ERROR] エラーコード: 23000
[2025-05-13 10:53:07] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'Ueff5c52f3e0077e6bf695d59414142ec' for key 'line_room_links.line_user_id'
)

[2025-05-13 10:53:07] [ERROR] SQLステート: 23000
[2025-05-13 10:53:07] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-13 10:53:07] [INFO] 重複したユーザーIDの既存レコードを発見: ID=10
[2025-05-13 10:53:07] [INFO] 重複ユーザーの登録情報を更新しました: ID=10
[2025-05-13 10:53:07] [INFO] トランザクションコミット成功
[2025-05-13 10:53:07] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":10,"registration_type":"updated"}
[2025-05-13 10:53:07] [INFO] JSONレスポンスを送信完了
[2025-05-13 10:53:07] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":10,"registration_type":"updated"}
2025-05-13 10:53:07 - ユーザーID: Ueff5c52f3e0077e6bf695d59414142ec - 部屋番号更新 - 部屋: fg#11 - 期間: 2025-05-13 から 2025-05-08
[2025-05-13 10:53:07] [DEBUG] 出力バッファに170バイトのデータがあります
[2025-05-13 10:53:07] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":10,"registration_type":"updated"}
[2025-05-13 10:53:07] [DEBUG] 出力バッファをフラッシュします
[2025-05-13 10:53:07] [INFO] 処理完了
[2025-05-13 10:55:16] [INFO] --- 登録API処理開始 ---
[2025-05-13 10:55:16] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-13 10:55:16] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI5MjkxZTZiNmEzOGM3ZDhhZjY4YzUyNjZmYWEyODIwOGQ2ZGQ1OTg0NWZhYTAyNGU1NDFiZGIzOWZlMTM1ZDRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzEwNDM5MiwiaWF0IjoxNzQ3MTAwNzkyLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.yl44N2VsWTqq28xI-AexkJtFx_qRLLDbi-hG694BJwHtaZqgwgdc4OuslwZG7zhqEGF38pG85xi-MFwbcPKQJw","room_number":"fg#11","user_name":"くらひで","check_in":"2025-05-13","check_out":"2025-05-14","check_out_time":"11:00"}
[2025-05-13 10:55:16] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI5MjkxZTZiNmEzOGM3ZDhhZjY4YzUyNjZmYWEyODIwOGQ2ZGQ1OTg0NWZhYTAyNGU1NDFiZGIzOWZlMTM1ZDRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzEwNDM5MiwiaWF0IjoxNzQ3MTAwNzkyLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.yl44N2VsWTqq28xI-AexkJtFx_qRLLDbi-hG694BJwHtaZqgwgdc4OuslwZG7zhqEGF38pG85xi-MFwbcPKQJw
    [room_number] => fg#11
    [user_name] => くらひで
    [check_in] => 2025-05-13
    [check_out] => 2025-05-14
    [check_out_time] => 11:00
)

[2025-05-13 10:55:16] [INFO] forceフラグ: false
[2025-05-13 10:55:16] [INFO] 処理パラメータ: room=fg#11, user=くらひで, checkIn=2025-05-13, checkOut=2025-05-14
[2025-05-13 10:55:16] [INFO] IDトークンを検証: eyJraWQiOiI5MjkxZTZi...
[2025-05-13 10:55:16] [DEBUG] トークン検証開始: eyJraWQiOiI5MjkxZTZi...
[2025-05-13 10:55:16] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1747104392
    [iat] => 1747100792
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-13 10:55:16] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-13 10:55:16] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-13 10:55:16] [INFO] データベース接続を開始します
[2025-05-13 10:55:16] [INFO] データベース接続成功
[2025-05-13 10:55:16] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-13 10:55:16] [INFO] line_room_linksテーブルが存在します
[2025-05-13 10:55:16] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-13 10:55:16] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-13 10:55:16] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=40 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-13 10:55:16] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-13 10:55:16] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#10","order_session_id":"250513083517216749868","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-09","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-13 08:35:17"}
[2025-05-13 10:55:16] [INFO] トランザクション開始
[2025-05-13 10:55:16] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-13 10:55:16] [DEBUG] パラメータバインド: roomNumber=fg#11
[2025-05-13 10:55:16] [INFO] 部屋検索クエリ実行完了
[2025-05-13 10:55:16] [INFO] 部屋検索結果: 部屋あり ID=11, アクティブ=1
[2025-05-13 10:55:16] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-13 10:55:16] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-13 10:55:16] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-13 10:55:16] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-13 10:55:16] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-13 10:55:16] [INFO] 非アクティブ化した登録数: 1
[2025-05-13 10:55:16] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-13 10:55:16] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-13 10:55:16] [DEBUG] プリペアドステートメント作成成功
[2025-05-13 10:55:16] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-13, checkOut=2025-05-09
[2025-05-13 10:55:16] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#11, userName=くらひで, checkInDate=2025-05-13, checkOutDate=2025-05-09
[2025-05-13 10:55:16] [INFO] SQLを実行します
[2025-05-13 10:55:16] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#11","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-13","check_out_date":"2025-05-09"}
[2025-05-13 10:55:16] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-13 10:55:16] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-13 10:55:16] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-13 10:55:16] [ERROR] エラーコード: 23000
[2025-05-13 10:55:16] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-05-13 10:55:16] [ERROR] SQLステート: 23000
[2025-05-13 10:55:16] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-13 10:55:16] [ERROR] スタックトレース: #0 {main}
[2025-05-13 10:55:16] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-13 10:55:16] [ERROR] スタックトレース: #0 {main}
[2025-05-13 10:55:16] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-13 10:55:16] [INFO] エラーJSONレスポンスを送信完了
[2025-05-13 10:55:16] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-13 10:55:16] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-13 10:55:16] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-13 10:55:16] [DEBUG] 出力バッファをフラッシュします
[2025-05-13 10:55:16] [INFO] 処理完了
[2025-05-13 10:55:16] [INFO] --- 登録API処理開始 ---
[2025-05-13 10:55:16] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-13 10:55:16] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI5MjkxZTZiNmEzOGM3ZDhhZjY4YzUyNjZmYWEyODIwOGQ2ZGQ1OTg0NWZhYTAyNGU1NDFiZGIzOWZlMTM1ZDRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzEwNDM5MiwiaWF0IjoxNzQ3MTAwNzkyLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.yl44N2VsWTqq28xI-AexkJtFx_qRLLDbi-hG694BJwHtaZqgwgdc4OuslwZG7zhqEGF38pG85xi-MFwbcPKQJw","room_number":"fg#11","user_name":"くらひで","check_in":"2025-05-13","check_out":"2025-05-14","check_out_time":"11:00","force":true}
[2025-05-13 10:55:16] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI5MjkxZTZiNmEzOGM3ZDhhZjY4YzUyNjZmYWEyODIwOGQ2ZGQ1OTg0NWZhYTAyNGU1NDFiZGIzOWZlMTM1ZDRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzEwNDM5MiwiaWF0IjoxNzQ3MTAwNzkyLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.yl44N2VsWTqq28xI-AexkJtFx_qRLLDbi-hG694BJwHtaZqgwgdc4OuslwZG7zhqEGF38pG85xi-MFwbcPKQJw
    [room_number] => fg#11
    [user_name] => くらひで
    [check_in] => 2025-05-13
    [check_out] => 2025-05-14
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-13 10:55:16] [INFO] forceフラグ: true
[2025-05-13 10:55:16] [INFO] 処理パラメータ: room=fg#11, user=くらひで, checkIn=2025-05-13, checkOut=2025-05-14
[2025-05-13 10:55:16] [INFO] IDトークンを検証: eyJraWQiOiI5MjkxZTZi...
[2025-05-13 10:55:16] [DEBUG] トークン検証開始: eyJraWQiOiI5MjkxZTZi...
[2025-05-13 10:55:16] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1747104392
    [iat] => 1747100792
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-13 10:55:16] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-13 10:55:16] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-13 10:55:16] [INFO] データベース接続を開始します
[2025-05-13 10:55:16] [INFO] データベース接続成功
[2025-05-13 10:55:16] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-13 10:55:16] [INFO] line_room_linksテーブルが存在します
[2025-05-13 10:55:16] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-13 10:55:16] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-13 10:55:16] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=42 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-13 10:55:16] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-13 10:55:16] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#10","order_session_id":"250513083517216749868","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-09","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-13 08:35:17"}
[2025-05-13 10:55:16] [INFO] トランザクション開始
[2025-05-13 10:55:16] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-13 10:55:16] [DEBUG] パラメータバインド: roomNumber=fg#11
[2025-05-13 10:55:16] [INFO] 部屋検索クエリ実行完了
[2025-05-13 10:55:16] [INFO] 部屋検索結果: 部屋あり ID=11, アクティブ=1
[2025-05-13 10:55:16] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-13 10:55:16] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-13 10:55:16] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-13 10:55:16] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-13 10:55:16] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-13 10:55:16] [INFO] 非アクティブ化した登録数: 1
[2025-05-13 10:55:16] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-13 10:55:16] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-13 10:55:16] [DEBUG] プリペアドステートメント作成成功
[2025-05-13 10:55:16] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-13, checkOut=2025-05-09
[2025-05-13 10:55:16] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#11, userName=くらひで, checkInDate=2025-05-13, checkOutDate=2025-05-09
[2025-05-13 10:55:16] [INFO] SQLを実行します
[2025-05-13 10:55:16] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#11","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-13","check_out_date":"2025-05-09"}
[2025-05-13 10:55:16] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-13 10:55:16] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-13 10:55:16] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-13 10:55:16] [ERROR] エラーコード: 23000
[2025-05-13 10:55:16] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-05-13 10:55:16] [ERROR] SQLステート: 23000
[2025-05-13 10:55:16] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-13 10:55:16] [INFO] 重複したユーザーIDの既存レコードを発見: ID=35
[2025-05-13 10:55:16] [INFO] 重複ユーザーの登録情報を更新しました: ID=35
[2025-05-13 10:55:16] [INFO] トランザクションコミット成功
[2025-05-13 10:55:16] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":35,"registration_type":"updated"}
[2025-05-13 10:55:16] [INFO] JSONレスポンスを送信完了
[2025-05-13 10:55:16] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":35,"registration_type":"updated"}
2025-05-13 10:55:16 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#11 - 期間: 2025-05-13 から 2025-05-09
[2025-05-13 10:55:16] [DEBUG] 出力バッファに170バイトのデータがあります
[2025-05-13 10:55:16] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":35,"registration_type":"updated"}
[2025-05-13 10:55:16] [DEBUG] 出力バッファをフラッシュします
[2025-05-13 10:55:16] [INFO] 処理完了
[2025-05-13 12:07:18] [INFO] --- 登録API処理開始 ---
[2025-05-13 12:07:18] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-13 12:07:18] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiIyNmNmMzk1ZjQ4MTYyZTRhMzc3MzM5Yjk1MjBjNzA2NzI5ZTFmZGMzYTY0NWI3YTlhZTc3YWMyYTQ4NzVhODA4IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzEwOTEyNSwiaWF0IjoxNzQ3MTA1NTI1LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.J1PWrVqiJJSMGxR_obagIIwQdAT9XPLjg9LOdCdMN8JJJbvHajWzeP-H-QyiKQl7YqasFO6YiS-5EBTvDCbPSw","room_number":"fg#10","user_name":"くらひで","check_in":"2025-05-13","check_out":"2025-05-14","check_out_time":"11:00"}
[2025-05-13 12:07:18] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiIyNmNmMzk1ZjQ4MTYyZTRhMzc3MzM5Yjk1MjBjNzA2NzI5ZTFmZGMzYTY0NWI3YTlhZTc3YWMyYTQ4NzVhODA4IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzEwOTEyNSwiaWF0IjoxNzQ3MTA1NTI1LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.J1PWrVqiJJSMGxR_obagIIwQdAT9XPLjg9LOdCdMN8JJJbvHajWzeP-H-QyiKQl7YqasFO6YiS-5EBTvDCbPSw
    [room_number] => fg#10
    [user_name] => くらひで
    [check_in] => 2025-05-13
    [check_out] => 2025-05-14
    [check_out_time] => 11:00
)

[2025-05-13 12:07:18] [INFO] forceフラグ: false
[2025-05-13 12:07:18] [INFO] 処理パラメータ: room=fg#10, user=くらひで, checkIn=2025-05-13, checkOut=2025-05-14
[2025-05-13 12:07:18] [INFO] IDトークンを検証: eyJraWQiOiIyNmNmMzk1...
[2025-05-13 12:07:18] [DEBUG] トークン検証開始: eyJraWQiOiIyNmNmMzk1...
[2025-05-13 12:07:18] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1747109125
    [iat] => 1747105525
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-13 12:07:18] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-13 12:07:18] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-13 12:07:18] [INFO] データベース接続を開始します
[2025-05-13 12:07:18] [INFO] データベース接続成功
[2025-05-13 12:07:18] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-13 12:07:18] [INFO] line_room_linksテーブルが存在します
[2025-05-13 12:07:18] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-13 12:07:18] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-13 12:07:18] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=44 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-13 12:07:18] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-13 12:07:18] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#11","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-13","check_out_date":"2025-05-09","access_token":null,"is_active":0,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-13 11:48:40"}
[2025-05-13 12:07:18] [INFO] トランザクション開始
[2025-05-13 12:07:18] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-13 12:07:18] [DEBUG] パラメータバインド: roomNumber=fg#10
[2025-05-13 12:07:18] [INFO] 部屋検索クエリ実行完了
[2025-05-13 12:07:18] [INFO] 部屋検索結果: 部屋あり ID=10, アクティブ=1
[2025-05-13 12:07:18] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-13 12:07:18] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-13 12:07:18] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-13 12:07:18] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-13 12:07:18] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-13 12:07:18] [INFO] 非アクティブ化した登録数: 0
[2025-05-13 12:07:18] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-13 12:07:18] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-13 12:07:18] [DEBUG] プリペアドステートメント作成成功
[2025-05-13 12:07:18] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-13, checkOut=2025-05-09
[2025-05-13 12:07:18] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#10, userName=くらひで, checkInDate=2025-05-13, checkOutDate=2025-05-09
[2025-05-13 12:07:18] [INFO] SQLを実行します
[2025-05-13 12:07:18] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#10","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-13","check_out_date":"2025-05-09"}
[2025-05-13 12:07:18] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-13 12:07:18] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-13 12:07:18] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-13 12:07:18] [ERROR] エラーコード: 23000
[2025-05-13 12:07:18] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-05-13 12:07:18] [ERROR] SQLステート: 23000
[2025-05-13 12:07:18] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-13 12:07:18] [ERROR] スタックトレース: #0 {main}
[2025-05-13 12:07:18] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-13 12:07:18] [ERROR] スタックトレース: #0 {main}
[2025-05-13 12:07:18] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-13 12:07:18] [INFO] エラーJSONレスポンスを送信完了
[2025-05-13 12:07:18] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-13 12:07:18] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-13 12:07:18] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-13 12:07:18] [DEBUG] 出力バッファをフラッシュします
[2025-05-13 12:07:18] [INFO] 処理完了
[2025-05-13 12:07:18] [INFO] --- 登録API処理開始 ---
[2025-05-13 12:07:18] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-13 12:07:18] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiIyNmNmMzk1ZjQ4MTYyZTRhMzc3MzM5Yjk1MjBjNzA2NzI5ZTFmZGMzYTY0NWI3YTlhZTc3YWMyYTQ4NzVhODA4IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzEwOTEyNSwiaWF0IjoxNzQ3MTA1NTI1LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.J1PWrVqiJJSMGxR_obagIIwQdAT9XPLjg9LOdCdMN8JJJbvHajWzeP-H-QyiKQl7YqasFO6YiS-5EBTvDCbPSw","room_number":"fg#10","user_name":"くらひで","check_in":"2025-05-13","check_out":"2025-05-14","check_out_time":"11:00","force":true}
[2025-05-13 12:07:18] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiIyNmNmMzk1ZjQ4MTYyZTRhMzc3MzM5Yjk1MjBjNzA2NzI5ZTFmZGMzYTY0NWI3YTlhZTc3YWMyYTQ4NzVhODA4IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzEwOTEyNSwiaWF0IjoxNzQ3MTA1NTI1LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.J1PWrVqiJJSMGxR_obagIIwQdAT9XPLjg9LOdCdMN8JJJbvHajWzeP-H-QyiKQl7YqasFO6YiS-5EBTvDCbPSw
    [room_number] => fg#10
    [user_name] => くらひで
    [check_in] => 2025-05-13
    [check_out] => 2025-05-14
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-13 12:07:18] [INFO] forceフラグ: true
[2025-05-13 12:07:18] [INFO] 処理パラメータ: room=fg#10, user=くらひで, checkIn=2025-05-13, checkOut=2025-05-14
[2025-05-13 12:07:18] [INFO] IDトークンを検証: eyJraWQiOiIyNmNmMzk1...
[2025-05-13 12:07:18] [DEBUG] トークン検証開始: eyJraWQiOiIyNmNmMzk1...
[2025-05-13 12:07:18] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1747109125
    [iat] => 1747105525
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-13 12:07:18] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-13 12:07:18] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-13 12:07:18] [INFO] データベース接続を開始します
[2025-05-13 12:07:18] [INFO] データベース接続成功
[2025-05-13 12:07:18] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-13 12:07:18] [INFO] line_room_linksテーブルが存在します
[2025-05-13 12:07:18] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-13 12:07:18] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-13 12:07:18] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=46 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-13 12:07:18] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-13 12:07:18] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#11","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-13","check_out_date":"2025-05-09","access_token":null,"is_active":0,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-13 11:48:40"}
[2025-05-13 12:07:18] [INFO] トランザクション開始
[2025-05-13 12:07:18] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-13 12:07:18] [DEBUG] パラメータバインド: roomNumber=fg#10
[2025-05-13 12:07:18] [INFO] 部屋検索クエリ実行完了
[2025-05-13 12:07:18] [INFO] 部屋検索結果: 部屋あり ID=10, アクティブ=1
[2025-05-13 12:07:18] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-13 12:07:18] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-13 12:07:18] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-13 12:07:18] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-13 12:07:18] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-13 12:07:18] [INFO] 非アクティブ化した登録数: 0
[2025-05-13 12:07:18] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-13 12:07:18] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-13 12:07:18] [DEBUG] プリペアドステートメント作成成功
[2025-05-13 12:07:18] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-13, checkOut=2025-05-09
[2025-05-13 12:07:18] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#10, userName=くらひで, checkInDate=2025-05-13, checkOutDate=2025-05-09
[2025-05-13 12:07:18] [INFO] SQLを実行します
[2025-05-13 12:07:18] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#10","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-13","check_out_date":"2025-05-09"}
[2025-05-13 12:07:18] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-13 12:07:18] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-13 12:07:18] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-13 12:07:18] [ERROR] エラーコード: 23000
[2025-05-13 12:07:18] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-05-13 12:07:18] [ERROR] SQLステート: 23000
[2025-05-13 12:07:18] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-13 12:07:18] [INFO] 重複したユーザーIDの既存レコードを発見: ID=35
[2025-05-13 12:07:18] [INFO] 重複ユーザーの登録情報を更新しました: ID=35
[2025-05-13 12:07:18] [INFO] トランザクションコミット成功
[2025-05-13 12:07:18] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":35,"registration_type":"updated"}
[2025-05-13 12:07:18] [INFO] JSONレスポンスを送信完了
[2025-05-13 12:07:18] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":35,"registration_type":"updated"}
2025-05-13 12:07:18 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#10 - 期間: 2025-05-13 から 2025-05-09
[2025-05-13 12:07:18] [DEBUG] 出力バッファに170バイトのデータがあります
[2025-05-13 12:07:18] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":35,"registration_type":"updated"}
[2025-05-13 12:07:18] [DEBUG] 出力バッファをフラッシュします
[2025-05-13 12:07:18] [INFO] 処理完了
[2025-05-13 23:22:24] [INFO] --- 登録API処理開始 ---
[2025-05-13 23:22:24] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-13 23:22:24] [INFO] --- 登録API処理開始 ---
[2025-05-13 23:22:24] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-13 23:22:24] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTk0MDYzZGY4MWFkYTdhZDczNGJjNmY5OTlhYTU4ZDJhIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzE0OTczMiwiaWF0IjoxNzQ3MTQ2MTMyLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi5Y2X6ZuyIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoVzc4aXp3TUhDQmdGRUJqNDAwQjNUemxWQm5WeVBnNVFmWEpHZkNKRVYzOHZjQnRMTVg4WGVTWVNBWHdySTAxT2FpSkNkaUpGVmk5OCJ9.qN1FG0T2XCsZw9H6iIXnj6gP9miK_A3-nkK6kz8L8K5y1UJAjF8wSltxRECwW--vppjQV2e5LJlAi8NLC_b_Lw","room_number":"fg#13","user_name":"南雲","check_in":"2025-05-13","check_out":"2025-05-14","check_out_time":"11:00"}
[2025-05-13 23:22:24] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTk0MDYzZGY4MWFkYTdhZDczNGJjNmY5OTlhYTU4ZDJhIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzE0OTczMiwiaWF0IjoxNzQ3MTQ2MTMyLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi5Y2X6ZuyIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoVzc4aXp3TUhDQmdGRUJqNDAwQjNUemxWQm5WeVBnNVFmWEpHZkNKRVYzOHZjQnRMTVg4WGVTWVNBWHdySTAxT2FpSkNkaUpGVmk5OCJ9.qN1FG0T2XCsZw9H6iIXnj6gP9miK_A3-nkK6kz8L8K5y1UJAjF8wSltxRECwW--vppjQV2e5LJlAi8NLC_b_Lw
    [room_number] => fg#13
    [user_name] => 南雲
    [check_in] => 2025-05-13
    [check_out] => 2025-05-14
    [check_out_time] => 11:00
)

[2025-05-13 23:22:24] [INFO] forceフラグ: false
[2025-05-13 23:22:24] [INFO] 処理パラメータ: room=fg#13, user=南雲, checkIn=2025-05-13, checkOut=2025-05-14
[2025-05-13 23:22:24] [INFO] IDトークンを検証: eyJraWQiOiJhMmE0NTlh...
[2025-05-13 23:22:24] [DEBUG] トークン検証開始: eyJraWQiOiJhMmE0NTlh...
[2025-05-13 23:22:24] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U94063df81ada7ad734bc6f999aa58d2a
    [aud] => 2007363986
    [exp] => 1747149732
    [iat] => 1747146132
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => 南雲
    [picture] => https://profile.line-scdn.net/0hW78izwMHCBgFEBj400B3TzlVBnVyPg5QfXJGfCJEV38vcBtLMX8XeSYSAXwrI01OaiJCdiJFVi98
)

[2025-05-13 23:22:24] [INFO] トークン検証成功: ユーザーID U94063df81ada7ad734bc6f999aa58d2a
[2025-05-13 23:22:24] [INFO] IDトークン検証成功: userId=U94063df81ada7ad734bc6f999aa58d2a
[2025-05-13 23:22:24] [INFO] データベース接続を開始します
[2025-05-13 23:22:24] [INFO] データベース接続成功
[2025-05-13 23:22:24] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-13 23:22:24] [INFO] line_room_linksテーブルが存在します
[2025-05-13 23:22:24] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-13 23:22:24] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-13 23:22:24] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=48 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-13 23:22:24] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-13 23:22:24] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#10","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-13","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-13 12:07:18"}
[2025-05-13 23:22:24] [INFO] トランザクション開始
[2025-05-13 23:22:24] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-13 23:22:24] [DEBUG] パラメータバインド: roomNumber=fg#13
[2025-05-13 23:22:24] [INFO] 部屋検索クエリ実行完了
[2025-05-13 23:22:24] [INFO] 部屋検索結果: 部屋あり ID=13, アクティブ=1
[2025-05-13 23:22:24] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-13 23:22:24] [DEBUG] パラメータバインド: userId=U94063df81ada7ad734bc6f999aa58d2a
[2025-05-13 23:22:24] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-13 23:22:24] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-13 23:22:24] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-13 23:22:24] [INFO] 非アクティブ化した登録数: 0
[2025-05-13 23:22:24] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-13 23:22:24] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-13 23:22:24] [DEBUG] プリペアドステートメント作成成功
[2025-05-13 23:22:24] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-13, checkOut=2025-05-06
[2025-05-13 23:22:24] [DEBUG] パラメータバインド完了: userId=U94063df81ada7ad734bc6f999aa58d2a, roomNumber=fg#13, userName=南雲, checkInDate=2025-05-13, checkOutDate=2025-05-06
[2025-05-13 23:22:24] [INFO] SQLを実行します
[2025-05-13 23:22:24] [DEBUG] 挿入予定の値: {"line_user_id":"U94063df81ada7ad734bc6f999aa58d2a","room_number":"fg#13","user_name":"\u5357\u96f2","check_in_date":"2025-05-13","check_out_date":"2025-05-06"}
[2025-05-13 23:22:24] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-13 23:22:24] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U94063df81ada7ad734bc6f999aa58d2a' for key 'line_room_links.line_user_id'
[2025-05-13 23:22:24] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U94063df81ada7ad734bc6f999aa58d2a' for key 'line_room_links.line_user_id'
[2025-05-13 23:22:24] [ERROR] エラーコード: 23000
[2025-05-13 23:22:24] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U94063df81ada7ad734bc6f999aa58d2a' for key 'line_room_links.line_user_id'
)

[2025-05-13 23:22:24] [ERROR] SQLステート: 23000
[2025-05-13 23:22:24] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-13 23:22:24] [ERROR] スタックトレース: #0 {main}
[2025-05-13 23:22:24] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-13 23:22:24] [ERROR] スタックトレース: #0 {main}
[2025-05-13 23:22:24] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-13 23:22:24] [INFO] エラーJSONレスポンスを送信完了
[2025-05-13 23:22:24] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-13 23:22:24] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-13 23:22:24] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-13 23:22:24] [DEBUG] 出力バッファをフラッシュします
[2025-05-13 23:22:24] [INFO] 処理完了
[2025-05-13 23:22:24] [INFO] --- 登録API処理開始 ---
[2025-05-13 23:22:24] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-13 23:22:24] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTk0MDYzZGY4MWFkYTdhZDczNGJjNmY5OTlhYTU4ZDJhIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzE0OTczMiwiaWF0IjoxNzQ3MTQ2MTMyLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi5Y2X6ZuyIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoVzc4aXp3TUhDQmdGRUJqNDAwQjNUemxWQm5WeVBnNVFmWEpHZkNKRVYzOHZjQnRMTVg4WGVTWVNBWHdySTAxT2FpSkNkaUpGVmk5OCJ9.qN1FG0T2XCsZw9H6iIXnj6gP9miK_A3-nkK6kz8L8K5y1UJAjF8wSltxRECwW--vppjQV2e5LJlAi8NLC_b_Lw","room_number":"fg#13","user_name":"南雲","check_in":"2025-05-13","check_out":"2025-05-14","check_out_time":"11:00","force":true}
[2025-05-13 23:22:24] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTk0MDYzZGY4MWFkYTdhZDczNGJjNmY5OTlhYTU4ZDJhIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzE0OTczMiwiaWF0IjoxNzQ3MTQ2MTMyLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi5Y2X6ZuyIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoVzc4aXp3TUhDQmdGRUJqNDAwQjNUemxWQm5WeVBnNVFmWEpHZkNKRVYzOHZjQnRMTVg4WGVTWVNBWHdySTAxT2FpSkNkaUpGVmk5OCJ9.qN1FG0T2XCsZw9H6iIXnj6gP9miK_A3-nkK6kz8L8K5y1UJAjF8wSltxRECwW--vppjQV2e5LJlAi8NLC_b_Lw
    [room_number] => fg#13
    [user_name] => 南雲
    [check_in] => 2025-05-13
    [check_out] => 2025-05-14
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-13 23:22:24] [INFO] forceフラグ: true
[2025-05-13 23:22:24] [INFO] 処理パラメータ: room=fg#13, user=南雲, checkIn=2025-05-13, checkOut=2025-05-14
[2025-05-13 23:22:24] [INFO] IDトークンを検証: eyJraWQiOiJhMmE0NTlh...
[2025-05-13 23:22:24] [DEBUG] トークン検証開始: eyJraWQiOiJhMmE0NTlh...
[2025-05-13 23:22:24] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U94063df81ada7ad734bc6f999aa58d2a
    [aud] => 2007363986
    [exp] => 1747149732
    [iat] => 1747146132
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => 南雲
    [picture] => https://profile.line-scdn.net/0hW78izwMHCBgFEBj400B3TzlVBnVyPg5QfXJGfCJEV38vcBtLMX8XeSYSAXwrI01OaiJCdiJFVi98
)

[2025-05-13 23:22:24] [INFO] トークン検証成功: ユーザーID U94063df81ada7ad734bc6f999aa58d2a
[2025-05-13 23:22:24] [INFO] IDトークン検証成功: userId=U94063df81ada7ad734bc6f999aa58d2a
[2025-05-13 23:22:24] [INFO] データベース接続を開始します
[2025-05-13 23:22:24] [INFO] データベース接続成功
[2025-05-13 23:22:24] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-13 23:22:24] [INFO] line_room_linksテーブルが存在します
[2025-05-13 23:22:24] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-13 23:22:24] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-13 23:22:24] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=50 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-13 23:22:24] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-13 23:22:24] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#10","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-13","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-13 12:07:18"}
[2025-05-13 23:22:24] [INFO] トランザクション開始
[2025-05-13 23:22:24] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-13 23:22:24] [DEBUG] パラメータバインド: roomNumber=fg#13
[2025-05-13 23:22:24] [INFO] 部屋検索クエリ実行完了
[2025-05-13 23:22:24] [INFO] 部屋検索結果: 部屋あり ID=13, アクティブ=1
[2025-05-13 23:22:24] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-13 23:22:24] [DEBUG] パラメータバインド: userId=U94063df81ada7ad734bc6f999aa58d2a
[2025-05-13 23:22:24] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-13 23:22:24] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-13 23:22:24] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-13 23:22:24] [INFO] 非アクティブ化した登録数: 0
[2025-05-13 23:22:24] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-13 23:22:24] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-13 23:22:24] [DEBUG] プリペアドステートメント作成成功
[2025-05-13 23:22:24] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-13, checkOut=2025-05-06
[2025-05-13 23:22:24] [DEBUG] パラメータバインド完了: userId=U94063df81ada7ad734bc6f999aa58d2a, roomNumber=fg#13, userName=南雲, checkInDate=2025-05-13, checkOutDate=2025-05-06
[2025-05-13 23:22:24] [INFO] SQLを実行します
[2025-05-13 23:22:24] [DEBUG] 挿入予定の値: {"line_user_id":"U94063df81ada7ad734bc6f999aa58d2a","room_number":"fg#13","user_name":"\u5357\u96f2","check_in_date":"2025-05-13","check_out_date":"2025-05-06"}
[2025-05-13 23:22:24] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-13 23:22:24] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U94063df81ada7ad734bc6f999aa58d2a' for key 'line_room_links.line_user_id'
[2025-05-13 23:22:24] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U94063df81ada7ad734bc6f999aa58d2a' for key 'line_room_links.line_user_id'
[2025-05-13 23:22:24] [ERROR] エラーコード: 23000
[2025-05-13 23:22:24] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U94063df81ada7ad734bc6f999aa58d2a' for key 'line_room_links.line_user_id'
)

[2025-05-13 23:22:24] [ERROR] SQLステート: 23000
[2025-05-13 23:22:24] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-13 23:22:24] [INFO] 重複したユーザーIDの既存レコードを発見: ID=3
[2025-05-13 23:22:24] [INFO] 重複ユーザーの登録情報を更新しました: ID=3
[2025-05-13 23:22:24] [INFO] トランザクションコミット成功
[2025-05-13 23:22:24] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":3,"registration_type":"updated"}
[2025-05-13 23:22:24] [INFO] JSONレスポンスを送信完了
[2025-05-13 23:22:24] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":3,"registration_type":"updated"}
2025-05-13 23:22:24 - ユーザーID: U94063df81ada7ad734bc6f999aa58d2a - 部屋番号更新 - 部屋: fg#13 - 期間: 2025-05-13 から 2025-05-06
[2025-05-13 23:22:24] [DEBUG] 出力バッファに169バイトのデータがあります
[2025-05-13 23:22:24] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":3,"registration_type":"updated"}
[2025-05-13 23:22:24] [DEBUG] 出力バッファをフラッシュします
[2025-05-13 23:22:24] [INFO] 処理完了
[2025-05-14 10:03:50] [INFO] --- 登録API処理開始 ---
[2025-05-14 10:03:50] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 10:03:50] [INFO] --- 登録API処理開始 ---
[2025-05-14 10:03:50] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 10:03:50] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhNTI0YTQwNGU3YTk3ZDM1ZGM2NDYzMzc1NjMwNTUyNWVkMmRjNGE1YjQ4YTEzMDczNmY3NGU5YTNhNWQ0YjFkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzE4ODIxMywiaWF0IjoxNzQ3MTg0NjEzLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.b7pufHkx6fqBTpxR5fK3w6bX-QcbkykfpTM1ys49lijSzOSQablgSO9FaSrzABJxtj5r0fmFfiV0UbsrM59-Zg","room_number":"fg#04","user_name":"くらひで","check_in":"2025-05-14","check_out":"2025-05-15","check_out_time":"11:00"}
[2025-05-14 10:03:50] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhNTI0YTQwNGU3YTk3ZDM1ZGM2NDYzMzc1NjMwNTUyNWVkMmRjNGE1YjQ4YTEzMDczNmY3NGU5YTNhNWQ0YjFkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzE4ODIxMywiaWF0IjoxNzQ3MTg0NjEzLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.b7pufHkx6fqBTpxR5fK3w6bX-QcbkykfpTM1ys49lijSzOSQablgSO9FaSrzABJxtj5r0fmFfiV0UbsrM59-Zg
    [room_number] => fg#04
    [user_name] => くらひで
    [check_in] => 2025-05-14
    [check_out] => 2025-05-15
    [check_out_time] => 11:00
)

[2025-05-14 10:03:50] [INFO] forceフラグ: false
[2025-05-14 10:03:50] [INFO] 処理パラメータ: room=fg#04, user=くらひで, checkIn=2025-05-14, checkOut=2025-05-15
[2025-05-14 10:03:50] [INFO] IDトークンを検証: eyJraWQiOiJhNTI0YTQw...
[2025-05-14 10:03:50] [DEBUG] トークン検証開始: eyJraWQiOiJhNTI0YTQw...
[2025-05-14 10:03:50] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1747188213
    [iat] => 1747184613
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-14 10:03:50] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-14 10:03:50] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 10:03:50] [INFO] データベース接続を開始します
[2025-05-14 10:03:50] [INFO] データベース接続成功
[2025-05-14 10:03:50] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-14 10:03:50] [INFO] line_room_linksテーブルが存在します
[2025-05-14 10:03:50] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-14 10:03:50] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-14 10:03:50] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=52 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-14 10:03:50] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-14 10:03:50] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#10","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-13","check_out_date":"2025-05-09","access_token":null,"is_active":0,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 04:14:53"}
[2025-05-14 10:03:50] [INFO] トランザクション開始
[2025-05-14 10:03:50] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-14 10:03:50] [DEBUG] パラメータバインド: roomNumber=fg#04
[2025-05-14 10:03:50] [INFO] 部屋検索クエリ実行完了
[2025-05-14 10:03:50] [INFO] 部屋検索結果: 部屋あり ID=4, アクティブ=1
[2025-05-14 10:03:50] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-14 10:03:50] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 10:03:50] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-14 10:03:50] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-14 10:03:50] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-14 10:03:50] [INFO] 非アクティブ化した登録数: 0
[2025-05-14 10:03:50] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-14 10:03:50] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-14 10:03:50] [DEBUG] プリペアドステートメント作成成功
[2025-05-14 10:03:50] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-14, checkOut=2025-05-09
[2025-05-14 10:03:50] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#04, userName=くらひで, checkInDate=2025-05-14, checkOutDate=2025-05-09
[2025-05-14 10:03:50] [INFO] SQLを実行します
[2025-05-14 10:03:50] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#04","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09"}
[2025-05-14 10:03:50] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-14 10:03:50] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 10:03:50] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 10:03:50] [ERROR] エラーコード: 23000
[2025-05-14 10:03:50] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-05-14 10:03:50] [ERROR] SQLステート: 23000
[2025-05-14 10:03:50] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-14 10:03:50] [ERROR] スタックトレース: #0 {main}
[2025-05-14 10:03:50] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-14 10:03:50] [ERROR] スタックトレース: #0 {main}
[2025-05-14 10:03:50] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-14 10:03:50] [INFO] エラーJSONレスポンスを送信完了
[2025-05-14 10:03:50] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-14 10:03:50] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-14 10:03:50] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-14 10:03:50] [DEBUG] 出力バッファをフラッシュします
[2025-05-14 10:03:50] [INFO] 処理完了
[2025-05-14 10:03:50] [INFO] --- 登録API処理開始 ---
[2025-05-14 10:03:50] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 10:03:50] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhNTI0YTQwNGU3YTk3ZDM1ZGM2NDYzMzc1NjMwNTUyNWVkMmRjNGE1YjQ4YTEzMDczNmY3NGU5YTNhNWQ0YjFkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzE4ODIxMywiaWF0IjoxNzQ3MTg0NjEzLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.b7pufHkx6fqBTpxR5fK3w6bX-QcbkykfpTM1ys49lijSzOSQablgSO9FaSrzABJxtj5r0fmFfiV0UbsrM59-Zg","room_number":"fg#04","user_name":"くらひで","check_in":"2025-05-14","check_out":"2025-05-15","check_out_time":"11:00","force":true}
[2025-05-14 10:03:50] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhNTI0YTQwNGU3YTk3ZDM1ZGM2NDYzMzc1NjMwNTUyNWVkMmRjNGE1YjQ4YTEzMDczNmY3NGU5YTNhNWQ0YjFkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzE4ODIxMywiaWF0IjoxNzQ3MTg0NjEzLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.b7pufHkx6fqBTpxR5fK3w6bX-QcbkykfpTM1ys49lijSzOSQablgSO9FaSrzABJxtj5r0fmFfiV0UbsrM59-Zg
    [room_number] => fg#04
    [user_name] => くらひで
    [check_in] => 2025-05-14
    [check_out] => 2025-05-15
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-14 10:03:50] [INFO] forceフラグ: true
[2025-05-14 10:03:50] [INFO] 処理パラメータ: room=fg#04, user=くらひで, checkIn=2025-05-14, checkOut=2025-05-15
[2025-05-14 10:03:50] [INFO] IDトークンを検証: eyJraWQiOiJhNTI0YTQw...
[2025-05-14 10:03:50] [DEBUG] トークン検証開始: eyJraWQiOiJhNTI0YTQw...
[2025-05-14 10:03:50] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1747188213
    [iat] => 1747184613
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-14 10:03:50] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-14 10:03:50] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 10:03:50] [INFO] データベース接続を開始します
[2025-05-14 10:03:50] [INFO] データベース接続成功
[2025-05-14 10:03:50] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-14 10:03:50] [INFO] line_room_linksテーブルが存在します
[2025-05-14 10:03:50] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-14 10:03:50] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-14 10:03:50] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=54 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-14 10:03:50] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-14 10:03:50] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#10","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-13","check_out_date":"2025-05-09","access_token":null,"is_active":0,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 04:14:53"}
[2025-05-14 10:03:50] [INFO] トランザクション開始
[2025-05-14 10:03:50] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-14 10:03:50] [DEBUG] パラメータバインド: roomNumber=fg#04
[2025-05-14 10:03:50] [INFO] 部屋検索クエリ実行完了
[2025-05-14 10:03:50] [INFO] 部屋検索結果: 部屋あり ID=4, アクティブ=1
[2025-05-14 10:03:50] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-14 10:03:50] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 10:03:50] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-14 10:03:50] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-14 10:03:50] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-14 10:03:50] [INFO] 非アクティブ化した登録数: 0
[2025-05-14 10:03:50] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-14 10:03:50] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-14 10:03:50] [DEBUG] プリペアドステートメント作成成功
[2025-05-14 10:03:50] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-14, checkOut=2025-05-09
[2025-05-14 10:03:50] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#04, userName=くらひで, checkInDate=2025-05-14, checkOutDate=2025-05-09
[2025-05-14 10:03:50] [INFO] SQLを実行します
[2025-05-14 10:03:50] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#04","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09"}
[2025-05-14 10:03:50] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-14 10:03:50] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 10:03:50] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 10:03:50] [ERROR] エラーコード: 23000
[2025-05-14 10:03:50] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-05-14 10:03:50] [ERROR] SQLステート: 23000
[2025-05-14 10:03:50] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-14 10:03:50] [INFO] 重複したユーザーIDの既存レコードを発見: ID=35
[2025-05-14 10:03:50] [INFO] 重複ユーザーの登録情報を更新しました: ID=35
[2025-05-14 10:03:50] [INFO] トランザクションコミット成功
[2025-05-14 10:03:50] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":35,"registration_type":"updated"}
[2025-05-14 10:03:50] [INFO] JSONレスポンスを送信完了
[2025-05-14 10:03:50] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":35,"registration_type":"updated"}
2025-05-14 10:03:50 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#04 - 期間: 2025-05-14 から 2025-05-09
[2025-05-14 10:03:50] [DEBUG] 出力バッファに170バイトのデータがあります
[2025-05-14 10:03:50] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":35,"registration_type":"updated"}
[2025-05-14 10:03:50] [DEBUG] 出力バッファをフラッシュします
[2025-05-14 10:03:50] [INFO] 処理完了
[2025-05-14 13:10:55] [INFO] --- 登録API処理開始 ---
[2025-05-14 13:10:55] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 13:10:55] [INFO] --- 登録API処理開始 ---
[2025-05-14 13:10:55] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 13:10:55] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzE5OTE1NSwiaWF0IjoxNzQ3MTk1NTU1LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.SHuRLrm3xakSPuHbeF-TvJKaDym_nDA67fx8cBqVFCTCFIn27TidzJshMM5lh0HCf7DEJakSJfT0O1uuj9Opyw","room_number":"fg#05","user_name":"くらひで","check_in":"2025-05-14","check_out":"2025-05-15","check_out_time":"11:00"}
[2025-05-14 13:10:55] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzE5OTE1NSwiaWF0IjoxNzQ3MTk1NTU1LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.SHuRLrm3xakSPuHbeF-TvJKaDym_nDA67fx8cBqVFCTCFIn27TidzJshMM5lh0HCf7DEJakSJfT0O1uuj9Opyw
    [room_number] => fg#05
    [user_name] => くらひで
    [check_in] => 2025-05-14
    [check_out] => 2025-05-15
    [check_out_time] => 11:00
)

[2025-05-14 13:10:55] [INFO] forceフラグ: false
[2025-05-14 13:10:55] [INFO] 処理パラメータ: room=fg#05, user=くらひで, checkIn=2025-05-14, checkOut=2025-05-15
[2025-05-14 13:10:55] [INFO] IDトークンを検証: eyJraWQiOiJhMmE0NTlh...
[2025-05-14 13:10:55] [DEBUG] トークン検証開始: eyJraWQiOiJhMmE0NTlh...
[2025-05-14 13:10:55] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1747199155
    [iat] => 1747195555
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-14 13:10:55] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-14 13:10:55] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 13:10:55] [INFO] データベース接続を開始します
[2025-05-14 13:10:55] [INFO] データベース接続成功
[2025-05-14 13:10:55] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-14 13:10:55] [INFO] line_room_linksテーブルが存在します
[2025-05-14 13:10:55] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-14 13:10:55] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-14 13:10:55] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=56 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-14 13:10:55] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-14 13:10:55] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#04","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":0,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 11:21:53"}
[2025-05-14 13:10:55] [INFO] トランザクション開始
[2025-05-14 13:10:55] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-14 13:10:55] [DEBUG] パラメータバインド: roomNumber=fg#05
[2025-05-14 13:10:55] [INFO] 部屋検索クエリ実行完了
[2025-05-14 13:10:55] [INFO] 部屋検索結果: 部屋あり ID=5, アクティブ=1
[2025-05-14 13:10:55] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-14 13:10:55] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 13:10:55] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-14 13:10:55] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-14 13:10:55] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-14 13:10:55] [INFO] 非アクティブ化した登録数: 0
[2025-05-14 13:10:55] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-14 13:10:55] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-14 13:10:55] [DEBUG] プリペアドステートメント作成成功
[2025-05-14 13:10:55] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-14, checkOut=2025-05-09
[2025-05-14 13:10:55] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#05, userName=くらひで, checkInDate=2025-05-14, checkOutDate=2025-05-09
[2025-05-14 13:10:55] [INFO] SQLを実行します
[2025-05-14 13:10:55] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#05","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09"}
[2025-05-14 13:10:55] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-14 13:10:55] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 13:10:55] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 13:10:55] [ERROR] エラーコード: 23000
[2025-05-14 13:10:55] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-05-14 13:10:55] [ERROR] SQLステート: 23000
[2025-05-14 13:10:55] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-14 13:10:55] [ERROR] スタックトレース: #0 {main}
[2025-05-14 13:10:55] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-14 13:10:55] [ERROR] スタックトレース: #0 {main}
[2025-05-14 13:10:55] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-14 13:10:55] [INFO] エラーJSONレスポンスを送信完了
[2025-05-14 13:10:55] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-14 13:10:55] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-14 13:10:55] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-14 13:10:55] [DEBUG] 出力バッファをフラッシュします
[2025-05-14 13:10:55] [INFO] 処理完了
[2025-05-14 13:10:55] [INFO] --- 登録API処理開始 ---
[2025-05-14 13:10:55] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 13:10:55] [INFO] --- 登録API処理開始 ---
[2025-05-14 13:10:55] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 13:10:55] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzE5OTE1NSwiaWF0IjoxNzQ3MTk1NTU1LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.SHuRLrm3xakSPuHbeF-TvJKaDym_nDA67fx8cBqVFCTCFIn27TidzJshMM5lh0HCf7DEJakSJfT0O1uuj9Opyw","room_number":"fg#05","user_name":"くらひで","check_in":"2025-05-14","check_out":"2025-05-15","check_out_time":"11:00","force":true}
[2025-05-14 13:10:55] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzE5OTE1NSwiaWF0IjoxNzQ3MTk1NTU1LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.SHuRLrm3xakSPuHbeF-TvJKaDym_nDA67fx8cBqVFCTCFIn27TidzJshMM5lh0HCf7DEJakSJfT0O1uuj9Opyw
    [room_number] => fg#05
    [user_name] => くらひで
    [check_in] => 2025-05-14
    [check_out] => 2025-05-15
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-14 13:10:55] [INFO] forceフラグ: true
[2025-05-14 13:10:55] [INFO] 処理パラメータ: room=fg#05, user=くらひで, checkIn=2025-05-14, checkOut=2025-05-15
[2025-05-14 13:10:55] [INFO] IDトークンを検証: eyJraWQiOiJhMmE0NTlh...
[2025-05-14 13:10:55] [DEBUG] トークン検証開始: eyJraWQiOiJhMmE0NTlh...
[2025-05-14 13:10:55] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1747199155
    [iat] => 1747195555
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-14 13:10:55] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-14 13:10:55] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 13:10:55] [INFO] データベース接続を開始します
[2025-05-14 13:10:55] [INFO] データベース接続成功
[2025-05-14 13:10:55] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-14 13:10:55] [INFO] line_room_linksテーブルが存在します
[2025-05-14 13:10:55] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-14 13:10:55] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-14 13:10:55] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=58 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-14 13:10:55] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-14 13:10:55] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#04","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":0,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 11:21:53"}
[2025-05-14 13:10:55] [INFO] トランザクション開始
[2025-05-14 13:10:55] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-14 13:10:55] [DEBUG] パラメータバインド: roomNumber=fg#05
[2025-05-14 13:10:55] [INFO] 部屋検索クエリ実行完了
[2025-05-14 13:10:55] [INFO] 部屋検索結果: 部屋あり ID=5, アクティブ=1
[2025-05-14 13:10:55] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-14 13:10:55] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 13:10:55] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-14 13:10:55] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-14 13:10:55] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-14 13:10:55] [INFO] 非アクティブ化した登録数: 0
[2025-05-14 13:10:55] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-14 13:10:55] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-14 13:10:55] [DEBUG] プリペアドステートメント作成成功
[2025-05-14 13:10:55] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-14, checkOut=2025-05-09
[2025-05-14 13:10:55] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#05, userName=くらひで, checkInDate=2025-05-14, checkOutDate=2025-05-09
[2025-05-14 13:10:55] [INFO] SQLを実行します
[2025-05-14 13:10:55] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#05","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09"}
[2025-05-14 13:10:55] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-14 13:10:55] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 13:10:55] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 13:10:55] [ERROR] エラーコード: 23000
[2025-05-14 13:10:55] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-05-14 13:10:55] [ERROR] SQLステート: 23000
[2025-05-14 13:10:55] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-14 13:10:55] [INFO] 重複したユーザーIDの既存レコードを発見: ID=35
[2025-05-14 13:10:55] [INFO] 重複ユーザーの登録情報を更新しました: ID=35
[2025-05-14 13:10:55] [INFO] トランザクションコミット成功
[2025-05-14 13:10:55] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":35,"registration_type":"updated"}
[2025-05-14 13:10:55] [INFO] JSONレスポンスを送信完了
[2025-05-14 13:10:55] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":35,"registration_type":"updated"}
2025-05-14 13:10:55 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#05 - 期間: 2025-05-14 から 2025-05-09
[2025-05-14 13:10:55] [DEBUG] 出力バッファに170バイトのデータがあります
[2025-05-14 13:10:55] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":35,"registration_type":"updated"}
[2025-05-14 13:10:55] [DEBUG] 出力バッファをフラッシュします
[2025-05-14 13:10:55] [INFO] 処理完了
[2025-05-14 15:07:03] [INFO] --- 登録API処理開始 ---
[2025-05-14 15:07:03] [INFO] リクエスト元IPアドレス: 222.224.253.151
[2025-05-14 15:07:03] [INFO] --- 登録API処理開始 ---
[2025-05-14 15:07:03] [INFO] リクエスト元IPアドレス: 222.224.253.151
[2025-05-14 15:07:03] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhNzk2OGMyZWExNWYwZjQxNjM1ZGU1ZTA4ODI5MDQ5MWIwMjMxYTU2YTQ5Y2M4YTZjZDZlZDQ0MTcyN2EyNTJmIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTY1N2IyNDBmYzY1NDM2ZDk4NmM0ZDJkYmY5YmI5ZmExIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIwNjM0NywiaWF0IjoxNzQ3MjAyNzQ3LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44Gy44KN44GNIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoMzZwQi1zTUdiQmxOTzNrckYtd1RUbkYtWW5RNkZXcFJOVjF6ZldBOE1TMWhDQzFJY3c0bGVqOW9NaXBsRGlJYUl3cDJlenBwTkNvMCJ9.kndach-UBHa75_5uZzT-rGy93eja3pk9OTazJVqcGMO5IfybO2ltvKB20r8neJgXv9-DdHpaoK3zHNaW3lOOMA","room_number":"fg#01","user_name":"ひろき","check_in":"2025-05-14","check_out":"2025-05-15","check_out_time":"11:00"}
[2025-05-14 15:07:03] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhNzk2OGMyZWExNWYwZjQxNjM1ZGU1ZTA4ODI5MDQ5MWIwMjMxYTU2YTQ5Y2M4YTZjZDZlZDQ0MTcyN2EyNTJmIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTY1N2IyNDBmYzY1NDM2ZDk4NmM0ZDJkYmY5YmI5ZmExIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIwNjM0NywiaWF0IjoxNzQ3MjAyNzQ3LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44Gy44KN44GNIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoMzZwQi1zTUdiQmxOTzNrckYtd1RUbkYtWW5RNkZXcFJOVjF6ZldBOE1TMWhDQzFJY3c0bGVqOW9NaXBsRGlJYUl3cDJlenBwTkNvMCJ9.kndach-UBHa75_5uZzT-rGy93eja3pk9OTazJVqcGMO5IfybO2ltvKB20r8neJgXv9-DdHpaoK3zHNaW3lOOMA
    [room_number] => fg#01
    [user_name] => ひろき
    [check_in] => 2025-05-14
    [check_out] => 2025-05-15
    [check_out_time] => 11:00
)

[2025-05-14 15:07:03] [INFO] forceフラグ: false
[2025-05-14 15:07:03] [INFO] 処理パラメータ: room=fg#01, user=ひろき, checkIn=2025-05-14, checkOut=2025-05-15
[2025-05-14 15:07:03] [INFO] IDトークンを検証: eyJraWQiOiJhNzk2OGMy...
[2025-05-14 15:07:03] [DEBUG] トークン検証開始: eyJraWQiOiJhNzk2OGMy...
[2025-05-14 15:07:03] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U657b240fc65436d986c4d2dbf9bb9fa1
    [aud] => 2007363986
    [exp] => 1747206347
    [iat] => 1747202747
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => ひろき
    [picture] => https://profile.line-scdn.net/0h36pB-sMGbBlNO3krF-wTTnF-YnQ6FWpRNV1zfWA8MS1hCC1Icw4lej9oMiplDiIaIwp2ezppNCo0
)

[2025-05-14 15:07:03] [INFO] トークン検証成功: ユーザーID U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-14 15:07:03] [INFO] IDトークン検証成功: userId=U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-14 15:07:03] [INFO] データベース接続を開始します
[2025-05-14 15:07:03] [INFO] データベース接続成功
[2025-05-14 15:07:03] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-14 15:07:03] [INFO] line_room_linksテーブルが存在します
[2025-05-14 15:07:03] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-14 15:07:03] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-14 15:07:03] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=60 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-14 15:07:03] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-14 15:07:03] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#05","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 13:10:55"}
[2025-05-14 15:07:03] [INFO] トランザクション開始
[2025-05-14 15:07:03] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-14 15:07:03] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-14 15:07:03] [INFO] 部屋検索クエリ実行完了
[2025-05-14 15:07:03] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-14 15:07:03] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-14 15:07:03] [DEBUG] パラメータバインド: userId=U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-14 15:07:03] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-14 15:07:03] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-14 15:07:03] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-14 15:07:03] [INFO] 非アクティブ化した登録数: 0
[2025-05-14 15:07:03] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-14 15:07:03] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-14 15:07:03] [DEBUG] プリペアドステートメント作成成功
[2025-05-14 15:07:03] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-14, checkOut=2025-05-09
[2025-05-14 15:07:03] [DEBUG] パラメータバインド完了: userId=U657b240fc65436d986c4d2dbf9bb9fa1, roomNumber=fg#01, userName=ひろき, checkInDate=2025-05-14, checkOutDate=2025-05-09
[2025-05-14 15:07:03] [INFO] SQLを実行します
[2025-05-14 15:07:03] [DEBUG] 挿入予定の値: {"line_user_id":"U657b240fc65436d986c4d2dbf9bb9fa1","room_number":"fg#01","user_name":"\u3072\u308d\u304d","check_in_date":"2025-05-14","check_out_date":"2025-05-09"}
[2025-05-14 15:07:03] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-14 15:07:03] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
[2025-05-14 15:07:03] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
[2025-05-14 15:07:03] [ERROR] エラーコード: 23000
[2025-05-14 15:07:03] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
)

[2025-05-14 15:07:03] [ERROR] SQLステート: 23000
[2025-05-14 15:07:03] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-14 15:07:03] [ERROR] スタックトレース: #0 {main}
[2025-05-14 15:07:03] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-14 15:07:03] [ERROR] スタックトレース: #0 {main}
[2025-05-14 15:07:03] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-14 15:07:03] [INFO] エラーJSONレスポンスを送信完了
[2025-05-14 15:07:03] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-14 15:07:03] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-14 15:07:03] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-14 15:07:03] [DEBUG] 出力バッファをフラッシュします
[2025-05-14 15:07:03] [INFO] 処理完了
[2025-05-14 15:07:04] [INFO] --- 登録API処理開始 ---
[2025-05-14 15:07:04] [INFO] リクエスト元IPアドレス: 222.224.253.151
[2025-05-14 15:07:04] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhNzk2OGMyZWExNWYwZjQxNjM1ZGU1ZTA4ODI5MDQ5MWIwMjMxYTU2YTQ5Y2M4YTZjZDZlZDQ0MTcyN2EyNTJmIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTY1N2IyNDBmYzY1NDM2ZDk4NmM0ZDJkYmY5YmI5ZmExIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIwNjM0NywiaWF0IjoxNzQ3MjAyNzQ3LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44Gy44KN44GNIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoMzZwQi1zTUdiQmxOTzNrckYtd1RUbkYtWW5RNkZXcFJOVjF6ZldBOE1TMWhDQzFJY3c0bGVqOW9NaXBsRGlJYUl3cDJlenBwTkNvMCJ9.kndach-UBHa75_5uZzT-rGy93eja3pk9OTazJVqcGMO5IfybO2ltvKB20r8neJgXv9-DdHpaoK3zHNaW3lOOMA","room_number":"fg#01","user_name":"ひろき","check_in":"2025-05-14","check_out":"2025-05-15","check_out_time":"11:00","force":true}
[2025-05-14 15:07:04] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhNzk2OGMyZWExNWYwZjQxNjM1ZGU1ZTA4ODI5MDQ5MWIwMjMxYTU2YTQ5Y2M4YTZjZDZlZDQ0MTcyN2EyNTJmIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTY1N2IyNDBmYzY1NDM2ZDk4NmM0ZDJkYmY5YmI5ZmExIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIwNjM0NywiaWF0IjoxNzQ3MjAyNzQ3LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44Gy44KN44GNIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoMzZwQi1zTUdiQmxOTzNrckYtd1RUbkYtWW5RNkZXcFJOVjF6ZldBOE1TMWhDQzFJY3c0bGVqOW9NaXBsRGlJYUl3cDJlenBwTkNvMCJ9.kndach-UBHa75_5uZzT-rGy93eja3pk9OTazJVqcGMO5IfybO2ltvKB20r8neJgXv9-DdHpaoK3zHNaW3lOOMA
    [room_number] => fg#01
    [user_name] => ひろき
    [check_in] => 2025-05-14
    [check_out] => 2025-05-15
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-14 15:07:04] [INFO] forceフラグ: true
[2025-05-14 15:07:04] [INFO] 処理パラメータ: room=fg#01, user=ひろき, checkIn=2025-05-14, checkOut=2025-05-15
[2025-05-14 15:07:04] [INFO] IDトークンを検証: eyJraWQiOiJhNzk2OGMy...
[2025-05-14 15:07:04] [DEBUG] トークン検証開始: eyJraWQiOiJhNzk2OGMy...
[2025-05-14 15:07:04] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U657b240fc65436d986c4d2dbf9bb9fa1
    [aud] => 2007363986
    [exp] => 1747206347
    [iat] => 1747202747
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => ひろき
    [picture] => https://profile.line-scdn.net/0h36pB-sMGbBlNO3krF-wTTnF-YnQ6FWpRNV1zfWA8MS1hCC1Icw4lej9oMiplDiIaIwp2ezppNCo0
)

[2025-05-14 15:07:04] [INFO] トークン検証成功: ユーザーID U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-14 15:07:04] [INFO] IDトークン検証成功: userId=U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-14 15:07:04] [INFO] データベース接続を開始します
[2025-05-14 15:07:04] [INFO] データベース接続成功
[2025-05-14 15:07:04] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-14 15:07:04] [INFO] line_room_linksテーブルが存在します
[2025-05-14 15:07:04] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-14 15:07:04] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-14 15:07:04] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=62 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-14 15:07:04] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-14 15:07:04] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#05","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 13:10:55"}
[2025-05-14 15:07:04] [INFO] トランザクション開始
[2025-05-14 15:07:04] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-14 15:07:04] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-14 15:07:04] [INFO] 部屋検索クエリ実行完了
[2025-05-14 15:07:04] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-14 15:07:04] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-14 15:07:04] [DEBUG] パラメータバインド: userId=U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-14 15:07:04] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-14 15:07:04] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-14 15:07:04] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-14 15:07:04] [INFO] 非アクティブ化した登録数: 0
[2025-05-14 15:07:04] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-14 15:07:04] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-14 15:07:04] [DEBUG] プリペアドステートメント作成成功
[2025-05-14 15:07:04] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-14, checkOut=2025-05-09
[2025-05-14 15:07:04] [DEBUG] パラメータバインド完了: userId=U657b240fc65436d986c4d2dbf9bb9fa1, roomNumber=fg#01, userName=ひろき, checkInDate=2025-05-14, checkOutDate=2025-05-09
[2025-05-14 15:07:04] [INFO] SQLを実行します
[2025-05-14 15:07:04] [DEBUG] 挿入予定の値: {"line_user_id":"U657b240fc65436d986c4d2dbf9bb9fa1","room_number":"fg#01","user_name":"\u3072\u308d\u304d","check_in_date":"2025-05-14","check_out_date":"2025-05-09"}
[2025-05-14 15:07:04] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-14 15:07:04] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
[2025-05-14 15:07:04] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
[2025-05-14 15:07:04] [ERROR] エラーコード: 23000
[2025-05-14 15:07:04] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
)

[2025-05-14 15:07:04] [ERROR] SQLステート: 23000
[2025-05-14 15:07:04] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-14 15:07:04] [INFO] 重複したユーザーIDの既存レコードを発見: ID=30
[2025-05-14 15:07:04] [INFO] 重複ユーザーの登録情報を更新しました: ID=30
[2025-05-14 15:07:04] [INFO] トランザクションコミット成功
[2025-05-14 15:07:04] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":30,"registration_type":"updated"}
[2025-05-14 15:07:04] [INFO] JSONレスポンスを送信完了
[2025-05-14 15:07:04] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":30,"registration_type":"updated"}
2025-05-14 15:07:04 - ユーザーID: U657b240fc65436d986c4d2dbf9bb9fa1 - 部屋番号更新 - 部屋: fg#01 - 期間: 2025-05-14 から 2025-05-09
[2025-05-14 15:07:04] [DEBUG] 出力バッファに170バイトのデータがあります
[2025-05-14 15:07:04] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":30,"registration_type":"updated"}
[2025-05-14 15:07:04] [DEBUG] 出力バッファをフラッシュします
[2025-05-14 15:07:04] [INFO] 処理完了
[2025-05-14 15:14:25] [INFO] --- 登録API処理開始 ---
[2025-05-14 15:14:25] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 15:14:25] [INFO] --- 登録API処理開始 ---
[2025-05-14 15:14:25] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 15:14:25] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIwNjgyOCwiaWF0IjoxNzQ3MjAzMjI4LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.gm5i3bltZLC9SRp2eWwhmweTYcYYifbC7MCZcuBqlrMVTvwg6DrxNVsxw5m6HfpHmOLCtoANezOdRWiCCG_EVQ","room_number":"fg#13","user_name":"くらひで","check_in":"2025-05-14","check_out":"2025-05-15","check_out_time":"11:00"}
[2025-05-14 15:14:25] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIwNjgyOCwiaWF0IjoxNzQ3MjAzMjI4LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.gm5i3bltZLC9SRp2eWwhmweTYcYYifbC7MCZcuBqlrMVTvwg6DrxNVsxw5m6HfpHmOLCtoANezOdRWiCCG_EVQ
    [room_number] => fg#13
    [user_name] => くらひで
    [check_in] => 2025-05-14
    [check_out] => 2025-05-15
    [check_out_time] => 11:00
)

[2025-05-14 15:14:25] [INFO] forceフラグ: false
[2025-05-14 15:14:25] [INFO] 処理パラメータ: room=fg#13, user=くらひで, checkIn=2025-05-14, checkOut=2025-05-15
[2025-05-14 15:14:25] [INFO] IDトークンを検証: eyJraWQiOiJhMmE0NTlh...
[2025-05-14 15:14:25] [DEBUG] トークン検証開始: eyJraWQiOiJhMmE0NTlh...
[2025-05-14 15:14:25] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1747206828
    [iat] => 1747203228
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-14 15:14:25] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-14 15:14:25] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 15:14:25] [INFO] データベース接続を開始します
[2025-05-14 15:14:25] [INFO] データベース接続成功
[2025-05-14 15:14:25] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-14 15:14:25] [INFO] line_room_linksテーブルが存在します
[2025-05-14 15:14:25] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-14 15:14:25] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-14 15:14:25] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=64 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-14 15:14:25] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-14 15:14:25] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#05","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":0,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 15:13:31"}
[2025-05-14 15:14:25] [INFO] トランザクション開始
[2025-05-14 15:14:25] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-14 15:14:25] [DEBUG] パラメータバインド: roomNumber=fg#13
[2025-05-14 15:14:25] [INFO] 部屋検索クエリ実行完了
[2025-05-14 15:14:25] [INFO] 部屋検索結果: 部屋あり ID=13, アクティブ=1
[2025-05-14 15:14:25] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-14 15:14:25] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 15:14:25] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-14 15:14:25] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-14 15:14:25] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-14 15:14:25] [INFO] 非アクティブ化した登録数: 0
[2025-05-14 15:14:25] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-14 15:14:25] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-14 15:14:25] [DEBUG] プリペアドステートメント作成成功
[2025-05-14 15:14:25] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-14, checkOut=2025-05-09
[2025-05-14 15:14:25] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#13, userName=くらひで, checkInDate=2025-05-14, checkOutDate=2025-05-09
[2025-05-14 15:14:25] [INFO] SQLを実行します
[2025-05-14 15:14:25] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#13","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09"}
[2025-05-14 15:14:25] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-14 15:14:25] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 15:14:25] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 15:14:25] [ERROR] エラーコード: 23000
[2025-05-14 15:14:25] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-05-14 15:14:25] [ERROR] SQLステート: 23000
[2025-05-14 15:14:25] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-14 15:14:25] [ERROR] スタックトレース: #0 {main}
[2025-05-14 15:14:25] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-14 15:14:25] [ERROR] スタックトレース: #0 {main}
[2025-05-14 15:14:25] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-14 15:14:25] [INFO] エラーJSONレスポンスを送信完了
[2025-05-14 15:14:25] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-14 15:14:25] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-14 15:14:25] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-14 15:14:25] [DEBUG] 出力バッファをフラッシュします
[2025-05-14 15:14:25] [INFO] 処理完了
[2025-05-14 15:14:25] [INFO] --- 登録API処理開始 ---
[2025-05-14 15:14:25] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 15:14:25] [INFO] --- 登録API処理開始 ---
[2025-05-14 15:14:25] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 15:14:25] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIwNjgyOCwiaWF0IjoxNzQ3MjAzMjI4LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.gm5i3bltZLC9SRp2eWwhmweTYcYYifbC7MCZcuBqlrMVTvwg6DrxNVsxw5m6HfpHmOLCtoANezOdRWiCCG_EVQ","room_number":"fg#13","user_name":"くらひで","check_in":"2025-05-14","check_out":"2025-05-15","check_out_time":"11:00","force":true}
[2025-05-14 15:14:25] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIwNjgyOCwiaWF0IjoxNzQ3MjAzMjI4LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.gm5i3bltZLC9SRp2eWwhmweTYcYYifbC7MCZcuBqlrMVTvwg6DrxNVsxw5m6HfpHmOLCtoANezOdRWiCCG_EVQ
    [room_number] => fg#13
    [user_name] => くらひで
    [check_in] => 2025-05-14
    [check_out] => 2025-05-15
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-14 15:14:25] [INFO] forceフラグ: true
[2025-05-14 15:14:25] [INFO] 処理パラメータ: room=fg#13, user=くらひで, checkIn=2025-05-14, checkOut=2025-05-15
[2025-05-14 15:14:25] [INFO] IDトークンを検証: eyJraWQiOiJhMmE0NTlh...
[2025-05-14 15:14:25] [DEBUG] トークン検証開始: eyJraWQiOiJhMmE0NTlh...
[2025-05-14 15:14:25] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1747206828
    [iat] => 1747203228
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-14 15:14:25] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-14 15:14:25] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 15:14:25] [INFO] データベース接続を開始します
[2025-05-14 15:14:25] [INFO] データベース接続成功
[2025-05-14 15:14:25] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-14 15:14:25] [INFO] line_room_linksテーブルが存在します
[2025-05-14 15:14:25] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-14 15:14:25] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-14 15:14:25] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=66 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-14 15:14:25] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-14 15:14:25] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#05","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":0,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 15:13:31"}
[2025-05-14 15:14:25] [INFO] トランザクション開始
[2025-05-14 15:14:25] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-14 15:14:25] [DEBUG] パラメータバインド: roomNumber=fg#13
[2025-05-14 15:14:25] [INFO] 部屋検索クエリ実行完了
[2025-05-14 15:14:25] [INFO] 部屋検索結果: 部屋あり ID=13, アクティブ=1
[2025-05-14 15:14:25] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-14 15:14:25] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 15:14:25] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-14 15:14:25] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-14 15:14:25] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-14 15:14:25] [INFO] 非アクティブ化した登録数: 0
[2025-05-14 15:14:25] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-14 15:14:25] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-14 15:14:25] [DEBUG] プリペアドステートメント作成成功
[2025-05-14 15:14:25] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-14, checkOut=2025-05-09
[2025-05-14 15:14:25] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#13, userName=くらひで, checkInDate=2025-05-14, checkOutDate=2025-05-09
[2025-05-14 15:14:25] [INFO] SQLを実行します
[2025-05-14 15:14:25] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#13","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09"}
[2025-05-14 15:14:25] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-14 15:14:25] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 15:14:25] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 15:14:25] [ERROR] エラーコード: 23000
[2025-05-14 15:14:25] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-05-14 15:14:25] [ERROR] SQLステート: 23000
[2025-05-14 15:14:25] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-14 15:14:25] [INFO] 重複したユーザーIDの既存レコードを発見: ID=35
[2025-05-14 15:14:25] [INFO] 重複ユーザーの登録情報を更新しました: ID=35
[2025-05-14 15:14:25] [INFO] トランザクションコミット成功
[2025-05-14 15:14:25] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":35,"registration_type":"updated"}
[2025-05-14 15:14:25] [INFO] JSONレスポンスを送信完了
[2025-05-14 15:14:25] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":35,"registration_type":"updated"}
2025-05-14 15:14:25 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#13 - 期間: 2025-05-14 から 2025-05-09
[2025-05-14 15:14:25] [DEBUG] 出力バッファに170バイトのデータがあります
[2025-05-14 15:14:25] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":35,"registration_type":"updated"}
[2025-05-14 15:14:25] [DEBUG] 出力バッファをフラッシュします
[2025-05-14 15:14:25] [INFO] 処理完了
[2025-05-14 15:57:14] [INFO] --- 登録API処理開始 ---
[2025-05-14 15:57:14] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 15:57:14] [INFO] --- 登録API処理開始 ---
[2025-05-14 15:57:14] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 15:57:14] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIwNjgyOCwiaWF0IjoxNzQ3MjAzMjI4LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.gm5i3bltZLC9SRp2eWwhmweTYcYYifbC7MCZcuBqlrMVTvwg6DrxNVsxw5m6HfpHmOLCtoANezOdRWiCCG_EVQ","room_number":"fg#05","user_name":"くらひで","check_in":"2025-05-14","check_out":"2025-05-15","check_out_time":"11:00"}
[2025-05-14 15:57:14] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIwNjgyOCwiaWF0IjoxNzQ3MjAzMjI4LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.gm5i3bltZLC9SRp2eWwhmweTYcYYifbC7MCZcuBqlrMVTvwg6DrxNVsxw5m6HfpHmOLCtoANezOdRWiCCG_EVQ
    [room_number] => fg#05
    [user_name] => くらひで
    [check_in] => 2025-05-14
    [check_out] => 2025-05-15
    [check_out_time] => 11:00
)

[2025-05-14 15:57:14] [INFO] forceフラグ: false
[2025-05-14 15:57:14] [INFO] 処理パラメータ: room=fg#05, user=くらひで, checkIn=2025-05-14, checkOut=2025-05-15
[2025-05-14 15:57:14] [INFO] IDトークンを検証: eyJraWQiOiJhMmE0NTlh...
[2025-05-14 15:57:14] [DEBUG] トークン検証開始: eyJraWQiOiJhMmE0NTlh...
[2025-05-14 15:57:14] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1747206828
    [iat] => 1747203228
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-14 15:57:14] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-14 15:57:14] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 15:57:14] [INFO] データベース接続を開始します
[2025-05-14 15:57:14] [INFO] データベース接続成功
[2025-05-14 15:57:14] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-14 15:57:14] [INFO] line_room_linksテーブルが存在します
[2025-05-14 15:57:14] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-14 15:57:14] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-14 15:57:14] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=68 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-14 15:57:14] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-14 15:57:14] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#13","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 15:14:25"}
[2025-05-14 15:57:14] [INFO] トランザクション開始
[2025-05-14 15:57:14] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-14 15:57:14] [DEBUG] パラメータバインド: roomNumber=fg#05
[2025-05-14 15:57:14] [INFO] 部屋検索クエリ実行完了
[2025-05-14 15:57:14] [INFO] 部屋検索結果: 部屋あり ID=5, アクティブ=1
[2025-05-14 15:57:14] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-14 15:57:14] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 15:57:14] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-14 15:57:14] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-14 15:57:14] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-14 15:57:14] [INFO] 非アクティブ化した登録数: 1
[2025-05-14 15:57:14] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-14 15:57:14] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-14 15:57:14] [DEBUG] プリペアドステートメント作成成功
[2025-05-14 15:57:14] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-14, checkOut=2025-05-09
[2025-05-14 15:57:14] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#05, userName=くらひで, checkInDate=2025-05-14, checkOutDate=2025-05-09
[2025-05-14 15:57:14] [INFO] SQLを実行します
[2025-05-14 15:57:14] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#05","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09"}
[2025-05-14 15:57:14] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-14 15:57:14] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 15:57:14] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 15:57:14] [ERROR] エラーコード: 23000
[2025-05-14 15:57:14] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-05-14 15:57:14] [ERROR] SQLステート: 23000
[2025-05-14 15:57:14] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-14 15:57:14] [ERROR] スタックトレース: #0 {main}
[2025-05-14 15:57:14] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-14 15:57:14] [ERROR] スタックトレース: #0 {main}
[2025-05-14 15:57:14] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-14 15:57:14] [INFO] エラーJSONレスポンスを送信完了
[2025-05-14 15:57:14] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-14 15:57:14] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-14 15:57:14] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-14 15:57:14] [DEBUG] 出力バッファをフラッシュします
[2025-05-14 15:57:14] [INFO] 処理完了
[2025-05-14 15:57:14] [INFO] --- 登録API処理開始 ---
[2025-05-14 15:57:14] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 15:57:14] [INFO] --- 登録API処理開始 ---
[2025-05-14 15:57:14] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 15:57:14] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIwNjgyOCwiaWF0IjoxNzQ3MjAzMjI4LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.gm5i3bltZLC9SRp2eWwhmweTYcYYifbC7MCZcuBqlrMVTvwg6DrxNVsxw5m6HfpHmOLCtoANezOdRWiCCG_EVQ","room_number":"fg#05","user_name":"くらひで","check_in":"2025-05-14","check_out":"2025-05-15","check_out_time":"11:00","force":true}
[2025-05-14 15:57:14] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIwNjgyOCwiaWF0IjoxNzQ3MjAzMjI4LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.gm5i3bltZLC9SRp2eWwhmweTYcYYifbC7MCZcuBqlrMVTvwg6DrxNVsxw5m6HfpHmOLCtoANezOdRWiCCG_EVQ
    [room_number] => fg#05
    [user_name] => くらひで
    [check_in] => 2025-05-14
    [check_out] => 2025-05-15
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-14 15:57:14] [INFO] forceフラグ: true
[2025-05-14 15:57:14] [INFO] 処理パラメータ: room=fg#05, user=くらひで, checkIn=2025-05-14, checkOut=2025-05-15
[2025-05-14 15:57:14] [INFO] IDトークンを検証: eyJraWQiOiJhMmE0NTlh...
[2025-05-14 15:57:14] [DEBUG] トークン検証開始: eyJraWQiOiJhMmE0NTlh...
[2025-05-14 15:57:14] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1747206828
    [iat] => 1747203228
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-14 15:57:14] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-14 15:57:14] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 15:57:14] [INFO] データベース接続を開始します
[2025-05-14 15:57:14] [INFO] データベース接続成功
[2025-05-14 15:57:14] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-14 15:57:14] [INFO] line_room_linksテーブルが存在します
[2025-05-14 15:57:14] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-14 15:57:14] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-14 15:57:14] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=70 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-14 15:57:14] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-14 15:57:14] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#13","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 15:14:25"}
[2025-05-14 15:57:14] [INFO] トランザクション開始
[2025-05-14 15:57:14] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-14 15:57:14] [DEBUG] パラメータバインド: roomNumber=fg#05
[2025-05-14 15:57:14] [INFO] 部屋検索クエリ実行完了
[2025-05-14 15:57:14] [INFO] 部屋検索結果: 部屋あり ID=5, アクティブ=1
[2025-05-14 15:57:14] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-14 15:57:14] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 15:57:14] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-14 15:57:14] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-14 15:57:14] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-14 15:57:14] [INFO] 非アクティブ化した登録数: 1
[2025-05-14 15:57:14] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-14 15:57:14] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-14 15:57:14] [DEBUG] プリペアドステートメント作成成功
[2025-05-14 15:57:14] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-14, checkOut=2025-05-09
[2025-05-14 15:57:14] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#05, userName=くらひで, checkInDate=2025-05-14, checkOutDate=2025-05-09
[2025-05-14 15:57:14] [INFO] SQLを実行します
[2025-05-14 15:57:14] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#05","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09"}
[2025-05-14 15:57:14] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-14 15:57:14] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 15:57:14] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 15:57:14] [ERROR] エラーコード: 23000
[2025-05-14 15:57:14] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-05-14 15:57:14] [ERROR] SQLステート: 23000
[2025-05-14 15:57:14] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-14 15:57:14] [INFO] 重複したユーザーIDの既存レコードを発見: ID=35
[2025-05-14 15:57:14] [INFO] 重複ユーザーの登録情報を更新しました: ID=35
[2025-05-14 15:57:14] [INFO] トランザクションコミット成功
[2025-05-14 15:57:14] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":35,"registration_type":"updated"}
[2025-05-14 15:57:14] [INFO] JSONレスポンスを送信完了
[2025-05-14 15:57:14] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":35,"registration_type":"updated"}
2025-05-14 15:57:14 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#05 - 期間: 2025-05-14 から 2025-05-09
[2025-05-14 15:57:14] [DEBUG] 出力バッファに170バイトのデータがあります
[2025-05-14 15:57:14] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":35,"registration_type":"updated"}
[2025-05-14 15:57:14] [DEBUG] 出力バッファをフラッシュします
[2025-05-14 15:57:14] [INFO] 処理完了
[2025-05-14 16:29:21] [INFO] --- 登録API処理開始 ---
[2025-05-14 16:29:21] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 16:29:21] [INFO] --- 登録API処理開始 ---
[2025-05-14 16:29:21] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 16:29:21] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJlNmE2OTE5Mzg2MTY5YmE1NGRlOWRkMzM2YjQxNDc5YTAxMDEyZGMwYzQyOGJhYWUyZGUxOGU1OWVlMjE0NmRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIxMTMwOSwiaWF0IjoxNzQ3MjA3NzA5LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.SvO6_wCykbCzxlZtULn1U_J4wLGIFuQAvDQQO_ttCQ353Kv4ecPFwTXyCh1rfRbCFAtw8-gSKtTDuPvfdRL03w","room_number":"fg#01","user_name":"くらひで","check_in":"2025-05-14","check_out":"2025-05-15","check_out_time":"11:00"}
[2025-05-14 16:29:21] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJlNmE2OTE5Mzg2MTY5YmE1NGRlOWRkMzM2YjQxNDc5YTAxMDEyZGMwYzQyOGJhYWUyZGUxOGU1OWVlMjE0NmRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIxMTMwOSwiaWF0IjoxNzQ3MjA3NzA5LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.SvO6_wCykbCzxlZtULn1U_J4wLGIFuQAvDQQO_ttCQ353Kv4ecPFwTXyCh1rfRbCFAtw8-gSKtTDuPvfdRL03w
    [room_number] => fg#01
    [user_name] => くらひで
    [check_in] => 2025-05-14
    [check_out] => 2025-05-15
    [check_out_time] => 11:00
)

[2025-05-14 16:29:21] [INFO] forceフラグ: false
[2025-05-14 16:29:21] [INFO] 処理パラメータ: room=fg#01, user=くらひで, checkIn=2025-05-14, checkOut=2025-05-15
[2025-05-14 16:29:21] [INFO] IDトークンを検証: eyJraWQiOiJlNmE2OTE5...
[2025-05-14 16:29:21] [DEBUG] トークン検証開始: eyJraWQiOiJlNmE2OTE5...
[2025-05-14 16:29:21] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1747211309
    [iat] => 1747207709
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-14 16:29:21] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-14 16:29:21] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 16:29:21] [INFO] データベース接続を開始します
[2025-05-14 16:29:21] [INFO] データベース接続成功
[2025-05-14 16:29:21] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-14 16:29:21] [INFO] line_room_linksテーブルが存在します
[2025-05-14 16:29:21] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-14 16:29:21] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-14 16:29:21] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=72 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-14 16:29:21] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-14 16:29:21] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#05","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":0,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 16:28:13"}
[2025-05-14 16:29:21] [INFO] トランザクション開始
[2025-05-14 16:29:21] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-14 16:29:21] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-14 16:29:21] [INFO] 部屋検索クエリ実行完了
[2025-05-14 16:29:21] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-14 16:29:21] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-14 16:29:21] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 16:29:21] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-14 16:29:21] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-14 16:29:21] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-14 16:29:21] [INFO] 非アクティブ化した登録数: 0
[2025-05-14 16:29:21] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-14 16:29:21] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-14 16:29:21] [DEBUG] プリペアドステートメント作成成功
[2025-05-14 16:29:21] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-14, checkOut=2025-05-09
[2025-05-14 16:29:21] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#01, userName=くらひで, checkInDate=2025-05-14, checkOutDate=2025-05-09
[2025-05-14 16:29:21] [INFO] SQLを実行します
[2025-05-14 16:29:21] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09"}
[2025-05-14 16:29:21] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-14 16:29:21] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 16:29:21] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 16:29:21] [ERROR] エラーコード: 23000
[2025-05-14 16:29:21] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-05-14 16:29:21] [ERROR] SQLステート: 23000
[2025-05-14 16:29:21] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-14 16:29:21] [ERROR] スタックトレース: #0 {main}
[2025-05-14 16:29:21] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-14 16:29:21] [ERROR] スタックトレース: #0 {main}
[2025-05-14 16:29:21] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-14 16:29:21] [INFO] エラーJSONレスポンスを送信完了
[2025-05-14 16:29:21] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-14 16:29:21] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-14 16:29:21] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-14 16:29:21] [DEBUG] 出力バッファをフラッシュします
[2025-05-14 16:29:21] [INFO] 処理完了
[2025-05-14 16:29:21] [INFO] --- 登録API処理開始 ---
[2025-05-14 16:29:21] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 16:29:21] [INFO] --- 登録API処理開始 ---
[2025-05-14 16:29:21] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 16:29:21] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJlNmE2OTE5Mzg2MTY5YmE1NGRlOWRkMzM2YjQxNDc5YTAxMDEyZGMwYzQyOGJhYWUyZGUxOGU1OWVlMjE0NmRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIxMTMwOSwiaWF0IjoxNzQ3MjA3NzA5LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.SvO6_wCykbCzxlZtULn1U_J4wLGIFuQAvDQQO_ttCQ353Kv4ecPFwTXyCh1rfRbCFAtw8-gSKtTDuPvfdRL03w","room_number":"fg#01","user_name":"くらひで","check_in":"2025-05-14","check_out":"2025-05-15","check_out_time":"11:00","force":true}
[2025-05-14 16:29:21] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJlNmE2OTE5Mzg2MTY5YmE1NGRlOWRkMzM2YjQxNDc5YTAxMDEyZGMwYzQyOGJhYWUyZGUxOGU1OWVlMjE0NmRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIxMTMwOSwiaWF0IjoxNzQ3MjA3NzA5LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.SvO6_wCykbCzxlZtULn1U_J4wLGIFuQAvDQQO_ttCQ353Kv4ecPFwTXyCh1rfRbCFAtw8-gSKtTDuPvfdRL03w
    [room_number] => fg#01
    [user_name] => くらひで
    [check_in] => 2025-05-14
    [check_out] => 2025-05-15
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-14 16:29:21] [INFO] forceフラグ: true
[2025-05-14 16:29:21] [INFO] 処理パラメータ: room=fg#01, user=くらひで, checkIn=2025-05-14, checkOut=2025-05-15
[2025-05-14 16:29:21] [INFO] IDトークンを検証: eyJraWQiOiJlNmE2OTE5...
[2025-05-14 16:29:21] [DEBUG] トークン検証開始: eyJraWQiOiJlNmE2OTE5...
[2025-05-14 16:29:21] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1747211309
    [iat] => 1747207709
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-14 16:29:21] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-14 16:29:21] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 16:29:21] [INFO] データベース接続を開始します
[2025-05-14 16:29:21] [INFO] データベース接続成功
[2025-05-14 16:29:21] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-14 16:29:21] [INFO] line_room_linksテーブルが存在します
[2025-05-14 16:29:21] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-14 16:29:21] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-14 16:29:21] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=74 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-14 16:29:21] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-14 16:29:21] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#05","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":0,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 16:28:13"}
[2025-05-14 16:29:21] [INFO] トランザクション開始
[2025-05-14 16:29:21] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-14 16:29:21] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-14 16:29:21] [INFO] 部屋検索クエリ実行完了
[2025-05-14 16:29:21] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-14 16:29:21] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-14 16:29:21] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 16:29:21] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-14 16:29:21] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-14 16:29:21] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-14 16:29:21] [INFO] 非アクティブ化した登録数: 0
[2025-05-14 16:29:21] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-14 16:29:21] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-14 16:29:21] [DEBUG] プリペアドステートメント作成成功
[2025-05-14 16:29:21] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-14, checkOut=2025-05-09
[2025-05-14 16:29:21] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#01, userName=くらひで, checkInDate=2025-05-14, checkOutDate=2025-05-09
[2025-05-14 16:29:21] [INFO] SQLを実行します
[2025-05-14 16:29:21] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09"}
[2025-05-14 16:29:21] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-14 16:29:21] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 16:29:21] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 16:29:21] [ERROR] エラーコード: 23000
[2025-05-14 16:29:21] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-05-14 16:29:21] [ERROR] SQLステート: 23000
[2025-05-14 16:29:21] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-14 16:29:21] [INFO] 重複したユーザーIDの既存レコードを発見: ID=35
[2025-05-14 16:29:21] [INFO] 重複ユーザーの登録情報を更新しました: ID=35
[2025-05-14 16:29:21] [INFO] トランザクションコミット成功
[2025-05-14 16:29:21] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":35,"registration_type":"updated"}
[2025-05-14 16:29:21] [INFO] JSONレスポンスを送信完了
[2025-05-14 16:29:21] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":35,"registration_type":"updated"}
2025-05-14 16:29:21 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#01 - 期間: 2025-05-14 から 2025-05-09
[2025-05-14 16:29:21] [DEBUG] 出力バッファに170バイトのデータがあります
[2025-05-14 16:29:21] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":35,"registration_type":"updated"}
[2025-05-14 16:29:21] [DEBUG] 出力バッファをフラッシュします
[2025-05-14 16:29:21] [INFO] 処理完了
[2025-05-14 16:52:16] [INFO] --- 登録API処理開始 ---
[2025-05-14 16:52:16] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 16:52:16] [INFO] --- 登録API処理開始 ---
[2025-05-14 16:52:16] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 16:52:16] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJlNmE2OTE5Mzg2MTY5YmE1NGRlOWRkMzM2YjQxNDc5YTAxMDEyZGMwYzQyOGJhYWUyZGUxOGU1OWVlMjE0NmRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIxMTMwOSwiaWF0IjoxNzQ3MjA3NzA5LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.SvO6_wCykbCzxlZtULn1U_J4wLGIFuQAvDQQO_ttCQ353Kv4ecPFwTXyCh1rfRbCFAtw8-gSKtTDuPvfdRL03w","room_number":"fg#01","user_name":"くらひで","check_in":"2025-05-14","check_out":"2025-05-15","check_out_time":"11:00"}
[2025-05-14 16:52:16] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJlNmE2OTE5Mzg2MTY5YmE1NGRlOWRkMzM2YjQxNDc5YTAxMDEyZGMwYzQyOGJhYWUyZGUxOGU1OWVlMjE0NmRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIxMTMwOSwiaWF0IjoxNzQ3MjA3NzA5LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.SvO6_wCykbCzxlZtULn1U_J4wLGIFuQAvDQQO_ttCQ353Kv4ecPFwTXyCh1rfRbCFAtw8-gSKtTDuPvfdRL03w
    [room_number] => fg#01
    [user_name] => くらひで
    [check_in] => 2025-05-14
    [check_out] => 2025-05-15
    [check_out_time] => 11:00
)

[2025-05-14 16:52:16] [INFO] forceフラグ: false
[2025-05-14 16:52:16] [INFO] 処理パラメータ: room=fg#01, user=くらひで, checkIn=2025-05-14, checkOut=2025-05-15
[2025-05-14 16:52:16] [INFO] IDトークンを検証: eyJraWQiOiJlNmE2OTE5...
[2025-05-14 16:52:16] [DEBUG] トークン検証開始: eyJraWQiOiJlNmE2OTE5...
[2025-05-14 16:52:16] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1747211309
    [iat] => 1747207709
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-14 16:52:16] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-14 16:52:16] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 16:52:16] [INFO] データベース接続を開始します
[2025-05-14 16:52:16] [INFO] データベース接続成功
[2025-05-14 16:52:16] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-14 16:52:16] [INFO] line_room_linksテーブルが存在します
[2025-05-14 16:52:16] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-14 16:52:16] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-14 16:52:16] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=76 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-14 16:52:16] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-14 16:52:16] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":0,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 16:51:42"}
[2025-05-14 16:52:16] [INFO] トランザクション開始
[2025-05-14 16:52:16] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-14 16:52:16] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-14 16:52:16] [INFO] 部屋検索クエリ実行完了
[2025-05-14 16:52:16] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-14 16:52:16] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-14 16:52:16] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 16:52:16] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-14 16:52:16] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-14 16:52:16] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-14 16:52:16] [INFO] 非アクティブ化した登録数: 0
[2025-05-14 16:52:16] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-14 16:52:16] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-14 16:52:16] [DEBUG] プリペアドステートメント作成成功
[2025-05-14 16:52:16] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-14, checkOut=2025-05-09
[2025-05-14 16:52:16] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#01, userName=くらひで, checkInDate=2025-05-14, checkOutDate=2025-05-09
[2025-05-14 16:52:16] [INFO] SQLを実行します
[2025-05-14 16:52:16] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09"}
[2025-05-14 16:52:16] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-14 16:52:16] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 16:52:16] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 16:52:16] [ERROR] エラーコード: 23000
[2025-05-14 16:52:16] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-05-14 16:52:16] [ERROR] SQLステート: 23000
[2025-05-14 16:52:16] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-14 16:52:16] [ERROR] スタックトレース: #0 {main}
[2025-05-14 16:52:16] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-14 16:52:16] [ERROR] スタックトレース: #0 {main}
[2025-05-14 16:52:16] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-14 16:52:16] [INFO] エラーJSONレスポンスを送信完了
[2025-05-14 16:52:16] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-14 16:52:16] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-14 16:52:16] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-14 16:52:16] [DEBUG] 出力バッファをフラッシュします
[2025-05-14 16:52:16] [INFO] 処理完了
[2025-05-14 16:52:16] [INFO] --- 登録API処理開始 ---
[2025-05-14 16:52:16] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 16:52:16] [INFO] --- 登録API処理開始 ---
[2025-05-14 16:52:16] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 16:52:16] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJlNmE2OTE5Mzg2MTY5YmE1NGRlOWRkMzM2YjQxNDc5YTAxMDEyZGMwYzQyOGJhYWUyZGUxOGU1OWVlMjE0NmRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIxMTMwOSwiaWF0IjoxNzQ3MjA3NzA5LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.SvO6_wCykbCzxlZtULn1U_J4wLGIFuQAvDQQO_ttCQ353Kv4ecPFwTXyCh1rfRbCFAtw8-gSKtTDuPvfdRL03w","room_number":"fg#01","user_name":"くらひで","check_in":"2025-05-14","check_out":"2025-05-15","check_out_time":"11:00","force":true}
[2025-05-14 16:52:16] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJlNmE2OTE5Mzg2MTY5YmE1NGRlOWRkMzM2YjQxNDc5YTAxMDEyZGMwYzQyOGJhYWUyZGUxOGU1OWVlMjE0NmRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIxMTMwOSwiaWF0IjoxNzQ3MjA3NzA5LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.SvO6_wCykbCzxlZtULn1U_J4wLGIFuQAvDQQO_ttCQ353Kv4ecPFwTXyCh1rfRbCFAtw8-gSKtTDuPvfdRL03w
    [room_number] => fg#01
    [user_name] => くらひで
    [check_in] => 2025-05-14
    [check_out] => 2025-05-15
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-14 16:52:16] [INFO] forceフラグ: true
[2025-05-14 16:52:16] [INFO] 処理パラメータ: room=fg#01, user=くらひで, checkIn=2025-05-14, checkOut=2025-05-15
[2025-05-14 16:52:16] [INFO] IDトークンを検証: eyJraWQiOiJlNmE2OTE5...
[2025-05-14 16:52:16] [DEBUG] トークン検証開始: eyJraWQiOiJlNmE2OTE5...
[2025-05-14 16:52:16] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1747211309
    [iat] => 1747207709
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-14 16:52:16] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-14 16:52:16] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 16:52:16] [INFO] データベース接続を開始します
[2025-05-14 16:52:16] [INFO] データベース接続成功
[2025-05-14 16:52:16] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-14 16:52:16] [INFO] line_room_linksテーブルが存在します
[2025-05-14 16:52:16] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-14 16:52:16] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-14 16:52:16] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=78 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-14 16:52:16] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-14 16:52:16] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":0,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 16:51:42"}
[2025-05-14 16:52:16] [INFO] トランザクション開始
[2025-05-14 16:52:16] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-14 16:52:16] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-14 16:52:16] [INFO] 部屋検索クエリ実行完了
[2025-05-14 16:52:16] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-14 16:52:16] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-14 16:52:16] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 16:52:16] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-14 16:52:16] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-14 16:52:16] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-14 16:52:16] [INFO] 非アクティブ化した登録数: 0
[2025-05-14 16:52:16] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-14 16:52:16] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-14 16:52:16] [DEBUG] プリペアドステートメント作成成功
[2025-05-14 16:52:16] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-14, checkOut=2025-05-09
[2025-05-14 16:52:16] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#01, userName=くらひで, checkInDate=2025-05-14, checkOutDate=2025-05-09
[2025-05-14 16:52:16] [INFO] SQLを実行します
[2025-05-14 16:52:16] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09"}
[2025-05-14 16:52:16] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-14 16:52:16] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 16:52:16] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 16:52:16] [ERROR] エラーコード: 23000
[2025-05-14 16:52:16] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-05-14 16:52:16] [ERROR] SQLステート: 23000
[2025-05-14 16:52:16] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-14 16:52:16] [INFO] 重複したユーザーIDの既存レコードを発見: ID=35
[2025-05-14 16:52:16] [INFO] 重複ユーザーの登録情報を更新しました: ID=35
[2025-05-14 16:52:16] [INFO] トランザクションコミット成功
[2025-05-14 16:52:16] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":35,"registration_type":"updated"}
[2025-05-14 16:52:16] [INFO] JSONレスポンスを送信完了
[2025-05-14 16:52:16] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":35,"registration_type":"updated"}
2025-05-14 16:52:16 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#01 - 期間: 2025-05-14 から 2025-05-09
[2025-05-14 16:52:16] [DEBUG] 出力バッファに170バイトのデータがあります
[2025-05-14 16:52:16] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":35,"registration_type":"updated"}
[2025-05-14 16:52:16] [DEBUG] 出力バッファをフラッシュします
[2025-05-14 16:52:16] [INFO] 処理完了
[2025-05-14 17:03:33] [INFO] --- 登録API処理開始 ---
[2025-05-14 17:03:33] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 17:03:33] [INFO] --- 登録API処理開始 ---
[2025-05-14 17:03:33] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 17:03:33] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJlNmE2OTE5Mzg2MTY5YmE1NGRlOWRkMzM2YjQxNDc5YTAxMDEyZGMwYzQyOGJhYWUyZGUxOGU1OWVlMjE0NmRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIxMTMwOSwiaWF0IjoxNzQ3MjA3NzA5LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.SvO6_wCykbCzxlZtULn1U_J4wLGIFuQAvDQQO_ttCQ353Kv4ecPFwTXyCh1rfRbCFAtw8-gSKtTDuPvfdRL03w","room_number":"fg#01","user_name":"くらひで","check_in":"2025-05-14","check_out":"2025-05-15","check_out_time":"11:00"}
[2025-05-14 17:03:33] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJlNmE2OTE5Mzg2MTY5YmE1NGRlOWRkMzM2YjQxNDc5YTAxMDEyZGMwYzQyOGJhYWUyZGUxOGU1OWVlMjE0NmRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIxMTMwOSwiaWF0IjoxNzQ3MjA3NzA5LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.SvO6_wCykbCzxlZtULn1U_J4wLGIFuQAvDQQO_ttCQ353Kv4ecPFwTXyCh1rfRbCFAtw8-gSKtTDuPvfdRL03w
    [room_number] => fg#01
    [user_name] => くらひで
    [check_in] => 2025-05-14
    [check_out] => 2025-05-15
    [check_out_time] => 11:00
)

[2025-05-14 17:03:33] [INFO] forceフラグ: false
[2025-05-14 17:03:33] [INFO] 処理パラメータ: room=fg#01, user=くらひで, checkIn=2025-05-14, checkOut=2025-05-15
[2025-05-14 17:03:33] [INFO] IDトークンを検証: eyJraWQiOiJlNmE2OTE5...
[2025-05-14 17:03:33] [DEBUG] トークン検証開始: eyJraWQiOiJlNmE2OTE5...
[2025-05-14 17:03:33] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1747211309
    [iat] => 1747207709
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-14 17:03:33] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-14 17:03:33] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 17:03:33] [INFO] データベース接続を開始します
[2025-05-14 17:03:33] [INFO] データベース接続成功
[2025-05-14 17:03:33] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-14 17:03:33] [INFO] line_room_linksテーブルが存在します
[2025-05-14 17:03:33] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-14 17:03:33] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-14 17:03:33] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=80 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-14 17:03:33] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-14 17:03:33] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 16:52:16"}
[2025-05-14 17:03:33] [INFO] トランザクション開始
[2025-05-14 17:03:33] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-14 17:03:33] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-14 17:03:33] [INFO] 部屋検索クエリ実行完了
[2025-05-14 17:03:33] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-14 17:03:33] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-14 17:03:33] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 17:03:33] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-14 17:03:33] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-14 17:03:33] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-14 17:03:33] [INFO] 非アクティブ化した登録数: 1
[2025-05-14 17:03:33] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-14 17:03:33] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-14 17:03:33] [DEBUG] プリペアドステートメント作成成功
[2025-05-14 17:03:33] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-14, checkOut=2025-05-09
[2025-05-14 17:03:33] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#01, userName=くらひで, checkInDate=2025-05-14, checkOutDate=2025-05-09
[2025-05-14 17:03:33] [INFO] SQLを実行します
[2025-05-14 17:03:33] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09"}
[2025-05-14 17:03:33] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-14 17:03:33] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 17:03:33] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 17:03:33] [ERROR] エラーコード: 23000
[2025-05-14 17:03:33] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-05-14 17:03:33] [ERROR] SQLステート: 23000
[2025-05-14 17:03:33] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-14 17:03:33] [ERROR] スタックトレース: #0 {main}
[2025-05-14 17:03:33] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-14 17:03:33] [ERROR] スタックトレース: #0 {main}
[2025-05-14 17:03:33] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-14 17:03:33] [INFO] エラーJSONレスポンスを送信完了
[2025-05-14 17:03:33] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-14 17:03:33] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-14 17:03:33] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-14 17:03:33] [DEBUG] 出力バッファをフラッシュします
[2025-05-14 17:03:33] [INFO] 処理完了
[2025-05-14 17:03:33] [INFO] --- 登録API処理開始 ---
[2025-05-14 17:03:33] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 17:03:33] [INFO] --- 登録API処理開始 ---
[2025-05-14 17:03:33] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 17:03:33] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJlNmE2OTE5Mzg2MTY5YmE1NGRlOWRkMzM2YjQxNDc5YTAxMDEyZGMwYzQyOGJhYWUyZGUxOGU1OWVlMjE0NmRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIxMTMwOSwiaWF0IjoxNzQ3MjA3NzA5LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.SvO6_wCykbCzxlZtULn1U_J4wLGIFuQAvDQQO_ttCQ353Kv4ecPFwTXyCh1rfRbCFAtw8-gSKtTDuPvfdRL03w","room_number":"fg#01","user_name":"くらひで","check_in":"2025-05-14","check_out":"2025-05-15","check_out_time":"11:00","force":true}
[2025-05-14 17:03:33] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJlNmE2OTE5Mzg2MTY5YmE1NGRlOWRkMzM2YjQxNDc5YTAxMDEyZGMwYzQyOGJhYWUyZGUxOGU1OWVlMjE0NmRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIxMTMwOSwiaWF0IjoxNzQ3MjA3NzA5LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.SvO6_wCykbCzxlZtULn1U_J4wLGIFuQAvDQQO_ttCQ353Kv4ecPFwTXyCh1rfRbCFAtw8-gSKtTDuPvfdRL03w
    [room_number] => fg#01
    [user_name] => くらひで
    [check_in] => 2025-05-14
    [check_out] => 2025-05-15
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-14 17:03:33] [INFO] forceフラグ: true
[2025-05-14 17:03:33] [INFO] 処理パラメータ: room=fg#01, user=くらひで, checkIn=2025-05-14, checkOut=2025-05-15
[2025-05-14 17:03:33] [INFO] IDトークンを検証: eyJraWQiOiJlNmE2OTE5...
[2025-05-14 17:03:33] [DEBUG] トークン検証開始: eyJraWQiOiJlNmE2OTE5...
[2025-05-14 17:03:33] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1747211309
    [iat] => 1747207709
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-14 17:03:33] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-14 17:03:33] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 17:03:33] [INFO] データベース接続を開始します
[2025-05-14 17:03:33] [INFO] データベース接続成功
[2025-05-14 17:03:33] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-14 17:03:33] [INFO] line_room_linksテーブルが存在します
[2025-05-14 17:03:33] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-14 17:03:33] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-14 17:03:33] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=82 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-14 17:03:33] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-14 17:03:33] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 16:52:16"}
[2025-05-14 17:03:33] [INFO] トランザクション開始
[2025-05-14 17:03:33] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-14 17:03:33] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-14 17:03:33] [INFO] 部屋検索クエリ実行完了
[2025-05-14 17:03:33] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-14 17:03:33] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-14 17:03:33] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-14 17:03:33] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-14 17:03:33] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-14 17:03:33] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-14 17:03:33] [INFO] 非アクティブ化した登録数: 1
[2025-05-14 17:03:33] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-14 17:03:33] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-14 17:03:33] [DEBUG] プリペアドステートメント作成成功
[2025-05-14 17:03:33] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-14, checkOut=2025-05-09
[2025-05-14 17:03:33] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#01, userName=くらひで, checkInDate=2025-05-14, checkOutDate=2025-05-09
[2025-05-14 17:03:33] [INFO] SQLを実行します
[2025-05-14 17:03:33] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09"}
[2025-05-14 17:03:33] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-14 17:03:33] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 17:03:33] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-14 17:03:33] [ERROR] エラーコード: 23000
[2025-05-14 17:03:33] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-05-14 17:03:33] [ERROR] SQLステート: 23000
[2025-05-14 17:03:33] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-14 17:03:33] [INFO] 重複したユーザーIDの既存レコードを発見: ID=35
[2025-05-14 17:03:33] [INFO] 重複ユーザーの登録情報を更新しました: ID=35
[2025-05-14 17:03:33] [INFO] トランザクションコミット成功
[2025-05-14 17:03:33] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":35,"registration_type":"updated"}
[2025-05-14 17:03:33] [INFO] JSONレスポンスを送信完了
[2025-05-14 17:03:33] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":35,"registration_type":"updated"}
2025-05-14 17:03:33 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#01 - 期間: 2025-05-14 から 2025-05-09
[2025-05-14 17:03:33] [DEBUG] 出力バッファに170バイトのデータがあります
[2025-05-14 17:03:33] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":35,"registration_type":"updated"}
[2025-05-14 17:03:33] [DEBUG] 出力バッファをフラッシュします
[2025-05-14 17:03:33] [INFO] 処理完了
[2025-05-14 18:01:16] [INFO] --- 登録API処理開始 ---
[2025-05-14 18:01:16] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 18:01:16] [INFO] --- 登録API処理開始 ---
[2025-05-14 18:01:16] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 18:01:16] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTllMWY1YzY2YjRhMjZmZDBjMzNjODkwYWQ4MjZiMTkyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIxNjg1MCwiaWF0IjoxNzQ3MjEzMjUwLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi5YCJ55Sw5p-a5pyJIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoV2Q0Z0hnRUZDRXNKSGliallxdDNIRFZiQmlaLU1BNERjU3hGZmkwWVhub2lLaGhPWm5BU0pId1hCQzV4TFVvWk1Tc1FMU3RNWG41dyJ9.Btz6hEAaDBsKYMih8ZzgeAQoN-ZKXGn375ku4lg20jy-60ctuYs2KTapXKtSWAXt5gzZ_10E8teGlvJ1lZOl1A","room_number":"fg#07","user_name":"倉田柚有","check_in":"2025-05-14","check_out":"2025-05-15","check_out_time":"11:00"}
[2025-05-14 18:01:16] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTllMWY1YzY2YjRhMjZmZDBjMzNjODkwYWQ4MjZiMTkyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIxNjg1MCwiaWF0IjoxNzQ3MjEzMjUwLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi5YCJ55Sw5p-a5pyJIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoV2Q0Z0hnRUZDRXNKSGliallxdDNIRFZiQmlaLU1BNERjU3hGZmkwWVhub2lLaGhPWm5BU0pId1hCQzV4TFVvWk1Tc1FMU3RNWG41dyJ9.Btz6hEAaDBsKYMih8ZzgeAQoN-ZKXGn375ku4lg20jy-60ctuYs2KTapXKtSWAXt5gzZ_10E8teGlvJ1lZOl1A
    [room_number] => fg#07
    [user_name] => 倉田柚有
    [check_in] => 2025-05-14
    [check_out] => 2025-05-15
    [check_out_time] => 11:00
)

[2025-05-14 18:01:16] [INFO] forceフラグ: false
[2025-05-14 18:01:16] [INFO] 処理パラメータ: room=fg#07, user=倉田柚有, checkIn=2025-05-14, checkOut=2025-05-15
[2025-05-14 18:01:16] [INFO] IDトークンを検証: eyJraWQiOiJjY2Q1OGMy...
[2025-05-14 18:01:16] [DEBUG] トークン検証開始: eyJraWQiOiJjY2Q1OGMy...
[2025-05-14 18:01:16] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U9e1f5c66b4a26fd0c33c890ad826b192
    [aud] => 2007363986
    [exp] => 1747216850
    [iat] => 1747213250
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => 倉田柚有
    [picture] => https://profile.line-scdn.net/0hWd4gHgEFCEsJHibjYqt3HDVbBiZ-MA4DcSxFfi0YXnoiKhhOZnASJHwXBC5xLUoZMSsQLStMXn5w
)

[2025-05-14 18:01:16] [INFO] トークン検証成功: ユーザーID U9e1f5c66b4a26fd0c33c890ad826b192
[2025-05-14 18:01:16] [INFO] IDトークン検証成功: userId=U9e1f5c66b4a26fd0c33c890ad826b192
[2025-05-14 18:01:16] [INFO] データベース接続を開始します
[2025-05-14 18:01:16] [INFO] データベース接続成功
[2025-05-14 18:01:16] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-14 18:01:16] [INFO] line_room_linksテーブルが存在します
[2025-05-14 18:01:16] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-14 18:01:16] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-14 18:01:16] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=84 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-14 18:01:16] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-14 18:01:16] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 17:03:33"}
[2025-05-14 18:01:16] [INFO] トランザクション開始
[2025-05-14 18:01:16] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-14 18:01:16] [DEBUG] パラメータバインド: roomNumber=fg#07
[2025-05-14 18:01:16] [INFO] 部屋検索クエリ実行完了
[2025-05-14 18:01:16] [INFO] 部屋検索結果: 部屋あり ID=7, アクティブ=1
[2025-05-14 18:01:16] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-14 18:01:16] [DEBUG] パラメータバインド: userId=U9e1f5c66b4a26fd0c33c890ad826b192
[2025-05-14 18:01:16] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-14 18:01:16] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-14 18:01:16] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-14 18:01:16] [INFO] 非アクティブ化した登録数: 0
[2025-05-14 18:01:16] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-14 18:01:16] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-14 18:01:16] [DEBUG] プリペアドステートメント作成成功
[2025-05-14 18:01:16] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-14, checkOut=2025-05-07
[2025-05-14 18:01:16] [DEBUG] パラメータバインド完了: userId=U9e1f5c66b4a26fd0c33c890ad826b192, roomNumber=fg#07, userName=倉田柚有, checkInDate=2025-05-14, checkOutDate=2025-05-07
[2025-05-14 18:01:16] [INFO] SQLを実行します
[2025-05-14 18:01:16] [DEBUG] 挿入予定の値: {"line_user_id":"U9e1f5c66b4a26fd0c33c890ad826b192","room_number":"fg#07","user_name":"\u5009\u7530\u67da\u6709","check_in_date":"2025-05-14","check_out_date":"2025-05-07"}
[2025-05-14 18:01:16] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-14 18:01:16] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U9e1f5c66b4a26fd0c33c890ad826b192' for key 'line_room_links.line_user_id'
[2025-05-14 18:01:16] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U9e1f5c66b4a26fd0c33c890ad826b192' for key 'line_room_links.line_user_id'
[2025-05-14 18:01:16] [ERROR] エラーコード: 23000
[2025-05-14 18:01:16] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U9e1f5c66b4a26fd0c33c890ad826b192' for key 'line_room_links.line_user_id'
)

[2025-05-14 18:01:16] [ERROR] SQLステート: 23000
[2025-05-14 18:01:16] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-14 18:01:16] [ERROR] スタックトレース: #0 {main}
[2025-05-14 18:01:16] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-14 18:01:16] [ERROR] スタックトレース: #0 {main}
[2025-05-14 18:01:16] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-14 18:01:16] [INFO] エラーJSONレスポンスを送信完了
[2025-05-14 18:01:16] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-14 18:01:16] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-14 18:01:16] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-14 18:01:16] [DEBUG] 出力バッファをフラッシュします
[2025-05-14 18:01:16] [INFO] 処理完了
[2025-05-14 18:01:16] [INFO] --- 登録API処理開始 ---
[2025-05-14 18:01:16] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-14 18:01:16] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTllMWY1YzY2YjRhMjZmZDBjMzNjODkwYWQ4MjZiMTkyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIxNjg1MCwiaWF0IjoxNzQ3MjEzMjUwLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi5YCJ55Sw5p-a5pyJIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoV2Q0Z0hnRUZDRXNKSGliallxdDNIRFZiQmlaLU1BNERjU3hGZmkwWVhub2lLaGhPWm5BU0pId1hCQzV4TFVvWk1Tc1FMU3RNWG41dyJ9.Btz6hEAaDBsKYMih8ZzgeAQoN-ZKXGn375ku4lg20jy-60ctuYs2KTapXKtSWAXt5gzZ_10E8teGlvJ1lZOl1A","room_number":"fg#07","user_name":"倉田柚有","check_in":"2025-05-14","check_out":"2025-05-15","check_out_time":"11:00","force":true}
[2025-05-14 18:01:16] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTllMWY1YzY2YjRhMjZmZDBjMzNjODkwYWQ4MjZiMTkyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIxNjg1MCwiaWF0IjoxNzQ3MjEzMjUwLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi5YCJ55Sw5p-a5pyJIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoV2Q0Z0hnRUZDRXNKSGliallxdDNIRFZiQmlaLU1BNERjU3hGZmkwWVhub2lLaGhPWm5BU0pId1hCQzV4TFVvWk1Tc1FMU3RNWG41dyJ9.Btz6hEAaDBsKYMih8ZzgeAQoN-ZKXGn375ku4lg20jy-60ctuYs2KTapXKtSWAXt5gzZ_10E8teGlvJ1lZOl1A
    [room_number] => fg#07
    [user_name] => 倉田柚有
    [check_in] => 2025-05-14
    [check_out] => 2025-05-15
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-14 18:01:16] [INFO] forceフラグ: true
[2025-05-14 18:01:16] [INFO] 処理パラメータ: room=fg#07, user=倉田柚有, checkIn=2025-05-14, checkOut=2025-05-15
[2025-05-14 18:01:16] [INFO] IDトークンを検証: eyJraWQiOiJjY2Q1OGMy...
[2025-05-14 18:01:16] [DEBUG] トークン検証開始: eyJraWQiOiJjY2Q1OGMy...
[2025-05-14 18:01:16] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U9e1f5c66b4a26fd0c33c890ad826b192
    [aud] => 2007363986
    [exp] => 1747216850
    [iat] => 1747213250
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => 倉田柚有
    [picture] => https://profile.line-scdn.net/0hWd4gHgEFCEsJHibjYqt3HDVbBiZ-MA4DcSxFfi0YXnoiKhhOZnASJHwXBC5xLUoZMSsQLStMXn5w
)

[2025-05-14 18:01:16] [INFO] トークン検証成功: ユーザーID U9e1f5c66b4a26fd0c33c890ad826b192
[2025-05-14 18:01:16] [INFO] IDトークン検証成功: userId=U9e1f5c66b4a26fd0c33c890ad826b192
[2025-05-14 18:01:16] [INFO] データベース接続を開始します
[2025-05-14 18:01:16] [INFO] データベース接続成功
[2025-05-14 18:01:16] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-14 18:01:16] [INFO] line_room_linksテーブルが存在します
[2025-05-14 18:01:16] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-14 18:01:16] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-14 18:01:16] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=86 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-14 18:01:16] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-14 18:01:16] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 17:03:33"}
[2025-05-14 18:01:16] [INFO] トランザクション開始
[2025-05-14 18:01:16] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-14 18:01:16] [DEBUG] パラメータバインド: roomNumber=fg#07
[2025-05-14 18:01:16] [INFO] 部屋検索クエリ実行完了
[2025-05-14 18:01:16] [INFO] 部屋検索結果: 部屋あり ID=7, アクティブ=1
[2025-05-14 18:01:16] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-14 18:01:16] [DEBUG] パラメータバインド: userId=U9e1f5c66b4a26fd0c33c890ad826b192
[2025-05-14 18:01:16] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-14 18:01:16] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-14 18:01:16] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-14 18:01:16] [INFO] 非アクティブ化した登録数: 0
[2025-05-14 18:01:16] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-14 18:01:16] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-14 18:01:16] [DEBUG] プリペアドステートメント作成成功
[2025-05-14 18:01:16] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-14, checkOut=2025-05-07
[2025-05-14 18:01:16] [DEBUG] パラメータバインド完了: userId=U9e1f5c66b4a26fd0c33c890ad826b192, roomNumber=fg#07, userName=倉田柚有, checkInDate=2025-05-14, checkOutDate=2025-05-07
[2025-05-14 18:01:16] [INFO] SQLを実行します
[2025-05-14 18:01:16] [DEBUG] 挿入予定の値: {"line_user_id":"U9e1f5c66b4a26fd0c33c890ad826b192","room_number":"fg#07","user_name":"\u5009\u7530\u67da\u6709","check_in_date":"2025-05-14","check_out_date":"2025-05-07"}
[2025-05-14 18:01:16] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-14 18:01:16] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U9e1f5c66b4a26fd0c33c890ad826b192' for key 'line_room_links.line_user_id'
[2025-05-14 18:01:16] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U9e1f5c66b4a26fd0c33c890ad826b192' for key 'line_room_links.line_user_id'
[2025-05-14 18:01:16] [ERROR] エラーコード: 23000
[2025-05-14 18:01:16] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U9e1f5c66b4a26fd0c33c890ad826b192' for key 'line_room_links.line_user_id'
)

[2025-05-14 18:01:16] [ERROR] SQLステート: 23000
[2025-05-14 18:01:16] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-14 18:01:16] [INFO] 重複したユーザーIDの既存レコードを発見: ID=9
[2025-05-14 18:01:16] [INFO] 重複ユーザーの登録情報を更新しました: ID=9
[2025-05-14 18:01:16] [INFO] トランザクションコミット成功
[2025-05-14 18:01:16] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":9,"registration_type":"updated"}
[2025-05-14 18:01:16] [INFO] JSONレスポンスを送信完了
[2025-05-14 18:01:16] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":9,"registration_type":"updated"}
2025-05-14 18:01:16 - ユーザーID: U9e1f5c66b4a26fd0c33c890ad826b192 - 部屋番号更新 - 部屋: fg#07 - 期間: 2025-05-14 から 2025-05-07
[2025-05-14 18:01:16] [DEBUG] 出力バッファに169バイトのデータがあります
[2025-05-14 18:01:16] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":9,"registration_type":"updated"}
[2025-05-14 18:01:16] [DEBUG] 出力バッファをフラッシュします
[2025-05-14 18:01:16] [INFO] 処理完了
[2025-05-14 21:41:39] [INFO] --- 登録API処理開始 ---
[2025-05-14 21:41:39] [INFO] リクエスト元IPアドレス: 222.224.253.151
[2025-05-14 21:41:39] [INFO] --- 登録API処理開始 ---
[2025-05-14 21:41:39] [INFO] リクエスト元IPアドレス: 222.224.253.151
[2025-05-14 21:41:39] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTY1N2IyNDBmYzY1NDM2ZDk4NmM0ZDJkYmY5YmI5ZmExIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIzMDA5MCwiaWF0IjoxNzQ3MjI2NDkwLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44Gy44KN44GNIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoMzZwQi1zTUdiQmxOTzNrckYtd1RUbkYtWW5RNkZXcFJOVjF6ZldBOE1TMWhDQzFJY3c0bGVqOW9NaXBsRGlJYUl3cDJlenBwTkNvMCJ9.ZrZ_cFgEkP9nxEZjmsK7Wt9XtdYvkp3c4KT8otrgl3IORjaBQp1zsmvBld3Y9he2Qg-0bAY41XHwmYrnrBao2w","room_number":"fg#01","user_name":"ひろき","check_in":"2025-05-14","check_out":"2025-05-15","check_out_time":"11:00"}
[2025-05-14 21:41:39] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTY1N2IyNDBmYzY1NDM2ZDk4NmM0ZDJkYmY5YmI5ZmExIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIzMDA5MCwiaWF0IjoxNzQ3MjI2NDkwLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44Gy44KN44GNIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoMzZwQi1zTUdiQmxOTzNrckYtd1RUbkYtWW5RNkZXcFJOVjF6ZldBOE1TMWhDQzFJY3c0bGVqOW9NaXBsRGlJYUl3cDJlenBwTkNvMCJ9.ZrZ_cFgEkP9nxEZjmsK7Wt9XtdYvkp3c4KT8otrgl3IORjaBQp1zsmvBld3Y9he2Qg-0bAY41XHwmYrnrBao2w
    [room_number] => fg#01
    [user_name] => ひろき
    [check_in] => 2025-05-14
    [check_out] => 2025-05-15
    [check_out_time] => 11:00
)

[2025-05-14 21:41:39] [INFO] forceフラグ: false
[2025-05-14 21:41:39] [INFO] 処理パラメータ: room=fg#01, user=ひろき, checkIn=2025-05-14, checkOut=2025-05-15
[2025-05-14 21:41:39] [INFO] IDトークンを検証: eyJraWQiOiJjY2Q1OGMy...
[2025-05-14 21:41:39] [DEBUG] トークン検証開始: eyJraWQiOiJjY2Q1OGMy...
[2025-05-14 21:41:39] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U657b240fc65436d986c4d2dbf9bb9fa1
    [aud] => 2007363986
    [exp] => 1747230090
    [iat] => 1747226490
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => ひろき
    [picture] => https://profile.line-scdn.net/0h36pB-sMGbBlNO3krF-wTTnF-YnQ6FWpRNV1zfWA8MS1hCC1Icw4lej9oMiplDiIaIwp2ezppNCo0
)

[2025-05-14 21:41:39] [INFO] トークン検証成功: ユーザーID U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-14 21:41:39] [INFO] IDトークン検証成功: userId=U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-14 21:41:39] [INFO] データベース接続を開始します
[2025-05-14 21:41:39] [INFO] データベース接続成功
[2025-05-14 21:41:39] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-14 21:41:39] [INFO] line_room_linksテーブルが存在します
[2025-05-14 21:41:39] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-14 21:41:39] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-14 21:41:39] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=88 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-14 21:41:39] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-14 21:41:39] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 17:03:33"}
[2025-05-14 21:41:39] [INFO] トランザクション開始
[2025-05-14 21:41:39] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-14 21:41:39] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-14 21:41:39] [INFO] 部屋検索クエリ実行完了
[2025-05-14 21:41:39] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-14 21:41:39] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-14 21:41:39] [DEBUG] パラメータバインド: userId=U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-14 21:41:39] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-14 21:41:39] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-14 21:41:39] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-14 21:41:39] [INFO] 非アクティブ化した登録数: 1
[2025-05-14 21:41:39] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-14 21:41:39] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-14 21:41:39] [DEBUG] プリペアドステートメント作成成功
[2025-05-14 21:41:39] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-14, checkOut=2025-05-09
[2025-05-14 21:41:39] [DEBUG] パラメータバインド完了: userId=U657b240fc65436d986c4d2dbf9bb9fa1, roomNumber=fg#01, userName=ひろき, checkInDate=2025-05-14, checkOutDate=2025-05-09
[2025-05-14 21:41:39] [INFO] SQLを実行します
[2025-05-14 21:41:39] [DEBUG] 挿入予定の値: {"line_user_id":"U657b240fc65436d986c4d2dbf9bb9fa1","room_number":"fg#01","user_name":"\u3072\u308d\u304d","check_in_date":"2025-05-14","check_out_date":"2025-05-09"}
[2025-05-14 21:41:39] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-14 21:41:39] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
[2025-05-14 21:41:39] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
[2025-05-14 21:41:39] [ERROR] エラーコード: 23000
[2025-05-14 21:41:39] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
)

[2025-05-14 21:41:39] [ERROR] SQLステート: 23000
[2025-05-14 21:41:39] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-14 21:41:39] [ERROR] スタックトレース: #0 {main}
[2025-05-14 21:41:39] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-14 21:41:39] [ERROR] スタックトレース: #0 {main}
[2025-05-14 21:41:39] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-14 21:41:39] [INFO] エラーJSONレスポンスを送信完了
[2025-05-14 21:41:39] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-14 21:41:39] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-14 21:41:39] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-14 21:41:39] [DEBUG] 出力バッファをフラッシュします
[2025-05-14 21:41:39] [INFO] 処理完了
[2025-05-14 21:41:39] [INFO] --- 登録API処理開始 ---
[2025-05-14 21:41:39] [INFO] リクエスト元IPアドレス: 222.224.253.151
[2025-05-14 21:41:39] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTY1N2IyNDBmYzY1NDM2ZDk4NmM0ZDJkYmY5YmI5ZmExIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIzMDA5MCwiaWF0IjoxNzQ3MjI2NDkwLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44Gy44KN44GNIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoMzZwQi1zTUdiQmxOTzNrckYtd1RUbkYtWW5RNkZXcFJOVjF6ZldBOE1TMWhDQzFJY3c0bGVqOW9NaXBsRGlJYUl3cDJlenBwTkNvMCJ9.ZrZ_cFgEkP9nxEZjmsK7Wt9XtdYvkp3c4KT8otrgl3IORjaBQp1zsmvBld3Y9he2Qg-0bAY41XHwmYrnrBao2w","room_number":"fg#01","user_name":"ひろき","check_in":"2025-05-14","check_out":"2025-05-15","check_out_time":"11:00","force":true}
[2025-05-14 21:41:39] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTY1N2IyNDBmYzY1NDM2ZDk4NmM0ZDJkYmY5YmI5ZmExIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzIzMDA5MCwiaWF0IjoxNzQ3MjI2NDkwLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44Gy44KN44GNIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoMzZwQi1zTUdiQmxOTzNrckYtd1RUbkYtWW5RNkZXcFJOVjF6ZldBOE1TMWhDQzFJY3c0bGVqOW9NaXBsRGlJYUl3cDJlenBwTkNvMCJ9.ZrZ_cFgEkP9nxEZjmsK7Wt9XtdYvkp3c4KT8otrgl3IORjaBQp1zsmvBld3Y9he2Qg-0bAY41XHwmYrnrBao2w
    [room_number] => fg#01
    [user_name] => ひろき
    [check_in] => 2025-05-14
    [check_out] => 2025-05-15
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-14 21:41:39] [INFO] forceフラグ: true
[2025-05-14 21:41:39] [INFO] 処理パラメータ: room=fg#01, user=ひろき, checkIn=2025-05-14, checkOut=2025-05-15
[2025-05-14 21:41:39] [INFO] IDトークンを検証: eyJraWQiOiJjY2Q1OGMy...
[2025-05-14 21:41:39] [DEBUG] トークン検証開始: eyJraWQiOiJjY2Q1OGMy...
[2025-05-14 21:41:39] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U657b240fc65436d986c4d2dbf9bb9fa1
    [aud] => 2007363986
    [exp] => 1747230090
    [iat] => 1747226490
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => ひろき
    [picture] => https://profile.line-scdn.net/0h36pB-sMGbBlNO3krF-wTTnF-YnQ6FWpRNV1zfWA8MS1hCC1Icw4lej9oMiplDiIaIwp2ezppNCo0
)

[2025-05-14 21:41:39] [INFO] トークン検証成功: ユーザーID U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-14 21:41:39] [INFO] IDトークン検証成功: userId=U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-14 21:41:39] [INFO] データベース接続を開始します
[2025-05-14 21:41:39] [INFO] データベース接続成功
[2025-05-14 21:41:39] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-14 21:41:39] [INFO] line_room_linksテーブルが存在します
[2025-05-14 21:41:39] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-14 21:41:39] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-14 21:41:39] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=90 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-14 21:41:39] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-14 21:41:39] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 17:03:33"}
[2025-05-14 21:41:39] [INFO] トランザクション開始
[2025-05-14 21:41:39] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-14 21:41:39] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-14 21:41:39] [INFO] 部屋検索クエリ実行完了
[2025-05-14 21:41:39] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-14 21:41:39] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-14 21:41:39] [DEBUG] パラメータバインド: userId=U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-14 21:41:39] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-14 21:41:39] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-14 21:41:39] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-14 21:41:39] [INFO] 非アクティブ化した登録数: 1
[2025-05-14 21:41:39] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-14 21:41:39] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-14 21:41:39] [DEBUG] プリペアドステートメント作成成功
[2025-05-14 21:41:39] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-14, checkOut=2025-05-09
[2025-05-14 21:41:39] [DEBUG] パラメータバインド完了: userId=U657b240fc65436d986c4d2dbf9bb9fa1, roomNumber=fg#01, userName=ひろき, checkInDate=2025-05-14, checkOutDate=2025-05-09
[2025-05-14 21:41:39] [INFO] SQLを実行します
[2025-05-14 21:41:39] [DEBUG] 挿入予定の値: {"line_user_id":"U657b240fc65436d986c4d2dbf9bb9fa1","room_number":"fg#01","user_name":"\u3072\u308d\u304d","check_in_date":"2025-05-14","check_out_date":"2025-05-09"}
[2025-05-14 21:41:39] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-14 21:41:39] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
[2025-05-14 21:41:39] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
[2025-05-14 21:41:39] [ERROR] エラーコード: 23000
[2025-05-14 21:41:39] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
)

[2025-05-14 21:41:39] [ERROR] SQLステート: 23000
[2025-05-14 21:41:39] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-14 21:41:39] [INFO] 重複したユーザーIDの既存レコードを発見: ID=30
[2025-05-14 21:41:39] [INFO] 重複ユーザーの登録情報を更新しました: ID=30
[2025-05-14 21:41:39] [INFO] トランザクションコミット成功
[2025-05-14 21:41:39] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":30,"registration_type":"updated"}
[2025-05-14 21:41:39] [INFO] JSONレスポンスを送信完了
[2025-05-14 21:41:39] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":30,"registration_type":"updated"}
2025-05-14 21:41:39 - ユーザーID: U657b240fc65436d986c4d2dbf9bb9fa1 - 部屋番号更新 - 部屋: fg#01 - 期間: 2025-05-14 から 2025-05-09
[2025-05-14 21:41:39] [DEBUG] 出力バッファに170バイトのデータがあります
[2025-05-14 21:41:39] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":30,"registration_type":"updated"}
[2025-05-14 21:41:39] [DEBUG] 出力バッファをフラッシュします
[2025-05-14 21:41:39] [INFO] 処理完了
[2025-05-16 00:17:40] [INFO] --- 登録API処理開始 ---
[2025-05-16 00:17:40] [INFO] リクエスト元IPアドレス: 222.224.253.151
[2025-05-16 00:17:40] [INFO] --- 登録API処理開始 ---
[2025-05-16 00:17:40] [INFO] リクエスト元IPアドレス: 222.224.253.151
[2025-05-16 00:17:40] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI2YWE4YWQwN2NkMmFhYWRjYzY1NmY3ZTIxMzljY2U4YjhjNGE2YzgxYzI5MDQyZjQ4MTY4MDY3MmZkMDNjOTY5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTY1N2IyNDBmYzY1NDM2ZDk4NmM0ZDJkYmY5YmI5ZmExIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzMyNTg1NSwiaWF0IjoxNzQ3MzIyMjU1LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44Gy44KN44GNIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoMzZwQi1zTUdiQmxOTzNrckYtd1RUbkYtWW5RNkZXcFJOVjF6ZldBOE1TMWhDQzFJY3c0bGVqOW9NaXBsRGlJYUl3cDJlenBwTkNvMCJ9._UkM-Uc6yCR3CA7VKcYC7EgIX2rdoBGMrzJAI24MvBVoJtqvjixTNEi-BHRB45tjBK9VXpxg9iRyx-fqg42Ruw","room_number":"fg#01","user_name":"ひろき","check_in":"2025-05-16","check_out":"2025-05-17","check_out_time":"11:00"}
[2025-05-16 00:17:40] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI2YWE4YWQwN2NkMmFhYWRjYzY1NmY3ZTIxMzljY2U4YjhjNGE2YzgxYzI5MDQyZjQ4MTY4MDY3MmZkMDNjOTY5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTY1N2IyNDBmYzY1NDM2ZDk4NmM0ZDJkYmY5YmI5ZmExIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzMyNTg1NSwiaWF0IjoxNzQ3MzIyMjU1LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44Gy44KN44GNIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoMzZwQi1zTUdiQmxOTzNrckYtd1RUbkYtWW5RNkZXcFJOVjF6ZldBOE1TMWhDQzFJY3c0bGVqOW9NaXBsRGlJYUl3cDJlenBwTkNvMCJ9._UkM-Uc6yCR3CA7VKcYC7EgIX2rdoBGMrzJAI24MvBVoJtqvjixTNEi-BHRB45tjBK9VXpxg9iRyx-fqg42Ruw
    [room_number] => fg#01
    [user_name] => ひろき
    [check_in] => 2025-05-16
    [check_out] => 2025-05-17
    [check_out_time] => 11:00
)

[2025-05-16 00:17:40] [INFO] forceフラグ: false
[2025-05-16 00:17:40] [INFO] 処理パラメータ: room=fg#01, user=ひろき, checkIn=2025-05-16, checkOut=2025-05-17
[2025-05-16 00:17:40] [INFO] IDトークンを検証: eyJraWQiOiI2YWE4YWQw...
[2025-05-16 00:17:40] [DEBUG] トークン検証開始: eyJraWQiOiI2YWE4YWQw...
[2025-05-16 00:17:40] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U657b240fc65436d986c4d2dbf9bb9fa1
    [aud] => 2007363986
    [exp] => 1747325855
    [iat] => 1747322255
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => ひろき
    [picture] => https://profile.line-scdn.net/0h36pB-sMGbBlNO3krF-wTTnF-YnQ6FWpRNV1zfWA8MS1hCC1Icw4lej9oMiplDiIaIwp2ezppNCo0
)

[2025-05-16 00:17:40] [INFO] トークン検証成功: ユーザーID U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-16 00:17:40] [INFO] IDトークン検証成功: userId=U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-16 00:17:40] [INFO] データベース接続を開始します
[2025-05-16 00:17:40] [INFO] データベース接続成功
[2025-05-16 00:17:40] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-16 00:17:40] [INFO] line_room_linksテーブルが存在します
[2025-05-16 00:17:40] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-16 00:17:40] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-16 00:17:40] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=92 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-16 00:17:40] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-16 00:17:40] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 17:03:33"}
[2025-05-16 00:17:40] [INFO] トランザクション開始
[2025-05-16 00:17:40] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-16 00:17:40] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-16 00:17:40] [INFO] 部屋検索クエリ実行完了
[2025-05-16 00:17:40] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-16 00:17:40] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-16 00:17:40] [DEBUG] パラメータバインド: userId=U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-16 00:17:40] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-16 00:17:40] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-16 00:17:40] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-16 00:17:40] [INFO] 非アクティブ化した登録数: 1
[2025-05-16 00:17:40] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-16 00:17:40] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-16 00:17:40] [DEBUG] プリペアドステートメント作成成功
[2025-05-16 00:17:40] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-16, checkOut=2025-05-09
[2025-05-16 00:17:40] [DEBUG] パラメータバインド完了: userId=U657b240fc65436d986c4d2dbf9bb9fa1, roomNumber=fg#01, userName=ひろき, checkInDate=2025-05-16, checkOutDate=2025-05-09
[2025-05-16 00:17:40] [INFO] SQLを実行します
[2025-05-16 00:17:40] [DEBUG] 挿入予定の値: {"line_user_id":"U657b240fc65436d986c4d2dbf9bb9fa1","room_number":"fg#01","user_name":"\u3072\u308d\u304d","check_in_date":"2025-05-16","check_out_date":"2025-05-09"}
[2025-05-16 00:17:40] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-16 00:17:40] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
[2025-05-16 00:17:40] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
[2025-05-16 00:17:40] [ERROR] エラーコード: 23000
[2025-05-16 00:17:40] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
)

[2025-05-16 00:17:40] [ERROR] SQLステート: 23000
[2025-05-16 00:17:40] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-16 00:17:40] [ERROR] スタックトレース: #0 {main}
[2025-05-16 00:17:40] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-16 00:17:40] [ERROR] スタックトレース: #0 {main}
[2025-05-16 00:17:40] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-16 00:17:40] [INFO] エラーJSONレスポンスを送信完了
[2025-05-16 00:17:40] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-16 00:17:40] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-16 00:17:40] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-16 00:17:40] [DEBUG] 出力バッファをフラッシュします
[2025-05-16 00:17:40] [INFO] 処理完了
[2025-05-16 00:17:40] [INFO] --- 登録API処理開始 ---
[2025-05-16 00:17:40] [INFO] リクエスト元IPアドレス: 222.224.253.151
[2025-05-16 00:17:40] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI2YWE4YWQwN2NkMmFhYWRjYzY1NmY3ZTIxMzljY2U4YjhjNGE2YzgxYzI5MDQyZjQ4MTY4MDY3MmZkMDNjOTY5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTY1N2IyNDBmYzY1NDM2ZDk4NmM0ZDJkYmY5YmI5ZmExIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzMyNTg1NSwiaWF0IjoxNzQ3MzIyMjU1LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44Gy44KN44GNIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoMzZwQi1zTUdiQmxOTzNrckYtd1RUbkYtWW5RNkZXcFJOVjF6ZldBOE1TMWhDQzFJY3c0bGVqOW9NaXBsRGlJYUl3cDJlenBwTkNvMCJ9._UkM-Uc6yCR3CA7VKcYC7EgIX2rdoBGMrzJAI24MvBVoJtqvjixTNEi-BHRB45tjBK9VXpxg9iRyx-fqg42Ruw","room_number":"fg#01","user_name":"ひろき","check_in":"2025-05-16","check_out":"2025-05-17","check_out_time":"11:00","force":true}
[2025-05-16 00:17:40] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI2YWE4YWQwN2NkMmFhYWRjYzY1NmY3ZTIxMzljY2U4YjhjNGE2YzgxYzI5MDQyZjQ4MTY4MDY3MmZkMDNjOTY5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTY1N2IyNDBmYzY1NDM2ZDk4NmM0ZDJkYmY5YmI5ZmExIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzMyNTg1NSwiaWF0IjoxNzQ3MzIyMjU1LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44Gy44KN44GNIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoMzZwQi1zTUdiQmxOTzNrckYtd1RUbkYtWW5RNkZXcFJOVjF6ZldBOE1TMWhDQzFJY3c0bGVqOW9NaXBsRGlJYUl3cDJlenBwTkNvMCJ9._UkM-Uc6yCR3CA7VKcYC7EgIX2rdoBGMrzJAI24MvBVoJtqvjixTNEi-BHRB45tjBK9VXpxg9iRyx-fqg42Ruw
    [room_number] => fg#01
    [user_name] => ひろき
    [check_in] => 2025-05-16
    [check_out] => 2025-05-17
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-16 00:17:40] [INFO] forceフラグ: true
[2025-05-16 00:17:40] [INFO] 処理パラメータ: room=fg#01, user=ひろき, checkIn=2025-05-16, checkOut=2025-05-17
[2025-05-16 00:17:40] [INFO] IDトークンを検証: eyJraWQiOiI2YWE4YWQw...
[2025-05-16 00:17:40] [DEBUG] トークン検証開始: eyJraWQiOiI2YWE4YWQw...
[2025-05-16 00:17:40] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U657b240fc65436d986c4d2dbf9bb9fa1
    [aud] => 2007363986
    [exp] => 1747325855
    [iat] => 1747322255
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => ひろき
    [picture] => https://profile.line-scdn.net/0h36pB-sMGbBlNO3krF-wTTnF-YnQ6FWpRNV1zfWA8MS1hCC1Icw4lej9oMiplDiIaIwp2ezppNCo0
)

[2025-05-16 00:17:40] [INFO] トークン検証成功: ユーザーID U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-16 00:17:40] [INFO] IDトークン検証成功: userId=U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-16 00:17:40] [INFO] データベース接続を開始します
[2025-05-16 00:17:40] [INFO] データベース接続成功
[2025-05-16 00:17:40] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-16 00:17:40] [INFO] line_room_linksテーブルが存在します
[2025-05-16 00:17:40] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-16 00:17:40] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-16 00:17:40] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=94 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-16 00:17:40] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-16 00:17:40] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 17:03:33"}
[2025-05-16 00:17:40] [INFO] トランザクション開始
[2025-05-16 00:17:40] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-16 00:17:40] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-16 00:17:40] [INFO] 部屋検索クエリ実行完了
[2025-05-16 00:17:40] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-16 00:17:40] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-16 00:17:40] [DEBUG] パラメータバインド: userId=U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-16 00:17:40] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-16 00:17:40] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-16 00:17:40] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-16 00:17:40] [INFO] 非アクティブ化した登録数: 1
[2025-05-16 00:17:40] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-16 00:17:40] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-16 00:17:40] [DEBUG] プリペアドステートメント作成成功
[2025-05-16 00:17:40] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-16, checkOut=2025-05-09
[2025-05-16 00:17:40] [DEBUG] パラメータバインド完了: userId=U657b240fc65436d986c4d2dbf9bb9fa1, roomNumber=fg#01, userName=ひろき, checkInDate=2025-05-16, checkOutDate=2025-05-09
[2025-05-16 00:17:40] [INFO] SQLを実行します
[2025-05-16 00:17:40] [DEBUG] 挿入予定の値: {"line_user_id":"U657b240fc65436d986c4d2dbf9bb9fa1","room_number":"fg#01","user_name":"\u3072\u308d\u304d","check_in_date":"2025-05-16","check_out_date":"2025-05-09"}
[2025-05-16 00:17:40] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-16 00:17:40] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
[2025-05-16 00:17:40] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
[2025-05-16 00:17:40] [ERROR] エラーコード: 23000
[2025-05-16 00:17:40] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
)

[2025-05-16 00:17:40] [ERROR] SQLステート: 23000
[2025-05-16 00:17:40] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-16 00:17:40] [INFO] 重複したユーザーIDの既存レコードを発見: ID=30
[2025-05-16 00:17:40] [INFO] 重複ユーザーの登録情報を更新しました: ID=30
[2025-05-16 00:17:40] [INFO] トランザクションコミット成功
[2025-05-16 00:17:40] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":30,"registration_type":"updated"}
[2025-05-16 00:17:40] [INFO] JSONレスポンスを送信完了
[2025-05-16 00:17:40] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":30,"registration_type":"updated"}
2025-05-16 00:17:40 - ユーザーID: U657b240fc65436d986c4d2dbf9bb9fa1 - 部屋番号更新 - 部屋: fg#01 - 期間: 2025-05-16 から 2025-05-09
[2025-05-16 00:17:40] [DEBUG] 出力バッファに170バイトのデータがあります
[2025-05-16 00:17:40] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":30,"registration_type":"updated"}
[2025-05-16 00:17:40] [DEBUG] 出力バッファをフラッシュします
[2025-05-16 00:17:40] [INFO] 処理完了
[2025-05-16 00:26:58] [INFO] --- 登録API処理開始 ---
[2025-05-16 00:26:58] [INFO] リクエスト元IPアドレス: 222.224.253.151
[2025-05-16 00:26:58] [INFO] --- 登録API処理開始 ---
[2025-05-16 00:26:58] [INFO] リクエスト元IPアドレス: 222.224.253.151
[2025-05-16 00:26:58] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI2YWE4YWQwN2NkMmFhYWRjYzY1NmY3ZTIxMzljY2U4YjhjNGE2YzgxYzI5MDQyZjQ4MTY4MDY3MmZkMDNjOTY5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTY1N2IyNDBmYzY1NDM2ZDk4NmM0ZDJkYmY5YmI5ZmExIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzMyNTg1NSwiaWF0IjoxNzQ3MzIyMjU1LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44Gy44KN44GNIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoMzZwQi1zTUdiQmxOTzNrckYtd1RUbkYtWW5RNkZXcFJOVjF6ZldBOE1TMWhDQzFJY3c0bGVqOW9NaXBsRGlJYUl3cDJlenBwTkNvMCJ9._UkM-Uc6yCR3CA7VKcYC7EgIX2rdoBGMrzJAI24MvBVoJtqvjixTNEi-BHRB45tjBK9VXpxg9iRyx-fqg42Ruw","room_number":"fg#01","user_name":"ひろき","check_in":"2025-05-16","check_out":"2025-05-17","check_out_time":"11:00"}
[2025-05-16 00:26:58] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI2YWE4YWQwN2NkMmFhYWRjYzY1NmY3ZTIxMzljY2U4YjhjNGE2YzgxYzI5MDQyZjQ4MTY4MDY3MmZkMDNjOTY5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTY1N2IyNDBmYzY1NDM2ZDk4NmM0ZDJkYmY5YmI5ZmExIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzMyNTg1NSwiaWF0IjoxNzQ3MzIyMjU1LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44Gy44KN44GNIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoMzZwQi1zTUdiQmxOTzNrckYtd1RUbkYtWW5RNkZXcFJOVjF6ZldBOE1TMWhDQzFJY3c0bGVqOW9NaXBsRGlJYUl3cDJlenBwTkNvMCJ9._UkM-Uc6yCR3CA7VKcYC7EgIX2rdoBGMrzJAI24MvBVoJtqvjixTNEi-BHRB45tjBK9VXpxg9iRyx-fqg42Ruw
    [room_number] => fg#01
    [user_name] => ひろき
    [check_in] => 2025-05-16
    [check_out] => 2025-05-17
    [check_out_time] => 11:00
)

[2025-05-16 00:26:58] [INFO] forceフラグ: false
[2025-05-16 00:26:58] [INFO] 処理パラメータ: room=fg#01, user=ひろき, checkIn=2025-05-16, checkOut=2025-05-17
[2025-05-16 00:26:58] [INFO] IDトークンを検証: eyJraWQiOiI2YWE4YWQw...
[2025-05-16 00:26:58] [DEBUG] トークン検証開始: eyJraWQiOiI2YWE4YWQw...
[2025-05-16 00:26:58] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U657b240fc65436d986c4d2dbf9bb9fa1
    [aud] => 2007363986
    [exp] => 1747325855
    [iat] => 1747322255
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => ひろき
    [picture] => https://profile.line-scdn.net/0h36pB-sMGbBlNO3krF-wTTnF-YnQ6FWpRNV1zfWA8MS1hCC1Icw4lej9oMiplDiIaIwp2ezppNCo0
)

[2025-05-16 00:26:58] [INFO] トークン検証成功: ユーザーID U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-16 00:26:58] [INFO] IDトークン検証成功: userId=U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-16 00:26:58] [INFO] データベース接続を開始します
[2025-05-16 00:26:58] [INFO] データベース接続成功
[2025-05-16 00:26:58] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-16 00:26:58] [INFO] line_room_linksテーブルが存在します
[2025-05-16 00:26:58] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-16 00:26:58] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-16 00:26:58] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=96 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-16 00:26:58] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-16 00:26:58] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 17:03:33"}
[2025-05-16 00:26:58] [INFO] トランザクション開始
[2025-05-16 00:26:58] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-16 00:26:58] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-16 00:26:58] [INFO] 部屋検索クエリ実行完了
[2025-05-16 00:26:58] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-16 00:26:58] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-16 00:26:58] [DEBUG] パラメータバインド: userId=U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-16 00:26:58] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-16 00:26:58] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-16 00:26:58] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-16 00:26:58] [INFO] 非アクティブ化した登録数: 1
[2025-05-16 00:26:58] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-16 00:26:58] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-16 00:26:58] [DEBUG] プリペアドステートメント作成成功
[2025-05-16 00:26:58] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-16, checkOut=2025-05-09
[2025-05-16 00:26:58] [DEBUG] パラメータバインド完了: userId=U657b240fc65436d986c4d2dbf9bb9fa1, roomNumber=fg#01, userName=ひろき, checkInDate=2025-05-16, checkOutDate=2025-05-09
[2025-05-16 00:26:58] [INFO] SQLを実行します
[2025-05-16 00:26:58] [DEBUG] 挿入予定の値: {"line_user_id":"U657b240fc65436d986c4d2dbf9bb9fa1","room_number":"fg#01","user_name":"\u3072\u308d\u304d","check_in_date":"2025-05-16","check_out_date":"2025-05-09"}
[2025-05-16 00:26:58] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-16 00:26:58] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
[2025-05-16 00:26:58] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
[2025-05-16 00:26:58] [ERROR] エラーコード: 23000
[2025-05-16 00:26:58] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
)

[2025-05-16 00:26:58] [ERROR] SQLステート: 23000
[2025-05-16 00:26:58] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-16 00:26:58] [ERROR] スタックトレース: #0 {main}
[2025-05-16 00:26:58] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-16 00:26:58] [ERROR] スタックトレース: #0 {main}
[2025-05-16 00:26:58] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-16 00:26:58] [INFO] エラーJSONレスポンスを送信完了
[2025-05-16 00:26:58] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-16 00:26:58] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-16 00:26:58] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-16 00:26:58] [DEBUG] 出力バッファをフラッシュします
[2025-05-16 00:26:58] [INFO] 処理完了
[2025-05-16 00:26:58] [INFO] --- 登録API処理開始 ---
[2025-05-16 00:26:58] [INFO] リクエスト元IPアドレス: 222.224.253.151
[2025-05-16 00:26:58] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI2YWE4YWQwN2NkMmFhYWRjYzY1NmY3ZTIxMzljY2U4YjhjNGE2YzgxYzI5MDQyZjQ4MTY4MDY3MmZkMDNjOTY5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTY1N2IyNDBmYzY1NDM2ZDk4NmM0ZDJkYmY5YmI5ZmExIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzMyNTg1NSwiaWF0IjoxNzQ3MzIyMjU1LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44Gy44KN44GNIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoMzZwQi1zTUdiQmxOTzNrckYtd1RUbkYtWW5RNkZXcFJOVjF6ZldBOE1TMWhDQzFJY3c0bGVqOW9NaXBsRGlJYUl3cDJlenBwTkNvMCJ9._UkM-Uc6yCR3CA7VKcYC7EgIX2rdoBGMrzJAI24MvBVoJtqvjixTNEi-BHRB45tjBK9VXpxg9iRyx-fqg42Ruw","room_number":"fg#01","user_name":"ひろき","check_in":"2025-05-16","check_out":"2025-05-17","check_out_time":"11:00","force":true}
[2025-05-16 00:26:58] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI2YWE4YWQwN2NkMmFhYWRjYzY1NmY3ZTIxMzljY2U4YjhjNGE2YzgxYzI5MDQyZjQ4MTY4MDY3MmZkMDNjOTY5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTY1N2IyNDBmYzY1NDM2ZDk4NmM0ZDJkYmY5YmI5ZmExIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzMyNTg1NSwiaWF0IjoxNzQ3MzIyMjU1LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44Gy44KN44GNIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoMzZwQi1zTUdiQmxOTzNrckYtd1RUbkYtWW5RNkZXcFJOVjF6ZldBOE1TMWhDQzFJY3c0bGVqOW9NaXBsRGlJYUl3cDJlenBwTkNvMCJ9._UkM-Uc6yCR3CA7VKcYC7EgIX2rdoBGMrzJAI24MvBVoJtqvjixTNEi-BHRB45tjBK9VXpxg9iRyx-fqg42Ruw
    [room_number] => fg#01
    [user_name] => ひろき
    [check_in] => 2025-05-16
    [check_out] => 2025-05-17
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-16 00:26:58] [INFO] forceフラグ: true
[2025-05-16 00:26:58] [INFO] 処理パラメータ: room=fg#01, user=ひろき, checkIn=2025-05-16, checkOut=2025-05-17
[2025-05-16 00:26:58] [INFO] IDトークンを検証: eyJraWQiOiI2YWE4YWQw...
[2025-05-16 00:26:58] [DEBUG] トークン検証開始: eyJraWQiOiI2YWE4YWQw...
[2025-05-16 00:26:58] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U657b240fc65436d986c4d2dbf9bb9fa1
    [aud] => 2007363986
    [exp] => 1747325855
    [iat] => 1747322255
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => ひろき
    [picture] => https://profile.line-scdn.net/0h36pB-sMGbBlNO3krF-wTTnF-YnQ6FWpRNV1zfWA8MS1hCC1Icw4lej9oMiplDiIaIwp2ezppNCo0
)

[2025-05-16 00:26:58] [INFO] トークン検証成功: ユーザーID U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-16 00:26:58] [INFO] IDトークン検証成功: userId=U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-16 00:26:58] [INFO] データベース接続を開始します
[2025-05-16 00:26:58] [INFO] データベース接続成功
[2025-05-16 00:26:58] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-16 00:26:58] [INFO] line_room_linksテーブルが存在します
[2025-05-16 00:26:58] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-16 00:26:58] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-16 00:26:58] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=98 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-16 00:26:58] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-16 00:26:58] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 17:03:33"}
[2025-05-16 00:26:58] [INFO] トランザクション開始
[2025-05-16 00:26:58] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-16 00:26:58] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-16 00:26:58] [INFO] 部屋検索クエリ実行完了
[2025-05-16 00:26:58] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-16 00:26:58] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-16 00:26:58] [DEBUG] パラメータバインド: userId=U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-16 00:26:58] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-16 00:26:58] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-16 00:26:58] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-16 00:26:58] [INFO] 非アクティブ化した登録数: 1
[2025-05-16 00:26:58] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-16 00:26:58] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-16 00:26:58] [DEBUG] プリペアドステートメント作成成功
[2025-05-16 00:26:58] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-16, checkOut=2025-05-09
[2025-05-16 00:26:58] [DEBUG] パラメータバインド完了: userId=U657b240fc65436d986c4d2dbf9bb9fa1, roomNumber=fg#01, userName=ひろき, checkInDate=2025-05-16, checkOutDate=2025-05-09
[2025-05-16 00:26:58] [INFO] SQLを実行します
[2025-05-16 00:26:58] [DEBUG] 挿入予定の値: {"line_user_id":"U657b240fc65436d986c4d2dbf9bb9fa1","room_number":"fg#01","user_name":"\u3072\u308d\u304d","check_in_date":"2025-05-16","check_out_date":"2025-05-09"}
[2025-05-16 00:26:58] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-16 00:26:58] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
[2025-05-16 00:26:58] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
[2025-05-16 00:26:58] [ERROR] エラーコード: 23000
[2025-05-16 00:26:58] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
)

[2025-05-16 00:26:58] [ERROR] SQLステート: 23000
[2025-05-16 00:26:58] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-16 00:26:58] [INFO] 重複したユーザーIDの既存レコードを発見: ID=30
[2025-05-16 00:26:58] [INFO] 重複ユーザーの登録情報を更新しました: ID=30
[2025-05-16 00:26:58] [INFO] トランザクションコミット成功
[2025-05-16 00:26:58] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":30,"registration_type":"updated"}
[2025-05-16 00:26:58] [INFO] JSONレスポンスを送信完了
[2025-05-16 00:26:58] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":30,"registration_type":"updated"}
2025-05-16 00:26:58 - ユーザーID: U657b240fc65436d986c4d2dbf9bb9fa1 - 部屋番号更新 - 部屋: fg#01 - 期間: 2025-05-16 から 2025-05-09
[2025-05-16 00:26:58] [DEBUG] 出力バッファに170バイトのデータがあります
[2025-05-16 00:26:58] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":30,"registration_type":"updated"}
[2025-05-16 00:26:58] [DEBUG] 出力バッファをフラッシュします
[2025-05-16 00:26:58] [INFO] 処理完了
[2025-05-16 19:18:27] [INFO] --- 登録API処理開始 ---
[2025-05-16 19:18:27] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-16 19:18:28] [INFO] --- 登録API処理開始 ---
[2025-05-16 19:18:28] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-16 19:18:28] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJjNmYzNGU4NjNkM2U1ZTMyYmEzMjA4MTQwMmQ4YjNlMTBlOGVkYjYzODU2OGE1N2IyNzE2YzBmMzBmNTY3MTAzIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTllMWY1YzY2YjRhMjZmZDBjMzNjODkwYWQ4MjZiMTkyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzM5NDI4MiwiaWF0IjoxNzQ3MzkwNjgyLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi5YCJ55Sw5p-a5pyJIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoV2Q0Z0hnRUZDRXNKSGliallxdDNIRFZiQmlaLU1BNERjU3hGZmkwWVhub2lLaGhPWm5BU0pId1hCQzV4TFVvWk1Tc1FMU3RNWG41dyJ9.JZyoI7GLWlPAjZa9qKtidfB2bSlAAIXnWrBPwRXBxhYTLlW9lBLbEjpOGfsbASU3z_h7ptnuO_R5Q-iB37xrOg","room_number":"fg#09","user_name":"倉田柚有","check_in":"2025-05-16","check_out":"2025-05-17","check_out_time":"11:00"}
[2025-05-16 19:18:28] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJjNmYzNGU4NjNkM2U1ZTMyYmEzMjA4MTQwMmQ4YjNlMTBlOGVkYjYzODU2OGE1N2IyNzE2YzBmMzBmNTY3MTAzIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTllMWY1YzY2YjRhMjZmZDBjMzNjODkwYWQ4MjZiMTkyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzM5NDI4MiwiaWF0IjoxNzQ3MzkwNjgyLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi5YCJ55Sw5p-a5pyJIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoV2Q0Z0hnRUZDRXNKSGliallxdDNIRFZiQmlaLU1BNERjU3hGZmkwWVhub2lLaGhPWm5BU0pId1hCQzV4TFVvWk1Tc1FMU3RNWG41dyJ9.JZyoI7GLWlPAjZa9qKtidfB2bSlAAIXnWrBPwRXBxhYTLlW9lBLbEjpOGfsbASU3z_h7ptnuO_R5Q-iB37xrOg
    [room_number] => fg#09
    [user_name] => 倉田柚有
    [check_in] => 2025-05-16
    [check_out] => 2025-05-17
    [check_out_time] => 11:00
)

[2025-05-16 19:18:28] [INFO] forceフラグ: false
[2025-05-16 19:18:28] [INFO] 処理パラメータ: room=fg#09, user=倉田柚有, checkIn=2025-05-16, checkOut=2025-05-17
[2025-05-16 19:18:28] [INFO] IDトークンを検証: eyJraWQiOiJjNmYzNGU4...
[2025-05-16 19:18:28] [DEBUG] トークン検証開始: eyJraWQiOiJjNmYzNGU4...
[2025-05-16 19:18:28] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U9e1f5c66b4a26fd0c33c890ad826b192
    [aud] => 2007363986
    [exp] => 1747394282
    [iat] => 1747390682
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => 倉田柚有
    [picture] => https://profile.line-scdn.net/0hWd4gHgEFCEsJHibjYqt3HDVbBiZ-MA4DcSxFfi0YXnoiKhhOZnASJHwXBC5xLUoZMSsQLStMXn5w
)

[2025-05-16 19:18:28] [INFO] トークン検証成功: ユーザーID U9e1f5c66b4a26fd0c33c890ad826b192
[2025-05-16 19:18:28] [INFO] IDトークン検証成功: userId=U9e1f5c66b4a26fd0c33c890ad826b192
[2025-05-16 19:18:28] [INFO] データベース接続を開始します
[2025-05-16 19:18:28] [INFO] データベース接続成功
[2025-05-16 19:18:28] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-16 19:18:28] [INFO] line_room_linksテーブルが存在します
[2025-05-16 19:18:28] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-16 19:18:28] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-16 19:18:28] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=100 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-16 19:18:28] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-16 19:18:28] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 17:03:33"}
[2025-05-16 19:18:28] [INFO] トランザクション開始
[2025-05-16 19:18:28] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-16 19:18:28] [DEBUG] パラメータバインド: roomNumber=fg#09
[2025-05-16 19:18:28] [INFO] 部屋検索クエリ実行完了
[2025-05-16 19:18:28] [INFO] 部屋検索結果: 部屋あり ID=9, アクティブ=1
[2025-05-16 19:18:28] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-16 19:18:28] [DEBUG] パラメータバインド: userId=U9e1f5c66b4a26fd0c33c890ad826b192
[2025-05-16 19:18:28] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-16 19:18:28] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-16 19:18:28] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-16 19:18:28] [INFO] 非アクティブ化した登録数: 0
[2025-05-16 19:18:28] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-16 19:18:28] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-16 19:18:28] [DEBUG] プリペアドステートメント作成成功
[2025-05-16 19:18:28] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-16, checkOut=2025-05-07
[2025-05-16 19:18:28] [DEBUG] パラメータバインド完了: userId=U9e1f5c66b4a26fd0c33c890ad826b192, roomNumber=fg#09, userName=倉田柚有, checkInDate=2025-05-16, checkOutDate=2025-05-07
[2025-05-16 19:18:28] [INFO] SQLを実行します
[2025-05-16 19:18:28] [DEBUG] 挿入予定の値: {"line_user_id":"U9e1f5c66b4a26fd0c33c890ad826b192","room_number":"fg#09","user_name":"\u5009\u7530\u67da\u6709","check_in_date":"2025-05-16","check_out_date":"2025-05-07"}
[2025-05-16 19:18:28] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-16 19:18:28] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U9e1f5c66b4a26fd0c33c890ad826b192' for key 'line_room_links.line_user_id'
[2025-05-16 19:18:28] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U9e1f5c66b4a26fd0c33c890ad826b192' for key 'line_room_links.line_user_id'
[2025-05-16 19:18:28] [ERROR] エラーコード: 23000
[2025-05-16 19:18:28] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U9e1f5c66b4a26fd0c33c890ad826b192' for key 'line_room_links.line_user_id'
)

[2025-05-16 19:18:28] [ERROR] SQLステート: 23000
[2025-05-16 19:18:28] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-16 19:18:28] [ERROR] スタックトレース: #0 {main}
[2025-05-16 19:18:28] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-16 19:18:28] [ERROR] スタックトレース: #0 {main}
[2025-05-16 19:18:28] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-16 19:18:28] [INFO] エラーJSONレスポンスを送信完了
[2025-05-16 19:18:28] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-16 19:18:28] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-16 19:18:28] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-16 19:18:28] [DEBUG] 出力バッファをフラッシュします
[2025-05-16 19:18:28] [INFO] 処理完了
[2025-05-16 19:18:28] [INFO] --- 登録API処理開始 ---
[2025-05-16 19:18:28] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-16 19:18:28] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJjNmYzNGU4NjNkM2U1ZTMyYmEzMjA4MTQwMmQ4YjNlMTBlOGVkYjYzODU2OGE1N2IyNzE2YzBmMzBmNTY3MTAzIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTllMWY1YzY2YjRhMjZmZDBjMzNjODkwYWQ4MjZiMTkyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzM5NDI4MiwiaWF0IjoxNzQ3MzkwNjgyLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi5YCJ55Sw5p-a5pyJIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoV2Q0Z0hnRUZDRXNKSGliallxdDNIRFZiQmlaLU1BNERjU3hGZmkwWVhub2lLaGhPWm5BU0pId1hCQzV4TFVvWk1Tc1FMU3RNWG41dyJ9.JZyoI7GLWlPAjZa9qKtidfB2bSlAAIXnWrBPwRXBxhYTLlW9lBLbEjpOGfsbASU3z_h7ptnuO_R5Q-iB37xrOg","room_number":"fg#09","user_name":"倉田柚有","check_in":"2025-05-16","check_out":"2025-05-17","check_out_time":"11:00","force":true}
[2025-05-16 19:18:28] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJjNmYzNGU4NjNkM2U1ZTMyYmEzMjA4MTQwMmQ4YjNlMTBlOGVkYjYzODU2OGE1N2IyNzE2YzBmMzBmNTY3MTAzIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTllMWY1YzY2YjRhMjZmZDBjMzNjODkwYWQ4MjZiMTkyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzM5NDI4MiwiaWF0IjoxNzQ3MzkwNjgyLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi5YCJ55Sw5p-a5pyJIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoV2Q0Z0hnRUZDRXNKSGliallxdDNIRFZiQmlaLU1BNERjU3hGZmkwWVhub2lLaGhPWm5BU0pId1hCQzV4TFVvWk1Tc1FMU3RNWG41dyJ9.JZyoI7GLWlPAjZa9qKtidfB2bSlAAIXnWrBPwRXBxhYTLlW9lBLbEjpOGfsbASU3z_h7ptnuO_R5Q-iB37xrOg
    [room_number] => fg#09
    [user_name] => 倉田柚有
    [check_in] => 2025-05-16
    [check_out] => 2025-05-17
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-16 19:18:28] [INFO] forceフラグ: true
[2025-05-16 19:18:28] [INFO] 処理パラメータ: room=fg#09, user=倉田柚有, checkIn=2025-05-16, checkOut=2025-05-17
[2025-05-16 19:18:28] [INFO] IDトークンを検証: eyJraWQiOiJjNmYzNGU4...
[2025-05-16 19:18:28] [DEBUG] トークン検証開始: eyJraWQiOiJjNmYzNGU4...
[2025-05-16 19:18:28] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U9e1f5c66b4a26fd0c33c890ad826b192
    [aud] => 2007363986
    [exp] => 1747394282
    [iat] => 1747390682
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => 倉田柚有
    [picture] => https://profile.line-scdn.net/0hWd4gHgEFCEsJHibjYqt3HDVbBiZ-MA4DcSxFfi0YXnoiKhhOZnASJHwXBC5xLUoZMSsQLStMXn5w
)

[2025-05-16 19:18:28] [INFO] トークン検証成功: ユーザーID U9e1f5c66b4a26fd0c33c890ad826b192
[2025-05-16 19:18:28] [INFO] IDトークン検証成功: userId=U9e1f5c66b4a26fd0c33c890ad826b192
[2025-05-16 19:18:28] [INFO] データベース接続を開始します
[2025-05-16 19:18:28] [INFO] データベース接続成功
[2025-05-16 19:18:28] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-16 19:18:28] [INFO] line_room_linksテーブルが存在します
[2025-05-16 19:18:28] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-16 19:18:28] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-16 19:18:28] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=102 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-16 19:18:28] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-16 19:18:28] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 17:03:33"}
[2025-05-16 19:18:28] [INFO] トランザクション開始
[2025-05-16 19:18:28] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-16 19:18:28] [DEBUG] パラメータバインド: roomNumber=fg#09
[2025-05-16 19:18:28] [INFO] 部屋検索クエリ実行完了
[2025-05-16 19:18:28] [INFO] 部屋検索結果: 部屋あり ID=9, アクティブ=1
[2025-05-16 19:18:28] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-16 19:18:28] [DEBUG] パラメータバインド: userId=U9e1f5c66b4a26fd0c33c890ad826b192
[2025-05-16 19:18:28] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-16 19:18:28] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-16 19:18:28] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-16 19:18:28] [INFO] 非アクティブ化した登録数: 0
[2025-05-16 19:18:28] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-16 19:18:28] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-16 19:18:28] [DEBUG] プリペアドステートメント作成成功
[2025-05-16 19:18:28] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-16, checkOut=2025-05-07
[2025-05-16 19:18:28] [DEBUG] パラメータバインド完了: userId=U9e1f5c66b4a26fd0c33c890ad826b192, roomNumber=fg#09, userName=倉田柚有, checkInDate=2025-05-16, checkOutDate=2025-05-07
[2025-05-16 19:18:28] [INFO] SQLを実行します
[2025-05-16 19:18:28] [DEBUG] 挿入予定の値: {"line_user_id":"U9e1f5c66b4a26fd0c33c890ad826b192","room_number":"fg#09","user_name":"\u5009\u7530\u67da\u6709","check_in_date":"2025-05-16","check_out_date":"2025-05-07"}
[2025-05-16 19:18:28] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-16 19:18:28] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U9e1f5c66b4a26fd0c33c890ad826b192' for key 'line_room_links.line_user_id'
[2025-05-16 19:18:28] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U9e1f5c66b4a26fd0c33c890ad826b192' for key 'line_room_links.line_user_id'
[2025-05-16 19:18:28] [ERROR] エラーコード: 23000
[2025-05-16 19:18:28] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U9e1f5c66b4a26fd0c33c890ad826b192' for key 'line_room_links.line_user_id'
)

[2025-05-16 19:18:28] [ERROR] SQLステート: 23000
[2025-05-16 19:18:28] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-16 19:18:28] [INFO] 重複したユーザーIDの既存レコードを発見: ID=9
[2025-05-16 19:18:28] [INFO] 重複ユーザーの登録情報を更新しました: ID=9
[2025-05-16 19:18:28] [INFO] トランザクションコミット成功
[2025-05-16 19:18:28] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":9,"registration_type":"updated"}
[2025-05-16 19:18:28] [INFO] JSONレスポンスを送信完了
[2025-05-16 19:18:28] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":9,"registration_type":"updated"}
2025-05-16 19:18:28 - ユーザーID: U9e1f5c66b4a26fd0c33c890ad826b192 - 部屋番号更新 - 部屋: fg#09 - 期間: 2025-05-16 から 2025-05-07
[2025-05-16 19:18:28] [DEBUG] 出力バッファに169バイトのデータがあります
[2025-05-16 19:18:28] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":9,"registration_type":"updated"}
[2025-05-16 19:18:28] [DEBUG] 出力バッファをフラッシュします
[2025-05-16 19:18:28] [INFO] 処理完了
[2025-05-16 19:37:27] [INFO] --- 登録API処理開始 ---
[2025-05-16 19:37:27] [INFO] リクエスト元IPアドレス: 222.224.253.151
[2025-05-16 19:37:27] [INFO] --- 登録API処理開始 ---
[2025-05-16 19:37:27] [INFO] リクエスト元IPアドレス: 222.224.253.151
[2025-05-16 19:37:27] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiIyNmNmMzk1ZjQ4MTYyZTRhMzc3MzM5Yjk1MjBjNzA2NzI5ZTFmZGMzYTY0NWI3YTlhZTc3YWMyYTQ4NzVhODA4IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTY1N2IyNDBmYzY1NDM2ZDk4NmM0ZDJkYmY5YmI5ZmExIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzM5NTM2OCwiaWF0IjoxNzQ3MzkxNzY4LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44Gy44KN44GNIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoMzZwQi1zTUdiQmxOTzNrckYtd1RUbkYtWW5RNkZXcFJOVjF6ZldBOE1TMWhDQzFJY3c0bGVqOW9NaXBsRGlJYUl3cDJlenBwTkNvMCJ9.7IlMZ4ESfkqxmb41kGrF2rSRjF3yt_68W6GWCPms3wrlBmmfTbUvhqqsLEYLGyp6S5JU8Mn_i5zt0GyHgf0tYw","room_number":"fg#01","user_name":"ひろき","check_in":"2025-05-16","check_out":"2025-05-17","check_out_time":"11:00"}
[2025-05-16 19:37:27] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiIyNmNmMzk1ZjQ4MTYyZTRhMzc3MzM5Yjk1MjBjNzA2NzI5ZTFmZGMzYTY0NWI3YTlhZTc3YWMyYTQ4NzVhODA4IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTY1N2IyNDBmYzY1NDM2ZDk4NmM0ZDJkYmY5YmI5ZmExIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzM5NTM2OCwiaWF0IjoxNzQ3MzkxNzY4LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44Gy44KN44GNIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoMzZwQi1zTUdiQmxOTzNrckYtd1RUbkYtWW5RNkZXcFJOVjF6ZldBOE1TMWhDQzFJY3c0bGVqOW9NaXBsRGlJYUl3cDJlenBwTkNvMCJ9.7IlMZ4ESfkqxmb41kGrF2rSRjF3yt_68W6GWCPms3wrlBmmfTbUvhqqsLEYLGyp6S5JU8Mn_i5zt0GyHgf0tYw
    [room_number] => fg#01
    [user_name] => ひろき
    [check_in] => 2025-05-16
    [check_out] => 2025-05-17
    [check_out_time] => 11:00
)

[2025-05-16 19:37:27] [INFO] forceフラグ: false
[2025-05-16 19:37:27] [INFO] 処理パラメータ: room=fg#01, user=ひろき, checkIn=2025-05-16, checkOut=2025-05-17
[2025-05-16 19:37:27] [INFO] IDトークンを検証: eyJraWQiOiIyNmNmMzk1...
[2025-05-16 19:37:27] [DEBUG] トークン検証開始: eyJraWQiOiIyNmNmMzk1...
[2025-05-16 19:37:27] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U657b240fc65436d986c4d2dbf9bb9fa1
    [aud] => 2007363986
    [exp] => 1747395368
    [iat] => 1747391768
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => ひろき
    [picture] => https://profile.line-scdn.net/0h36pB-sMGbBlNO3krF-wTTnF-YnQ6FWpRNV1zfWA8MS1hCC1Icw4lej9oMiplDiIaIwp2ezppNCo0
)

[2025-05-16 19:37:27] [INFO] トークン検証成功: ユーザーID U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-16 19:37:27] [INFO] IDトークン検証成功: userId=U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-16 19:37:27] [INFO] データベース接続を開始します
[2025-05-16 19:37:27] [INFO] データベース接続成功
[2025-05-16 19:37:27] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-16 19:37:27] [INFO] line_room_linksテーブルが存在します
[2025-05-16 19:37:27] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-16 19:37:27] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-16 19:37:27] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=104 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-16 19:37:27] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-16 19:37:27] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 17:03:33"}
[2025-05-16 19:37:27] [INFO] トランザクション開始
[2025-05-16 19:37:27] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-16 19:37:27] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-16 19:37:27] [INFO] 部屋検索クエリ実行完了
[2025-05-16 19:37:27] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-16 19:37:27] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-16 19:37:27] [DEBUG] パラメータバインド: userId=U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-16 19:37:27] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-16 19:37:27] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-16 19:37:27] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-16 19:37:27] [INFO] 非アクティブ化した登録数: 1
[2025-05-16 19:37:27] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-16 19:37:27] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-16 19:37:27] [DEBUG] プリペアドステートメント作成成功
[2025-05-16 19:37:27] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-16, checkOut=2025-05-09
[2025-05-16 19:37:27] [DEBUG] パラメータバインド完了: userId=U657b240fc65436d986c4d2dbf9bb9fa1, roomNumber=fg#01, userName=ひろき, checkInDate=2025-05-16, checkOutDate=2025-05-09
[2025-05-16 19:37:27] [INFO] SQLを実行します
[2025-05-16 19:37:27] [DEBUG] 挿入予定の値: {"line_user_id":"U657b240fc65436d986c4d2dbf9bb9fa1","room_number":"fg#01","user_name":"\u3072\u308d\u304d","check_in_date":"2025-05-16","check_out_date":"2025-05-09"}
[2025-05-16 19:37:27] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-16 19:37:27] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
[2025-05-16 19:37:27] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
[2025-05-16 19:37:27] [ERROR] エラーコード: 23000
[2025-05-16 19:37:27] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
)

[2025-05-16 19:37:27] [ERROR] SQLステート: 23000
[2025-05-16 19:37:27] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-16 19:37:27] [ERROR] スタックトレース: #0 {main}
[2025-05-16 19:37:27] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-16 19:37:27] [ERROR] スタックトレース: #0 {main}
[2025-05-16 19:37:27] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-16 19:37:27] [INFO] エラーJSONレスポンスを送信完了
[2025-05-16 19:37:27] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-16 19:37:27] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-16 19:37:27] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-16 19:37:27] [DEBUG] 出力バッファをフラッシュします
[2025-05-16 19:37:27] [INFO] 処理完了
[2025-05-16 19:37:27] [INFO] --- 登録API処理開始 ---
[2025-05-16 19:37:27] [INFO] リクエスト元IPアドレス: 222.224.253.151
[2025-05-16 19:37:27] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiIyNmNmMzk1ZjQ4MTYyZTRhMzc3MzM5Yjk1MjBjNzA2NzI5ZTFmZGMzYTY0NWI3YTlhZTc3YWMyYTQ4NzVhODA4IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTY1N2IyNDBmYzY1NDM2ZDk4NmM0ZDJkYmY5YmI5ZmExIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzM5NTM2OCwiaWF0IjoxNzQ3MzkxNzY4LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44Gy44KN44GNIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoMzZwQi1zTUdiQmxOTzNrckYtd1RUbkYtWW5RNkZXcFJOVjF6ZldBOE1TMWhDQzFJY3c0bGVqOW9NaXBsRGlJYUl3cDJlenBwTkNvMCJ9.7IlMZ4ESfkqxmb41kGrF2rSRjF3yt_68W6GWCPms3wrlBmmfTbUvhqqsLEYLGyp6S5JU8Mn_i5zt0GyHgf0tYw","room_number":"fg#01","user_name":"ひろき","check_in":"2025-05-16","check_out":"2025-05-17","check_out_time":"11:00","force":true}
[2025-05-16 19:37:27] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiIyNmNmMzk1ZjQ4MTYyZTRhMzc3MzM5Yjk1MjBjNzA2NzI5ZTFmZGMzYTY0NWI3YTlhZTc3YWMyYTQ4NzVhODA4IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTY1N2IyNDBmYzY1NDM2ZDk4NmM0ZDJkYmY5YmI5ZmExIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzM5NTM2OCwiaWF0IjoxNzQ3MzkxNzY4LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44Gy44KN44GNIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoMzZwQi1zTUdiQmxOTzNrckYtd1RUbkYtWW5RNkZXcFJOVjF6ZldBOE1TMWhDQzFJY3c0bGVqOW9NaXBsRGlJYUl3cDJlenBwTkNvMCJ9.7IlMZ4ESfkqxmb41kGrF2rSRjF3yt_68W6GWCPms3wrlBmmfTbUvhqqsLEYLGyp6S5JU8Mn_i5zt0GyHgf0tYw
    [room_number] => fg#01
    [user_name] => ひろき
    [check_in] => 2025-05-16
    [check_out] => 2025-05-17
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-16 19:37:27] [INFO] forceフラグ: true
[2025-05-16 19:37:27] [INFO] 処理パラメータ: room=fg#01, user=ひろき, checkIn=2025-05-16, checkOut=2025-05-17
[2025-05-16 19:37:27] [INFO] IDトークンを検証: eyJraWQiOiIyNmNmMzk1...
[2025-05-16 19:37:27] [DEBUG] トークン検証開始: eyJraWQiOiIyNmNmMzk1...
[2025-05-16 19:37:27] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U657b240fc65436d986c4d2dbf9bb9fa1
    [aud] => 2007363986
    [exp] => 1747395368
    [iat] => 1747391768
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => ひろき
    [picture] => https://profile.line-scdn.net/0h36pB-sMGbBlNO3krF-wTTnF-YnQ6FWpRNV1zfWA8MS1hCC1Icw4lej9oMiplDiIaIwp2ezppNCo0
)

[2025-05-16 19:37:27] [INFO] トークン検証成功: ユーザーID U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-16 19:37:27] [INFO] IDトークン検証成功: userId=U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-16 19:37:27] [INFO] データベース接続を開始します
[2025-05-16 19:37:27] [INFO] データベース接続成功
[2025-05-16 19:37:27] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-16 19:37:27] [INFO] line_room_linksテーブルが存在します
[2025-05-16 19:37:27] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-16 19:37:27] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-16 19:37:27] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=106 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-16 19:37:27] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-16 19:37:27] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250513105615537721697","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-14 17:03:33"}
[2025-05-16 19:37:27] [INFO] トランザクション開始
[2025-05-16 19:37:27] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-16 19:37:27] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-16 19:37:27] [INFO] 部屋検索クエリ実行完了
[2025-05-16 19:37:27] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-16 19:37:27] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-16 19:37:27] [DEBUG] パラメータバインド: userId=U657b240fc65436d986c4d2dbf9bb9fa1
[2025-05-16 19:37:27] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-16 19:37:27] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-16 19:37:27] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-16 19:37:27] [INFO] 非アクティブ化した登録数: 1
[2025-05-16 19:37:27] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-16 19:37:27] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-16 19:37:27] [DEBUG] プリペアドステートメント作成成功
[2025-05-16 19:37:27] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-16, checkOut=2025-05-09
[2025-05-16 19:37:27] [DEBUG] パラメータバインド完了: userId=U657b240fc65436d986c4d2dbf9bb9fa1, roomNumber=fg#01, userName=ひろき, checkInDate=2025-05-16, checkOutDate=2025-05-09
[2025-05-16 19:37:27] [INFO] SQLを実行します
[2025-05-16 19:37:27] [DEBUG] 挿入予定の値: {"line_user_id":"U657b240fc65436d986c4d2dbf9bb9fa1","room_number":"fg#01","user_name":"\u3072\u308d\u304d","check_in_date":"2025-05-16","check_out_date":"2025-05-09"}
[2025-05-16 19:37:27] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-16 19:37:27] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
[2025-05-16 19:37:27] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
[2025-05-16 19:37:27] [ERROR] エラーコード: 23000
[2025-05-16 19:37:27] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U657b240fc65436d986c4d2dbf9bb9fa1' for key 'line_room_links.line_user_id'
)

[2025-05-16 19:37:27] [ERROR] SQLステート: 23000
[2025-05-16 19:37:27] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-16 19:37:27] [INFO] 重複したユーザーIDの既存レコードを発見: ID=30
[2025-05-16 19:37:27] [INFO] 重複ユーザーの登録情報を更新しました: ID=30
[2025-05-16 19:37:27] [INFO] トランザクションコミット成功
[2025-05-16 19:37:27] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":30,"registration_type":"updated"}
[2025-05-16 19:37:27] [INFO] JSONレスポンスを送信完了
[2025-05-16 19:37:27] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":30,"registration_type":"updated"}
2025-05-16 19:37:27 - ユーザーID: U657b240fc65436d986c4d2dbf9bb9fa1 - 部屋番号更新 - 部屋: fg#01 - 期間: 2025-05-16 から 2025-05-09
[2025-05-16 19:37:27] [DEBUG] 出力バッファに170バイトのデータがあります
[2025-05-16 19:37:27] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":30,"registration_type":"updated"}
[2025-05-16 19:37:27] [DEBUG] 出力バッファをフラッシュします
[2025-05-16 19:37:27] [INFO] 処理完了
[2025-05-20 17:18:22] [INFO] --- 登録API処理開始 ---
[2025-05-20 17:18:22] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-20 17:18:22] [INFO] --- 登録API処理開始 ---
[2025-05-20 17:18:22] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-20 17:18:22] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI3MTU5ZTNlYWUwZjdmMmQ4NjhmM2MwOWI2ZGU5MzBlYzMzNjNlYzA0NTI2ZjQwY2FlYzliMWYwOGUwZjQzY2E2IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTk0MDYzZGY4MWFkYTdhZDczNGJjNmY5OTlhYTU4ZDJhIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzczMDY2MSwiaWF0IjoxNzQ3NzI3MDYxLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi5Y2X6ZuyIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoVzc4aXp3TUhDQmdGRUJqNDAwQjNUemxWQm5WeVBnNVFmWEpHZkNKRVYzOHZjQnRMTVg4WGVTWVNBWHdySTAxT2FpSkNkaUpGVmk5OCJ9.yi2JXKLpKJHlvu4lldlQ8I8dFwpykgpHkk0Jm-O-7v1SPhnuycg0Vfia4baOLJ23f81z2zCy2mtKTIUbFjA8uQ","room_number":"fg#13","user_name":"南雲","check_in":"2025-05-20","check_out":"2025-05-21","check_out_time":"11:00"}
[2025-05-20 17:18:22] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI3MTU5ZTNlYWUwZjdmMmQ4NjhmM2MwOWI2ZGU5MzBlYzMzNjNlYzA0NTI2ZjQwY2FlYzliMWYwOGUwZjQzY2E2IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTk0MDYzZGY4MWFkYTdhZDczNGJjNmY5OTlhYTU4ZDJhIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzczMDY2MSwiaWF0IjoxNzQ3NzI3MDYxLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi5Y2X6ZuyIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoVzc4aXp3TUhDQmdGRUJqNDAwQjNUemxWQm5WeVBnNVFmWEpHZkNKRVYzOHZjQnRMTVg4WGVTWVNBWHdySTAxT2FpSkNkaUpGVmk5OCJ9.yi2JXKLpKJHlvu4lldlQ8I8dFwpykgpHkk0Jm-O-7v1SPhnuycg0Vfia4baOLJ23f81z2zCy2mtKTIUbFjA8uQ
    [room_number] => fg#13
    [user_name] => 南雲
    [check_in] => 2025-05-20
    [check_out] => 2025-05-21
    [check_out_time] => 11:00
)

[2025-05-20 17:18:22] [INFO] forceフラグ: false
[2025-05-20 17:18:22] [INFO] 処理パラメータ: room=fg#13, user=南雲, checkIn=2025-05-20, checkOut=2025-05-21
[2025-05-20 17:18:22] [INFO] IDトークンを検証: eyJraWQiOiI3MTU5ZTNl...
[2025-05-20 17:18:22] [DEBUG] トークン検証開始: eyJraWQiOiI3MTU5ZTNl...
[2025-05-20 17:18:22] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U94063df81ada7ad734bc6f999aa58d2a
    [aud] => 2007363986
    [exp] => 1747730661
    [iat] => 1747727061
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => 南雲
    [picture] => https://profile.line-scdn.net/0hW78izwMHCBgFEBj400B3TzlVBnVyPg5QfXJGfCJEV38vcBtLMX8XeSYSAXwrI01OaiJCdiJFVi98
)

[2025-05-20 17:18:22] [INFO] トークン検証成功: ユーザーID U94063df81ada7ad734bc6f999aa58d2a
[2025-05-20 17:18:22] [INFO] IDトークン検証成功: userId=U94063df81ada7ad734bc6f999aa58d2a
[2025-05-20 17:18:22] [INFO] データベース接続を開始します
[2025-05-20 17:18:22] [INFO] データベース接続成功
[2025-05-20 17:18:22] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-20 17:18:22] [INFO] line_room_linksテーブルが存在します
[2025-05-20 17:18:22] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-20 17:18:22] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-20 17:18:22] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=108 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-20 17:18:22] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-20 17:18:22] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250516193833098604749","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-16 19:38:33"}
[2025-05-20 17:18:22] [INFO] トランザクション開始
[2025-05-20 17:18:22] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-20 17:18:22] [DEBUG] パラメータバインド: roomNumber=fg#13
[2025-05-20 17:18:22] [INFO] 部屋検索クエリ実行完了
[2025-05-20 17:18:22] [INFO] 部屋検索結果: 部屋あり ID=13, アクティブ=1
[2025-05-20 17:18:22] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-20 17:18:22] [DEBUG] パラメータバインド: userId=U94063df81ada7ad734bc6f999aa58d2a
[2025-05-20 17:18:22] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-20 17:18:22] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-20 17:18:22] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-20 17:18:22] [INFO] 非アクティブ化した登録数: 1
[2025-05-20 17:18:22] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-20 17:18:22] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-20 17:18:22] [DEBUG] プリペアドステートメント作成成功
[2025-05-20 17:18:22] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-20, checkOut=2025-05-06
[2025-05-20 17:18:22] [DEBUG] パラメータバインド完了: userId=U94063df81ada7ad734bc6f999aa58d2a, roomNumber=fg#13, userName=南雲, checkInDate=2025-05-20, checkOutDate=2025-05-06
[2025-05-20 17:18:22] [INFO] SQLを実行します
[2025-05-20 17:18:22] [DEBUG] 挿入予定の値: {"line_user_id":"U94063df81ada7ad734bc6f999aa58d2a","room_number":"fg#13","user_name":"\u5357\u96f2","check_in_date":"2025-05-20","check_out_date":"2025-05-06"}
[2025-05-20 17:18:22] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-20 17:18:22] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U94063df81ada7ad734bc6f999aa58d2a' for key 'line_room_links.line_user_id'
[2025-05-20 17:18:22] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U94063df81ada7ad734bc6f999aa58d2a' for key 'line_room_links.line_user_id'
[2025-05-20 17:18:22] [ERROR] エラーコード: 23000
[2025-05-20 17:18:22] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U94063df81ada7ad734bc6f999aa58d2a' for key 'line_room_links.line_user_id'
)

[2025-05-20 17:18:22] [ERROR] SQLステート: 23000
[2025-05-20 17:18:22] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-20 17:18:22] [ERROR] スタックトレース: #0 {main}
[2025-05-20 17:18:22] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-20 17:18:22] [ERROR] スタックトレース: #0 {main}
[2025-05-20 17:18:22] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-20 17:18:22] [INFO] エラーJSONレスポンスを送信完了
[2025-05-20 17:18:22] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-20 17:18:22] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-20 17:18:22] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-20 17:18:22] [DEBUG] 出力バッファをフラッシュします
[2025-05-20 17:18:22] [INFO] 処理完了
[2025-05-20 17:18:22] [INFO] --- 登録API処理開始 ---
[2025-05-20 17:18:22] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-20 17:18:22] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI3MTU5ZTNlYWUwZjdmMmQ4NjhmM2MwOWI2ZGU5MzBlYzMzNjNlYzA0NTI2ZjQwY2FlYzliMWYwOGUwZjQzY2E2IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTk0MDYzZGY4MWFkYTdhZDczNGJjNmY5OTlhYTU4ZDJhIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzczMDY2MSwiaWF0IjoxNzQ3NzI3MDYxLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi5Y2X6ZuyIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoVzc4aXp3TUhDQmdGRUJqNDAwQjNUemxWQm5WeVBnNVFmWEpHZkNKRVYzOHZjQnRMTVg4WGVTWVNBWHdySTAxT2FpSkNkaUpGVmk5OCJ9.yi2JXKLpKJHlvu4lldlQ8I8dFwpykgpHkk0Jm-O-7v1SPhnuycg0Vfia4baOLJ23f81z2zCy2mtKTIUbFjA8uQ","room_number":"fg#13","user_name":"南雲","check_in":"2025-05-20","check_out":"2025-05-21","check_out_time":"11:00","force":true}
[2025-05-20 17:18:22] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI3MTU5ZTNlYWUwZjdmMmQ4NjhmM2MwOWI2ZGU5MzBlYzMzNjNlYzA0NTI2ZjQwY2FlYzliMWYwOGUwZjQzY2E2IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTk0MDYzZGY4MWFkYTdhZDczNGJjNmY5OTlhYTU4ZDJhIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0NzczMDY2MSwiaWF0IjoxNzQ3NzI3MDYxLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi5Y2X6ZuyIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoVzc4aXp3TUhDQmdGRUJqNDAwQjNUemxWQm5WeVBnNVFmWEpHZkNKRVYzOHZjQnRMTVg4WGVTWVNBWHdySTAxT2FpSkNkaUpGVmk5OCJ9.yi2JXKLpKJHlvu4lldlQ8I8dFwpykgpHkk0Jm-O-7v1SPhnuycg0Vfia4baOLJ23f81z2zCy2mtKTIUbFjA8uQ
    [room_number] => fg#13
    [user_name] => 南雲
    [check_in] => 2025-05-20
    [check_out] => 2025-05-21
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-20 17:18:22] [INFO] forceフラグ: true
[2025-05-20 17:18:22] [INFO] 処理パラメータ: room=fg#13, user=南雲, checkIn=2025-05-20, checkOut=2025-05-21
[2025-05-20 17:18:22] [INFO] IDトークンを検証: eyJraWQiOiI3MTU5ZTNl...
[2025-05-20 17:18:22] [DEBUG] トークン検証開始: eyJraWQiOiI3MTU5ZTNl...
[2025-05-20 17:18:22] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U94063df81ada7ad734bc6f999aa58d2a
    [aud] => 2007363986
    [exp] => 1747730661
    [iat] => 1747727061
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => 南雲
    [picture] => https://profile.line-scdn.net/0hW78izwMHCBgFEBj400B3TzlVBnVyPg5QfXJGfCJEV38vcBtLMX8XeSYSAXwrI01OaiJCdiJFVi98
)

[2025-05-20 17:18:22] [INFO] トークン検証成功: ユーザーID U94063df81ada7ad734bc6f999aa58d2a
[2025-05-20 17:18:22] [INFO] IDトークン検証成功: userId=U94063df81ada7ad734bc6f999aa58d2a
[2025-05-20 17:18:22] [INFO] データベース接続を開始します
[2025-05-20 17:18:22] [INFO] データベース接続成功
[2025-05-20 17:18:22] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-20 17:18:22] [INFO] line_room_linksテーブルが存在します
[2025-05-20 17:18:22] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-20 17:18:22] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-20 17:18:22] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=110 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-20 17:18:22] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-20 17:18:22] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250516193833098604749","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-16 19:38:33"}
[2025-05-20 17:18:22] [INFO] トランザクション開始
[2025-05-20 17:18:22] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-20 17:18:22] [DEBUG] パラメータバインド: roomNumber=fg#13
[2025-05-20 17:18:22] [INFO] 部屋検索クエリ実行完了
[2025-05-20 17:18:22] [INFO] 部屋検索結果: 部屋あり ID=13, アクティブ=1
[2025-05-20 17:18:22] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-20 17:18:22] [DEBUG] パラメータバインド: userId=U94063df81ada7ad734bc6f999aa58d2a
[2025-05-20 17:18:22] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-20 17:18:22] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-20 17:18:22] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-20 17:18:22] [INFO] 非アクティブ化した登録数: 1
[2025-05-20 17:18:22] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-20 17:18:22] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-20 17:18:22] [DEBUG] プリペアドステートメント作成成功
[2025-05-20 17:18:22] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-20, checkOut=2025-05-06
[2025-05-20 17:18:22] [DEBUG] パラメータバインド完了: userId=U94063df81ada7ad734bc6f999aa58d2a, roomNumber=fg#13, userName=南雲, checkInDate=2025-05-20, checkOutDate=2025-05-06
[2025-05-20 17:18:22] [INFO] SQLを実行します
[2025-05-20 17:18:22] [DEBUG] 挿入予定の値: {"line_user_id":"U94063df81ada7ad734bc6f999aa58d2a","room_number":"fg#13","user_name":"\u5357\u96f2","check_in_date":"2025-05-20","check_out_date":"2025-05-06"}
[2025-05-20 17:18:22] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-20 17:18:22] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U94063df81ada7ad734bc6f999aa58d2a' for key 'line_room_links.line_user_id'
[2025-05-20 17:18:22] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U94063df81ada7ad734bc6f999aa58d2a' for key 'line_room_links.line_user_id'
[2025-05-20 17:18:22] [ERROR] エラーコード: 23000
[2025-05-20 17:18:22] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U94063df81ada7ad734bc6f999aa58d2a' for key 'line_room_links.line_user_id'
)

[2025-05-20 17:18:22] [ERROR] SQLステート: 23000
[2025-05-20 17:18:22] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-20 17:18:22] [INFO] 重複したユーザーIDの既存レコードを発見: ID=3
[2025-05-20 17:18:22] [INFO] 重複ユーザーの登録情報を更新しました: ID=3
[2025-05-20 17:18:22] [INFO] トランザクションコミット成功
[2025-05-20 17:18:22] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":3,"registration_type":"updated"}
[2025-05-20 17:18:22] [INFO] JSONレスポンスを送信完了
[2025-05-20 17:18:22] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":3,"registration_type":"updated"}
2025-05-20 17:18:22 - ユーザーID: U94063df81ada7ad734bc6f999aa58d2a - 部屋番号更新 - 部屋: fg#13 - 期間: 2025-05-20 から 2025-05-06
[2025-05-20 17:18:22] [DEBUG] 出力バッファに169バイトのデータがあります
[2025-05-20 17:18:22] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":3,"registration_type":"updated"}
[2025-05-20 17:18:22] [DEBUG] 出力バッファをフラッシュします
[2025-05-20 17:18:22] [INFO] 処理完了
[2025-05-27 07:15:34] [INFO] --- 登録API処理開始 ---
[2025-05-27 07:15:34] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-27 07:15:34] [INFO] --- 登録API処理開始 ---
[2025-05-27 07:15:34] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-27 07:15:34] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiIyNmNmMzk1ZjQ4MTYyZTRhMzc3MzM5Yjk1MjBjNzA2NzI5ZTFmZGMzYTY0NWI3YTlhZTc3YWMyYTQ4NzVhODA4IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODMwMTMxOCwiaWF0IjoxNzQ4Mjk3NzE4LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.z4vIAo4F-fmWm7s-XLKwY9x5KRDXsnuLYVpMu875vx7pBOuamK4xRzRuD6xOL19SfgOZs5wBVqPS_I4efPU2kg","room_number":"fg#12","user_name":"くらひで","check_in":"2025-05-27","check_out":"2025-05-28","check_out_time":"11:00"}
[2025-05-27 07:15:34] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiIyNmNmMzk1ZjQ4MTYyZTRhMzc3MzM5Yjk1MjBjNzA2NzI5ZTFmZGMzYTY0NWI3YTlhZTc3YWMyYTQ4NzVhODA4IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODMwMTMxOCwiaWF0IjoxNzQ4Mjk3NzE4LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.z4vIAo4F-fmWm7s-XLKwY9x5KRDXsnuLYVpMu875vx7pBOuamK4xRzRuD6xOL19SfgOZs5wBVqPS_I4efPU2kg
    [room_number] => fg#12
    [user_name] => くらひで
    [check_in] => 2025-05-27
    [check_out] => 2025-05-28
    [check_out_time] => 11:00
)

[2025-05-27 07:15:34] [INFO] forceフラグ: false
[2025-05-27 07:15:34] [INFO] 処理パラメータ: room=fg#12, user=くらひで, checkIn=2025-05-27, checkOut=2025-05-28
[2025-05-27 07:15:34] [INFO] IDトークンを検証: eyJraWQiOiIyNmNmMzk1...
[2025-05-27 07:15:34] [DEBUG] トークン検証開始: eyJraWQiOiIyNmNmMzk1...
[2025-05-27 07:15:34] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748301318
    [iat] => 1748297718
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-27 07:15:34] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-27 07:15:34] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-27 07:15:34] [INFO] データベース接続を開始します
[2025-05-27 07:15:34] [INFO] データベース接続成功
[2025-05-27 07:15:34] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-27 07:15:34] [INFO] line_room_linksテーブルが存在します
[2025-05-27 07:15:34] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-27 07:15:34] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-27 07:15:34] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=190 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-27 07:15:34] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-27 07:15:34] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250516193833098604749","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":0,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-25 10:59:32"}
[2025-05-27 07:15:34] [INFO] トランザクション開始
[2025-05-27 07:15:34] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-27 07:15:34] [DEBUG] パラメータバインド: roomNumber=fg#12
[2025-05-27 07:15:34] [INFO] 部屋検索クエリ実行完了
[2025-05-27 07:15:34] [INFO] 部屋検索結果: 部屋あり ID=12, アクティブ=1
[2025-05-27 07:15:34] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-27 07:15:34] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-27 07:15:34] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-27 07:15:34] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-27 07:15:34] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-27 07:15:34] [INFO] 非アクティブ化した登録数: 0
[2025-05-27 07:15:34] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-27 07:15:34] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-27 07:15:34] [DEBUG] プリペアドステートメント作成成功
[2025-05-27 07:15:34] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-27, checkOut=2025-05-09
[2025-05-27 07:15:34] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#12, userName=くらひで, checkInDate=2025-05-27, checkOutDate=2025-05-09
[2025-05-27 07:15:34] [INFO] SQLを実行します
[2025-05-27 07:15:34] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#12","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-27","check_out_date":"2025-05-09"}
[2025-05-27 07:15:34] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-27 07:15:34] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-27 07:15:34] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-27 07:15:34] [ERROR] エラーコード: 23000
[2025-05-27 07:15:34] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-05-27 07:15:34] [ERROR] SQLステート: 23000
[2025-05-27 07:15:34] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-27 07:15:34] [ERROR] スタックトレース: #0 {main}
[2025-05-27 07:15:34] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-27 07:15:34] [ERROR] スタックトレース: #0 {main}
[2025-05-27 07:15:34] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-27 07:15:34] [INFO] エラーJSONレスポンスを送信完了
[2025-05-27 07:15:34] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-27 07:15:34] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-27 07:15:34] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-27 07:15:34] [DEBUG] 出力バッファをフラッシュします
[2025-05-27 07:15:34] [INFO] 処理完了
[2025-05-27 07:15:34] [INFO] --- 登録API処理開始 ---
[2025-05-27 07:15:34] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-27 07:15:34] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiIyNmNmMzk1ZjQ4MTYyZTRhMzc3MzM5Yjk1MjBjNzA2NzI5ZTFmZGMzYTY0NWI3YTlhZTc3YWMyYTQ4NzVhODA4IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODMwMTMxOCwiaWF0IjoxNzQ4Mjk3NzE4LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.z4vIAo4F-fmWm7s-XLKwY9x5KRDXsnuLYVpMu875vx7pBOuamK4xRzRuD6xOL19SfgOZs5wBVqPS_I4efPU2kg","room_number":"fg#12","user_name":"くらひで","check_in":"2025-05-27","check_out":"2025-05-28","check_out_time":"11:00","force":true}
[2025-05-27 07:15:34] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiIyNmNmMzk1ZjQ4MTYyZTRhMzc3MzM5Yjk1MjBjNzA2NzI5ZTFmZGMzYTY0NWI3YTlhZTc3YWMyYTQ4NzVhODA4IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODMwMTMxOCwiaWF0IjoxNzQ4Mjk3NzE4LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.z4vIAo4F-fmWm7s-XLKwY9x5KRDXsnuLYVpMu875vx7pBOuamK4xRzRuD6xOL19SfgOZs5wBVqPS_I4efPU2kg
    [room_number] => fg#12
    [user_name] => くらひで
    [check_in] => 2025-05-27
    [check_out] => 2025-05-28
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-27 07:15:34] [INFO] forceフラグ: true
[2025-05-27 07:15:34] [INFO] 処理パラメータ: room=fg#12, user=くらひで, checkIn=2025-05-27, checkOut=2025-05-28
[2025-05-27 07:15:34] [INFO] IDトークンを検証: eyJraWQiOiIyNmNmMzk1...
[2025-05-27 07:15:34] [DEBUG] トークン検証開始: eyJraWQiOiIyNmNmMzk1...
[2025-05-27 07:15:34] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748301318
    [iat] => 1748297718
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-27 07:15:34] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-27 07:15:34] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-27 07:15:34] [INFO] データベース接続を開始します
[2025-05-27 07:15:34] [INFO] データベース接続成功
[2025-05-27 07:15:34] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-27 07:15:34] [INFO] line_room_linksテーブルが存在します
[2025-05-27 07:15:34] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-27 07:15:34] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-27 07:15:34] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=192 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-27 07:15:34] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-27 07:15:34] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250516193833098604749","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-14","check_out_date":"2025-05-09","access_token":null,"is_active":0,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-25 10:59:32"}
[2025-05-27 07:15:34] [INFO] トランザクション開始
[2025-05-27 07:15:34] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-27 07:15:34] [DEBUG] パラメータバインド: roomNumber=fg#12
[2025-05-27 07:15:34] [INFO] 部屋検索クエリ実行完了
[2025-05-27 07:15:34] [INFO] 部屋検索結果: 部屋あり ID=12, アクティブ=1
[2025-05-27 07:15:34] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-27 07:15:34] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-27 07:15:34] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-27 07:15:34] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-27 07:15:34] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-27 07:15:34] [INFO] 非アクティブ化した登録数: 0
[2025-05-27 07:15:34] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-27 07:15:34] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-27 07:15:34] [DEBUG] プリペアドステートメント作成成功
[2025-05-27 07:15:34] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-27, checkOut=2025-05-09
[2025-05-27 07:15:34] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#12, userName=くらひで, checkInDate=2025-05-27, checkOutDate=2025-05-09
[2025-05-27 07:15:34] [INFO] SQLを実行します
[2025-05-27 07:15:34] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#12","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-27","check_out_date":"2025-05-09"}
[2025-05-27 07:15:34] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-27 07:15:34] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-27 07:15:34] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-05-27 07:15:34] [ERROR] エラーコード: 23000
[2025-05-27 07:15:34] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-05-27 07:15:34] [ERROR] SQLステート: 23000
[2025-05-27 07:15:34] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-27 07:15:34] [INFO] 重複したユーザーIDの既存レコードを発見: ID=35
[2025-05-27 07:15:34] [INFO] 重複ユーザーの登録情報を更新しました: ID=35
[2025-05-27 07:15:34] [INFO] トランザクションコミット成功
[2025-05-27 07:15:34] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":35,"registration_type":"updated"}
[2025-05-27 07:15:34] [INFO] JSONレスポンスを送信完了
[2025-05-27 07:15:34] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":35,"registration_type":"updated"}
2025-05-27 07:15:34 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#12 - 期間: 2025-05-27 から 2025-05-09
[2025-05-27 07:15:34] [DEBUG] 出力バッファに170バイトのデータがあります
[2025-05-27 07:15:34] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":35,"registration_type":"updated"}
[2025-05-27 07:15:34] [DEBUG] 出力バッファをフラッシュします
[2025-05-27 07:15:34] [INFO] 処理完了
[2025-05-30 16:39:32] [INFO] --- 登録API処理開始 ---
[2025-05-30 16:39:32] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 16:39:32] [INFO] --- 登録API処理開始 ---
[2025-05-30 16:39:32] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 16:39:32] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI5MjkxZTZiNmEzOGM3ZDhhZjY4YzUyNjZmYWEyODIwOGQ2ZGQ1OTg0NWZhYTAyNGU1NDFiZGIzOWZlMTM1ZDRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWVmZjVjNTJmM2UwMDc3ZTZiZjY5NWQ1OTQxNDE0MmVjIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5NDM1OSwiaWF0IjoxNzQ4NTkwNzU5LCJuYW1lIjoid2FzaG8iLCJwaWN0dXJlIjoiaHR0cHM6Ly9wcm9maWxlLmxpbmUtc2Nkbi5uZXQvMG0wMzliMjg5ZDcyNTE4YzZjMWUwNDBlZmFjZWQ3OGE1OWVhM2MwODgyNWUwNSJ9.VhmpmYgEkCyw_xWZhAOYMaZDf5rvuOdzGQHIjnsznFLCS5Ez9hr8MPtgdwxObopKWE7DNkFriEtSwJjMjH9zCQ","room_number":"fg#01","user_name":"washo","check_in":"2025-05-30","check_out":"2025-05-31","check_out_time":"11:00"}
[2025-05-30 16:39:32] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI5MjkxZTZiNmEzOGM3ZDhhZjY4YzUyNjZmYWEyODIwOGQ2ZGQ1OTg0NWZhYTAyNGU1NDFiZGIzOWZlMTM1ZDRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWVmZjVjNTJmM2UwMDc3ZTZiZjY5NWQ1OTQxNDE0MmVjIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5NDM1OSwiaWF0IjoxNzQ4NTkwNzU5LCJuYW1lIjoid2FzaG8iLCJwaWN0dXJlIjoiaHR0cHM6Ly9wcm9maWxlLmxpbmUtc2Nkbi5uZXQvMG0wMzliMjg5ZDcyNTE4YzZjMWUwNDBlZmFjZWQ3OGE1OWVhM2MwODgyNWUwNSJ9.VhmpmYgEkCyw_xWZhAOYMaZDf5rvuOdzGQHIjnsznFLCS5Ez9hr8MPtgdwxObopKWE7DNkFriEtSwJjMjH9zCQ
    [room_number] => fg#01
    [user_name] => washo
    [check_in] => 2025-05-30
    [check_out] => 2025-05-31
    [check_out_time] => 11:00
)

[2025-05-30 16:39:32] [INFO] forceフラグ: false
[2025-05-30 16:39:32] [INFO] 処理パラメータ: room=fg#01, user=washo, checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 16:39:32] [INFO] IDトークンを検証: eyJraWQiOiI5MjkxZTZi...
[2025-05-30 16:39:32] [DEBUG] トークン検証開始: eyJraWQiOiI5MjkxZTZi...
[2025-05-30 16:39:32] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => Ueff5c52f3e0077e6bf695d59414142ec
    [aud] => 2007363986
    [exp] => 1748594359
    [iat] => 1748590759
    [name] => washo
    [picture] => https://profile.line-scdn.net/0m039b289d72518c6c1e040efaced78a59ea3c08825e05
)

[2025-05-30 16:39:32] [INFO] トークン検証成功: ユーザーID Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 16:39:32] [INFO] IDトークン検証成功: userId=Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 16:39:32] [INFO] データベース接続を開始します
[2025-05-30 16:39:32] [INFO] データベース接続成功
[2025-05-30 16:39:32] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-30 16:39:32] [INFO] line_room_linksテーブルが存在します
[2025-05-30 16:39:32] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-30 16:39:32] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-30 16:39:32] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=194 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-30 16:39:32] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-30 16:39:32] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#12","order_session_id":"250530143946756130854","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-27","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-30 14:39:46"}
[2025-05-30 16:39:32] [INFO] トランザクション開始
[2025-05-30 16:39:32] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-30 16:39:32] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-30 16:39:32] [INFO] 部屋検索クエリ実行完了
[2025-05-30 16:39:32] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-30 16:39:32] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-30 16:39:32] [DEBUG] パラメータバインド: userId=Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 16:39:32] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-30 16:39:32] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-30 16:39:32] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-30 16:39:32] [INFO] 非アクティブ化した登録数: 0
[2025-05-30 16:39:32] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-30 16:39:32] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-30 16:39:32] [DEBUG] プリペアドステートメント作成成功
[2025-05-30 16:39:32] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-30, checkOut=2025-05-08
[2025-05-30 16:39:32] [DEBUG] パラメータバインド完了: userId=Ueff5c52f3e0077e6bf695d59414142ec, roomNumber=fg#01, userName=washo, checkInDate=2025-05-30, checkOutDate=2025-05-08
[2025-05-30 16:39:32] [INFO] SQLを実行します
[2025-05-30 16:39:32] [DEBUG] 挿入予定の値: {"line_user_id":"Ueff5c52f3e0077e6bf695d59414142ec","room_number":"fg#01","user_name":"washo","check_in_date":"2025-05-30","check_out_date":"2025-05-08"}
[2025-05-30 16:39:32] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-30 16:39:32] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'Ueff5c52f3e0077e6bf695d59414142ec' for key 'line_room_links.line_user_id'
[2025-05-30 16:39:32] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'Ueff5c52f3e0077e6bf695d59414142ec' for key 'line_room_links.line_user_id'
[2025-05-30 16:39:32] [ERROR] エラーコード: 23000
[2025-05-30 16:39:32] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'Ueff5c52f3e0077e6bf695d59414142ec' for key 'line_room_links.line_user_id'
)

[2025-05-30 16:39:32] [ERROR] SQLステート: 23000
[2025-05-30 16:39:32] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-30 16:39:32] [ERROR] スタックトレース: #0 {main}
[2025-05-30 16:39:32] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-30 16:39:32] [ERROR] スタックトレース: #0 {main}
[2025-05-30 16:39:32] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-30 16:39:32] [INFO] エラーJSONレスポンスを送信完了
[2025-05-30 16:39:32] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-30 16:39:32] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-30 16:39:32] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-30 16:39:32] [DEBUG] 出力バッファをフラッシュします
[2025-05-30 16:39:32] [INFO] 処理完了
[2025-05-30 16:39:32] [INFO] --- 登録API処理開始 ---
[2025-05-30 16:39:32] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 16:39:32] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI5MjkxZTZiNmEzOGM3ZDhhZjY4YzUyNjZmYWEyODIwOGQ2ZGQ1OTg0NWZhYTAyNGU1NDFiZGIzOWZlMTM1ZDRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWVmZjVjNTJmM2UwMDc3ZTZiZjY5NWQ1OTQxNDE0MmVjIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5NDM1OSwiaWF0IjoxNzQ4NTkwNzU5LCJuYW1lIjoid2FzaG8iLCJwaWN0dXJlIjoiaHR0cHM6Ly9wcm9maWxlLmxpbmUtc2Nkbi5uZXQvMG0wMzliMjg5ZDcyNTE4YzZjMWUwNDBlZmFjZWQ3OGE1OWVhM2MwODgyNWUwNSJ9.VhmpmYgEkCyw_xWZhAOYMaZDf5rvuOdzGQHIjnsznFLCS5Ez9hr8MPtgdwxObopKWE7DNkFriEtSwJjMjH9zCQ","room_number":"fg#01","user_name":"washo","check_in":"2025-05-30","check_out":"2025-05-31","check_out_time":"11:00","force":true}
[2025-05-30 16:39:32] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI5MjkxZTZiNmEzOGM3ZDhhZjY4YzUyNjZmYWEyODIwOGQ2ZGQ1OTg0NWZhYTAyNGU1NDFiZGIzOWZlMTM1ZDRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWVmZjVjNTJmM2UwMDc3ZTZiZjY5NWQ1OTQxNDE0MmVjIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5NDM1OSwiaWF0IjoxNzQ4NTkwNzU5LCJuYW1lIjoid2FzaG8iLCJwaWN0dXJlIjoiaHR0cHM6Ly9wcm9maWxlLmxpbmUtc2Nkbi5uZXQvMG0wMzliMjg5ZDcyNTE4YzZjMWUwNDBlZmFjZWQ3OGE1OWVhM2MwODgyNWUwNSJ9.VhmpmYgEkCyw_xWZhAOYMaZDf5rvuOdzGQHIjnsznFLCS5Ez9hr8MPtgdwxObopKWE7DNkFriEtSwJjMjH9zCQ
    [room_number] => fg#01
    [user_name] => washo
    [check_in] => 2025-05-30
    [check_out] => 2025-05-31
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-30 16:39:32] [INFO] forceフラグ: true
[2025-05-30 16:39:32] [INFO] 処理パラメータ: room=fg#01, user=washo, checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 16:39:32] [INFO] IDトークンを検証: eyJraWQiOiI5MjkxZTZi...
[2025-05-30 16:39:32] [DEBUG] トークン検証開始: eyJraWQiOiI5MjkxZTZi...
[2025-05-30 16:39:32] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => Ueff5c52f3e0077e6bf695d59414142ec
    [aud] => 2007363986
    [exp] => 1748594359
    [iat] => 1748590759
    [name] => washo
    [picture] => https://profile.line-scdn.net/0m039b289d72518c6c1e040efaced78a59ea3c08825e05
)

[2025-05-30 16:39:32] [INFO] トークン検証成功: ユーザーID Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 16:39:32] [INFO] IDトークン検証成功: userId=Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 16:39:32] [INFO] データベース接続を開始します
[2025-05-30 16:39:32] [INFO] データベース接続成功
[2025-05-30 16:39:32] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-30 16:39:32] [INFO] line_room_linksテーブルが存在します
[2025-05-30 16:39:32] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-30 16:39:32] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-30 16:39:32] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=196 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-30 16:39:32] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-30 16:39:32] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#12","order_session_id":"250530143946756130854","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-27","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-30 14:39:46"}
[2025-05-30 16:39:32] [INFO] トランザクション開始
[2025-05-30 16:39:32] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-30 16:39:32] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-30 16:39:32] [INFO] 部屋検索クエリ実行完了
[2025-05-30 16:39:32] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-30 16:39:32] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-30 16:39:32] [DEBUG] パラメータバインド: userId=Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 16:39:32] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-30 16:39:32] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-30 16:39:32] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-30 16:39:32] [INFO] 非アクティブ化した登録数: 0
[2025-05-30 16:39:32] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-30 16:39:32] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-30 16:39:32] [DEBUG] プリペアドステートメント作成成功
[2025-05-30 16:39:32] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-30, checkOut=2025-05-08
[2025-05-30 16:39:32] [DEBUG] パラメータバインド完了: userId=Ueff5c52f3e0077e6bf695d59414142ec, roomNumber=fg#01, userName=washo, checkInDate=2025-05-30, checkOutDate=2025-05-08
[2025-05-30 16:39:32] [INFO] SQLを実行します
[2025-05-30 16:39:32] [DEBUG] 挿入予定の値: {"line_user_id":"Ueff5c52f3e0077e6bf695d59414142ec","room_number":"fg#01","user_name":"washo","check_in_date":"2025-05-30","check_out_date":"2025-05-08"}
[2025-05-30 16:39:32] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-30 16:39:32] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'Ueff5c52f3e0077e6bf695d59414142ec' for key 'line_room_links.line_user_id'
[2025-05-30 16:39:32] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'Ueff5c52f3e0077e6bf695d59414142ec' for key 'line_room_links.line_user_id'
[2025-05-30 16:39:32] [ERROR] エラーコード: 23000
[2025-05-30 16:39:32] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'Ueff5c52f3e0077e6bf695d59414142ec' for key 'line_room_links.line_user_id'
)

[2025-05-30 16:39:32] [ERROR] SQLステート: 23000
[2025-05-30 16:39:32] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-30 16:39:32] [INFO] 重複したユーザーIDの既存レコードを発見: ID=10
[2025-05-30 16:39:32] [INFO] 重複ユーザーの登録情報を更新しました: ID=10
[2025-05-30 16:39:32] [INFO] トランザクションコミット成功
[2025-05-30 16:39:32] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":10,"registration_type":"updated"}
[2025-05-30 16:39:32] [INFO] JSONレスポンスを送信完了
[2025-05-30 16:39:32] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":10,"registration_type":"updated"}
2025-05-30 16:39:32 - ユーザーID: Ueff5c52f3e0077e6bf695d59414142ec - 部屋番号更新 - 部屋: fg#01 - 期間: 2025-05-30 から 2025-05-08
[2025-05-30 16:39:32] [DEBUG] 出力バッファに170バイトのデータがあります
[2025-05-30 16:39:32] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":10,"registration_type":"updated"}
[2025-05-30 16:39:32] [DEBUG] 出力バッファをフラッシュします
[2025-05-30 16:39:32] [INFO] 処理完了
[2025-05-30 16:40:55] [INFO] --- 登録API処理開始 ---
[2025-05-30 16:40:55] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 16:40:55] [INFO] --- 登録API処理開始 ---
[2025-05-30 16:40:55] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 16:40:55] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiIyNmNmMzk1ZjQ4MTYyZTRhMzc3MzM5Yjk1MjBjNzA2NzI5ZTFmZGMzYTY0NWI3YTlhZTc3YWMyYTQ4NzVhODA4IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWVmZjVjNTJmM2UwMDc3ZTZiZjY5NWQ1OTQxNDE0MmVjIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5NDQzNCwiaWF0IjoxNzQ4NTkwODM0LCJuYW1lIjoid2FzaG8iLCJwaWN0dXJlIjoiaHR0cHM6Ly9wcm9maWxlLmxpbmUtc2Nkbi5uZXQvMG0wMzliMjg5ZDcyNTE4YzZjMWUwNDBlZmFjZWQ3OGE1OWVhM2MwODgyNWUwNSJ9._oxf3Eei3W2Avd4IargpmImsHJNCY-XQODe8DfFKv-Z2ANG41r-N6UU3fArqlQHwQlSc1id7EWbR0smB5vJEEA","room_number":"fg#01","user_name":"washo","check_in":"2025-05-30","check_out":"2025-05-31","check_out_time":"11:00"}
[2025-05-30 16:40:55] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiIyNmNmMzk1ZjQ4MTYyZTRhMzc3MzM5Yjk1MjBjNzA2NzI5ZTFmZGMzYTY0NWI3YTlhZTc3YWMyYTQ4NzVhODA4IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWVmZjVjNTJmM2UwMDc3ZTZiZjY5NWQ1OTQxNDE0MmVjIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5NDQzNCwiaWF0IjoxNzQ4NTkwODM0LCJuYW1lIjoid2FzaG8iLCJwaWN0dXJlIjoiaHR0cHM6Ly9wcm9maWxlLmxpbmUtc2Nkbi5uZXQvMG0wMzliMjg5ZDcyNTE4YzZjMWUwNDBlZmFjZWQ3OGE1OWVhM2MwODgyNWUwNSJ9._oxf3Eei3W2Avd4IargpmImsHJNCY-XQODe8DfFKv-Z2ANG41r-N6UU3fArqlQHwQlSc1id7EWbR0smB5vJEEA
    [room_number] => fg#01
    [user_name] => washo
    [check_in] => 2025-05-30
    [check_out] => 2025-05-31
    [check_out_time] => 11:00
)

[2025-05-30 16:40:55] [INFO] forceフラグ: false
[2025-05-30 16:40:55] [INFO] 処理パラメータ: room=fg#01, user=washo, checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 16:40:55] [INFO] IDトークンを検証: eyJraWQiOiIyNmNmMzk1...
[2025-05-30 16:40:55] [DEBUG] トークン検証開始: eyJraWQiOiIyNmNmMzk1...
[2025-05-30 16:40:55] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => Ueff5c52f3e0077e6bf695d59414142ec
    [aud] => 2007363986
    [exp] => 1748594434
    [iat] => 1748590834
    [name] => washo
    [picture] => https://profile.line-scdn.net/0m039b289d72518c6c1e040efaced78a59ea3c08825e05
)

[2025-05-30 16:40:55] [INFO] トークン検証成功: ユーザーID Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 16:40:55] [INFO] IDトークン検証成功: userId=Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 16:40:55] [INFO] データベース接続を開始します
[2025-05-30 16:40:55] [INFO] データベース接続成功
[2025-05-30 16:40:55] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-30 16:40:55] [INFO] line_room_linksテーブルが存在します
[2025-05-30 16:40:55] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-30 16:40:55] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-30 16:40:55] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=198 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-30 16:40:55] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-30 16:40:55] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#12","order_session_id":"250530143946756130854","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-27","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-30 14:39:46"}
[2025-05-30 16:40:55] [INFO] トランザクション開始
[2025-05-30 16:40:55] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-30 16:40:55] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-30 16:40:55] [INFO] 部屋検索クエリ実行完了
[2025-05-30 16:40:55] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-30 16:40:55] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-30 16:40:55] [DEBUG] パラメータバインド: userId=Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 16:40:55] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-30 16:40:55] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-30 16:40:55] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-30 16:40:55] [INFO] 非アクティブ化した登録数: 1
[2025-05-30 16:40:55] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-30 16:40:55] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-30 16:40:55] [DEBUG] プリペアドステートメント作成成功
[2025-05-30 16:40:55] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-30, checkOut=2025-05-08
[2025-05-30 16:40:55] [DEBUG] パラメータバインド完了: userId=Ueff5c52f3e0077e6bf695d59414142ec, roomNumber=fg#01, userName=washo, checkInDate=2025-05-30, checkOutDate=2025-05-08
[2025-05-30 16:40:55] [INFO] SQLを実行します
[2025-05-30 16:40:55] [DEBUG] 挿入予定の値: {"line_user_id":"Ueff5c52f3e0077e6bf695d59414142ec","room_number":"fg#01","user_name":"washo","check_in_date":"2025-05-30","check_out_date":"2025-05-08"}
[2025-05-30 16:40:55] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-30 16:40:55] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'Ueff5c52f3e0077e6bf695d59414142ec' for key 'line_room_links.line_user_id'
[2025-05-30 16:40:55] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'Ueff5c52f3e0077e6bf695d59414142ec' for key 'line_room_links.line_user_id'
[2025-05-30 16:40:55] [ERROR] エラーコード: 23000
[2025-05-30 16:40:55] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'Ueff5c52f3e0077e6bf695d59414142ec' for key 'line_room_links.line_user_id'
)

[2025-05-30 16:40:55] [ERROR] SQLステート: 23000
[2025-05-30 16:40:55] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-05-30 16:40:55] [ERROR] スタックトレース: #0 {main}
[2025-05-30 16:40:55] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-05-30 16:40:55] [ERROR] スタックトレース: #0 {main}
[2025-05-30 16:40:55] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-30 16:40:55] [INFO] エラーJSONレスポンスを送信完了
[2025-05-30 16:40:55] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-05-30 16:40:55] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-05-30 16:40:55] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-05-30 16:40:55] [DEBUG] 出力バッファをフラッシュします
[2025-05-30 16:40:55] [INFO] 処理完了
[2025-05-30 16:40:55] [INFO] --- 登録API処理開始 ---
[2025-05-30 16:40:55] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 16:40:55] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiIyNmNmMzk1ZjQ4MTYyZTRhMzc3MzM5Yjk1MjBjNzA2NzI5ZTFmZGMzYTY0NWI3YTlhZTc3YWMyYTQ4NzVhODA4IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWVmZjVjNTJmM2UwMDc3ZTZiZjY5NWQ1OTQxNDE0MmVjIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5NDQzNCwiaWF0IjoxNzQ4NTkwODM0LCJuYW1lIjoid2FzaG8iLCJwaWN0dXJlIjoiaHR0cHM6Ly9wcm9maWxlLmxpbmUtc2Nkbi5uZXQvMG0wMzliMjg5ZDcyNTE4YzZjMWUwNDBlZmFjZWQ3OGE1OWVhM2MwODgyNWUwNSJ9._oxf3Eei3W2Avd4IargpmImsHJNCY-XQODe8DfFKv-Z2ANG41r-N6UU3fArqlQHwQlSc1id7EWbR0smB5vJEEA","room_number":"fg#01","user_name":"washo","check_in":"2025-05-30","check_out":"2025-05-31","check_out_time":"11:00","force":true}
[2025-05-30 16:40:55] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiIyNmNmMzk1ZjQ4MTYyZTRhMzc3MzM5Yjk1MjBjNzA2NzI5ZTFmZGMzYTY0NWI3YTlhZTc3YWMyYTQ4NzVhODA4IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWVmZjVjNTJmM2UwMDc3ZTZiZjY5NWQ1OTQxNDE0MmVjIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5NDQzNCwiaWF0IjoxNzQ4NTkwODM0LCJuYW1lIjoid2FzaG8iLCJwaWN0dXJlIjoiaHR0cHM6Ly9wcm9maWxlLmxpbmUtc2Nkbi5uZXQvMG0wMzliMjg5ZDcyNTE4YzZjMWUwNDBlZmFjZWQ3OGE1OWVhM2MwODgyNWUwNSJ9._oxf3Eei3W2Avd4IargpmImsHJNCY-XQODe8DfFKv-Z2ANG41r-N6UU3fArqlQHwQlSc1id7EWbR0smB5vJEEA
    [room_number] => fg#01
    [user_name] => washo
    [check_in] => 2025-05-30
    [check_out] => 2025-05-31
    [check_out_time] => 11:00
    [force] => 1
)

[2025-05-30 16:40:55] [INFO] forceフラグ: true
[2025-05-30 16:40:55] [INFO] 処理パラメータ: room=fg#01, user=washo, checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 16:40:55] [INFO] IDトークンを検証: eyJraWQiOiIyNmNmMzk1...
[2025-05-30 16:40:55] [DEBUG] トークン検証開始: eyJraWQiOiIyNmNmMzk1...
[2025-05-30 16:40:55] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => Ueff5c52f3e0077e6bf695d59414142ec
    [aud] => 2007363986
    [exp] => 1748594434
    [iat] => 1748590834
    [name] => washo
    [picture] => https://profile.line-scdn.net/0m039b289d72518c6c1e040efaced78a59ea3c08825e05
)

[2025-05-30 16:40:55] [INFO] トークン検証成功: ユーザーID Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 16:40:55] [INFO] IDトークン検証成功: userId=Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 16:40:55] [INFO] データベース接続を開始します
[2025-05-30 16:40:55] [INFO] データベース接続成功
[2025-05-30 16:40:55] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-30 16:40:55] [INFO] line_room_linksテーブルが存在します
[2025-05-30 16:40:55] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-30 16:40:55] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-30 16:40:55] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=200 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-30 16:40:55] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-30 16:40:55] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#12","order_session_id":"250530143946756130854","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-27","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-30 14:39:46"}
[2025-05-30 16:40:55] [INFO] トランザクション開始
[2025-05-30 16:40:55] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-30 16:40:55] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-30 16:40:55] [INFO] 部屋検索クエリ実行完了
[2025-05-30 16:40:55] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-30 16:40:55] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-30 16:40:55] [DEBUG] パラメータバインド: userId=Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 16:40:55] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-30 16:40:55] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-30 16:40:55] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-30 16:40:55] [INFO] 非アクティブ化した登録数: 1
[2025-05-30 16:40:55] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-30 16:40:55] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-30 16:40:55] [DEBUG] プリペアドステートメント作成成功
[2025-05-30 16:40:55] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-30, checkOut=2025-05-08
[2025-05-30 16:40:55] [DEBUG] パラメータバインド完了: userId=Ueff5c52f3e0077e6bf695d59414142ec, roomNumber=fg#01, userName=washo, checkInDate=2025-05-30, checkOutDate=2025-05-08
[2025-05-30 16:40:55] [INFO] SQLを実行します
[2025-05-30 16:40:55] [DEBUG] 挿入予定の値: {"line_user_id":"Ueff5c52f3e0077e6bf695d59414142ec","room_number":"fg#01","user_name":"washo","check_in_date":"2025-05-30","check_out_date":"2025-05-08"}
[2025-05-30 16:40:55] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-30 16:40:55] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'Ueff5c52f3e0077e6bf695d59414142ec' for key 'line_room_links.line_user_id'
[2025-05-30 16:40:55] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'Ueff5c52f3e0077e6bf695d59414142ec' for key 'line_room_links.line_user_id'
[2025-05-30 16:40:55] [ERROR] エラーコード: 23000
[2025-05-30 16:40:55] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'Ueff5c52f3e0077e6bf695d59414142ec' for key 'line_room_links.line_user_id'
)

[2025-05-30 16:40:55] [ERROR] SQLステート: 23000
[2025-05-30 16:40:55] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-05-30 16:40:55] [INFO] 重複したユーザーIDの既存レコードを発見: ID=10
[2025-05-30 16:40:55] [INFO] 重複ユーザーの登録情報を更新しました: ID=10
[2025-05-30 16:40:55] [INFO] トランザクションコミット成功
[2025-05-30 16:40:55] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":10,"registration_type":"updated"}
[2025-05-30 16:40:55] [INFO] JSONレスポンスを送信完了
[2025-05-30 16:40:55] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":10,"registration_type":"updated"}
2025-05-30 16:40:55 - ユーザーID: Ueff5c52f3e0077e6bf695d59414142ec - 部屋番号更新 - 部屋: fg#01 - 期間: 2025-05-30 から 2025-05-08
[2025-05-30 16:40:55] [DEBUG] 出力バッファに170バイトのデータがあります
[2025-05-30 16:40:55] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":10,"registration_type":"updated"}
[2025-05-30 16:40:55] [DEBUG] 出力バッファをフラッシュします
[2025-05-30 16:40:55] [INFO] 処理完了
[2025-05-30 17:05:17] [INFO] --- 登録API処理開始 ---
[2025-05-30 17:05:17] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 17:05:17] [INFO] --- 登録API処理開始 ---
[2025-05-30 17:05:17] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 17:05:17] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhNzk2OGMyZWExNWYwZjQxNjM1ZGU1ZTA4ODI5MDQ5MWIwMjMxYTU2YTQ5Y2M4YTZjZDZlZDQ0MTcyN2EyNTJmIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWVmZjVjNTJmM2UwMDc3ZTZiZjY5NWQ1OTQxNDE0MmVjIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5NTkwOCwiaWF0IjoxNzQ4NTkyMzA4LCJuYW1lIjoid2FzaG8iLCJwaWN0dXJlIjoiaHR0cHM6Ly9wcm9maWxlLmxpbmUtc2Nkbi5uZXQvMG0wMzliMjg5ZDcyNTE4YzZjMWUwNDBlZmFjZWQ3OGE1OWVhM2MwODgyNWUwNSJ9.EHcRLw3TknAfSYqlEUQMkQ44u0vCiRGr19yifXv1G_4v6v8AXxDmfRWfd7QBx6VTSpIFJy7GpJJ11XLFxt9h7A","room_number":"fg#02","user_name":"washo","check_in":"2025-05-30","check_out":"2025-05-31","check_out_time":"11:00"}
[2025-05-30 17:05:17] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhNzk2OGMyZWExNWYwZjQxNjM1ZGU1ZTA4ODI5MDQ5MWIwMjMxYTU2YTQ5Y2M4YTZjZDZlZDQ0MTcyN2EyNTJmIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWVmZjVjNTJmM2UwMDc3ZTZiZjY5NWQ1OTQxNDE0MmVjIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5NTkwOCwiaWF0IjoxNzQ4NTkyMzA4LCJuYW1lIjoid2FzaG8iLCJwaWN0dXJlIjoiaHR0cHM6Ly9wcm9maWxlLmxpbmUtc2Nkbi5uZXQvMG0wMzliMjg5ZDcyNTE4YzZjMWUwNDBlZmFjZWQ3OGE1OWVhM2MwODgyNWUwNSJ9.EHcRLw3TknAfSYqlEUQMkQ44u0vCiRGr19yifXv1G_4v6v8AXxDmfRWfd7QBx6VTSpIFJy7GpJJ11XLFxt9h7A
    [room_number] => fg#02
    [user_name] => washo
    [check_in] => 2025-05-30
    [check_out] => 2025-05-31
    [check_out_time] => 11:00
)

[2025-05-30 17:05:17] [INFO] forceフラグ: false
[2025-05-30 17:05:17] [INFO] 処理パラメータ: room=fg#02, user=washo, checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 17:05:17] [INFO] IDトークンを検証: eyJraWQiOiJhNzk2OGMy...
[2025-05-30 17:05:17] [DEBUG] トークン検証開始: eyJraWQiOiJhNzk2OGMy...
[2025-05-30 17:05:17] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => Ueff5c52f3e0077e6bf695d59414142ec
    [aud] => 2007363986
    [exp] => 1748595908
    [iat] => 1748592308
    [name] => washo
    [picture] => https://profile.line-scdn.net/0m039b289d72518c6c1e040efaced78a59ea3c08825e05
)

[2025-05-30 17:05:17] [INFO] トークン検証成功: ユーザーID Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 17:05:17] [INFO] IDトークン検証成功: userId=Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 17:05:17] [INFO] データベース接続を開始します
[2025-05-30 17:05:17] [INFO] データベース接続成功
[2025-05-30 17:05:17] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-30 17:05:17] [INFO] line_room_linksテーブルが存在します
[2025-05-30 17:05:17] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-30 17:05:17] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-30 17:05:17] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=202 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-30 17:05:17] [INFO] line_room_linksテーブルのレコード数: 5
[2025-05-30 17:05:17] [INFO] 最新のレコード: {"id":35,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#12","order_session_id":"250530143946756130854","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-27","check_out_date":"2025-05-09","access_token":null,"is_active":1,"created_at":"2025-05-08 21:36:39","updated_at":"2025-05-30 14:39:46"}
[2025-05-30 17:05:17] [INFO] トランザクション開始
[2025-05-30 17:05:17] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-30 17:05:17] [DEBUG] パラメータバインド: roomNumber=fg#02
[2025-05-30 17:05:17] [INFO] 部屋検索クエリ実行完了
[2025-05-30 17:05:17] [INFO] 部屋検索結果: 部屋あり ID=2, アクティブ=1
[2025-05-30 17:05:17] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-30 17:05:17] [DEBUG] パラメータバインド: userId=Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 17:05:17] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-30 17:05:17] [INFO] ユーザー全登録検索結果: 0件の登録あり
[2025-05-30 17:05:17] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-30 17:05:17] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-30 17:05:17] [DEBUG] プリペアドステートメント作成成功
[2025-05-30 17:05:17] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 17:05:17] [DEBUG] パラメータバインド完了: userId=Ueff5c52f3e0077e6bf695d59414142ec, roomNumber=fg#02, userName=washo, checkInDate=2025-05-30, checkOutDate=2025-05-31
[2025-05-30 17:05:17] [INFO] SQLを実行します
[2025-05-30 17:05:17] [DEBUG] 挿入予定の値: {"line_user_id":"Ueff5c52f3e0077e6bf695d59414142ec","room_number":"fg#02","user_name":"washo","check_in_date":"2025-05-30","check_out_date":"2025-05-31"}
[2025-05-30 17:05:17] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-30 17:05:17] [DEBUG] 直接クエリ実行結果: 成功
[2025-05-30 17:05:17] [INFO] 直接クエリで新規登録ID: 202
[2025-05-30 17:05:17] [INFO] トランザクションコミット成功
[2025-05-30 17:05:17] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"202","registration_type":"new"}
[2025-05-30 17:05:17] [INFO] JSONレスポンスを送信完了
[2025-05-30 17:05:17] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に登録されました","registration_id":"202","registration_type":"new"}
2025-05-30 17:05:17 - ユーザーID: Ueff5c52f3e0077e6bf695d59414142ec - 部屋番号新規登録 - 部屋: fg#02 - 期間: 2025-05-30 から 2025-05-31
[2025-05-30 17:05:17] [DEBUG] 出力バッファに169バイトのデータがあります
[2025-05-30 17:05:17] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"202","registration_type":"new"}
[2025-05-30 17:05:17] [DEBUG] 出力バッファをフラッシュします
[2025-05-30 17:05:17] [INFO] 処理完了
[2025-05-30 17:06:36] [INFO] --- 登録API処理開始 ---
[2025-05-30 17:06:36] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 17:06:36] [INFO] --- 登録API処理開始 ---
[2025-05-30 17:06:36] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 17:06:36] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJmYTEzNDA0Mjk5M2E0YTE3MTdlNGVlMTZiMGM0OGYzNTRkZTYxNzFmODUwMTU1OTcxODg1MDM4Mjg4ZmI5MmM5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWVmZjVjNTJmM2UwMDc3ZTZiZjY5NWQ1OTQxNDE0MmVjIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5NTc3NywiaWF0IjoxNzQ4NTkyMTc3LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoid2FzaG8iLCJwaWN0dXJlIjoiaHR0cHM6Ly9wcm9maWxlLmxpbmUtc2Nkbi5uZXQvMG0wMzliMjg5ZDcyNTE4YzZjMWUwNDBlZmFjZWQ3OGE1OWVhM2MwODgyNWUwNSJ9.9ByiRMn5fEf9j5-SlyUZGLlQUcMs2wXg9tH56yAivnfA9QFdIAZhiZqAwSsOREKTeaEFYnO6eh9_XaP9UJ9XDA","room_number":"fg#02","user_name":"washo","check_in":"2025-05-30","check_out":"2025-05-31","check_out_time":"11:00"}
[2025-05-30 17:06:36] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJmYTEzNDA0Mjk5M2E0YTE3MTdlNGVlMTZiMGM0OGYzNTRkZTYxNzFmODUwMTU1OTcxODg1MDM4Mjg4ZmI5MmM5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWVmZjVjNTJmM2UwMDc3ZTZiZjY5NWQ1OTQxNDE0MmVjIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5NTc3NywiaWF0IjoxNzQ4NTkyMTc3LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoid2FzaG8iLCJwaWN0dXJlIjoiaHR0cHM6Ly9wcm9maWxlLmxpbmUtc2Nkbi5uZXQvMG0wMzliMjg5ZDcyNTE4YzZjMWUwNDBlZmFjZWQ3OGE1OWVhM2MwODgyNWUwNSJ9.9ByiRMn5fEf9j5-SlyUZGLlQUcMs2wXg9tH56yAivnfA9QFdIAZhiZqAwSsOREKTeaEFYnO6eh9_XaP9UJ9XDA
    [room_number] => fg#02
    [user_name] => washo
    [check_in] => 2025-05-30
    [check_out] => 2025-05-31
    [check_out_time] => 11:00
)

[2025-05-30 17:06:36] [INFO] forceフラグ: false
[2025-05-30 17:06:36] [INFO] 処理パラメータ: room=fg#02, user=washo, checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 17:06:36] [INFO] IDトークンを検証: eyJraWQiOiJmYTEzNDA0...
[2025-05-30 17:06:36] [DEBUG] トークン検証開始: eyJraWQiOiJmYTEzNDA0...
[2025-05-30 17:06:36] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => Ueff5c52f3e0077e6bf695d59414142ec
    [aud] => 2007363986
    [exp] => 1748595777
    [iat] => 1748592177
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => washo
    [picture] => https://profile.line-scdn.net/0m039b289d72518c6c1e040efaced78a59ea3c08825e05
)

[2025-05-30 17:06:36] [INFO] トークン検証成功: ユーザーID Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 17:06:36] [INFO] IDトークン検証成功: userId=Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 17:06:36] [INFO] データベース接続を開始します
[2025-05-30 17:06:36] [INFO] データベース接続成功
[2025-05-30 17:06:36] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-30 17:06:36] [INFO] line_room_linksテーブルが存在します
[2025-05-30 17:06:36] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-30 17:06:36] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-30 17:06:36] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=203 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-30 17:06:36] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-30 17:06:36] [INFO] 最新のレコード: {"id":202,"line_user_id":"Ueff5c52f3e0077e6bf695d59414142ec","room_number":"fg#02","order_session_id":null,"user_name":"washo","check_in_date":"2025-05-30","check_out_date":"2025-05-31","access_token":null,"is_active":1,"created_at":"2025-05-30 17:05:17","updated_at":"2025-05-30 17:05:17"}
[2025-05-30 17:06:36] [INFO] トランザクション開始
[2025-05-30 17:06:36] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-30 17:06:36] [DEBUG] パラメータバインド: roomNumber=fg#02
[2025-05-30 17:06:36] [INFO] 部屋検索クエリ実行完了
[2025-05-30 17:06:36] [INFO] 部屋検索結果: 部屋あり ID=2, アクティブ=1
[2025-05-30 17:06:36] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-30 17:06:36] [DEBUG] パラメータバインド: userId=Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 17:06:36] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-30 17:06:36] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-30 17:06:36] [INFO] 有効な登録ID: 202, チェックアウト日: 2025-05-31
[2025-05-30 17:06:36] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-30 17:06:36] [INFO] 非アクティブ化した登録数: 1
[2025-05-30 17:06:36] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate
                WHERE id = :id
            
[2025-05-30 17:06:36] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-30 17:06:36] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 17:06:36] [DEBUG] パラメータバインド: id=202, roomNumber=fg#02, userName=washo, checkInDate=2025-05-30, checkOutDate=2025-05-31
[2025-05-30 17:06:36] [INFO] 更新クエリ実行完了: 成功
[2025-05-30 17:06:36] [INFO] 既存登録を更新: id=202
[2025-05-30 17:06:36] [INFO] トランザクションコミット成功
[2025-05-30 17:06:36] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":202,"registration_type":"update"}
[2025-05-30 17:06:36] [INFO] JSONレスポンスを送信完了
[2025-05-30 17:06:36] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":202,"registration_type":"update"}
2025-05-30 17:06:36 - ユーザーID: Ueff5c52f3e0077e6bf695d59414142ec - 部屋番号更新 - 部屋: fg#02 - 期間: 2025-05-30 から 2025-05-31
[2025-05-30 17:06:36] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-05-30 17:06:36] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":202,"registration_type":"update"}
[2025-05-30 17:06:36] [DEBUG] 出力バッファをフラッシュします
[2025-05-30 17:06:36] [INFO] 処理完了
[2025-05-30 17:09:17] [INFO] --- 登録API処理開始 ---
[2025-05-30 17:09:17] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 17:09:17] [INFO] --- 登録API処理開始 ---
[2025-05-30 17:09:17] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 17:09:17] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJmYTEzNDA0Mjk5M2E0YTE3MTdlNGVlMTZiMGM0OGYzNTRkZTYxNzFmODUwMTU1OTcxODg1MDM4Mjg4ZmI5MmM5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWVmZjVjNTJmM2UwMDc3ZTZiZjY5NWQ1OTQxNDE0MmVjIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5NTc3NywiaWF0IjoxNzQ4NTkyMTc3LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoid2FzaG8iLCJwaWN0dXJlIjoiaHR0cHM6Ly9wcm9maWxlLmxpbmUtc2Nkbi5uZXQvMG0wMzliMjg5ZDcyNTE4YzZjMWUwNDBlZmFjZWQ3OGE1OWVhM2MwODgyNWUwNSJ9.9ByiRMn5fEf9j5-SlyUZGLlQUcMs2wXg9tH56yAivnfA9QFdIAZhiZqAwSsOREKTeaEFYnO6eh9_XaP9UJ9XDA","room_number":"fg#02","user_name":"washo","check_in":"2025-05-30","check_out":"2025-05-31","check_out_time":"11:00"}
[2025-05-30 17:09:17] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJmYTEzNDA0Mjk5M2E0YTE3MTdlNGVlMTZiMGM0OGYzNTRkZTYxNzFmODUwMTU1OTcxODg1MDM4Mjg4ZmI5MmM5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWVmZjVjNTJmM2UwMDc3ZTZiZjY5NWQ1OTQxNDE0MmVjIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5NTc3NywiaWF0IjoxNzQ4NTkyMTc3LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoid2FzaG8iLCJwaWN0dXJlIjoiaHR0cHM6Ly9wcm9maWxlLmxpbmUtc2Nkbi5uZXQvMG0wMzliMjg5ZDcyNTE4YzZjMWUwNDBlZmFjZWQ3OGE1OWVhM2MwODgyNWUwNSJ9.9ByiRMn5fEf9j5-SlyUZGLlQUcMs2wXg9tH56yAivnfA9QFdIAZhiZqAwSsOREKTeaEFYnO6eh9_XaP9UJ9XDA
    [room_number] => fg#02
    [user_name] => washo
    [check_in] => 2025-05-30
    [check_out] => 2025-05-31
    [check_out_time] => 11:00
)

[2025-05-30 17:09:17] [INFO] forceフラグ: false
[2025-05-30 17:09:17] [INFO] 処理パラメータ: room=fg#02, user=washo, checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 17:09:17] [INFO] IDトークンを検証: eyJraWQiOiJmYTEzNDA0...
[2025-05-30 17:09:17] [DEBUG] トークン検証開始: eyJraWQiOiJmYTEzNDA0...
[2025-05-30 17:09:17] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => Ueff5c52f3e0077e6bf695d59414142ec
    [aud] => 2007363986
    [exp] => 1748595777
    [iat] => 1748592177
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => washo
    [picture] => https://profile.line-scdn.net/0m039b289d72518c6c1e040efaced78a59ea3c08825e05
)

[2025-05-30 17:09:17] [INFO] トークン検証成功: ユーザーID Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 17:09:17] [INFO] IDトークン検証成功: userId=Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 17:09:17] [INFO] データベース接続を開始します
[2025-05-30 17:09:17] [INFO] データベース接続成功
[2025-05-30 17:09:17] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-30 17:09:17] [INFO] line_room_linksテーブルが存在します
[2025-05-30 17:09:17] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-30 17:09:17] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-30 17:09:17] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=203 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-30 17:09:17] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-30 17:09:17] [INFO] 最新のレコード: {"id":202,"line_user_id":"Ueff5c52f3e0077e6bf695d59414142ec","room_number":"fg#02","order_session_id":null,"user_name":"washo","check_in_date":"2025-05-30","check_out_date":"2025-05-31","access_token":null,"is_active":0,"created_at":"2025-05-30 17:05:17","updated_at":"2025-05-30 17:06:36"}
[2025-05-30 17:09:17] [INFO] トランザクション開始
[2025-05-30 17:09:17] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-30 17:09:17] [DEBUG] パラメータバインド: roomNumber=fg#02
[2025-05-30 17:09:17] [INFO] 部屋検索クエリ実行完了
[2025-05-30 17:09:17] [INFO] 部屋検索結果: 部屋あり ID=2, アクティブ=1
[2025-05-30 17:09:17] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-30 17:09:17] [DEBUG] パラメータバインド: userId=Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 17:09:17] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-30 17:09:17] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-30 17:09:17] [INFO] 有効な登録ID: 202, チェックアウト日: 2025-05-31
[2025-05-30 17:09:17] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-30 17:09:17] [INFO] 非アクティブ化した登録数: 0
[2025-05-30 17:09:17] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate
                WHERE id = :id
            
[2025-05-30 17:09:17] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-30 17:09:17] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 17:09:17] [DEBUG] パラメータバインド: id=202, roomNumber=fg#02, userName=washo, checkInDate=2025-05-30, checkOutDate=2025-05-31
[2025-05-30 17:09:17] [INFO] 更新クエリ実行完了: 成功
[2025-05-30 17:09:17] [INFO] 既存登録を更新: id=202
[2025-05-30 17:09:17] [INFO] トランザクションコミット成功
[2025-05-30 17:09:17] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":202,"registration_type":"update"}
[2025-05-30 17:09:17] [INFO] JSONレスポンスを送信完了
[2025-05-30 17:09:17] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":202,"registration_type":"update"}
2025-05-30 17:09:17 - ユーザーID: Ueff5c52f3e0077e6bf695d59414142ec - 部屋番号更新 - 部屋: fg#02 - 期間: 2025-05-30 から 2025-05-31
[2025-05-30 17:09:17] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-05-30 17:09:17] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":202,"registration_type":"update"}
[2025-05-30 17:09:17] [DEBUG] 出力バッファをフラッシュします
[2025-05-30 17:09:17] [INFO] 処理完了
[2025-05-30 17:11:19] [INFO] --- 登録API処理開始 ---
[2025-05-30 17:11:19] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 17:11:20] [INFO] --- 登録API処理開始 ---
[2025-05-30 17:11:20] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 17:11:20] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJmYTEzNDA0Mjk5M2E0YTE3MTdlNGVlMTZiMGM0OGYzNTRkZTYxNzFmODUwMTU1OTcxODg1MDM4Mjg4ZmI5MmM5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWVmZjVjNTJmM2UwMDc3ZTZiZjY5NWQ1OTQxNDE0MmVjIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5NTc3NywiaWF0IjoxNzQ4NTkyMTc3LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoid2FzaG8iLCJwaWN0dXJlIjoiaHR0cHM6Ly9wcm9maWxlLmxpbmUtc2Nkbi5uZXQvMG0wMzliMjg5ZDcyNTE4YzZjMWUwNDBlZmFjZWQ3OGE1OWVhM2MwODgyNWUwNSJ9.9ByiRMn5fEf9j5-SlyUZGLlQUcMs2wXg9tH56yAivnfA9QFdIAZhiZqAwSsOREKTeaEFYnO6eh9_XaP9UJ9XDA","room_number":"fg#01","user_name":"washo","check_in":"2025-05-30","check_out":"2025-05-31","check_out_time":"11:00"}
[2025-05-30 17:11:20] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJmYTEzNDA0Mjk5M2E0YTE3MTdlNGVlMTZiMGM0OGYzNTRkZTYxNzFmODUwMTU1OTcxODg1MDM4Mjg4ZmI5MmM5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWVmZjVjNTJmM2UwMDc3ZTZiZjY5NWQ1OTQxNDE0MmVjIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5NTc3NywiaWF0IjoxNzQ4NTkyMTc3LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoid2FzaG8iLCJwaWN0dXJlIjoiaHR0cHM6Ly9wcm9maWxlLmxpbmUtc2Nkbi5uZXQvMG0wMzliMjg5ZDcyNTE4YzZjMWUwNDBlZmFjZWQ3OGE1OWVhM2MwODgyNWUwNSJ9.9ByiRMn5fEf9j5-SlyUZGLlQUcMs2wXg9tH56yAivnfA9QFdIAZhiZqAwSsOREKTeaEFYnO6eh9_XaP9UJ9XDA
    [room_number] => fg#01
    [user_name] => washo
    [check_in] => 2025-05-30
    [check_out] => 2025-05-31
    [check_out_time] => 11:00
)

[2025-05-30 17:11:20] [INFO] forceフラグ: false
[2025-05-30 17:11:20] [INFO] 処理パラメータ: room=fg#01, user=washo, checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 17:11:20] [INFO] IDトークンを検証: eyJraWQiOiJmYTEzNDA0...
[2025-05-30 17:11:20] [DEBUG] トークン検証開始: eyJraWQiOiJmYTEzNDA0...
[2025-05-30 17:11:20] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => Ueff5c52f3e0077e6bf695d59414142ec
    [aud] => 2007363986
    [exp] => 1748595777
    [iat] => 1748592177
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => washo
    [picture] => https://profile.line-scdn.net/0m039b289d72518c6c1e040efaced78a59ea3c08825e05
)

[2025-05-30 17:11:20] [INFO] トークン検証成功: ユーザーID Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 17:11:20] [INFO] IDトークン検証成功: userId=Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 17:11:20] [INFO] データベース接続を開始します
[2025-05-30 17:11:20] [INFO] データベース接続成功
[2025-05-30 17:11:20] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-30 17:11:20] [INFO] line_room_linksテーブルが存在します
[2025-05-30 17:11:20] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-30 17:11:20] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-30 17:11:20] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=203 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-30 17:11:20] [INFO] line_room_linksテーブルのレコード数: 6
[2025-05-30 17:11:20] [INFO] 最新のレコード: {"id":202,"line_user_id":"Ueff5c52f3e0077e6bf695d59414142ec","room_number":"fg#02","order_session_id":null,"user_name":"washo","check_in_date":"2025-05-30","check_out_date":"2025-05-31","access_token":null,"is_active":0,"created_at":"2025-05-30 17:05:17","updated_at":"2025-05-30 17:06:36"}
[2025-05-30 17:11:20] [INFO] トランザクション開始
[2025-05-30 17:11:20] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-30 17:11:20] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-30 17:11:20] [INFO] 部屋検索クエリ実行完了
[2025-05-30 17:11:20] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-30 17:11:20] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-30 17:11:20] [DEBUG] パラメータバインド: userId=Ueff5c52f3e0077e6bf695d59414142ec
[2025-05-30 17:11:20] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-30 17:11:20] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-30 17:11:20] [INFO] 有効な登録ID: 202, チェックアウト日: 2025-05-31
[2025-05-30 17:11:20] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-30 17:11:20] [INFO] 非アクティブ化した登録数: 0
[2025-05-30 17:11:20] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate
                WHERE id = :id
            
[2025-05-30 17:11:20] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-30 17:11:20] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 17:11:20] [DEBUG] パラメータバインド: id=202, roomNumber=fg#01, userName=washo, checkInDate=2025-05-30, checkOutDate=2025-05-31
[2025-05-30 17:11:20] [INFO] 更新クエリ実行完了: 成功
[2025-05-30 17:11:20] [INFO] 既存登録を更新: id=202
[2025-05-30 17:11:20] [INFO] トランザクションコミット成功
[2025-05-30 17:11:20] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":202,"registration_type":"update"}
[2025-05-30 17:11:20] [INFO] JSONレスポンスを送信完了
[2025-05-30 17:11:20] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":202,"registration_type":"update"}
2025-05-30 17:11:20 - ユーザーID: Ueff5c52f3e0077e6bf695d59414142ec - 部屋番号更新 - 部屋: fg#01 - 期間: 2025-05-30 から 2025-05-31
[2025-05-30 17:11:20] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-05-30 17:11:20] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":202,"registration_type":"update"}
[2025-05-30 17:11:20] [DEBUG] 出力バッファをフラッシュします
[2025-05-30 17:11:20] [INFO] 処理完了
[2025-05-30 17:34:27] [INFO] --- 登録API処理開始 ---
[2025-05-30 17:34:27] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 17:34:27] [INFO] --- 登録API処理開始 ---
[2025-05-30 17:34:27] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 17:34:27] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJmYTEzNDA0Mjk5M2E0YTE3MTdlNGVlMTZiMGM0OGYzNTRkZTYxNzFmODUwMTU1OTcxODg1MDM4Mjg4ZmI5MmM5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5NzY1OSwiaWF0IjoxNzQ4NTk0MDU5LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.jwXd2b0eQ-qhffA-CY1kjlX1RZbuwZO17kYOzfwFOtddGcqrmfddzfansWvB2DS69cIwsa_DQsr-d3cZgT2vTg","room_number":"fg#01","user_name":"くらひで","check_in":"2025-05-30","check_out":"2025-05-31","check_out_time":"11:00"}
[2025-05-30 17:34:27] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJmYTEzNDA0Mjk5M2E0YTE3MTdlNGVlMTZiMGM0OGYzNTRkZTYxNzFmODUwMTU1OTcxODg1MDM4Mjg4ZmI5MmM5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5NzY1OSwiaWF0IjoxNzQ4NTk0MDU5LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.jwXd2b0eQ-qhffA-CY1kjlX1RZbuwZO17kYOzfwFOtddGcqrmfddzfansWvB2DS69cIwsa_DQsr-d3cZgT2vTg
    [room_number] => fg#01
    [user_name] => くらひで
    [check_in] => 2025-05-30
    [check_out] => 2025-05-31
    [check_out_time] => 11:00
)

[2025-05-30 17:34:27] [INFO] forceフラグ: false
[2025-05-30 17:34:27] [INFO] 処理パラメータ: room=fg#01, user=くらひで, checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 17:34:27] [INFO] IDトークンを検証: eyJraWQiOiJmYTEzNDA0...
[2025-05-30 17:34:27] [DEBUG] トークン検証開始: eyJraWQiOiJmYTEzNDA0...
[2025-05-30 17:34:27] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748597659
    [iat] => 1748594059
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-30 17:34:27] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-30 17:34:27] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-30 17:34:27] [INFO] データベース接続を開始します
[2025-05-30 17:34:27] [INFO] データベース接続成功
[2025-05-30 17:34:27] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-30 17:34:27] [INFO] line_room_linksテーブルが存在します
[2025-05-30 17:34:27] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-30 17:34:27] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-30 17:34:27] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=203 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-30 17:34:27] [INFO] line_room_linksテーブルのレコード数: 0
[2025-05-30 17:34:27] [INFO] トランザクション開始
[2025-05-30 17:34:27] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-30 17:34:27] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-30 17:34:27] [INFO] 部屋検索クエリ実行完了
[2025-05-30 17:34:27] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-30 17:34:27] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-30 17:34:27] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-30 17:34:27] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-30 17:34:27] [INFO] ユーザー全登録検索結果: 0件の登録あり
[2025-05-30 17:34:27] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-30 17:34:27] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-30 17:34:27] [DEBUG] プリペアドステートメント作成成功
[2025-05-30 17:34:27] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 17:34:27] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#01, userName=くらひで, checkInDate=2025-05-30, checkOutDate=2025-05-31
[2025-05-30 17:34:27] [INFO] SQLを実行します
[2025-05-30 17:34:27] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-30","check_out_date":"2025-05-31"}
[2025-05-30 17:34:27] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-30 17:34:27] [DEBUG] 直接クエリ実行結果: 成功
[2025-05-30 17:34:27] [INFO] 直接クエリで新規登録ID: 203
[2025-05-30 17:34:27] [INFO] トランザクションコミット成功
[2025-05-30 17:34:27] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"203","registration_type":"new"}
[2025-05-30 17:34:27] [INFO] JSONレスポンスを送信完了
[2025-05-30 17:34:27] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に登録されました","registration_id":"203","registration_type":"new"}
2025-05-30 17:34:27 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号新規登録 - 部屋: fg#01 - 期間: 2025-05-30 から 2025-05-31
[2025-05-30 17:34:27] [DEBUG] 出力バッファに169バイトのデータがあります
[2025-05-30 17:34:27] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"203","registration_type":"new"}
[2025-05-30 17:34:27] [DEBUG] 出力バッファをフラッシュします
[2025-05-30 17:34:27] [INFO] 処理完了
[2025-05-30 18:09:43] [INFO] --- 登録API処理開始 ---
[2025-05-30 18:09:43] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 18:09:43] [INFO] --- 登録API処理開始 ---
[2025-05-30 18:09:43] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 18:09:43] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5OTc3MywiaWF0IjoxNzQ4NTk2MTczLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.Y438uUtsozZ_h2fjgJoDcGH8wVsyF5yJyoED_uNJrjITiPURC1iKHONRrXC5uOLJqbbBB9cAfXxZtBQPxmV0tA","room_number":"fg#01","user_name":"くらひで","check_in":"2025-05-30","check_out":"2025-05-31","check_out_time":"11:00"}
[2025-05-30 18:09:43] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5OTc3MywiaWF0IjoxNzQ4NTk2MTczLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.Y438uUtsozZ_h2fjgJoDcGH8wVsyF5yJyoED_uNJrjITiPURC1iKHONRrXC5uOLJqbbBB9cAfXxZtBQPxmV0tA
    [room_number] => fg#01
    [user_name] => くらひで
    [check_in] => 2025-05-30
    [check_out] => 2025-05-31
    [check_out_time] => 11:00
)

[2025-05-30 18:09:43] [INFO] forceフラグ: false
[2025-05-30 18:09:43] [INFO] 処理パラメータ: room=fg#01, user=くらひで, checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 18:09:43] [INFO] IDトークンを検証: eyJraWQiOiJhMmE0NTlh...
[2025-05-30 18:09:43] [DEBUG] トークン検証開始: eyJraWQiOiJhMmE0NTlh...
[2025-05-30 18:09:43] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748599773
    [iat] => 1748596173
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-30 18:09:43] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-30 18:09:43] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-30 18:09:43] [INFO] データベース接続を開始します
[2025-05-30 18:09:43] [INFO] データベース接続成功
[2025-05-30 18:09:43] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-30 18:09:43] [INFO] line_room_linksテーブルが存在します
[2025-05-30 18:09:43] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-30 18:09:43] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-30 18:09:43] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=204 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-30 18:09:43] [INFO] line_room_linksテーブルのレコード数: 0
[2025-05-30 18:09:43] [INFO] トランザクション開始
[2025-05-30 18:09:43] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-30 18:09:43] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-30 18:09:43] [INFO] 部屋検索クエリ実行完了
[2025-05-30 18:09:43] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-30 18:09:43] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-30 18:09:43] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-30 18:09:43] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-30 18:09:43] [INFO] ユーザー全登録検索結果: 0件の登録あり
[2025-05-30 18:09:43] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-30 18:09:43] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-30 18:09:43] [DEBUG] プリペアドステートメント作成成功
[2025-05-30 18:09:43] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 18:09:43] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#01, userName=くらひで, checkInDate=2025-05-30, checkOutDate=2025-05-31
[2025-05-30 18:09:43] [INFO] SQLを実行します
[2025-05-30 18:09:43] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-30","check_out_date":"2025-05-31"}
[2025-05-30 18:09:43] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-30 18:09:43] [DEBUG] 直接クエリ実行結果: 成功
[2025-05-30 18:09:43] [INFO] 直接クエリで新規登録ID: 204
[2025-05-30 18:09:43] [INFO] トランザクションコミット成功
[2025-05-30 18:09:43] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"204","registration_type":"new"}
[2025-05-30 18:09:43] [INFO] JSONレスポンスを送信完了
[2025-05-30 18:09:43] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に登録されました","registration_id":"204","registration_type":"new"}
2025-05-30 18:09:43 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号新規登録 - 部屋: fg#01 - 期間: 2025-05-30 から 2025-05-31
[2025-05-30 18:09:43] [DEBUG] 出力バッファに169バイトのデータがあります
[2025-05-30 18:09:43] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"204","registration_type":"new"}
[2025-05-30 18:09:43] [DEBUG] 出力バッファをフラッシュします
[2025-05-30 18:09:43] [INFO] 処理完了
[2025-05-30 18:13:14] [INFO] --- 登録API処理開始 ---
[2025-05-30 18:13:14] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 18:13:14] [INFO] --- 登録API処理開始 ---
[2025-05-30 18:13:14] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 18:13:14] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiIyNmNmMzk1ZjQ4MTYyZTRhMzc3MzM5Yjk1MjBjNzA2NzI5ZTFmZGMzYTY0NWI3YTlhZTc3YWMyYTQ4NzVhODA4IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTllMWY1YzY2YjRhMjZmZDBjMzNjODkwYWQ4MjZiMTkyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5OTk4NywiaWF0IjoxNzQ4NTk2Mzg3LCJuYW1lIjoi5YCJ55Sw5p-a5pyJIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoV2Q0Z0hnRUZDRXNKSGliallxdDNIRFZiQmlaLU1BNERjU3hGZmkwWVhub2lLaGhPWm5BU0pId1hCQzV4TFVvWk1Tc1FMU3RNWG41dyJ9.KgM7kxMGqBMdk6AG4iFTRmXcffroIrcgY3gYJfWOrfTM_16XWNI-KFHI-t7wwG1Q68kYngky24DAbFlorWjEEw","room_number":"fg#02","user_name":"倉田柚有","check_in":"2025-05-30","check_out":"2025-05-31","check_out_time":"11:00"}
[2025-05-30 18:13:14] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiIyNmNmMzk1ZjQ4MTYyZTRhMzc3MzM5Yjk1MjBjNzA2NzI5ZTFmZGMzYTY0NWI3YTlhZTc3YWMyYTQ4NzVhODA4IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTllMWY1YzY2YjRhMjZmZDBjMzNjODkwYWQ4MjZiMTkyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODU5OTk4NywiaWF0IjoxNzQ4NTk2Mzg3LCJuYW1lIjoi5YCJ55Sw5p-a5pyJIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoV2Q0Z0hnRUZDRXNKSGliallxdDNIRFZiQmlaLU1BNERjU3hGZmkwWVhub2lLaGhPWm5BU0pId1hCQzV4TFVvWk1Tc1FMU3RNWG41dyJ9.KgM7kxMGqBMdk6AG4iFTRmXcffroIrcgY3gYJfWOrfTM_16XWNI-KFHI-t7wwG1Q68kYngky24DAbFlorWjEEw
    [room_number] => fg#02
    [user_name] => 倉田柚有
    [check_in] => 2025-05-30
    [check_out] => 2025-05-31
    [check_out_time] => 11:00
)

[2025-05-30 18:13:14] [INFO] forceフラグ: false
[2025-05-30 18:13:14] [INFO] 処理パラメータ: room=fg#02, user=倉田柚有, checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 18:13:14] [INFO] IDトークンを検証: eyJraWQiOiIyNmNmMzk1...
[2025-05-30 18:13:14] [DEBUG] トークン検証開始: eyJraWQiOiIyNmNmMzk1...
[2025-05-30 18:13:14] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U9e1f5c66b4a26fd0c33c890ad826b192
    [aud] => 2007363986
    [exp] => 1748599987
    [iat] => 1748596387
    [name] => 倉田柚有
    [picture] => https://profile.line-scdn.net/0hWd4gHgEFCEsJHibjYqt3HDVbBiZ-MA4DcSxFfi0YXnoiKhhOZnASJHwXBC5xLUoZMSsQLStMXn5w
)

[2025-05-30 18:13:14] [INFO] トークン検証成功: ユーザーID U9e1f5c66b4a26fd0c33c890ad826b192
[2025-05-30 18:13:14] [INFO] IDトークン検証成功: userId=U9e1f5c66b4a26fd0c33c890ad826b192
[2025-05-30 18:13:14] [INFO] データベース接続を開始します
[2025-05-30 18:13:14] [INFO] データベース接続成功
[2025-05-30 18:13:14] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-30 18:13:14] [INFO] line_room_linksテーブルが存在します
[2025-05-30 18:13:14] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-30 18:13:14] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-30 18:13:14] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=205 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-30 18:13:14] [INFO] line_room_linksテーブルのレコード数: 1
[2025-05-30 18:13:14] [INFO] 最新のレコード: {"id":204,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":null,"user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-30","check_out_date":"2025-05-31","access_token":null,"is_active":1,"created_at":"2025-05-30 18:09:43","updated_at":"2025-05-30 18:09:43"}
[2025-05-30 18:13:14] [INFO] トランザクション開始
[2025-05-30 18:13:14] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-30 18:13:14] [DEBUG] パラメータバインド: roomNumber=fg#02
[2025-05-30 18:13:14] [INFO] 部屋検索クエリ実行完了
[2025-05-30 18:13:14] [INFO] 部屋検索結果: 部屋あり ID=2, アクティブ=1
[2025-05-30 18:13:14] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-30 18:13:14] [DEBUG] パラメータバインド: userId=U9e1f5c66b4a26fd0c33c890ad826b192
[2025-05-30 18:13:14] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-30 18:13:14] [INFO] ユーザー全登録検索結果: 0件の登録あり
[2025-05-30 18:13:14] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-30 18:13:14] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-30 18:13:14] [DEBUG] プリペアドステートメント作成成功
[2025-05-30 18:13:14] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 18:13:14] [DEBUG] パラメータバインド完了: userId=U9e1f5c66b4a26fd0c33c890ad826b192, roomNumber=fg#02, userName=倉田柚有, checkInDate=2025-05-30, checkOutDate=2025-05-31
[2025-05-30 18:13:14] [INFO] SQLを実行します
[2025-05-30 18:13:14] [DEBUG] 挿入予定の値: {"line_user_id":"U9e1f5c66b4a26fd0c33c890ad826b192","room_number":"fg#02","user_name":"\u5009\u7530\u67da\u6709","check_in_date":"2025-05-30","check_out_date":"2025-05-31"}
[2025-05-30 18:13:14] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-30 18:13:14] [DEBUG] 直接クエリ実行結果: 成功
[2025-05-30 18:13:14] [INFO] 直接クエリで新規登録ID: 205
[2025-05-30 18:13:14] [INFO] トランザクションコミット成功
[2025-05-30 18:13:14] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"205","registration_type":"new"}
[2025-05-30 18:13:14] [INFO] JSONレスポンスを送信完了
[2025-05-30 18:13:14] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に登録されました","registration_id":"205","registration_type":"new"}
2025-05-30 18:13:14 - ユーザーID: U9e1f5c66b4a26fd0c33c890ad826b192 - 部屋番号新規登録 - 部屋: fg#02 - 期間: 2025-05-30 から 2025-05-31
[2025-05-30 18:13:14] [DEBUG] 出力バッファに169バイトのデータがあります
[2025-05-30 18:13:14] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"205","registration_type":"new"}
[2025-05-30 18:13:14] [DEBUG] 出力バッファをフラッシュします
[2025-05-30 18:13:14] [INFO] 処理完了
[2025-05-30 18:14:55] [INFO] --- 登録API処理開始 ---
[2025-05-30 18:14:55] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 18:14:55] [INFO] --- 登録API処理開始 ---
[2025-05-30 18:14:55] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 18:14:55] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI5YjExMTJiMDk4ZjMxODRjNmU4M2ZjM2QxYmU4ZmMyMTdkYjFlYjIwNzU2YTE1NmNiNjNjZThjZTllMjdkZmQyIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTllMWY1YzY2YjRhMjZmZDBjMzNjODkwYWQ4MjZiMTkyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYwMDA5MiwiaWF0IjoxNzQ4NTk2NDkyLCJuYW1lIjoi5YCJ55Sw5p-a5pyJIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoV2Q0Z0hnRUZDRXNKSGliallxdDNIRFZiQmlaLU1BNERjU3hGZmkwWVhub2lLaGhPWm5BU0pId1hCQzV4TFVvWk1Tc1FMU3RNWG41dyJ9.Kh1YTeCXx9qdDEyfVHvVwrL-o7idH9vPLjlsbe1jIRu0col8-5MoMHLZQkMDx2y6AFyMz92XQUIeSs3yP72rkg","room_number":"fg#02","user_name":"倉田柚有","check_in":"2025-05-30","check_out":"2025-05-31","check_out_time":"11:00"}
[2025-05-30 18:14:55] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI5YjExMTJiMDk4ZjMxODRjNmU4M2ZjM2QxYmU4ZmMyMTdkYjFlYjIwNzU2YTE1NmNiNjNjZThjZTllMjdkZmQyIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTllMWY1YzY2YjRhMjZmZDBjMzNjODkwYWQ4MjZiMTkyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYwMDA5MiwiaWF0IjoxNzQ4NTk2NDkyLCJuYW1lIjoi5YCJ55Sw5p-a5pyJIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoV2Q0Z0hnRUZDRXNKSGliallxdDNIRFZiQmlaLU1BNERjU3hGZmkwWVhub2lLaGhPWm5BU0pId1hCQzV4TFVvWk1Tc1FMU3RNWG41dyJ9.Kh1YTeCXx9qdDEyfVHvVwrL-o7idH9vPLjlsbe1jIRu0col8-5MoMHLZQkMDx2y6AFyMz92XQUIeSs3yP72rkg
    [room_number] => fg#02
    [user_name] => 倉田柚有
    [check_in] => 2025-05-30
    [check_out] => 2025-05-31
    [check_out_time] => 11:00
)

[2025-05-30 18:14:55] [INFO] forceフラグ: false
[2025-05-30 18:14:55] [INFO] 処理パラメータ: room=fg#02, user=倉田柚有, checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 18:14:55] [INFO] IDトークンを検証: eyJraWQiOiI5YjExMTJi...
[2025-05-30 18:14:55] [DEBUG] トークン検証開始: eyJraWQiOiI5YjExMTJi...
[2025-05-30 18:14:55] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U9e1f5c66b4a26fd0c33c890ad826b192
    [aud] => 2007363986
    [exp] => 1748600092
    [iat] => 1748596492
    [name] => 倉田柚有
    [picture] => https://profile.line-scdn.net/0hWd4gHgEFCEsJHibjYqt3HDVbBiZ-MA4DcSxFfi0YXnoiKhhOZnASJHwXBC5xLUoZMSsQLStMXn5w
)

[2025-05-30 18:14:55] [INFO] トークン検証成功: ユーザーID U9e1f5c66b4a26fd0c33c890ad826b192
[2025-05-30 18:14:55] [INFO] IDトークン検証成功: userId=U9e1f5c66b4a26fd0c33c890ad826b192
[2025-05-30 18:14:55] [INFO] データベース接続を開始します
[2025-05-30 18:14:55] [INFO] データベース接続成功
[2025-05-30 18:14:55] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-30 18:14:55] [INFO] line_room_linksテーブルが存在します
[2025-05-30 18:14:55] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-30 18:14:55] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-30 18:14:55] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=206 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-30 18:14:55] [INFO] line_room_linksテーブルのレコード数: 1
[2025-05-30 18:14:55] [INFO] 最新のレコード: {"id":204,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":null,"user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-30","check_out_date":"2025-05-31","access_token":null,"is_active":1,"created_at":"2025-05-30 18:09:43","updated_at":"2025-05-30 18:09:43"}
[2025-05-30 18:14:55] [INFO] トランザクション開始
[2025-05-30 18:14:55] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-30 18:14:55] [DEBUG] パラメータバインド: roomNumber=fg#02
[2025-05-30 18:14:55] [INFO] 部屋検索クエリ実行完了
[2025-05-30 18:14:55] [INFO] 部屋検索結果: 部屋あり ID=2, アクティブ=1
[2025-05-30 18:14:55] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-30 18:14:55] [DEBUG] パラメータバインド: userId=U9e1f5c66b4a26fd0c33c890ad826b192
[2025-05-30 18:14:55] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-30 18:14:55] [INFO] ユーザー全登録検索結果: 0件の登録あり
[2025-05-30 18:14:55] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-30 18:14:55] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-30 18:14:55] [DEBUG] プリペアドステートメント作成成功
[2025-05-30 18:14:55] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 18:14:55] [DEBUG] パラメータバインド完了: userId=U9e1f5c66b4a26fd0c33c890ad826b192, roomNumber=fg#02, userName=倉田柚有, checkInDate=2025-05-30, checkOutDate=2025-05-31
[2025-05-30 18:14:55] [INFO] SQLを実行します
[2025-05-30 18:14:55] [DEBUG] 挿入予定の値: {"line_user_id":"U9e1f5c66b4a26fd0c33c890ad826b192","room_number":"fg#02","user_name":"\u5009\u7530\u67da\u6709","check_in_date":"2025-05-30","check_out_date":"2025-05-31"}
[2025-05-30 18:14:55] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-30 18:14:55] [DEBUG] 直接クエリ実行結果: 成功
[2025-05-30 18:14:55] [INFO] 直接クエリで新規登録ID: 206
[2025-05-30 18:14:55] [INFO] トランザクションコミット成功
[2025-05-30 18:14:55] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"206","registration_type":"new"}
[2025-05-30 18:14:55] [INFO] JSONレスポンスを送信完了
[2025-05-30 18:14:55] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に登録されました","registration_id":"206","registration_type":"new"}
2025-05-30 18:14:55 - ユーザーID: U9e1f5c66b4a26fd0c33c890ad826b192 - 部屋番号新規登録 - 部屋: fg#02 - 期間: 2025-05-30 から 2025-05-31
[2025-05-30 18:14:55] [DEBUG] 出力バッファに169バイトのデータがあります
[2025-05-30 18:14:55] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"206","registration_type":"new"}
[2025-05-30 18:14:55] [DEBUG] 出力バッファをフラッシュします
[2025-05-30 18:14:55] [INFO] 処理完了
[2025-05-30 18:20:35] [INFO] --- 登録API処理開始 ---
[2025-05-30 18:20:35] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 18:20:35] [INFO] --- 登録API処理開始 ---
[2025-05-30 18:20:35] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 18:20:35] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJmZTFlOGQ4ODhlYzY2NGNkMmFmZWY0NzljNWRiNzk2OTJjZDAxYWFjZDE0MTQ4M2E1NDMzOTM1MWYzOTVmYTI3IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYwMDQzMCwiaWF0IjoxNzQ4NTk2ODMwLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.qJPcklZyHj30ab-v6Qzhq6MXLISrfFG3wzxtQcrq6ilcUqXQIGpWYHRUk1dWqPm3UYRaainFSzIfhFfa-ORSIg","room_number":"fg#03","user_name":"くらひで","check_in":"2025-05-30","check_out":"2025-05-31","check_out_time":"11:00"}
[2025-05-30 18:20:35] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJmZTFlOGQ4ODhlYzY2NGNkMmFmZWY0NzljNWRiNzk2OTJjZDAxYWFjZDE0MTQ4M2E1NDMzOTM1MWYzOTVmYTI3IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYwMDQzMCwiaWF0IjoxNzQ4NTk2ODMwLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.qJPcklZyHj30ab-v6Qzhq6MXLISrfFG3wzxtQcrq6ilcUqXQIGpWYHRUk1dWqPm3UYRaainFSzIfhFfa-ORSIg
    [room_number] => fg#03
    [user_name] => くらひで
    [check_in] => 2025-05-30
    [check_out] => 2025-05-31
    [check_out_time] => 11:00
)

[2025-05-30 18:20:35] [INFO] forceフラグ: false
[2025-05-30 18:20:35] [INFO] 処理パラメータ: room=fg#03, user=くらひで, checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 18:20:35] [INFO] IDトークンを検証: eyJraWQiOiJmZTFlOGQ4...
[2025-05-30 18:20:35] [DEBUG] トークン検証開始: eyJraWQiOiJmZTFlOGQ4...
[2025-05-30 18:20:35] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748600430
    [iat] => 1748596830
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-30 18:20:35] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-30 18:20:35] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-30 18:20:35] [INFO] データベース接続を開始します
[2025-05-30 18:20:35] [INFO] データベース接続成功
[2025-05-30 18:20:35] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-30 18:20:35] [INFO] line_room_linksテーブルが存在します
[2025-05-30 18:20:35] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-30 18:20:35] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-30 18:20:35] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=207 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-30 18:20:35] [INFO] line_room_linksテーブルのレコード数: 1
[2025-05-30 18:20:35] [INFO] 最新のレコード: {"id":206,"line_user_id":"U9e1f5c66b4a26fd0c33c890ad826b192","room_number":"fg#02","order_session_id":null,"user_name":"\u5009\u7530\u67da\u6709","check_in_date":"2025-05-30","check_out_date":"2025-05-31","access_token":null,"is_active":1,"created_at":"2025-05-30 18:14:55","updated_at":"2025-05-30 18:14:55"}
[2025-05-30 18:20:35] [INFO] トランザクション開始
[2025-05-30 18:20:35] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-30 18:20:35] [DEBUG] パラメータバインド: roomNumber=fg#03
[2025-05-30 18:20:35] [INFO] 部屋検索クエリ実行完了
[2025-05-30 18:20:35] [INFO] 部屋検索結果: 部屋あり ID=3, アクティブ=1
[2025-05-30 18:20:35] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-30 18:20:35] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-30 18:20:35] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-30 18:20:35] [INFO] ユーザー全登録検索結果: 0件の登録あり
[2025-05-30 18:20:35] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-30 18:20:35] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-30 18:20:35] [DEBUG] プリペアドステートメント作成成功
[2025-05-30 18:20:35] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 18:20:35] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#03, userName=くらひで, checkInDate=2025-05-30, checkOutDate=2025-05-31
[2025-05-30 18:20:35] [INFO] SQLを実行します
[2025-05-30 18:20:35] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#03","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-30","check_out_date":"2025-05-31"}
[2025-05-30 18:20:35] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-30 18:20:35] [DEBUG] 直接クエリ実行結果: 成功
[2025-05-30 18:20:35] [INFO] 直接クエリで新規登録ID: 207
[2025-05-30 18:20:35] [INFO] トランザクションコミット成功
[2025-05-30 18:20:35] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"207","registration_type":"new"}
[2025-05-30 18:20:35] [INFO] JSONレスポンスを送信完了
[2025-05-30 18:20:35] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に登録されました","registration_id":"207","registration_type":"new"}
2025-05-30 18:20:35 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号新規登録 - 部屋: fg#03 - 期間: 2025-05-30 から 2025-05-31
[2025-05-30 18:20:35] [DEBUG] 出力バッファに169バイトのデータがあります
[2025-05-30 18:20:35] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"207","registration_type":"new"}
[2025-05-30 18:20:35] [DEBUG] 出力バッファをフラッシュします
[2025-05-30 18:20:35] [INFO] 処理完了
[2025-05-30 22:44:28] [INFO] --- 登録API処理開始 ---
[2025-05-30 22:44:28] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 22:44:28] [INFO] --- 登録API処理開始 ---
[2025-05-30 22:44:28] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 22:44:28] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiIxZjA2N2VlYzU5OWI3NGJmNGUyOGMyNDNjN2ZiYTY0NjNhMDM1OTMzNTUzZTMxZjdhMzg4ZTE0ZDQ0ZmE0OGUzIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYxNjI2MSwiaWF0IjoxNzQ4NjEyNjYxLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.HZ3acGNGyv6HQDsTZonKpyinskayrFMbAFhiO90Zyu4Uite9UjIaasa1_Ir3n6TEnvXnicugLs3uj-xxQEW7lQ","room_number":"fg#01","user_name":"くらひで","check_in":"2025-05-30","check_out":"2025-05-31","check_out_time":"11:00"}
[2025-05-30 22:44:28] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiIxZjA2N2VlYzU5OWI3NGJmNGUyOGMyNDNjN2ZiYTY0NjNhMDM1OTMzNTUzZTMxZjdhMzg4ZTE0ZDQ0ZmE0OGUzIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYxNjI2MSwiaWF0IjoxNzQ4NjEyNjYxLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.HZ3acGNGyv6HQDsTZonKpyinskayrFMbAFhiO90Zyu4Uite9UjIaasa1_Ir3n6TEnvXnicugLs3uj-xxQEW7lQ
    [room_number] => fg#01
    [user_name] => くらひで
    [check_in] => 2025-05-30
    [check_out] => 2025-05-31
    [check_out_time] => 11:00
)

[2025-05-30 22:44:28] [INFO] forceフラグ: false
[2025-05-30 22:44:28] [INFO] 処理パラメータ: room=fg#01, user=くらひで, checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 22:44:28] [INFO] IDトークンを検証: eyJraWQiOiIxZjA2N2Vl...
[2025-05-30 22:44:28] [DEBUG] トークン検証開始: eyJraWQiOiIxZjA2N2Vl...
[2025-05-30 22:44:28] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748616261
    [iat] => 1748612661
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-30 22:44:28] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-30 22:44:28] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-30 22:44:28] [INFO] データベース接続を開始します
[2025-05-30 22:44:28] [INFO] データベース接続成功
[2025-05-30 22:44:28] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-30 22:44:28] [INFO] line_room_linksテーブルが存在します
[2025-05-30 22:44:28] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-30 22:44:28] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-30 22:44:28] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=208 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-30 22:44:28] [INFO] line_room_linksテーブルのレコード数: 2
[2025-05-30 22:44:28] [INFO] 最新のレコード: {"id":207,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#03","order_session_id":"250530224306984018893","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-30","check_out_date":"2025-05-31","access_token":null,"is_active":0,"created_at":"2025-05-30 18:20:35","updated_at":"2025-05-30 22:43:46"}
[2025-05-30 22:44:28] [INFO] トランザクション開始
[2025-05-30 22:44:28] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-30 22:44:28] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-30 22:44:28] [INFO] 部屋検索クエリ実行完了
[2025-05-30 22:44:28] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-30 22:44:28] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-30 22:44:28] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-30 22:44:28] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-30 22:44:28] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-30 22:44:28] [INFO] 有効な登録ID: 207, チェックアウト日: 2025-05-31
[2025-05-30 22:44:28] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-30 22:44:28] [INFO] 非アクティブ化した登録数: 0
[2025-05-30 22:44:28] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate
                WHERE id = :id
            
[2025-05-30 22:44:28] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-30 22:44:28] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 22:44:28] [DEBUG] パラメータバインド: id=207, roomNumber=fg#01, userName=くらひで, checkInDate=2025-05-30, checkOutDate=2025-05-31
[2025-05-30 22:44:28] [INFO] 更新クエリ実行完了: 成功
[2025-05-30 22:44:28] [INFO] 既存登録を更新: id=207
[2025-05-30 22:44:28] [INFO] トランザクションコミット成功
[2025-05-30 22:44:28] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-30 22:44:28] [INFO] JSONレスポンスを送信完了
[2025-05-30 22:44:28] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":207,"registration_type":"update"}
2025-05-30 22:44:28 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#01 - 期間: 2025-05-30 から 2025-05-31
[2025-05-30 22:44:28] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-05-30 22:44:28] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-30 22:44:28] [DEBUG] 出力バッファをフラッシュします
[2025-05-30 22:44:28] [INFO] 処理完了
[2025-05-30 22:44:53] [INFO] --- 登録API処理開始 ---
[2025-05-30 22:44:53] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 22:44:53] [INFO] --- 登録API処理開始 ---
[2025-05-30 22:44:53] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 22:44:53] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiIxZjA2N2VlYzU5OWI3NGJmNGUyOGMyNDNjN2ZiYTY0NjNhMDM1OTMzNTUzZTMxZjdhMzg4ZTE0ZDQ0ZmE0OGUzIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYxNjI2MSwiaWF0IjoxNzQ4NjEyNjYxLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.HZ3acGNGyv6HQDsTZonKpyinskayrFMbAFhiO90Zyu4Uite9UjIaasa1_Ir3n6TEnvXnicugLs3uj-xxQEW7lQ","room_number":"fg#01","user_name":"くらひで","check_in":"2025-05-30","check_out":"2025-05-31","check_out_time":"11:00"}
[2025-05-30 22:44:53] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiIxZjA2N2VlYzU5OWI3NGJmNGUyOGMyNDNjN2ZiYTY0NjNhMDM1OTMzNTUzZTMxZjdhMzg4ZTE0ZDQ0ZmE0OGUzIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYxNjI2MSwiaWF0IjoxNzQ4NjEyNjYxLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.HZ3acGNGyv6HQDsTZonKpyinskayrFMbAFhiO90Zyu4Uite9UjIaasa1_Ir3n6TEnvXnicugLs3uj-xxQEW7lQ
    [room_number] => fg#01
    [user_name] => くらひで
    [check_in] => 2025-05-30
    [check_out] => 2025-05-31
    [check_out_time] => 11:00
)

[2025-05-30 22:44:53] [INFO] forceフラグ: false
[2025-05-30 22:44:53] [INFO] 処理パラメータ: room=fg#01, user=くらひで, checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 22:44:53] [INFO] IDトークンを検証: eyJraWQiOiIxZjA2N2Vl...
[2025-05-30 22:44:53] [DEBUG] トークン検証開始: eyJraWQiOiIxZjA2N2Vl...
[2025-05-30 22:44:53] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748616261
    [iat] => 1748612661
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-30 22:44:53] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-30 22:44:53] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-30 22:44:53] [INFO] データベース接続を開始します
[2025-05-30 22:44:53] [INFO] データベース接続成功
[2025-05-30 22:44:53] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-30 22:44:53] [INFO] line_room_linksテーブルが存在します
[2025-05-30 22:44:53] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-30 22:44:53] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-30 22:44:53] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=208 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-30 22:44:53] [INFO] line_room_linksテーブルのレコード数: 2
[2025-05-30 22:44:53] [INFO] 最新のレコード: {"id":207,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250530224306984018893","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-30","check_out_date":"2025-05-31","access_token":null,"is_active":0,"created_at":"2025-05-30 18:20:35","updated_at":"2025-05-30 22:44:28"}
[2025-05-30 22:44:53] [INFO] トランザクション開始
[2025-05-30 22:44:53] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-30 22:44:53] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-30 22:44:53] [INFO] 部屋検索クエリ実行完了
[2025-05-30 22:44:53] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-30 22:44:53] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-30 22:44:53] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-30 22:44:53] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-30 22:44:53] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-30 22:44:53] [INFO] 有効な登録ID: 207, チェックアウト日: 2025-05-31
[2025-05-30 22:44:53] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-30 22:44:53] [INFO] 非アクティブ化した登録数: 0
[2025-05-30 22:44:53] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate
                WHERE id = :id
            
[2025-05-30 22:44:53] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-30 22:44:53] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 22:44:53] [DEBUG] パラメータバインド: id=207, roomNumber=fg#01, userName=くらひで, checkInDate=2025-05-30, checkOutDate=2025-05-31
[2025-05-30 22:44:53] [INFO] 更新クエリ実行完了: 成功
[2025-05-30 22:44:53] [INFO] 既存登録を更新: id=207
[2025-05-30 22:44:53] [INFO] トランザクションコミット成功
[2025-05-30 22:44:53] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-30 22:44:53] [INFO] JSONレスポンスを送信完了
[2025-05-30 22:44:53] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":207,"registration_type":"update"}
2025-05-30 22:44:53 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#01 - 期間: 2025-05-30 から 2025-05-31
[2025-05-30 22:44:53] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-05-30 22:44:53] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-30 22:44:53] [DEBUG] 出力バッファをフラッシュします
[2025-05-30 22:44:53] [INFO] 処理完了
[2025-05-30 22:45:51] [INFO] --- 登録API処理開始 ---
[2025-05-30 22:45:51] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 22:45:51] [INFO] --- 登録API処理開始 ---
[2025-05-30 22:45:51] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 22:45:51] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI5YjExMTJiMDk4ZjMxODRjNmU4M2ZjM2QxYmU4ZmMyMTdkYjFlYjIwNzU2YTE1NmNiNjNjZThjZTllMjdkZmQyIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYxNjEzNCwiaWF0IjoxNzQ4NjEyNTM0LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.Rxx7GKFZwqKoC_WAa6rAsxPsGPUWy9HNURiKv1qyqx03Wl43HuFjcsKI83gcw5RojuXOs8tSo_wsoZQNCbrwig","room_number":"fg#99","user_name":"くらひで","check_in":"2025-05-30","check_out":"2025-05-31","check_out_time":"11:00"}
[2025-05-30 22:45:51] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI5YjExMTJiMDk4ZjMxODRjNmU4M2ZjM2QxYmU4ZmMyMTdkYjFlYjIwNzU2YTE1NmNiNjNjZThjZTllMjdkZmQyIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYxNjEzNCwiaWF0IjoxNzQ4NjEyNTM0LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.Rxx7GKFZwqKoC_WAa6rAsxPsGPUWy9HNURiKv1qyqx03Wl43HuFjcsKI83gcw5RojuXOs8tSo_wsoZQNCbrwig
    [room_number] => fg#99
    [user_name] => くらひで
    [check_in] => 2025-05-30
    [check_out] => 2025-05-31
    [check_out_time] => 11:00
)

[2025-05-30 22:45:51] [INFO] forceフラグ: false
[2025-05-30 22:45:51] [INFO] 処理パラメータ: room=fg#99, user=くらひで, checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 22:45:51] [INFO] IDトークンを検証: eyJraWQiOiI5YjExMTJi...
[2025-05-30 22:45:51] [DEBUG] トークン検証開始: eyJraWQiOiI5YjExMTJi...
[2025-05-30 22:45:51] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748616134
    [iat] => 1748612534
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-30 22:45:51] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-30 22:45:51] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-30 22:45:51] [INFO] データベース接続を開始します
[2025-05-30 22:45:51] [INFO] データベース接続成功
[2025-05-30 22:45:51] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-30 22:45:51] [INFO] line_room_linksテーブルが存在します
[2025-05-30 22:45:51] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-30 22:45:51] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-30 22:45:51] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=208 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-30 22:45:51] [INFO] line_room_linksテーブルのレコード数: 2
[2025-05-30 22:45:51] [INFO] 最新のレコード: {"id":207,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250530224306984018893","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-30","check_out_date":"2025-05-31","access_token":null,"is_active":0,"created_at":"2025-05-30 18:20:35","updated_at":"2025-05-30 22:44:28"}
[2025-05-30 22:45:51] [INFO] トランザクション開始
[2025-05-30 22:45:51] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-30 22:45:51] [DEBUG] パラメータバインド: roomNumber=fg#99
[2025-05-30 22:45:51] [INFO] 部屋検索クエリ実行完了
[2025-05-30 22:45:51] [INFO] 部屋検索結果: 部屋あり ID=15, アクティブ=1
[2025-05-30 22:45:51] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-30 22:45:51] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-30 22:45:51] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-30 22:45:51] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-30 22:45:51] [INFO] 有効な登録ID: 207, チェックアウト日: 2025-05-31
[2025-05-30 22:45:51] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-30 22:45:51] [INFO] 非アクティブ化した登録数: 0
[2025-05-30 22:45:51] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate
                WHERE id = :id
            
[2025-05-30 22:45:51] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-30 22:45:51] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 22:45:51] [DEBUG] パラメータバインド: id=207, roomNumber=fg#99, userName=くらひで, checkInDate=2025-05-30, checkOutDate=2025-05-31
[2025-05-30 22:45:51] [INFO] 更新クエリ実行完了: 成功
[2025-05-30 22:45:51] [INFO] 既存登録を更新: id=207
[2025-05-30 22:45:51] [INFO] トランザクションコミット成功
[2025-05-30 22:45:51] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-30 22:45:51] [INFO] JSONレスポンスを送信完了
[2025-05-30 22:45:51] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":207,"registration_type":"update"}
2025-05-30 22:45:51 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#99 - 期間: 2025-05-30 から 2025-05-31
[2025-05-30 22:45:51] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-05-30 22:45:51] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-30 22:45:51] [DEBUG] 出力バッファをフラッシュします
[2025-05-30 22:45:51] [INFO] 処理完了
[2025-05-30 22:46:11] [INFO] --- 登録API処理開始 ---
[2025-05-30 22:46:11] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 22:46:12] [INFO] --- 登録API処理開始 ---
[2025-05-30 22:46:12] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 22:46:12] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI5YjExMTJiMDk4ZjMxODRjNmU4M2ZjM2QxYmU4ZmMyMTdkYjFlYjIwNzU2YTE1NmNiNjNjZThjZTllMjdkZmQyIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYxNjEzNCwiaWF0IjoxNzQ4NjEyNTM0LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.Rxx7GKFZwqKoC_WAa6rAsxPsGPUWy9HNURiKv1qyqx03Wl43HuFjcsKI83gcw5RojuXOs8tSo_wsoZQNCbrwig","room_number":"fg#07","user_name":"くらひで","check_in":"2025-05-30","check_out":"2025-05-31","check_out_time":"11:00"}
[2025-05-30 22:46:12] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI5YjExMTJiMDk4ZjMxODRjNmU4M2ZjM2QxYmU4ZmMyMTdkYjFlYjIwNzU2YTE1NmNiNjNjZThjZTllMjdkZmQyIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYxNjEzNCwiaWF0IjoxNzQ4NjEyNTM0LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.Rxx7GKFZwqKoC_WAa6rAsxPsGPUWy9HNURiKv1qyqx03Wl43HuFjcsKI83gcw5RojuXOs8tSo_wsoZQNCbrwig
    [room_number] => fg#07
    [user_name] => くらひで
    [check_in] => 2025-05-30
    [check_out] => 2025-05-31
    [check_out_time] => 11:00
)

[2025-05-30 22:46:12] [INFO] forceフラグ: false
[2025-05-30 22:46:12] [INFO] 処理パラメータ: room=fg#07, user=くらひで, checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 22:46:12] [INFO] IDトークンを検証: eyJraWQiOiI5YjExMTJi...
[2025-05-30 22:46:12] [DEBUG] トークン検証開始: eyJraWQiOiI5YjExMTJi...
[2025-05-30 22:46:12] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748616134
    [iat] => 1748612534
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-30 22:46:12] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-30 22:46:12] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-30 22:46:12] [INFO] データベース接続を開始します
[2025-05-30 22:46:12] [INFO] データベース接続成功
[2025-05-30 22:46:12] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-30 22:46:12] [INFO] line_room_linksテーブルが存在します
[2025-05-30 22:46:12] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-30 22:46:12] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-30 22:46:12] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=208 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-30 22:46:12] [INFO] line_room_linksテーブルのレコード数: 2
[2025-05-30 22:46:12] [INFO] 最新のレコード: {"id":207,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#99","order_session_id":"250530224306984018893","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-30","check_out_date":"2025-05-31","access_token":null,"is_active":0,"created_at":"2025-05-30 18:20:35","updated_at":"2025-05-30 22:45:51"}
[2025-05-30 22:46:12] [INFO] トランザクション開始
[2025-05-30 22:46:12] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-30 22:46:12] [DEBUG] パラメータバインド: roomNumber=fg#07
[2025-05-30 22:46:12] [INFO] 部屋検索クエリ実行完了
[2025-05-30 22:46:12] [INFO] 部屋検索結果: 部屋あり ID=7, アクティブ=1
[2025-05-30 22:46:12] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-30 22:46:12] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-30 22:46:12] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-30 22:46:12] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-30 22:46:12] [INFO] 有効な登録ID: 207, チェックアウト日: 2025-05-31
[2025-05-30 22:46:12] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-30 22:46:12] [INFO] 非アクティブ化した登録数: 0
[2025-05-30 22:46:12] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate
                WHERE id = :id
            
[2025-05-30 22:46:12] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-30 22:46:12] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 22:46:12] [DEBUG] パラメータバインド: id=207, roomNumber=fg#07, userName=くらひで, checkInDate=2025-05-30, checkOutDate=2025-05-31
[2025-05-30 22:46:12] [INFO] 更新クエリ実行完了: 成功
[2025-05-30 22:46:12] [INFO] 既存登録を更新: id=207
[2025-05-30 22:46:12] [INFO] トランザクションコミット成功
[2025-05-30 22:46:12] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-30 22:46:12] [INFO] JSONレスポンスを送信完了
[2025-05-30 22:46:12] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":207,"registration_type":"update"}
2025-05-30 22:46:12 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#07 - 期間: 2025-05-30 から 2025-05-31
[2025-05-30 22:46:12] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-05-30 22:46:12] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-30 22:46:12] [DEBUG] 出力バッファをフラッシュします
[2025-05-30 22:46:12] [INFO] 処理完了
[2025-05-30 22:49:31] [INFO] --- 登録API処理開始 ---
[2025-05-30 22:49:31] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 22:49:31] [INFO] --- 登録API処理開始 ---
[2025-05-30 22:49:31] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 22:49:31] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiIxZjA2N2VlYzU5OWI3NGJmNGUyOGMyNDNjN2ZiYTY0NjNhMDM1OTMzNTUzZTMxZjdhMzg4ZTE0ZDQ0ZmE0OGUzIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYxNjI2MSwiaWF0IjoxNzQ4NjEyNjYxLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.HZ3acGNGyv6HQDsTZonKpyinskayrFMbAFhiO90Zyu4Uite9UjIaasa1_Ir3n6TEnvXnicugLs3uj-xxQEW7lQ","room_number":"fg#01","user_name":"くらひで","check_in":"2025-05-30","check_out":"2025-05-31","check_out_time":"11:00"}
[2025-05-30 22:49:31] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiIxZjA2N2VlYzU5OWI3NGJmNGUyOGMyNDNjN2ZiYTY0NjNhMDM1OTMzNTUzZTMxZjdhMzg4ZTE0ZDQ0ZmE0OGUzIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYxNjI2MSwiaWF0IjoxNzQ4NjEyNjYxLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.HZ3acGNGyv6HQDsTZonKpyinskayrFMbAFhiO90Zyu4Uite9UjIaasa1_Ir3n6TEnvXnicugLs3uj-xxQEW7lQ
    [room_number] => fg#01
    [user_name] => くらひで
    [check_in] => 2025-05-30
    [check_out] => 2025-05-31
    [check_out_time] => 11:00
)

[2025-05-30 22:49:31] [INFO] forceフラグ: false
[2025-05-30 22:49:31] [INFO] 処理パラメータ: room=fg#01, user=くらひで, checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 22:49:31] [INFO] IDトークンを検証: eyJraWQiOiIxZjA2N2Vl...
[2025-05-30 22:49:31] [DEBUG] トークン検証開始: eyJraWQiOiIxZjA2N2Vl...
[2025-05-30 22:49:31] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748616261
    [iat] => 1748612661
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-30 22:49:31] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-30 22:49:31] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-30 22:49:31] [INFO] データベース接続を開始します
[2025-05-30 22:49:31] [INFO] データベース接続成功
[2025-05-30 22:49:31] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-30 22:49:31] [INFO] line_room_linksテーブルが存在します
[2025-05-30 22:49:31] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-30 22:49:31] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-30 22:49:31] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=208 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-30 22:49:31] [INFO] line_room_linksテーブルのレコード数: 2
[2025-05-30 22:49:31] [INFO] 最新のレコード: {"id":207,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#07","order_session_id":"250530224306984018893","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-30","check_out_date":"2025-05-31","access_token":null,"is_active":0,"created_at":"2025-05-30 18:20:35","updated_at":"2025-05-30 22:46:12"}
[2025-05-30 22:49:31] [INFO] トランザクション開始
[2025-05-30 22:49:31] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-30 22:49:31] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-30 22:49:31] [INFO] 部屋検索クエリ実行完了
[2025-05-30 22:49:31] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-30 22:49:31] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-30 22:49:31] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-30 22:49:31] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-30 22:49:31] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-30 22:49:31] [INFO] 有効な登録ID: 207, チェックアウト日: 2025-05-31
[2025-05-30 22:49:31] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-30 22:49:31] [INFO] 非アクティブ化した登録数: 0
[2025-05-30 22:49:31] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate
                WHERE id = :id
            
[2025-05-30 22:49:31] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-30 22:49:31] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 22:49:31] [DEBUG] パラメータバインド: id=207, roomNumber=fg#01, userName=くらひで, checkInDate=2025-05-30, checkOutDate=2025-05-31
[2025-05-30 22:49:31] [INFO] 更新クエリ実行完了: 成功
[2025-05-30 22:49:31] [INFO] 既存登録を更新: id=207
[2025-05-30 22:49:31] [INFO] トランザクションコミット成功
[2025-05-30 22:49:31] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-30 22:49:31] [INFO] JSONレスポンスを送信完了
[2025-05-30 22:49:31] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":207,"registration_type":"update"}
2025-05-30 22:49:31 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#01 - 期間: 2025-05-30 から 2025-05-31
[2025-05-30 22:49:31] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-05-30 22:49:31] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-30 22:49:31] [DEBUG] 出力バッファをフラッシュします
[2025-05-30 22:49:31] [INFO] 処理完了
[2025-05-30 22:49:56] [INFO] --- 登録API処理開始 ---
[2025-05-30 22:49:56] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 22:49:56] [INFO] --- 登録API処理開始 ---
[2025-05-30 22:49:56] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 22:49:56] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiIxZjA2N2VlYzU5OWI3NGJmNGUyOGMyNDNjN2ZiYTY0NjNhMDM1OTMzNTUzZTMxZjdhMzg4ZTE0ZDQ0ZmE0OGUzIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYxNjI2MSwiaWF0IjoxNzQ4NjEyNjYxLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.HZ3acGNGyv6HQDsTZonKpyinskayrFMbAFhiO90Zyu4Uite9UjIaasa1_Ir3n6TEnvXnicugLs3uj-xxQEW7lQ","room_number":"fg#04","user_name":"くらひで","check_in":"2025-05-30","check_out":"2025-05-31","check_out_time":"11:00"}
[2025-05-30 22:49:56] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiIxZjA2N2VlYzU5OWI3NGJmNGUyOGMyNDNjN2ZiYTY0NjNhMDM1OTMzNTUzZTMxZjdhMzg4ZTE0ZDQ0ZmE0OGUzIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYxNjI2MSwiaWF0IjoxNzQ4NjEyNjYxLCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.HZ3acGNGyv6HQDsTZonKpyinskayrFMbAFhiO90Zyu4Uite9UjIaasa1_Ir3n6TEnvXnicugLs3uj-xxQEW7lQ
    [room_number] => fg#04
    [user_name] => くらひで
    [check_in] => 2025-05-30
    [check_out] => 2025-05-31
    [check_out_time] => 11:00
)

[2025-05-30 22:49:56] [INFO] forceフラグ: false
[2025-05-30 22:49:56] [INFO] 処理パラメータ: room=fg#04, user=くらひで, checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 22:49:56] [INFO] IDトークンを検証: eyJraWQiOiIxZjA2N2Vl...
[2025-05-30 22:49:56] [DEBUG] トークン検証開始: eyJraWQiOiIxZjA2N2Vl...
[2025-05-30 22:49:56] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748616261
    [iat] => 1748612661
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-30 22:49:56] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-30 22:49:56] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-30 22:49:56] [INFO] データベース接続を開始します
[2025-05-30 22:49:56] [INFO] データベース接続成功
[2025-05-30 22:49:56] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-30 22:49:56] [INFO] line_room_linksテーブルが存在します
[2025-05-30 22:49:56] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-30 22:49:56] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-30 22:49:56] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=208 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-30 22:49:56] [INFO] line_room_linksテーブルのレコード数: 2
[2025-05-30 22:49:56] [INFO] 最新のレコード: {"id":207,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250530224306984018893","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-30","check_out_date":"2025-05-31","access_token":null,"is_active":0,"created_at":"2025-05-30 18:20:35","updated_at":"2025-05-30 22:49:31"}
[2025-05-30 22:49:56] [INFO] トランザクション開始
[2025-05-30 22:49:56] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-30 22:49:56] [DEBUG] パラメータバインド: roomNumber=fg#04
[2025-05-30 22:49:56] [INFO] 部屋検索クエリ実行完了
[2025-05-30 22:49:56] [INFO] 部屋検索結果: 部屋あり ID=4, アクティブ=1
[2025-05-30 22:49:56] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-30 22:49:56] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-30 22:49:56] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-30 22:49:56] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-30 22:49:56] [INFO] 有効な登録ID: 207, チェックアウト日: 2025-05-31
[2025-05-30 22:49:56] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-30 22:49:56] [INFO] 非アクティブ化した登録数: 0
[2025-05-30 22:49:56] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate
                WHERE id = :id
            
[2025-05-30 22:49:56] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-30 22:49:56] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 22:49:56] [DEBUG] パラメータバインド: id=207, roomNumber=fg#04, userName=くらひで, checkInDate=2025-05-30, checkOutDate=2025-05-31
[2025-05-30 22:49:56] [INFO] 更新クエリ実行完了: 成功
[2025-05-30 22:49:56] [INFO] 既存登録を更新: id=207
[2025-05-30 22:49:56] [INFO] トランザクションコミット成功
[2025-05-30 22:49:56] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-30 22:49:56] [INFO] JSONレスポンスを送信完了
[2025-05-30 22:49:56] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":207,"registration_type":"update"}
2025-05-30 22:49:56 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#04 - 期間: 2025-05-30 から 2025-05-31
[2025-05-30 22:49:56] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-05-30 22:49:56] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-30 22:49:56] [DEBUG] 出力バッファをフラッシュします
[2025-05-30 22:49:56] [INFO] 処理完了
[2025-05-30 23:17:04] [INFO] --- 登録API処理開始 ---
[2025-05-30 23:17:04] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 23:17:05] [INFO] --- 登録API処理開始 ---
[2025-05-30 23:17:05] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-30 23:17:05] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI5YjExMTJiMDk4ZjMxODRjNmU4M2ZjM2QxYmU4ZmMyMTdkYjFlYjIwNzU2YTE1NmNiNjNjZThjZTllMjdkZmQyIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYxNjEzNCwiaWF0IjoxNzQ4NjEyNTM0LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.Rxx7GKFZwqKoC_WAa6rAsxPsGPUWy9HNURiKv1qyqx03Wl43HuFjcsKI83gcw5RojuXOs8tSo_wsoZQNCbrwig","room_number":"fg#99","user_name":"くらひで","check_in":"2025-05-30","check_out":"2025-05-31","check_out_time":"11:00"}
[2025-05-30 23:17:05] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI5YjExMTJiMDk4ZjMxODRjNmU4M2ZjM2QxYmU4ZmMyMTdkYjFlYjIwNzU2YTE1NmNiNjNjZThjZTllMjdkZmQyIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYxNjEzNCwiaWF0IjoxNzQ4NjEyNTM0LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.Rxx7GKFZwqKoC_WAa6rAsxPsGPUWy9HNURiKv1qyqx03Wl43HuFjcsKI83gcw5RojuXOs8tSo_wsoZQNCbrwig
    [room_number] => fg#99
    [user_name] => くらひで
    [check_in] => 2025-05-30
    [check_out] => 2025-05-31
    [check_out_time] => 11:00
)

[2025-05-30 23:17:05] [INFO] forceフラグ: false
[2025-05-30 23:17:05] [INFO] 処理パラメータ: room=fg#99, user=くらひで, checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 23:17:05] [INFO] IDトークンを検証: eyJraWQiOiI5YjExMTJi...
[2025-05-30 23:17:05] [DEBUG] トークン検証開始: eyJraWQiOiI5YjExMTJi...
[2025-05-30 23:17:05] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748616134
    [iat] => 1748612534
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-30 23:17:05] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-30 23:17:05] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-30 23:17:05] [INFO] データベース接続を開始します
[2025-05-30 23:17:05] [INFO] データベース接続成功
[2025-05-30 23:17:05] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-30 23:17:05] [INFO] line_room_linksテーブルが存在します
[2025-05-30 23:17:05] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-30 23:17:05] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-30 23:17:05] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=208 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-30 23:17:05] [INFO] line_room_linksテーブルのレコード数: 2
[2025-05-30 23:17:05] [INFO] 最新のレコード: {"id":207,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#04","order_session_id":"250530224306984018893","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-30","check_out_date":"2025-05-31","access_token":null,"is_active":0,"created_at":"2025-05-30 18:20:35","updated_at":"2025-05-30 22:49:56"}
[2025-05-30 23:17:05] [INFO] トランザクション開始
[2025-05-30 23:17:05] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-30 23:17:05] [DEBUG] パラメータバインド: roomNumber=fg#99
[2025-05-30 23:17:05] [INFO] 部屋検索クエリ実行完了
[2025-05-30 23:17:05] [INFO] 部屋検索結果: 部屋あり ID=15, アクティブ=1
[2025-05-30 23:17:05] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-30 23:17:05] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-30 23:17:05] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-30 23:17:05] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-30 23:17:05] [INFO] 有効な登録ID: 207, チェックアウト日: 2025-05-31
[2025-05-30 23:17:05] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-30 23:17:05] [INFO] 非アクティブ化した登録数: 0
[2025-05-30 23:17:05] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate,
                    is_active = 1
                WHERE id = :id
            
[2025-05-30 23:17:05] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-30 23:17:05] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-05-30, checkOut=2025-05-31
[2025-05-30 23:17:05] [DEBUG] パラメータバインド: id=207, roomNumber=fg#99, userName=くらひで, checkInDate=2025-05-30, checkOutDate=2025-05-31
[2025-05-30 23:17:05] [INFO] 更新クエリ実行完了: 成功
[2025-05-30 23:17:05] [INFO] 既存登録を更新: id=207
[2025-05-30 23:17:05] [INFO] トランザクションコミット成功
[2025-05-30 23:17:05] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-30 23:17:05] [INFO] JSONレスポンスを送信完了
[2025-05-30 23:17:05] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":207,"registration_type":"update"}
2025-05-30 23:17:05 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#99 - 期間: 2025-05-30 から 2025-05-31
[2025-05-30 23:17:05] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-05-30 23:17:05] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-30 23:17:05] [DEBUG] 出力バッファをフラッシュします
[2025-05-30 23:17:05] [INFO] 処理完了
[2025-05-31 03:29:42] [INFO] --- 登録API処理開始 ---
[2025-05-31 03:29:42] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-31 03:29:42] [INFO] --- 登録API処理開始 ---
[2025-05-31 03:29:42] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-31 03:29:42] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJmZTFlOGQ4ODhlYzY2NGNkMmFmZWY0NzljNWRiNzk2OTJjZDAxYWFjZDE0MTQ4M2E1NDMzOTM1MWYzOTVmYTI3IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYzMzM3NiwiaWF0IjoxNzQ4NjI5Nzc2LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.1X9v5AFjmoD9G0kMmpt1nw1WQzRC7dvuGeUbfZ6SbEOF1XWSaZD2mg9J4u9S-nDxJtY9IfuQERJyTUU_lD5IfA","room_number":"fg#01","user_name":"くらひで","check_in":"2025-05-31","check_out":"2025-06-01","check_out_time":"11:00"}
[2025-05-31 03:29:42] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJmZTFlOGQ4ODhlYzY2NGNkMmFmZWY0NzljNWRiNzk2OTJjZDAxYWFjZDE0MTQ4M2E1NDMzOTM1MWYzOTVmYTI3IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYzMzM3NiwiaWF0IjoxNzQ4NjI5Nzc2LCJhbXIiOlsibGluZXNzbyJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.1X9v5AFjmoD9G0kMmpt1nw1WQzRC7dvuGeUbfZ6SbEOF1XWSaZD2mg9J4u9S-nDxJtY9IfuQERJyTUU_lD5IfA
    [room_number] => fg#01
    [user_name] => くらひで
    [check_in] => 2025-05-31
    [check_out] => 2025-06-01
    [check_out_time] => 11:00
)

[2025-05-31 03:29:42] [INFO] forceフラグ: false
[2025-05-31 03:29:42] [INFO] 処理パラメータ: room=fg#01, user=くらひで, checkIn=2025-05-31, checkOut=2025-06-01
[2025-05-31 03:29:42] [INFO] IDトークンを検証: eyJraWQiOiJmZTFlOGQ4...
[2025-05-31 03:29:42] [DEBUG] トークン検証開始: eyJraWQiOiJmZTFlOGQ4...
[2025-05-31 03:29:42] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748633376
    [iat] => 1748629776
    [amr] => Array
        (
            [0] => linesso
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-31 03:29:42] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-31 03:29:42] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-31 03:29:42] [INFO] データベース接続を開始します
[2025-05-31 03:29:42] [INFO] データベース接続成功
[2025-05-31 03:29:42] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-31 03:29:42] [INFO] line_room_linksテーブルが存在します
[2025-05-31 03:29:42] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-31 03:29:42] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-31 03:29:42] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=208 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-31 03:29:42] [INFO] line_room_linksテーブルのレコード数: 2
[2025-05-31 03:29:42] [INFO] 最新のレコード: {"id":207,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#99","order_session_id":"250530231759511031730","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-30","check_out_date":"2025-05-31","access_token":null,"is_active":0,"created_at":"2025-05-30 18:20:35","updated_at":"2025-05-31 01:11:45"}
[2025-05-31 03:29:42] [INFO] トランザクション開始
[2025-05-31 03:29:42] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-31 03:29:42] [DEBUG] パラメータバインド: roomNumber=fg#01
[2025-05-31 03:29:42] [INFO] 部屋検索クエリ実行完了
[2025-05-31 03:29:42] [INFO] 部屋検索結果: 部屋あり ID=1, アクティブ=1
[2025-05-31 03:29:42] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-31 03:29:42] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-31 03:29:42] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-31 03:29:42] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-31 03:29:42] [INFO] 有効な登録ID: 207, チェックアウト日: 2025-05-31
[2025-05-31 03:29:42] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-31 03:29:42] [INFO] 非アクティブ化した登録数: 0
[2025-05-31 03:29:42] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate,
                    is_active = 1
                WHERE id = :id
            
[2025-05-31 03:29:42] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-31 03:29:42] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-05-31, checkOut=2025-05-31
[2025-05-31 03:29:42] [DEBUG] パラメータバインド: id=207, roomNumber=fg#01, userName=くらひで, checkInDate=2025-05-31, checkOutDate=2025-05-31
[2025-05-31 03:29:42] [INFO] 更新クエリ実行完了: 成功
[2025-05-31 03:29:42] [INFO] 既存登録を更新: id=207
[2025-05-31 03:29:42] [INFO] トランザクションコミット成功
[2025-05-31 03:29:42] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-31 03:29:42] [INFO] JSONレスポンスを送信完了
[2025-05-31 03:29:42] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":207,"registration_type":"update"}
2025-05-31 03:29:42 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#01 - 期間: 2025-05-31 から 2025-05-31
[2025-05-31 03:29:42] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-05-31 03:29:42] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-31 03:29:42] [DEBUG] 出力バッファをフラッシュします
[2025-05-31 03:29:42] [INFO] 処理完了
[2025-05-31 03:30:59] [INFO] --- 登録API処理開始 ---
[2025-05-31 03:30:59] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-31 03:30:59] [INFO] --- 登録API処理開始 ---
[2025-05-31 03:30:59] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-31 03:30:59] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI5NWU5MTE5ZjY1M2VhZTA5NWJiM2Q4NzFkNmJhOGZmNDY0NjdhYTMxNDU3NWE0NTQzNjE1ZjA1MWQ0YjczNWE2IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYzMzQ1NiwiaWF0IjoxNzQ4NjI5ODU2LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.I9IOJZMkBNOK-GL0WzqLhpsgUZ6bd8BQAtC0MfAdM0VZyLWK4mF-G1kPLu_EU4tzX7tP0t7sP58K5mU8eNBSkg","room_number":"fg#04","user_name":"くらひで","check_in":"2025-05-31","check_out":"2025-06-01","check_out_time":"11:00"}
[2025-05-31 03:30:59] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI5NWU5MTE5ZjY1M2VhZTA5NWJiM2Q4NzFkNmJhOGZmNDY0NjdhYTMxNDU3NWE0NTQzNjE1ZjA1MWQ0YjczNWE2IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODYzMzQ1NiwiaWF0IjoxNzQ4NjI5ODU2LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.I9IOJZMkBNOK-GL0WzqLhpsgUZ6bd8BQAtC0MfAdM0VZyLWK4mF-G1kPLu_EU4tzX7tP0t7sP58K5mU8eNBSkg
    [room_number] => fg#04
    [user_name] => くらひで
    [check_in] => 2025-05-31
    [check_out] => 2025-06-01
    [check_out_time] => 11:00
)

[2025-05-31 03:30:59] [INFO] forceフラグ: false
[2025-05-31 03:30:59] [INFO] 処理パラメータ: room=fg#04, user=くらひで, checkIn=2025-05-31, checkOut=2025-06-01
[2025-05-31 03:30:59] [INFO] IDトークンを検証: eyJraWQiOiI5NWU5MTE5...
[2025-05-31 03:30:59] [DEBUG] トークン検証開始: eyJraWQiOiI5NWU5MTE5...
[2025-05-31 03:30:59] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748633456
    [iat] => 1748629856
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-31 03:30:59] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-31 03:30:59] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-31 03:30:59] [INFO] データベース接続を開始します
[2025-05-31 03:30:59] [INFO] データベース接続成功
[2025-05-31 03:30:59] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-31 03:30:59] [INFO] line_room_linksテーブルが存在します
[2025-05-31 03:30:59] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-31 03:30:59] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-31 03:30:59] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=208 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-31 03:30:59] [INFO] line_room_linksテーブルのレコード数: 2
[2025-05-31 03:30:59] [INFO] 最新のレコード: {"id":207,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#01","order_session_id":"250530231759511031730","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-31","check_out_date":"2025-05-31","access_token":null,"is_active":0,"created_at":"2025-05-30 18:20:35","updated_at":"2025-05-31 03:30:33"}
[2025-05-31 03:30:59] [INFO] トランザクション開始
[2025-05-31 03:30:59] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-31 03:30:59] [DEBUG] パラメータバインド: roomNumber=fg#04
[2025-05-31 03:30:59] [INFO] 部屋検索クエリ実行完了
[2025-05-31 03:30:59] [INFO] 部屋検索結果: 部屋あり ID=4, アクティブ=1
[2025-05-31 03:30:59] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-31 03:30:59] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-31 03:30:59] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-31 03:30:59] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-31 03:30:59] [INFO] 有効な登録ID: 207, チェックアウト日: 2025-05-31
[2025-05-31 03:30:59] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-31 03:30:59] [INFO] 非アクティブ化した登録数: 0
[2025-05-31 03:30:59] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate,
                    is_active = 1
                WHERE id = :id
            
[2025-05-31 03:30:59] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-31 03:30:59] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-05-31, checkOut=2025-05-31
[2025-05-31 03:30:59] [DEBUG] パラメータバインド: id=207, roomNumber=fg#04, userName=くらひで, checkInDate=2025-05-31, checkOutDate=2025-05-31
[2025-05-31 03:30:59] [INFO] 更新クエリ実行完了: 成功
[2025-05-31 03:30:59] [INFO] 既存登録を更新: id=207
[2025-05-31 03:30:59] [INFO] トランザクションコミット成功
[2025-05-31 03:30:59] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-31 03:30:59] [INFO] JSONレスポンスを送信完了
[2025-05-31 03:30:59] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":207,"registration_type":"update"}
2025-05-31 03:30:59 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#04 - 期間: 2025-05-31 から 2025-05-31
[2025-05-31 03:30:59] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-05-31 03:30:59] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-31 03:30:59] [DEBUG] 出力バッファをフラッシュします
[2025-05-31 03:30:59] [INFO] 処理完了
[2025-05-31 15:13:17] [INFO] --- 登録API処理開始 ---
[2025-05-31 15:13:17] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-31 15:13:17] [INFO] --- 登録API処理開始 ---
[2025-05-31 15:13:17] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-31 15:13:17] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJjNmYzNGU4NjNkM2U1ZTMyYmEzMjA4MTQwMmQ4YjNlMTBlOGVkYjYzODU2OGE1N2IyNzE2YzBmMzBmNTY3MTAzIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODY3NTU5NCwiaWF0IjoxNzQ4NjcxOTk0LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.0qJhggbJMGz9GYaM0ly9AmpkizrhFUvz6YoGzDahAeVES1MNXdzGUfPp3lAzKOj0peWsnfIN4mWIwD0mTpgZcA","room_number":"fg#12","user_name":"くらひで","check_in":"2025-05-31","check_out":"2025-06-01","check_out_time":"11:00"}
[2025-05-31 15:13:17] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJjNmYzNGU4NjNkM2U1ZTMyYmEzMjA4MTQwMmQ4YjNlMTBlOGVkYjYzODU2OGE1N2IyNzE2YzBmMzBmNTY3MTAzIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODY3NTU5NCwiaWF0IjoxNzQ4NjcxOTk0LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.0qJhggbJMGz9GYaM0ly9AmpkizrhFUvz6YoGzDahAeVES1MNXdzGUfPp3lAzKOj0peWsnfIN4mWIwD0mTpgZcA
    [room_number] => fg#12
    [user_name] => くらひで
    [check_in] => 2025-05-31
    [check_out] => 2025-06-01
    [check_out_time] => 11:00
)

[2025-05-31 15:13:17] [INFO] forceフラグ: false
[2025-05-31 15:13:17] [INFO] 処理パラメータ: room=fg#12, user=くらひで, checkIn=2025-05-31, checkOut=2025-06-01
[2025-05-31 15:13:17] [INFO] IDトークンを検証: eyJraWQiOiJjNmYzNGU4...
[2025-05-31 15:13:17] [DEBUG] トークン検証開始: eyJraWQiOiJjNmYzNGU4...
[2025-05-31 15:13:17] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748675594
    [iat] => 1748671994
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-31 15:13:17] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-31 15:13:17] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-31 15:13:17] [INFO] データベース接続を開始します
[2025-05-31 15:13:17] [INFO] データベース接続成功
[2025-05-31 15:13:17] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-31 15:13:17] [INFO] line_room_linksテーブルが存在します
[2025-05-31 15:13:17] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-31 15:13:17] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-31 15:13:17] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=208 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-31 15:13:17] [INFO] line_room_linksテーブルのレコード数: 2
[2025-05-31 15:13:17] [INFO] 最新のレコード: {"id":207,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#99","order_session_id":"250530231759511031730","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-31","check_out_date":"2025-05-31","access_token":null,"is_active":0,"created_at":"2025-05-30 18:20:35","updated_at":"2025-05-31 14:59:25"}
[2025-05-31 15:13:17] [INFO] トランザクション開始
[2025-05-31 15:13:17] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-31 15:13:17] [DEBUG] パラメータバインド: roomNumber=fg#12
[2025-05-31 15:13:17] [INFO] 部屋検索クエリ実行完了
[2025-05-31 15:13:17] [INFO] 部屋検索結果: 部屋あり ID=12, アクティブ=1
[2025-05-31 15:13:17] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-31 15:13:17] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-31 15:13:17] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-31 15:13:17] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-31 15:13:17] [INFO] 有効な登録ID: 207, チェックアウト日: 2025-05-31
[2025-05-31 15:13:17] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-31 15:13:17] [INFO] 非アクティブ化した登録数: 0
[2025-05-31 15:13:17] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate,
                    is_active = 1
                WHERE id = :id
            
[2025-05-31 15:13:17] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-31 15:13:17] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-05-31, checkOut=2025-05-31
[2025-05-31 15:13:17] [DEBUG] パラメータバインド: id=207, roomNumber=fg#12, userName=くらひで, checkInDate=2025-05-31, checkOutDate=2025-05-31
[2025-05-31 15:13:17] [INFO] 更新クエリ実行完了: 成功
[2025-05-31 15:13:17] [INFO] 既存登録を更新: id=207
[2025-05-31 15:13:17] [INFO] トランザクションコミット成功
[2025-05-31 15:13:17] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-31 15:13:17] [INFO] JSONレスポンスを送信完了
[2025-05-31 15:13:17] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":207,"registration_type":"update"}
2025-05-31 15:13:17 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#12 - 期間: 2025-05-31 から 2025-05-31
[2025-05-31 15:13:17] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-05-31 15:13:17] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-31 15:13:17] [DEBUG] 出力バッファをフラッシュします
[2025-05-31 15:13:17] [INFO] 処理完了
[2025-05-31 20:13:26] [INFO] --- 登録API処理開始 ---
[2025-05-31 20:13:26] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-31 20:13:26] [INFO] --- 登録API処理開始 ---
[2025-05-31 20:13:26] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-31 20:13:26] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI2YWE4YWQwN2NkMmFhYWRjYzY1NmY3ZTIxMzljY2U4YjhjNGE2YzgxYzI5MDQyZjQ4MTY4MDY3MmZkMDNjOTY5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODY5MzQxOCwiaWF0IjoxNzQ4Njg5ODE4LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.L88Na89qRo1E1fbYPivu2qCoci_rDOym5OC_YEqN_9UiTF0gJng0GJBphCrE15r0oRBn6XzomIEq0xYKd_dOmQ","room_number":"fg#05","user_name":"くらひで","check_in":"2025-05-31","check_out":"2025-06-01","check_out_time":"11:00"}
[2025-05-31 20:13:26] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI2YWE4YWQwN2NkMmFhYWRjYzY1NmY3ZTIxMzljY2U4YjhjNGE2YzgxYzI5MDQyZjQ4MTY4MDY3MmZkMDNjOTY5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODY5MzQxOCwiaWF0IjoxNzQ4Njg5ODE4LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.L88Na89qRo1E1fbYPivu2qCoci_rDOym5OC_YEqN_9UiTF0gJng0GJBphCrE15r0oRBn6XzomIEq0xYKd_dOmQ
    [room_number] => fg#05
    [user_name] => くらひで
    [check_in] => 2025-05-31
    [check_out] => 2025-06-01
    [check_out_time] => 11:00
)

[2025-05-31 20:13:26] [INFO] forceフラグ: false
[2025-05-31 20:13:26] [INFO] 処理パラメータ: room=fg#05, user=くらひで, checkIn=2025-05-31, checkOut=2025-06-01
[2025-05-31 20:13:26] [INFO] IDトークンを検証: eyJraWQiOiI2YWE4YWQw...
[2025-05-31 20:13:26] [DEBUG] トークン検証開始: eyJraWQiOiI2YWE4YWQw...
[2025-05-31 20:13:26] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748693418
    [iat] => 1748689818
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-31 20:13:26] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-31 20:13:26] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-31 20:13:26] [INFO] データベース接続を開始します
[2025-05-31 20:13:26] [INFO] データベース接続成功
[2025-05-31 20:13:26] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-31 20:13:26] [INFO] line_room_linksテーブルが存在します
[2025-05-31 20:13:26] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-31 20:13:26] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-31 20:13:26] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=208 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-31 20:13:26] [INFO] line_room_linksテーブルのレコード数: 1
[2025-05-31 20:13:26] [INFO] 最新のレコード: {"id":207,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#12","order_session_id":"250530231759511031730","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-31","check_out_date":"2025-05-31","access_token":null,"is_active":1,"created_at":"2025-05-30 18:20:35","updated_at":"2025-05-31 15:13:17"}
[2025-05-31 20:13:26] [INFO] トランザクション開始
[2025-05-31 20:13:26] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-31 20:13:26] [DEBUG] パラメータバインド: roomNumber=fg#05
[2025-05-31 20:13:26] [INFO] 部屋検索クエリ実行完了
[2025-05-31 20:13:26] [INFO] 部屋検索結果: 部屋あり ID=5, アクティブ=1
[2025-05-31 20:13:26] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-31 20:13:26] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-31 20:13:26] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-31 20:13:26] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-31 20:13:26] [INFO] 部屋変更要求を検出: 旧=fg#12 新=fg#05
[2025-05-31 20:13:26] [INFO] 未払いセッション件数: 0
[2025-05-31 20:13:26] [INFO] 旧リンクを is_active=0 に更新: id=207
[2025-05-31 20:13:26] [INFO] 旧 order_sessions をクローズ: room_number=fg#12
[2025-05-31 20:13:26] [INFO] 有効な登録ID: 207, チェックアウト日: 2025-05-31
[2025-05-31 20:13:26] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-31 20:13:26] [INFO] 非アクティブ化した登録数: 0
[2025-05-31 20:13:26] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate,
                    is_active = 1
                WHERE id = :id
            
[2025-05-31 20:13:26] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-31 20:13:26] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-05-31, checkOut=2025-05-31
[2025-05-31 20:13:26] [DEBUG] パラメータバインド: id=207, roomNumber=fg#05, userName=くらひで, checkInDate=2025-05-31, checkOutDate=2025-05-31
[2025-05-31 20:13:26] [INFO] 更新クエリ実行完了: 成功
[2025-05-31 20:13:26] [INFO] 既存登録を更新: id=207
[2025-05-31 20:13:26] [INFO] トランザクションコミット成功
[2025-05-31 20:13:26] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-31 20:13:26] [INFO] JSONレスポンスを送信完了
[2025-05-31 20:13:26] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":207,"registration_type":"update"}
2025-05-31 20:13:26 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#05 - 期間: 2025-05-31 から 2025-05-31
[2025-05-31 20:13:26] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-05-31 20:13:26] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-31 20:13:26] [DEBUG] 出力バッファをフラッシュします
[2025-05-31 20:13:26] [INFO] 処理完了
[2025-05-31 20:14:07] [INFO] --- 登録API処理開始 ---
[2025-05-31 20:14:07] [INFO] リクエスト元IPアドレス: 27.94.206.33
[2025-05-31 20:14:07] [INFO] --- 登録API処理開始 ---
[2025-05-31 20:14:07] [INFO] リクエスト元IPアドレス: 27.94.206.33
[2025-05-31 20:14:07] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiIwZjdhYzBmOGEyMmUxMzFiNWZlNzVhOWNlMTY5OWFjYTE1MGY3ZjZjMGVkNzVlMjgyYjNiZjdmYjA5N2E3NjNlIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTllMWY1YzY2YjRhMjZmZDBjMzNjODkwYWQ4MjZiMTkyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODY5MzYzNSwiaWF0IjoxNzQ4NjkwMDM1LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi5YCJ55Sw5p-a5pyJIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoV2Q0Z0hnRUZDRXNKSGliallxdDNIRFZiQmlaLU1BNERjU3hGZmkwWVhub2lLaGhPWm5BU0pId1hCQzV4TFVvWk1Tc1FMU3RNWG41dyJ9.6_OF2zxxd7U5akwFdhuiSOWxMEqXElly3IkS37_385G6x6fDcum5FLsuPDC0J4VcFx2kG14VjUcLoDFbiRxeKg","room_number":"fg#99","user_name":"倉田柚有","check_in":"2025-05-31","check_out":"2025-06-01","check_out_time":"11:00"}
[2025-05-31 20:14:07] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiIwZjdhYzBmOGEyMmUxMzFiNWZlNzVhOWNlMTY5OWFjYTE1MGY3ZjZjMGVkNzVlMjgyYjNiZjdmYjA5N2E3NjNlIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTllMWY1YzY2YjRhMjZmZDBjMzNjODkwYWQ4MjZiMTkyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODY5MzYzNSwiaWF0IjoxNzQ4NjkwMDM1LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi5YCJ55Sw5p-a5pyJIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoV2Q0Z0hnRUZDRXNKSGliallxdDNIRFZiQmlaLU1BNERjU3hGZmkwWVhub2lLaGhPWm5BU0pId1hCQzV4TFVvWk1Tc1FMU3RNWG41dyJ9.6_OF2zxxd7U5akwFdhuiSOWxMEqXElly3IkS37_385G6x6fDcum5FLsuPDC0J4VcFx2kG14VjUcLoDFbiRxeKg
    [room_number] => fg#99
    [user_name] => 倉田柚有
    [check_in] => 2025-05-31
    [check_out] => 2025-06-01
    [check_out_time] => 11:00
)

[2025-05-31 20:14:07] [INFO] forceフラグ: false
[2025-05-31 20:14:07] [INFO] 処理パラメータ: room=fg#99, user=倉田柚有, checkIn=2025-05-31, checkOut=2025-06-01
[2025-05-31 20:14:07] [INFO] IDトークンを検証: eyJraWQiOiIwZjdhYzBm...
[2025-05-31 20:14:07] [DEBUG] トークン検証開始: eyJraWQiOiIwZjdhYzBm...
[2025-05-31 20:14:07] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U9e1f5c66b4a26fd0c33c890ad826b192
    [aud] => 2007363986
    [exp] => 1748693635
    [iat] => 1748690035
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => 倉田柚有
    [picture] => https://profile.line-scdn.net/0hWd4gHgEFCEsJHibjYqt3HDVbBiZ-MA4DcSxFfi0YXnoiKhhOZnASJHwXBC5xLUoZMSsQLStMXn5w
)

[2025-05-31 20:14:07] [INFO] トークン検証成功: ユーザーID U9e1f5c66b4a26fd0c33c890ad826b192
[2025-05-31 20:14:07] [INFO] IDトークン検証成功: userId=U9e1f5c66b4a26fd0c33c890ad826b192
[2025-05-31 20:14:07] [INFO] データベース接続を開始します
[2025-05-31 20:14:07] [INFO] データベース接続成功
[2025-05-31 20:14:07] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-31 20:14:07] [INFO] line_room_linksテーブルが存在します
[2025-05-31 20:14:07] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-31 20:14:07] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-31 20:14:07] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=208 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-31 20:14:07] [INFO] line_room_linksテーブルのレコード数: 1
[2025-05-31 20:14:07] [INFO] 最新のレコード: {"id":207,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#05","order_session_id":"250530231759511031730","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-05-31","check_out_date":"2025-05-31","access_token":null,"is_active":1,"created_at":"2025-05-30 18:20:35","updated_at":"2025-05-31 20:13:26"}
[2025-05-31 20:14:07] [INFO] トランザクション開始
[2025-05-31 20:14:07] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-31 20:14:07] [DEBUG] パラメータバインド: roomNumber=fg#99
[2025-05-31 20:14:07] [INFO] 部屋検索クエリ実行完了
[2025-05-31 20:14:07] [INFO] 部屋検索結果: 部屋あり ID=15, アクティブ=1
[2025-05-31 20:14:07] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-31 20:14:07] [DEBUG] パラメータバインド: userId=U9e1f5c66b4a26fd0c33c890ad826b192
[2025-05-31 20:14:07] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-31 20:14:07] [INFO] ユーザー全登録検索結果: 0件の登録あり
[2025-05-31 20:14:07] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-31 20:14:07] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-31 20:14:07] [DEBUG] プリペアドステートメント作成成功
[2025-05-31 20:14:07] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-31, checkOut=2025-06-01
[2025-05-31 20:14:07] [DEBUG] パラメータバインド完了: userId=U9e1f5c66b4a26fd0c33c890ad826b192, roomNumber=fg#99, userName=倉田柚有, checkInDate=2025-05-31, checkOutDate=2025-06-01
[2025-05-31 20:14:07] [INFO] SQLを実行します
[2025-05-31 20:14:07] [DEBUG] 挿入予定の値: {"line_user_id":"U9e1f5c66b4a26fd0c33c890ad826b192","room_number":"fg#99","user_name":"\u5009\u7530\u67da\u6709","check_in_date":"2025-05-31","check_out_date":"2025-06-01"}
[2025-05-31 20:14:07] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-31 20:14:07] [DEBUG] 直接クエリ実行結果: 成功
[2025-05-31 20:14:07] [INFO] 直接クエリで新規登録ID: 208
[2025-05-31 20:14:07] [INFO] トランザクションコミット成功
[2025-05-31 20:14:07] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"208","registration_type":"new"}
[2025-05-31 20:14:07] [INFO] JSONレスポンスを送信完了
[2025-05-31 20:14:07] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に登録されました","registration_id":"208","registration_type":"new"}
2025-05-31 20:14:07 - ユーザーID: U9e1f5c66b4a26fd0c33c890ad826b192 - 部屋番号新規登録 - 部屋: fg#99 - 期間: 2025-05-31 から 2025-06-01
[2025-05-31 20:14:07] [DEBUG] 出力バッファに169バイトのデータがあります
[2025-05-31 20:14:07] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"208","registration_type":"new"}
[2025-05-31 20:14:07] [DEBUG] 出力バッファをフラッシュします
[2025-05-31 20:14:07] [INFO] 処理完了
[2025-05-31 20:15:30] [INFO] --- 登録API処理開始 ---
[2025-05-31 20:15:30] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-31 20:15:30] [INFO] --- 登録API処理開始 ---
[2025-05-31 20:15:30] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-31 20:15:30] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJjNmYzNGU4NjNkM2U1ZTMyYmEzMjA4MTQwMmQ4YjNlMTBlOGVkYjYzODU2OGE1N2IyNzE2YzBmMzBmNTY3MTAzIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODY5MzcxNCwiaWF0IjoxNzQ4NjkwMTE0LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.6LuucJ-_ML2DeVW9O0zBgpwjWeQ4U1QJQ9ZDBTgwyt7Cpcgo0ER1saJDM2sh4SxXKIL0SXEqqTUucLayNxDsvw","room_number":"fg#05","user_name":"くらひで","check_in":"2025-05-31","check_out":"2025-06-01","check_out_time":"11:00"}
[2025-05-31 20:15:30] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJjNmYzNGU4NjNkM2U1ZTMyYmEzMjA4MTQwMmQ4YjNlMTBlOGVkYjYzODU2OGE1N2IyNzE2YzBmMzBmNTY3MTAzIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODY5MzcxNCwiaWF0IjoxNzQ4NjkwMTE0LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.6LuucJ-_ML2DeVW9O0zBgpwjWeQ4U1QJQ9ZDBTgwyt7Cpcgo0ER1saJDM2sh4SxXKIL0SXEqqTUucLayNxDsvw
    [room_number] => fg#05
    [user_name] => くらひで
    [check_in] => 2025-05-31
    [check_out] => 2025-06-01
    [check_out_time] => 11:00
)

[2025-05-31 20:15:30] [INFO] forceフラグ: false
[2025-05-31 20:15:30] [INFO] 処理パラメータ: room=fg#05, user=くらひで, checkIn=2025-05-31, checkOut=2025-06-01
[2025-05-31 20:15:30] [INFO] IDトークンを検証: eyJraWQiOiJjNmYzNGU4...
[2025-05-31 20:15:30] [DEBUG] トークン検証開始: eyJraWQiOiJjNmYzNGU4...
[2025-05-31 20:15:30] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748693714
    [iat] => 1748690114
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-31 20:15:30] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-31 20:15:30] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-31 20:15:30] [INFO] データベース接続を開始します
[2025-05-31 20:15:30] [INFO] データベース接続成功
[2025-05-31 20:15:30] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-31 20:15:30] [INFO] line_room_linksテーブルが存在します
[2025-05-31 20:15:30] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-31 20:15:30] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-31 20:15:30] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=209 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-31 20:15:30] [INFO] line_room_linksテーブルのレコード数: 2
[2025-05-31 20:15:30] [INFO] 最新のレコード: {"id":208,"line_user_id":"U9e1f5c66b4a26fd0c33c890ad826b192","room_number":"fg#99","order_session_id":null,"user_name":"\u5009\u7530\u67da\u6709","check_in_date":"2025-05-31","check_out_date":"2025-06-01","access_token":null,"is_active":1,"created_at":"2025-05-31 20:14:07","updated_at":"2025-05-31 20:14:07"}
[2025-05-31 20:15:30] [INFO] トランザクション開始
[2025-05-31 20:15:30] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-31 20:15:30] [DEBUG] パラメータバインド: roomNumber=fg#05
[2025-05-31 20:15:30] [INFO] 部屋検索クエリ実行完了
[2025-05-31 20:15:30] [INFO] 部屋検索結果: 部屋あり ID=5, アクティブ=1
[2025-05-31 20:15:30] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-31 20:15:30] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-31 20:15:30] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-31 20:15:30] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-31 20:15:30] [INFO] 有効な登録ID: 207, チェックアウト日: 2025-05-31
[2025-05-31 20:15:30] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-31 20:15:30] [INFO] 非アクティブ化した登録数: 1
[2025-05-31 20:15:30] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate,
                    is_active = 1
                WHERE id = :id
            
[2025-05-31 20:15:30] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-31 20:15:30] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-05-31, checkOut=2025-05-31
[2025-05-31 20:15:30] [DEBUG] パラメータバインド: id=207, roomNumber=fg#05, userName=くらひで, checkInDate=2025-05-31, checkOutDate=2025-05-31
[2025-05-31 20:15:30] [INFO] 更新クエリ実行完了: 成功
[2025-05-31 20:15:30] [INFO] 既存登録を更新: id=207
[2025-05-31 20:15:30] [INFO] トランザクションコミット成功
[2025-05-31 20:15:30] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-31 20:15:30] [INFO] JSONレスポンスを送信完了
[2025-05-31 20:15:30] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":207,"registration_type":"update"}
2025-05-31 20:15:30 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#05 - 期間: 2025-05-31 から 2025-05-31
[2025-05-31 20:15:30] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-05-31 20:15:30] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-31 20:15:30] [DEBUG] 出力バッファをフラッシュします
[2025-05-31 20:15:30] [INFO] 処理完了
[2025-05-31 20:37:26] [INFO] --- 登録API処理開始 ---
[2025-05-31 20:37:26] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-31 20:37:26] [INFO] --- 登録API処理開始 ---
[2025-05-31 20:37:26] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-31 20:37:26] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODY5Mzg0MCwiaWF0IjoxNzQ4NjkwMjQwLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.5g1vyU_kRyJgV576lNVmJpeADWeBGZ4RKOx8gLS6H4nlVelXxexVWKMZHbvEYxe4mQOvztgIwKQVHOSoMbp96w","room_number":"fg#11","user_name":"くらひで","check_in":"2025-05-31","check_out":"2025-06-01","check_out_time":"11:00"}
[2025-05-31 20:37:26] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODY5Mzg0MCwiaWF0IjoxNzQ4NjkwMjQwLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.5g1vyU_kRyJgV576lNVmJpeADWeBGZ4RKOx8gLS6H4nlVelXxexVWKMZHbvEYxe4mQOvztgIwKQVHOSoMbp96w
    [room_number] => fg#11
    [user_name] => くらひで
    [check_in] => 2025-05-31
    [check_out] => 2025-06-01
    [check_out_time] => 11:00
)

[2025-05-31 20:37:26] [INFO] forceフラグ: false
[2025-05-31 20:37:26] [INFO] 処理パラメータ: room=fg#11, user=くらひで, checkIn=2025-05-31, checkOut=2025-06-01
[2025-05-31 20:37:26] [INFO] IDトークンを検証: eyJraWQiOiJjY2Q1OGMy...
[2025-05-31 20:37:26] [DEBUG] トークン検証開始: eyJraWQiOiJjY2Q1OGMy...
[2025-05-31 20:37:26] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748693840
    [iat] => 1748690240
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-31 20:37:26] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-31 20:37:26] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-31 20:37:26] [INFO] データベース接続を開始します
[2025-05-31 20:37:26] [INFO] データベース接続成功
[2025-05-31 20:37:26] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-31 20:37:26] [INFO] line_room_linksテーブルが存在します
[2025-05-31 20:37:26] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-31 20:37:26] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-31 20:37:26] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=209 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-31 20:37:26] [INFO] line_room_linksテーブルのレコード数: 2
[2025-05-31 20:37:26] [INFO] 最新のレコード: {"id":208,"line_user_id":"U9e1f5c66b4a26fd0c33c890ad826b192","room_number":"fg#99","order_session_id":null,"user_name":"\u5009\u7530\u67da\u6709","check_in_date":"2025-05-31","check_out_date":"2025-06-01","access_token":null,"is_active":1,"created_at":"2025-05-31 20:14:07","updated_at":"2025-05-31 20:14:07"}
[2025-05-31 20:37:26] [INFO] トランザクション開始
[2025-05-31 20:37:26] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-31 20:37:26] [DEBUG] パラメータバインド: roomNumber=fg#11
[2025-05-31 20:37:26] [INFO] 部屋検索クエリ実行完了
[2025-05-31 20:37:26] [INFO] 部屋検索結果: 部屋あり ID=11, アクティブ=1
[2025-05-31 20:37:26] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-31 20:37:26] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-31 20:37:26] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-31 20:37:26] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-31 20:37:26] [INFO] 部屋変更要求を検出: 旧=fg#05 新=fg#11
[2025-05-31 20:37:26] [INFO] 未払いセッション件数: 0
[2025-05-31 20:37:26] [INFO] 旧リンクを is_active=0 に更新: id=207
[2025-05-31 20:37:26] [INFO] 旧 order_sessions をクローズ: room_number=fg#05
[2025-05-31 20:37:26] [INFO] 有効な登録ID: 207, チェックアウト日: 2025-05-31
[2025-05-31 20:37:26] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-31 20:37:26] [INFO] 非アクティブ化した登録数: 0
[2025-05-31 20:37:26] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate,
                    is_active = 1
                WHERE id = :id
            
[2025-05-31 20:37:26] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-31 20:37:26] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-05-31, checkOut=2025-05-31
[2025-05-31 20:37:26] [DEBUG] パラメータバインド: id=207, roomNumber=fg#11, userName=くらひで, checkInDate=2025-05-31, checkOutDate=2025-05-31
[2025-05-31 20:37:26] [INFO] 更新クエリ実行完了: 成功
[2025-05-31 20:37:26] [INFO] 既存登録を更新: id=207
[2025-05-31 20:37:26] [INFO] トランザクションコミット成功
[2025-05-31 20:37:26] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-31 20:37:26] [INFO] JSONレスポンスを送信完了
[2025-05-31 20:37:26] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":207,"registration_type":"update"}
2025-05-31 20:37:26 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#11 - 期間: 2025-05-31 から 2025-05-31
[2025-05-31 20:37:26] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-05-31 20:37:26] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-31 20:37:26] [DEBUG] 出力バッファをフラッシュします
[2025-05-31 20:37:26] [INFO] 処理完了
[2025-05-31 20:40:28] [INFO] --- 登録API処理開始 ---
[2025-05-31 20:40:28] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-31 20:40:28] [INFO] --- 登録API処理開始 ---
[2025-05-31 20:40:28] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-31 20:40:28] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODY5Mzg0MCwiaWF0IjoxNzQ4NjkwMjQwLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.5g1vyU_kRyJgV576lNVmJpeADWeBGZ4RKOx8gLS6H4nlVelXxexVWKMZHbvEYxe4mQOvztgIwKQVHOSoMbp96w","room_number":"fg#11","user_name":"くらひで","check_in":"2025-05-31","check_out":"2025-06-01","check_out_time":"11:00"}
[2025-05-31 20:40:28] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODY5Mzg0MCwiaWF0IjoxNzQ4NjkwMjQwLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.5g1vyU_kRyJgV576lNVmJpeADWeBGZ4RKOx8gLS6H4nlVelXxexVWKMZHbvEYxe4mQOvztgIwKQVHOSoMbp96w
    [room_number] => fg#11
    [user_name] => くらひで
    [check_in] => 2025-05-31
    [check_out] => 2025-06-01
    [check_out_time] => 11:00
)

[2025-05-31 20:40:28] [INFO] forceフラグ: false
[2025-05-31 20:40:28] [INFO] 処理パラメータ: room=fg#11, user=くらひで, checkIn=2025-05-31, checkOut=2025-06-01
[2025-05-31 20:40:28] [INFO] IDトークンを検証: eyJraWQiOiJjY2Q1OGMy...
[2025-05-31 20:40:28] [DEBUG] トークン検証開始: eyJraWQiOiJjY2Q1OGMy...
[2025-05-31 20:40:28] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748693840
    [iat] => 1748690240
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-31 20:40:28] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-31 20:40:28] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-31 20:40:28] [INFO] データベース接続を開始します
[2025-05-31 20:40:28] [INFO] データベース接続成功
[2025-05-31 20:40:28] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-31 20:40:28] [INFO] line_room_linksテーブルが存在します
[2025-05-31 20:40:28] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-31 20:40:28] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-31 20:40:28] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=209 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-31 20:40:28] [INFO] line_room_linksテーブルのレコード数: 2
[2025-05-31 20:40:28] [INFO] 最新のレコード: {"id":208,"line_user_id":"U9e1f5c66b4a26fd0c33c890ad826b192","room_number":"fg#99","order_session_id":null,"user_name":"\u5009\u7530\u67da\u6709","check_in_date":"2025-05-31","check_out_date":"2025-06-01","access_token":null,"is_active":1,"created_at":"2025-05-31 20:14:07","updated_at":"2025-05-31 20:14:07"}
[2025-05-31 20:40:28] [INFO] トランザクション開始
[2025-05-31 20:40:28] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-31 20:40:28] [DEBUG] パラメータバインド: roomNumber=fg#11
[2025-05-31 20:40:28] [INFO] 部屋検索クエリ実行完了
[2025-05-31 20:40:28] [INFO] 部屋検索結果: 部屋あり ID=11, アクティブ=1
[2025-05-31 20:40:28] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-31 20:40:28] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-31 20:40:28] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-31 20:40:28] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-31 20:40:28] [INFO] 有効な登録ID: 207, チェックアウト日: 2025-05-31
[2025-05-31 20:40:28] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-31 20:40:28] [INFO] 非アクティブ化した登録数: 1
[2025-05-31 20:40:28] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate,
                    is_active = 1
                WHERE id = :id
            
[2025-05-31 20:40:28] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-31 20:40:28] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-05-31, checkOut=2025-05-31
[2025-05-31 20:40:28] [DEBUG] パラメータバインド: id=207, roomNumber=fg#11, userName=くらひで, checkInDate=2025-05-31, checkOutDate=2025-05-31
[2025-05-31 20:40:28] [INFO] 更新クエリ実行完了: 成功
[2025-05-31 20:40:28] [INFO] 既存登録を更新: id=207
[2025-05-31 20:40:28] [INFO] トランザクションコミット成功
[2025-05-31 20:40:28] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-31 20:40:28] [INFO] JSONレスポンスを送信完了
[2025-05-31 20:40:28] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":207,"registration_type":"update"}
2025-05-31 20:40:28 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#11 - 期間: 2025-05-31 から 2025-05-31
[2025-05-31 20:40:28] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-05-31 20:40:28] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-31 20:40:28] [DEBUG] 出力バッファをフラッシュします
[2025-05-31 20:40:28] [INFO] 処理完了
[2025-05-31 20:50:52] [INFO] --- 登録API処理開始 ---
[2025-05-31 20:50:52] [INFO] リクエスト元IPアドレス: 116.254.34.167
[2025-05-31 20:50:52] [INFO] --- 登録API処理開始 ---
[2025-05-31 20:50:52] [INFO] リクエスト元IPアドレス: 116.254.34.167
[2025-05-31 20:50:52] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI3ZjMxMTU5YTY1YWE0YmYxZGRmMzQyYjU3MTcwZGQ3NDY3ZTkyZDEyZTg0YzI0Y2EyMGUxNDQyNTUzYjNmMDhjIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTBkMmE4MzNiMDdmZjhkYTZlMTExNDQwYTEwM2M5ZTM3IiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODY5NTg0NywiaWF0IjoxNzQ4NjkyMjQ3LCJuYW1lIjoi44Go44KC44G_IiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoa19YeE5RTmhOSEJsQVNOT3UtSkxKMWxFT2gwU0x6STRIV1FySGtVQlBrWWZNWHAwWFRBcFFSQlViRVFZWVhNdURqVl9Ia2RSYTBRYyJ9.xkK-cBaqPjcL-ziQUCgcLL14LDo6FSwufEtCbuzPkJwTvPeugrA0JS3D5jHgMLmqwmSGAWpdcLseh6slDfw8uA","room_number":"fg#09","user_name":"ともみ","check_in":"2025-05-31","check_out":"2025-06-01","check_out_time":"11:00"}
[2025-05-31 20:50:52] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI3ZjMxMTU5YTY1YWE0YmYxZGRmMzQyYjU3MTcwZGQ3NDY3ZTkyZDEyZTg0YzI0Y2EyMGUxNDQyNTUzYjNmMDhjIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTBkMmE4MzNiMDdmZjhkYTZlMTExNDQwYTEwM2M5ZTM3IiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODY5NTg0NywiaWF0IjoxNzQ4NjkyMjQ3LCJuYW1lIjoi44Go44KC44G_IiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoa19YeE5RTmhOSEJsQVNOT3UtSkxKMWxFT2gwU0x6STRIV1FySGtVQlBrWWZNWHAwWFRBcFFSQlViRVFZWVhNdURqVl9Ia2RSYTBRYyJ9.xkK-cBaqPjcL-ziQUCgcLL14LDo6FSwufEtCbuzPkJwTvPeugrA0JS3D5jHgMLmqwmSGAWpdcLseh6slDfw8uA
    [room_number] => fg#09
    [user_name] => ともみ
    [check_in] => 2025-05-31
    [check_out] => 2025-06-01
    [check_out_time] => 11:00
)

[2025-05-31 20:50:52] [INFO] forceフラグ: false
[2025-05-31 20:50:52] [INFO] 処理パラメータ: room=fg#09, user=ともみ, checkIn=2025-05-31, checkOut=2025-06-01
[2025-05-31 20:50:52] [INFO] IDトークンを検証: eyJraWQiOiI3ZjMxMTU5...
[2025-05-31 20:50:52] [DEBUG] トークン検証開始: eyJraWQiOiI3ZjMxMTU5...
[2025-05-31 20:50:52] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U0d2a833b07ff8da6e111440a103c9e37
    [aud] => 2007363986
    [exp] => 1748695847
    [iat] => 1748692247
    [name] => ともみ
    [picture] => https://profile.line-scdn.net/0hk_XxNQNhNHBlASNOu-JLJ1lEOh0SLzI4HWQrHkUBPkYfMXp0XTApQRBUbEQYYXMuDjV_HkdRa0Qc
)

[2025-05-31 20:50:52] [INFO] トークン検証成功: ユーザーID U0d2a833b07ff8da6e111440a103c9e37
[2025-05-31 20:50:52] [INFO] IDトークン検証成功: userId=U0d2a833b07ff8da6e111440a103c9e37
[2025-05-31 20:50:52] [INFO] データベース接続を開始します
[2025-05-31 20:50:52] [INFO] データベース接続成功
[2025-05-31 20:50:52] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-31 20:50:52] [INFO] line_room_linksテーブルが存在します
[2025-05-31 20:50:52] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-31 20:50:52] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-31 20:50:52] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=209 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-31 20:50:52] [INFO] line_room_linksテーブルのレコード数: 2
[2025-05-31 20:50:52] [INFO] 最新のレコード: {"id":208,"line_user_id":"U9e1f5c66b4a26fd0c33c890ad826b192","room_number":"fg#99","order_session_id":null,"user_name":"\u5009\u7530\u67da\u6709","check_in_date":"2025-05-31","check_out_date":"2025-06-01","access_token":null,"is_active":1,"created_at":"2025-05-31 20:14:07","updated_at":"2025-05-31 20:14:07"}
[2025-05-31 20:50:52] [INFO] トランザクション開始
[2025-05-31 20:50:52] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-31 20:50:52] [DEBUG] パラメータバインド: roomNumber=fg#09
[2025-05-31 20:50:52] [INFO] 部屋検索クエリ実行完了
[2025-05-31 20:50:52] [INFO] 部屋検索結果: 部屋あり ID=9, アクティブ=1
[2025-05-31 20:50:52] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-31 20:50:52] [DEBUG] パラメータバインド: userId=U0d2a833b07ff8da6e111440a103c9e37
[2025-05-31 20:50:52] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-31 20:50:52] [INFO] ユーザー全登録検索結果: 0件の登録あり
[2025-05-31 20:50:52] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-05-31 20:50:52] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-31 20:50:52] [DEBUG] プリペアドステートメント作成成功
[2025-05-31 20:50:52] [DEBUG] DateTimeを文字列に変換: checkIn=2025-05-31, checkOut=2025-06-01
[2025-05-31 20:50:52] [DEBUG] パラメータバインド完了: userId=U0d2a833b07ff8da6e111440a103c9e37, roomNumber=fg#09, userName=ともみ, checkInDate=2025-05-31, checkOutDate=2025-06-01
[2025-05-31 20:50:52] [INFO] SQLを実行します
[2025-05-31 20:50:52] [DEBUG] 挿入予定の値: {"line_user_id":"U0d2a833b07ff8da6e111440a103c9e37","room_number":"fg#09","user_name":"\u3068\u3082\u307f","check_in_date":"2025-05-31","check_out_date":"2025-06-01"}
[2025-05-31 20:50:52] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-05-31 20:50:52] [DEBUG] 直接クエリ実行結果: 成功
[2025-05-31 20:50:52] [INFO] 直接クエリで新規登録ID: 209
[2025-05-31 20:50:52] [INFO] トランザクションコミット成功
[2025-05-31 20:50:52] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"209","registration_type":"new"}
[2025-05-31 20:50:52] [INFO] JSONレスポンスを送信完了
[2025-05-31 20:50:52] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に登録されました","registration_id":"209","registration_type":"new"}
2025-05-31 20:50:52 - ユーザーID: U0d2a833b07ff8da6e111440a103c9e37 - 部屋番号新規登録 - 部屋: fg#09 - 期間: 2025-05-31 から 2025-06-01
[2025-05-31 20:50:52] [DEBUG] 出力バッファに169バイトのデータがあります
[2025-05-31 20:50:52] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"209","registration_type":"new"}
[2025-05-31 20:50:52] [DEBUG] 出力バッファをフラッシュします
[2025-05-31 20:50:52] [INFO] 処理完了
[2025-05-31 20:59:45] [INFO] --- 登録API処理開始 ---
[2025-05-31 20:59:45] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-31 20:59:45] [INFO] --- 登録API処理開始 ---
[2025-05-31 20:59:45] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-05-31 20:59:45] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhNTI0YTQwNGU3YTk3ZDM1ZGM2NDYzMzc1NjMwNTUyNWVkMmRjNGE1YjQ4YTEzMDczNmY3NGU5YTNhNWQ0YjFkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODY5NjM2NywiaWF0IjoxNzQ4NjkyNzY3LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.ztlrTYX_2wawWT45ve-8GlcRnROEKeTgwoAIkFPaOgj9muhjRHYdZVC4RqQQoGgNrns-viraANoPNBFMTNaRyw","room_number":"fg#08","user_name":"くらひで","check_in":"2025-05-31","check_out":"2025-06-01","check_out_time":"11:00"}
[2025-05-31 20:59:45] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhNTI0YTQwNGU3YTk3ZDM1ZGM2NDYzMzc1NjMwNTUyNWVkMmRjNGE1YjQ4YTEzMDczNmY3NGU5YTNhNWQ0YjFkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODY5NjM2NywiaWF0IjoxNzQ4NjkyNzY3LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.ztlrTYX_2wawWT45ve-8GlcRnROEKeTgwoAIkFPaOgj9muhjRHYdZVC4RqQQoGgNrns-viraANoPNBFMTNaRyw
    [room_number] => fg#08
    [user_name] => くらひで
    [check_in] => 2025-05-31
    [check_out] => 2025-06-01
    [check_out_time] => 11:00
)

[2025-05-31 20:59:45] [INFO] forceフラグ: false
[2025-05-31 20:59:45] [INFO] 処理パラメータ: room=fg#08, user=くらひで, checkIn=2025-05-31, checkOut=2025-06-01
[2025-05-31 20:59:45] [INFO] IDトークンを検証: eyJraWQiOiJhNTI0YTQw...
[2025-05-31 20:59:45] [DEBUG] トークン検証開始: eyJraWQiOiJhNTI0YTQw...
[2025-05-31 20:59:45] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748696367
    [iat] => 1748692767
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-05-31 20:59:45] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-05-31 20:59:45] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-05-31 20:59:45] [INFO] データベース接続を開始します
[2025-05-31 20:59:45] [INFO] データベース接続成功
[2025-05-31 20:59:45] [INFO] line_room_linksテーブルの構造を確認します
[2025-05-31 20:59:45] [INFO] line_room_linksテーブルが存在します
[2025-05-31 20:59:45] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-05-31 20:59:45] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-05-31 20:59:45] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=210 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-05-31 20:59:45] [INFO] line_room_linksテーブルのレコード数: 3
[2025-05-31 20:59:45] [INFO] 最新のレコード: {"id":209,"line_user_id":"U0d2a833b07ff8da6e111440a103c9e37","room_number":"fg#09","order_session_id":"250531205149768947569","user_name":"\u3068\u3082\u307f","check_in_date":"2025-05-31","check_out_date":"2025-06-01","access_token":null,"is_active":1,"created_at":"2025-05-31 20:50:52","updated_at":"2025-05-31 20:51:49"}
[2025-05-31 20:59:45] [INFO] トランザクション開始
[2025-05-31 20:59:45] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-05-31 20:59:45] [DEBUG] パラメータバインド: roomNumber=fg#08
[2025-05-31 20:59:45] [INFO] 部屋検索クエリ実行完了
[2025-05-31 20:59:45] [INFO] 部屋検索結果: 部屋あり ID=8, アクティブ=1
[2025-05-31 20:59:45] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-05-31 20:59:45] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-05-31 20:59:45] [INFO] ユーザー全登録検索クエリ実行完了
[2025-05-31 20:59:45] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-05-31 20:59:45] [INFO] 有効な登録ID: 207, チェックアウト日: 2025-05-31
[2025-05-31 20:59:45] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-05-31 20:59:45] [INFO] 非アクティブ化した登録数: 0
[2025-05-31 20:59:45] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate,
                    is_active = 1
                WHERE id = :id
            
[2025-05-31 20:59:45] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-05-31 20:59:45] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-05-31, checkOut=2025-05-31
[2025-05-31 20:59:45] [DEBUG] パラメータバインド: id=207, roomNumber=fg#08, userName=くらひで, checkInDate=2025-05-31, checkOutDate=2025-05-31
[2025-05-31 20:59:45] [INFO] 更新クエリ実行完了: 成功
[2025-05-31 20:59:45] [INFO] 既存登録を更新: id=207
[2025-05-31 20:59:45] [INFO] トランザクションコミット成功
[2025-05-31 20:59:45] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-31 20:59:45] [INFO] JSONレスポンスを送信完了
[2025-05-31 20:59:45] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":207,"registration_type":"update"}
2025-05-31 20:59:45 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#08 - 期間: 2025-05-31 から 2025-05-31
[2025-05-31 20:59:45] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-05-31 20:59:45] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"update"}
[2025-05-31 20:59:45] [DEBUG] 出力バッファをフラッシュします
[2025-05-31 20:59:45] [INFO] 処理完了
[2025-06-01 07:39:17] [INFO] --- 登録API処理開始 ---
[2025-06-01 07:39:17] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 07:39:17] [INFO] --- 登録API処理開始 ---
[2025-06-01 07:39:17] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 07:39:17] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhNTI0YTQwNGU3YTk3ZDM1ZGM2NDYzMzc1NjMwNTUyNWVkMmRjNGE1YjQ4YTEzMDczNmY3NGU5YTNhNWQ0YjFkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODczNDc0NywiaWF0IjoxNzQ4NzMxMTQ3LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.x2MESI3_Sb1d5q5h9kovcyLzyQgqNpqHcNgVv2NDqkF65GvMX-_X-8LUL2l4hlwGWKCJ0LV7uwTtCb3ceamtBw","room_number":"fg#07","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00"}
[2025-06-01 07:39:17] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhNTI0YTQwNGU3YTk3ZDM1ZGM2NDYzMzc1NjMwNTUyNWVkMmRjNGE1YjQ4YTEzMDczNmY3NGU5YTNhNWQ0YjFkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODczNDc0NywiaWF0IjoxNzQ4NzMxMTQ3LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.x2MESI3_Sb1d5q5h9kovcyLzyQgqNpqHcNgVv2NDqkF65GvMX-_X-8LUL2l4hlwGWKCJ0LV7uwTtCb3ceamtBw
    [room_number] => fg#07
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
)

[2025-06-01 07:39:17] [INFO] forceフラグ: false
[2025-06-01 07:39:17] [INFO] 処理パラメータ: room=fg#07, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 07:39:17] [INFO] IDトークンを検証: eyJraWQiOiJhNTI0YTQw...
[2025-06-01 07:39:17] [DEBUG] トークン検証開始: eyJraWQiOiJhNTI0YTQw...
[2025-06-01 07:39:17] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748734747
    [iat] => 1748731147
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 07:39:17] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 07:39:17] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 07:39:17] [INFO] データベース接続を開始します
[2025-06-01 07:39:17] [INFO] データベース接続成功
[2025-06-01 07:39:17] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 07:39:17] [INFO] line_room_linksテーブルが存在します
[2025-06-01 07:39:17] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 07:39:17] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 07:39:17] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=210 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 07:39:17] [INFO] line_room_linksテーブルのレコード数: 3
[2025-06-01 07:39:17] [INFO] 最新のレコード: {"id":209,"line_user_id":"U0d2a833b07ff8da6e111440a103c9e37","room_number":"fg#09","order_session_id":"250531205149768947569","user_name":"\u3068\u3082\u307f","check_in_date":"2025-05-31","check_out_date":"2025-06-01","access_token":null,"is_active":1,"created_at":"2025-05-31 20:50:52","updated_at":"2025-05-31 20:51:49"}
[2025-06-01 07:39:17] [INFO] トランザクション開始
[2025-06-01 07:39:17] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 07:39:17] [DEBUG] パラメータバインド: roomNumber=fg#07
[2025-06-01 07:39:17] [INFO] 部屋検索クエリ実行完了
[2025-06-01 07:39:17] [INFO] 部屋検索結果: 部屋あり ID=7, アクティブ=1
[2025-06-01 07:39:17] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 07:39:17] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 07:39:17] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 07:39:17] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 07:39:17] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 07:39:17] [INFO] 非アクティブ化した登録数: 0
[2025-06-01 07:39:17] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-01 07:39:17] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 07:39:17] [DEBUG] プリペアドステートメント作成成功
[2025-06-01 07:39:17] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-01, checkOut=2025-05-31
[2025-06-01 07:39:17] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#07, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-05-31
[2025-06-01 07:39:17] [INFO] SQLを実行します
[2025-06-01 07:39:17] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#07","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-05-31"}
[2025-06-01 07:39:17] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-01 07:39:17] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 07:39:17] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 07:39:17] [ERROR] エラーコード: 23000
[2025-06-01 07:39:17] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-06-01 07:39:17] [ERROR] SQLステート: 23000
[2025-06-01 07:39:17] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-06-01 07:39:17] [ERROR] スタックトレース: #0 {main}
[2025-06-01 07:39:17] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-06-01 07:39:17] [ERROR] スタックトレース: #0 {main}
[2025-06-01 07:39:17] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-06-01 07:39:17] [INFO] エラーJSONレスポンスを送信完了
[2025-06-01 07:39:17] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-06-01 07:39:17] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-06-01 07:39:17] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-06-01 07:39:17] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 07:39:17] [INFO] 処理完了
[2025-06-01 07:39:17] [INFO] --- 登録API処理開始 ---
[2025-06-01 07:39:17] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 07:39:17] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhNTI0YTQwNGU3YTk3ZDM1ZGM2NDYzMzc1NjMwNTUyNWVkMmRjNGE1YjQ4YTEzMDczNmY3NGU5YTNhNWQ0YjFkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODczNDc0NywiaWF0IjoxNzQ4NzMxMTQ3LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.x2MESI3_Sb1d5q5h9kovcyLzyQgqNpqHcNgVv2NDqkF65GvMX-_X-8LUL2l4hlwGWKCJ0LV7uwTtCb3ceamtBw","room_number":"fg#07","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00","force":true}
[2025-06-01 07:39:17] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhNTI0YTQwNGU3YTk3ZDM1ZGM2NDYzMzc1NjMwNTUyNWVkMmRjNGE1YjQ4YTEzMDczNmY3NGU5YTNhNWQ0YjFkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODczNDc0NywiaWF0IjoxNzQ4NzMxMTQ3LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.x2MESI3_Sb1d5q5h9kovcyLzyQgqNpqHcNgVv2NDqkF65GvMX-_X-8LUL2l4hlwGWKCJ0LV7uwTtCb3ceamtBw
    [room_number] => fg#07
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
    [force] => 1
)

[2025-06-01 07:39:17] [INFO] forceフラグ: true
[2025-06-01 07:39:17] [INFO] 処理パラメータ: room=fg#07, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 07:39:17] [INFO] IDトークンを検証: eyJraWQiOiJhNTI0YTQw...
[2025-06-01 07:39:17] [DEBUG] トークン検証開始: eyJraWQiOiJhNTI0YTQw...
[2025-06-01 07:39:17] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748734747
    [iat] => 1748731147
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 07:39:17] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 07:39:17] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 07:39:17] [INFO] データベース接続を開始します
[2025-06-01 07:39:17] [INFO] データベース接続成功
[2025-06-01 07:39:17] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 07:39:17] [INFO] line_room_linksテーブルが存在します
[2025-06-01 07:39:17] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 07:39:17] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 07:39:17] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=212 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 07:39:17] [INFO] line_room_linksテーブルのレコード数: 3
[2025-06-01 07:39:17] [INFO] 最新のレコード: {"id":209,"line_user_id":"U0d2a833b07ff8da6e111440a103c9e37","room_number":"fg#09","order_session_id":"250531205149768947569","user_name":"\u3068\u3082\u307f","check_in_date":"2025-05-31","check_out_date":"2025-06-01","access_token":null,"is_active":1,"created_at":"2025-05-31 20:50:52","updated_at":"2025-05-31 20:51:49"}
[2025-06-01 07:39:17] [INFO] トランザクション開始
[2025-06-01 07:39:17] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 07:39:17] [DEBUG] パラメータバインド: roomNumber=fg#07
[2025-06-01 07:39:17] [INFO] 部屋検索クエリ実行完了
[2025-06-01 07:39:17] [INFO] 部屋検索結果: 部屋あり ID=7, アクティブ=1
[2025-06-01 07:39:17] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 07:39:17] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 07:39:17] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 07:39:17] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 07:39:17] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 07:39:17] [INFO] 非アクティブ化した登録数: 0
[2025-06-01 07:39:17] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-01 07:39:17] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 07:39:17] [DEBUG] プリペアドステートメント作成成功
[2025-06-01 07:39:17] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-01, checkOut=2025-05-31
[2025-06-01 07:39:17] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#07, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-05-31
[2025-06-01 07:39:17] [INFO] SQLを実行します
[2025-06-01 07:39:17] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#07","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-05-31"}
[2025-06-01 07:39:17] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-01 07:39:17] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 07:39:17] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 07:39:17] [ERROR] エラーコード: 23000
[2025-06-01 07:39:17] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-06-01 07:39:17] [ERROR] SQLステート: 23000
[2025-06-01 07:39:17] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-06-01 07:39:17] [INFO] 重複したユーザーIDの既存レコードを発見: ID=207
[2025-06-01 07:39:17] [INFO] 重複ユーザーの登録情報を更新しました: ID=207
[2025-06-01 07:39:17] [INFO] トランザクションコミット成功
[2025-06-01 07:39:17] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"updated"}
[2025-06-01 07:39:17] [INFO] JSONレスポンスを送信完了
[2025-06-01 07:39:17] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":207,"registration_type":"updated"}
2025-06-01 07:39:17 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#07 - 期間: 2025-06-01 から 2025-05-31
[2025-06-01 07:39:17] [DEBUG] 出力バッファに171バイトのデータがあります
[2025-06-01 07:39:17] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"updated"}
[2025-06-01 07:39:17] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 07:39:17] [INFO] 処理完了
[2025-06-01 08:18:24] [INFO] --- 登録API処理開始 ---
[2025-06-01 08:18:24] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 08:18:24] [INFO] --- 登録API処理開始 ---
[2025-06-01 08:18:24] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 08:18:24] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJmZTFlOGQ4ODhlYzY2NGNkMmFmZWY0NzljNWRiNzk2OTJjZDAxYWFjZDE0MTQ4M2E1NDMzOTM1MWYzOTVmYTI3IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODczNzEwMCwiaWF0IjoxNzQ4NzMzNTAwLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.ckt-62XVpI7L6GqfEL_4GKBpjVFaZeV8UOFHdkUqvO92BuM0o2dvrIWL7oSuBovPmtEaDnCfUkr_cgJpaX2mpg","room_number":"fg#06","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00"}
[2025-06-01 08:18:24] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJmZTFlOGQ4ODhlYzY2NGNkMmFmZWY0NzljNWRiNzk2OTJjZDAxYWFjZDE0MTQ4M2E1NDMzOTM1MWYzOTVmYTI3IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODczNzEwMCwiaWF0IjoxNzQ4NzMzNTAwLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.ckt-62XVpI7L6GqfEL_4GKBpjVFaZeV8UOFHdkUqvO92BuM0o2dvrIWL7oSuBovPmtEaDnCfUkr_cgJpaX2mpg
    [room_number] => fg#06
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
)

[2025-06-01 08:18:24] [INFO] forceフラグ: false
[2025-06-01 08:18:24] [INFO] 処理パラメータ: room=fg#06, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 08:18:24] [INFO] IDトークンを検証: eyJraWQiOiJmZTFlOGQ4...
[2025-06-01 08:18:24] [DEBUG] トークン検証開始: eyJraWQiOiJmZTFlOGQ4...
[2025-06-01 08:18:24] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748737100
    [iat] => 1748733500
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 08:18:24] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 08:18:24] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 08:18:24] [INFO] データベース接続を開始します
[2025-06-01 08:18:24] [INFO] データベース接続成功
[2025-06-01 08:18:24] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 08:18:24] [INFO] line_room_linksテーブルが存在します
[2025-06-01 08:18:24] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 08:18:24] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 08:18:24] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=214 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 08:18:24] [INFO] line_room_linksテーブルのレコード数: 3
[2025-06-01 08:18:24] [INFO] 最新のレコード: {"id":209,"line_user_id":"U0d2a833b07ff8da6e111440a103c9e37","room_number":"fg#09","order_session_id":"250531205149768947569","user_name":"\u3068\u3082\u307f","check_in_date":"2025-05-31","check_out_date":"2025-06-01","access_token":null,"is_active":1,"created_at":"2025-05-31 20:50:52","updated_at":"2025-05-31 20:51:49"}
[2025-06-01 08:18:24] [INFO] トランザクション開始
[2025-06-01 08:18:24] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 08:18:24] [DEBUG] パラメータバインド: roomNumber=fg#06
[2025-06-01 08:18:24] [INFO] 部屋検索クエリ実行完了
[2025-06-01 08:18:24] [INFO] 部屋検索結果: 部屋あり ID=6, アクティブ=1
[2025-06-01 08:18:24] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 08:18:24] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 08:18:24] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 08:18:24] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 08:18:24] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 08:18:24] [INFO] 非アクティブ化した登録数: 0
[2025-06-01 08:18:24] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-01 08:18:24] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 08:18:24] [DEBUG] プリペアドステートメント作成成功
[2025-06-01 08:18:24] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-01, checkOut=2025-05-31
[2025-06-01 08:18:24] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#06, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-05-31
[2025-06-01 08:18:24] [INFO] SQLを実行します
[2025-06-01 08:18:24] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#06","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-05-31"}
[2025-06-01 08:18:24] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-01 08:18:24] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 08:18:24] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 08:18:24] [ERROR] エラーコード: 23000
[2025-06-01 08:18:24] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-06-01 08:18:24] [ERROR] SQLステート: 23000
[2025-06-01 08:18:24] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-06-01 08:18:24] [ERROR] スタックトレース: #0 {main}
[2025-06-01 08:18:24] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-06-01 08:18:24] [ERROR] スタックトレース: #0 {main}
[2025-06-01 08:18:24] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-06-01 08:18:24] [INFO] エラーJSONレスポンスを送信完了
[2025-06-01 08:18:24] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-06-01 08:18:24] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-06-01 08:18:24] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-06-01 08:18:24] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 08:18:24] [INFO] 処理完了
[2025-06-01 08:18:24] [INFO] --- 登録API処理開始 ---
[2025-06-01 08:18:24] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 08:18:24] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJmZTFlOGQ4ODhlYzY2NGNkMmFmZWY0NzljNWRiNzk2OTJjZDAxYWFjZDE0MTQ4M2E1NDMzOTM1MWYzOTVmYTI3IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODczNzEwMCwiaWF0IjoxNzQ4NzMzNTAwLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.ckt-62XVpI7L6GqfEL_4GKBpjVFaZeV8UOFHdkUqvO92BuM0o2dvrIWL7oSuBovPmtEaDnCfUkr_cgJpaX2mpg","room_number":"fg#06","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00","force":true}
[2025-06-01 08:18:24] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJmZTFlOGQ4ODhlYzY2NGNkMmFmZWY0NzljNWRiNzk2OTJjZDAxYWFjZDE0MTQ4M2E1NDMzOTM1MWYzOTVmYTI3IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODczNzEwMCwiaWF0IjoxNzQ4NzMzNTAwLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.ckt-62XVpI7L6GqfEL_4GKBpjVFaZeV8UOFHdkUqvO92BuM0o2dvrIWL7oSuBovPmtEaDnCfUkr_cgJpaX2mpg
    [room_number] => fg#06
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
    [force] => 1
)

[2025-06-01 08:18:24] [INFO] forceフラグ: true
[2025-06-01 08:18:24] [INFO] 処理パラメータ: room=fg#06, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 08:18:24] [INFO] IDトークンを検証: eyJraWQiOiJmZTFlOGQ4...
[2025-06-01 08:18:24] [DEBUG] トークン検証開始: eyJraWQiOiJmZTFlOGQ4...
[2025-06-01 08:18:24] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748737100
    [iat] => 1748733500
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 08:18:24] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 08:18:24] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 08:18:24] [INFO] データベース接続を開始します
[2025-06-01 08:18:24] [INFO] データベース接続成功
[2025-06-01 08:18:24] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 08:18:24] [INFO] line_room_linksテーブルが存在します
[2025-06-01 08:18:24] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 08:18:24] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 08:18:24] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=216 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 08:18:24] [INFO] line_room_linksテーブルのレコード数: 3
[2025-06-01 08:18:24] [INFO] 最新のレコード: {"id":209,"line_user_id":"U0d2a833b07ff8da6e111440a103c9e37","room_number":"fg#09","order_session_id":"250531205149768947569","user_name":"\u3068\u3082\u307f","check_in_date":"2025-05-31","check_out_date":"2025-06-01","access_token":null,"is_active":1,"created_at":"2025-05-31 20:50:52","updated_at":"2025-05-31 20:51:49"}
[2025-06-01 08:18:24] [INFO] トランザクション開始
[2025-06-01 08:18:24] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 08:18:24] [DEBUG] パラメータバインド: roomNumber=fg#06
[2025-06-01 08:18:24] [INFO] 部屋検索クエリ実行完了
[2025-06-01 08:18:24] [INFO] 部屋検索結果: 部屋あり ID=6, アクティブ=1
[2025-06-01 08:18:24] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 08:18:24] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 08:18:24] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 08:18:24] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 08:18:24] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 08:18:24] [INFO] 非アクティブ化した登録数: 0
[2025-06-01 08:18:24] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-01 08:18:24] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 08:18:24] [DEBUG] プリペアドステートメント作成成功
[2025-06-01 08:18:24] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-01, checkOut=2025-05-31
[2025-06-01 08:18:24] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#06, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-05-31
[2025-06-01 08:18:24] [INFO] SQLを実行します
[2025-06-01 08:18:24] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#06","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-05-31"}
[2025-06-01 08:18:24] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-01 08:18:24] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 08:18:24] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 08:18:24] [ERROR] エラーコード: 23000
[2025-06-01 08:18:24] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-06-01 08:18:24] [ERROR] SQLステート: 23000
[2025-06-01 08:18:24] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-06-01 08:18:24] [INFO] 重複したユーザーIDの既存レコードを発見: ID=207
[2025-06-01 08:18:24] [INFO] 重複ユーザーの登録情報を更新しました: ID=207
[2025-06-01 08:18:24] [INFO] トランザクションコミット成功
[2025-06-01 08:18:24] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"updated"}
[2025-06-01 08:18:24] [INFO] JSONレスポンスを送信完了
[2025-06-01 08:18:24] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":207,"registration_type":"updated"}
2025-06-01 08:18:24 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#06 - 期間: 2025-06-01 から 2025-05-31
[2025-06-01 08:18:24] [DEBUG] 出力バッファに171バイトのデータがあります
[2025-06-01 08:18:24] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"updated"}
[2025-06-01 08:18:24] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 08:18:24] [INFO] 処理完了
[2025-06-01 08:18:43] [INFO] --- 登録API処理開始 ---
[2025-06-01 08:18:43] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 08:18:43] [INFO] --- 登録API処理開始 ---
[2025-06-01 08:18:43] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 08:18:43] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJmZTFlOGQ4ODhlYzY2NGNkMmFmZWY0NzljNWRiNzk2OTJjZDAxYWFjZDE0MTQ4M2E1NDMzOTM1MWYzOTVmYTI3IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODczNzEwMCwiaWF0IjoxNzQ4NzMzNTAwLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.ckt-62XVpI7L6GqfEL_4GKBpjVFaZeV8UOFHdkUqvO92BuM0o2dvrIWL7oSuBovPmtEaDnCfUkr_cgJpaX2mpg","room_number":"fg#06","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00"}
[2025-06-01 08:18:43] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJmZTFlOGQ4ODhlYzY2NGNkMmFmZWY0NzljNWRiNzk2OTJjZDAxYWFjZDE0MTQ4M2E1NDMzOTM1MWYzOTVmYTI3IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODczNzEwMCwiaWF0IjoxNzQ4NzMzNTAwLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.ckt-62XVpI7L6GqfEL_4GKBpjVFaZeV8UOFHdkUqvO92BuM0o2dvrIWL7oSuBovPmtEaDnCfUkr_cgJpaX2mpg
    [room_number] => fg#06
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
)

[2025-06-01 08:18:43] [INFO] forceフラグ: false
[2025-06-01 08:18:43] [INFO] 処理パラメータ: room=fg#06, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 08:18:43] [INFO] IDトークンを検証: eyJraWQiOiJmZTFlOGQ4...
[2025-06-01 08:18:43] [DEBUG] トークン検証開始: eyJraWQiOiJmZTFlOGQ4...
[2025-06-01 08:18:43] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748737100
    [iat] => 1748733500
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 08:18:43] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 08:18:43] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 08:18:43] [INFO] データベース接続を開始します
[2025-06-01 08:18:43] [INFO] データベース接続成功
[2025-06-01 08:18:43] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 08:18:43] [INFO] line_room_linksテーブルが存在します
[2025-06-01 08:18:43] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 08:18:43] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 08:18:43] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=218 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 08:18:43] [INFO] line_room_linksテーブルのレコード数: 3
[2025-06-01 08:18:43] [INFO] 最新のレコード: {"id":209,"line_user_id":"U0d2a833b07ff8da6e111440a103c9e37","room_number":"fg#09","order_session_id":"250531205149768947569","user_name":"\u3068\u3082\u307f","check_in_date":"2025-05-31","check_out_date":"2025-06-01","access_token":null,"is_active":1,"created_at":"2025-05-31 20:50:52","updated_at":"2025-05-31 20:51:49"}
[2025-06-01 08:18:43] [INFO] トランザクション開始
[2025-06-01 08:18:43] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 08:18:43] [DEBUG] パラメータバインド: roomNumber=fg#06
[2025-06-01 08:18:43] [INFO] 部屋検索クエリ実行完了
[2025-06-01 08:18:43] [INFO] 部屋検索結果: 部屋あり ID=6, アクティブ=1
[2025-06-01 08:18:43] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 08:18:43] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 08:18:43] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 08:18:43] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 08:18:43] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 08:18:43] [INFO] 非アクティブ化した登録数: 1
[2025-06-01 08:18:43] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-01 08:18:43] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 08:18:43] [DEBUG] プリペアドステートメント作成成功
[2025-06-01 08:18:43] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-01, checkOut=2025-05-31
[2025-06-01 08:18:43] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#06, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-05-31
[2025-06-01 08:18:43] [INFO] SQLを実行します
[2025-06-01 08:18:43] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#06","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-05-31"}
[2025-06-01 08:18:43] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-01 08:18:43] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 08:18:43] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 08:18:43] [ERROR] エラーコード: 23000
[2025-06-01 08:18:43] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-06-01 08:18:43] [ERROR] SQLステート: 23000
[2025-06-01 08:18:43] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-06-01 08:18:43] [ERROR] スタックトレース: #0 {main}
[2025-06-01 08:18:43] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-06-01 08:18:43] [ERROR] スタックトレース: #0 {main}
[2025-06-01 08:18:43] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-06-01 08:18:43] [INFO] エラーJSONレスポンスを送信完了
[2025-06-01 08:18:43] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-06-01 08:18:43] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-06-01 08:18:43] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-06-01 08:18:43] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 08:18:43] [INFO] 処理完了
[2025-06-01 08:18:43] [INFO] --- 登録API処理開始 ---
[2025-06-01 08:18:43] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 08:18:43] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJmZTFlOGQ4ODhlYzY2NGNkMmFmZWY0NzljNWRiNzk2OTJjZDAxYWFjZDE0MTQ4M2E1NDMzOTM1MWYzOTVmYTI3IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODczNzEwMCwiaWF0IjoxNzQ4NzMzNTAwLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.ckt-62XVpI7L6GqfEL_4GKBpjVFaZeV8UOFHdkUqvO92BuM0o2dvrIWL7oSuBovPmtEaDnCfUkr_cgJpaX2mpg","room_number":"fg#06","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00","force":true}
[2025-06-01 08:18:43] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJmZTFlOGQ4ODhlYzY2NGNkMmFmZWY0NzljNWRiNzk2OTJjZDAxYWFjZDE0MTQ4M2E1NDMzOTM1MWYzOTVmYTI3IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODczNzEwMCwiaWF0IjoxNzQ4NzMzNTAwLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.ckt-62XVpI7L6GqfEL_4GKBpjVFaZeV8UOFHdkUqvO92BuM0o2dvrIWL7oSuBovPmtEaDnCfUkr_cgJpaX2mpg
    [room_number] => fg#06
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
    [force] => 1
)

[2025-06-01 08:18:43] [INFO] forceフラグ: true
[2025-06-01 08:18:43] [INFO] 処理パラメータ: room=fg#06, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 08:18:43] [INFO] IDトークンを検証: eyJraWQiOiJmZTFlOGQ4...
[2025-06-01 08:18:43] [DEBUG] トークン検証開始: eyJraWQiOiJmZTFlOGQ4...
[2025-06-01 08:18:43] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748737100
    [iat] => 1748733500
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 08:18:43] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 08:18:43] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 08:18:43] [INFO] データベース接続を開始します
[2025-06-01 08:18:43] [INFO] データベース接続成功
[2025-06-01 08:18:43] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 08:18:43] [INFO] line_room_linksテーブルが存在します
[2025-06-01 08:18:43] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 08:18:43] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 08:18:43] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=220 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 08:18:43] [INFO] line_room_linksテーブルのレコード数: 3
[2025-06-01 08:18:43] [INFO] 最新のレコード: {"id":209,"line_user_id":"U0d2a833b07ff8da6e111440a103c9e37","room_number":"fg#09","order_session_id":"250531205149768947569","user_name":"\u3068\u3082\u307f","check_in_date":"2025-05-31","check_out_date":"2025-06-01","access_token":null,"is_active":1,"created_at":"2025-05-31 20:50:52","updated_at":"2025-05-31 20:51:49"}
[2025-06-01 08:18:43] [INFO] トランザクション開始
[2025-06-01 08:18:43] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 08:18:43] [DEBUG] パラメータバインド: roomNumber=fg#06
[2025-06-01 08:18:43] [INFO] 部屋検索クエリ実行完了
[2025-06-01 08:18:43] [INFO] 部屋検索結果: 部屋あり ID=6, アクティブ=1
[2025-06-01 08:18:43] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 08:18:43] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 08:18:43] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 08:18:43] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 08:18:43] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 08:18:43] [INFO] 非アクティブ化した登録数: 1
[2025-06-01 08:18:43] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-01 08:18:43] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 08:18:43] [DEBUG] プリペアドステートメント作成成功
[2025-06-01 08:18:43] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-01, checkOut=2025-05-31
[2025-06-01 08:18:43] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#06, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-05-31
[2025-06-01 08:18:43] [INFO] SQLを実行します
[2025-06-01 08:18:43] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#06","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-05-31"}
[2025-06-01 08:18:43] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-01 08:18:43] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 08:18:43] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 08:18:43] [ERROR] エラーコード: 23000
[2025-06-01 08:18:43] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-06-01 08:18:43] [ERROR] SQLステート: 23000
[2025-06-01 08:18:43] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-06-01 08:18:43] [INFO] 重複したユーザーIDの既存レコードを発見: ID=207
[2025-06-01 08:18:43] [INFO] 重複ユーザーの登録情報を更新しました: ID=207
[2025-06-01 08:18:43] [INFO] トランザクションコミット成功
[2025-06-01 08:18:43] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"updated"}
[2025-06-01 08:18:43] [INFO] JSONレスポンスを送信完了
[2025-06-01 08:18:43] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":207,"registration_type":"updated"}
2025-06-01 08:18:43 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#06 - 期間: 2025-06-01 から 2025-05-31
[2025-06-01 08:18:43] [DEBUG] 出力バッファに171バイトのデータがあります
[2025-06-01 08:18:43] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"updated"}
[2025-06-01 08:18:43] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 08:18:43] [INFO] 処理完了
[2025-06-01 08:27:43] [INFO] --- 登録API処理開始 ---
[2025-06-01 08:27:43] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 08:27:43] [INFO] --- 登録API処理開始 ---
[2025-06-01 08:27:43] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 08:27:43] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODczNzY1OCwiaWF0IjoxNzQ4NzM0MDU4LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.nXHeHhygJZwqM2RiQwCuWCTeJHOoW6XBHrtuhWASUtrpDUxDDb4A9Qy9OUU1ucoTOqiIHt5jHiKLBCmnj8yBew","room_number":"fg#07","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00"}
[2025-06-01 08:27:43] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODczNzY1OCwiaWF0IjoxNzQ4NzM0MDU4LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.nXHeHhygJZwqM2RiQwCuWCTeJHOoW6XBHrtuhWASUtrpDUxDDb4A9Qy9OUU1ucoTOqiIHt5jHiKLBCmnj8yBew
    [room_number] => fg#07
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
)

[2025-06-01 08:27:43] [INFO] forceフラグ: false
[2025-06-01 08:27:43] [INFO] 処理パラメータ: room=fg#07, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 08:27:43] [INFO] IDトークンを検証: eyJraWQiOiJjY2Q1OGMy...
[2025-06-01 08:27:43] [DEBUG] トークン検証開始: eyJraWQiOiJjY2Q1OGMy...
[2025-06-01 08:27:43] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748737658
    [iat] => 1748734058
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 08:27:43] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 08:27:43] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 08:27:43] [INFO] データベース接続を開始します
[2025-06-01 08:27:43] [INFO] データベース接続成功
[2025-06-01 08:27:43] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 08:27:43] [INFO] line_room_linksテーブルが存在します
[2025-06-01 08:27:43] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 08:27:43] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 08:27:43] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=222 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 08:27:43] [INFO] line_room_linksテーブルのレコード数: 3
[2025-06-01 08:27:43] [INFO] 最新のレコード: {"id":209,"line_user_id":"U0d2a833b07ff8da6e111440a103c9e37","room_number":"fg#09","order_session_id":"250531205149768947569","user_name":"\u3068\u3082\u307f","check_in_date":"2025-05-31","check_out_date":"2025-06-01","access_token":null,"is_active":1,"created_at":"2025-05-31 20:50:52","updated_at":"2025-05-31 20:51:49"}
[2025-06-01 08:27:43] [INFO] トランザクション開始
[2025-06-01 08:27:43] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 08:27:43] [DEBUG] パラメータバインド: roomNumber=fg#07
[2025-06-01 08:27:43] [INFO] 部屋検索クエリ実行完了
[2025-06-01 08:27:43] [INFO] 部屋検索結果: 部屋あり ID=7, アクティブ=1
[2025-06-01 08:27:43] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 08:27:43] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 08:27:43] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 08:27:43] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 08:27:43] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 08:27:43] [INFO] 非アクティブ化した登録数: 0
[2025-06-01 08:27:43] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-01 08:27:43] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 08:27:43] [DEBUG] プリペアドステートメント作成成功
[2025-06-01 08:27:43] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-01, checkOut=2025-05-31
[2025-06-01 08:27:43] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#07, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-05-31
[2025-06-01 08:27:43] [INFO] SQLを実行します
[2025-06-01 08:27:43] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#07","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-05-31"}
[2025-06-01 08:27:43] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-01 08:27:43] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 08:27:43] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 08:27:43] [ERROR] エラーコード: 23000
[2025-06-01 08:27:43] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-06-01 08:27:43] [ERROR] SQLステート: 23000
[2025-06-01 08:27:43] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-06-01 08:27:43] [ERROR] スタックトレース: #0 {main}
[2025-06-01 08:27:43] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-06-01 08:27:43] [ERROR] スタックトレース: #0 {main}
[2025-06-01 08:27:43] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-06-01 08:27:43] [INFO] エラーJSONレスポンスを送信完了
[2025-06-01 08:27:43] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-06-01 08:27:43] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-06-01 08:27:43] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-06-01 08:27:43] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 08:27:43] [INFO] 処理完了
[2025-06-01 08:27:43] [INFO] --- 登録API処理開始 ---
[2025-06-01 08:27:43] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 08:27:43] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODczNzY1OCwiaWF0IjoxNzQ4NzM0MDU4LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.nXHeHhygJZwqM2RiQwCuWCTeJHOoW6XBHrtuhWASUtrpDUxDDb4A9Qy9OUU1ucoTOqiIHt5jHiKLBCmnj8yBew","room_number":"fg#07","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00","force":true}
[2025-06-01 08:27:43] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODczNzY1OCwiaWF0IjoxNzQ4NzM0MDU4LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.nXHeHhygJZwqM2RiQwCuWCTeJHOoW6XBHrtuhWASUtrpDUxDDb4A9Qy9OUU1ucoTOqiIHt5jHiKLBCmnj8yBew
    [room_number] => fg#07
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
    [force] => 1
)

[2025-06-01 08:27:43] [INFO] forceフラグ: true
[2025-06-01 08:27:43] [INFO] 処理パラメータ: room=fg#07, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 08:27:43] [INFO] IDトークンを検証: eyJraWQiOiJjY2Q1OGMy...
[2025-06-01 08:27:43] [DEBUG] トークン検証開始: eyJraWQiOiJjY2Q1OGMy...
[2025-06-01 08:27:43] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748737658
    [iat] => 1748734058
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 08:27:43] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 08:27:43] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 08:27:43] [INFO] データベース接続を開始します
[2025-06-01 08:27:43] [INFO] データベース接続成功
[2025-06-01 08:27:43] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 08:27:43] [INFO] line_room_linksテーブルが存在します
[2025-06-01 08:27:43] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 08:27:43] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 08:27:43] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=224 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 08:27:43] [INFO] line_room_linksテーブルのレコード数: 3
[2025-06-01 08:27:43] [INFO] 最新のレコード: {"id":209,"line_user_id":"U0d2a833b07ff8da6e111440a103c9e37","room_number":"fg#09","order_session_id":"250531205149768947569","user_name":"\u3068\u3082\u307f","check_in_date":"2025-05-31","check_out_date":"2025-06-01","access_token":null,"is_active":1,"created_at":"2025-05-31 20:50:52","updated_at":"2025-05-31 20:51:49"}
[2025-06-01 08:27:43] [INFO] トランザクション開始
[2025-06-01 08:27:43] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 08:27:43] [DEBUG] パラメータバインド: roomNumber=fg#07
[2025-06-01 08:27:43] [INFO] 部屋検索クエリ実行完了
[2025-06-01 08:27:43] [INFO] 部屋検索結果: 部屋あり ID=7, アクティブ=1
[2025-06-01 08:27:43] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 08:27:43] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 08:27:43] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 08:27:43] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 08:27:43] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 08:27:43] [INFO] 非アクティブ化した登録数: 0
[2025-06-01 08:27:43] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-01 08:27:43] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 08:27:43] [DEBUG] プリペアドステートメント作成成功
[2025-06-01 08:27:43] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-01, checkOut=2025-05-31
[2025-06-01 08:27:43] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#07, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-05-31
[2025-06-01 08:27:43] [INFO] SQLを実行します
[2025-06-01 08:27:43] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#07","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-05-31"}
[2025-06-01 08:27:43] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-01 08:27:43] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 08:27:43] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 08:27:43] [ERROR] エラーコード: 23000
[2025-06-01 08:27:43] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-06-01 08:27:43] [ERROR] SQLステート: 23000
[2025-06-01 08:27:43] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-06-01 08:27:43] [INFO] 重複したユーザーIDの既存レコードを発見: ID=207
[2025-06-01 08:27:43] [INFO] 重複ユーザーの登録情報を更新しました: ID=207
[2025-06-01 08:27:43] [INFO] トランザクションコミット成功
[2025-06-01 08:27:43] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"updated"}
[2025-06-01 08:27:43] [INFO] JSONレスポンスを送信完了
[2025-06-01 08:27:43] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":207,"registration_type":"updated"}
2025-06-01 08:27:43 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#07 - 期間: 2025-06-01 から 2025-05-31
[2025-06-01 08:27:43] [DEBUG] 出力バッファに171バイトのデータがあります
[2025-06-01 08:27:43] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"updated"}
[2025-06-01 08:27:43] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 08:27:43] [INFO] 処理完了
[2025-06-01 08:42:04] [INFO] --- 登録API処理開始 ---
[2025-06-01 08:42:04] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 08:42:04] [INFO] --- 登録API処理開始 ---
[2025-06-01 08:42:04] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 08:42:04] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJlNmE2OTE5Mzg2MTY5YmE1NGRlOWRkMzM2YjQxNDc5YTAxMDEyZGMwYzQyOGJhYWUyZGUxOGU1OWVlMjE0NmRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODczODUxMiwiaWF0IjoxNzQ4NzM0OTEyLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.RKJsXDmM4wYhO2XyzaTF1TO4G9Acy8jbV8QvgpW6ka0nvL86q7AksRs3hwXey0c0ZuAvx6ZwS4_cUAH0njrViw","room_number":"fg#07","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00"}
[2025-06-01 08:42:04] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJlNmE2OTE5Mzg2MTY5YmE1NGRlOWRkMzM2YjQxNDc5YTAxMDEyZGMwYzQyOGJhYWUyZGUxOGU1OWVlMjE0NmRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODczODUxMiwiaWF0IjoxNzQ4NzM0OTEyLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.RKJsXDmM4wYhO2XyzaTF1TO4G9Acy8jbV8QvgpW6ka0nvL86q7AksRs3hwXey0c0ZuAvx6ZwS4_cUAH0njrViw
    [room_number] => fg#07
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
)

[2025-06-01 08:42:04] [INFO] forceフラグ: false
[2025-06-01 08:42:04] [INFO] 処理パラメータ: room=fg#07, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 08:42:04] [INFO] IDトークンを検証: eyJraWQiOiJlNmE2OTE5...
[2025-06-01 08:42:04] [DEBUG] トークン検証開始: eyJraWQiOiJlNmE2OTE5...
[2025-06-01 08:42:04] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748738512
    [iat] => 1748734912
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 08:42:04] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 08:42:04] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 08:42:04] [INFO] データベース接続を開始します
[2025-06-01 08:42:04] [INFO] データベース接続成功
[2025-06-01 08:42:04] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 08:42:04] [INFO] line_room_linksテーブルが存在します
[2025-06-01 08:42:04] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 08:42:04] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 08:42:04] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=226 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 08:42:04] [INFO] line_room_linksテーブルのレコード数: 3
[2025-06-01 08:42:04] [INFO] 最新のレコード: {"id":209,"line_user_id":"U0d2a833b07ff8da6e111440a103c9e37","room_number":"fg#09","order_session_id":"250531205149768947569","user_name":"\u3068\u3082\u307f","check_in_date":"2025-05-31","check_out_date":"2025-06-01","access_token":null,"is_active":1,"created_at":"2025-05-31 20:50:52","updated_at":"2025-05-31 20:51:49"}
[2025-06-01 08:42:04] [INFO] トランザクション開始
[2025-06-01 08:42:04] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 08:42:04] [DEBUG] パラメータバインド: roomNumber=fg#07
[2025-06-01 08:42:04] [INFO] 部屋検索クエリ実行完了
[2025-06-01 08:42:04] [INFO] 部屋検索結果: 部屋あり ID=7, アクティブ=1
[2025-06-01 08:42:04] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 08:42:04] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 08:42:04] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 08:42:04] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 08:42:04] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 08:42:04] [INFO] 非アクティブ化した登録数: 0
[2025-06-01 08:42:04] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-01 08:42:04] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 08:42:04] [DEBUG] プリペアドステートメント作成成功
[2025-06-01 08:42:04] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-01, checkOut=2025-05-31
[2025-06-01 08:42:04] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#07, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-05-31
[2025-06-01 08:42:04] [INFO] SQLを実行します
[2025-06-01 08:42:04] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#07","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-05-31"}
[2025-06-01 08:42:04] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-01 08:42:04] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 08:42:04] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 08:42:04] [ERROR] エラーコード: 23000
[2025-06-01 08:42:04] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-06-01 08:42:04] [ERROR] SQLステート: 23000
[2025-06-01 08:42:04] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-06-01 08:42:04] [ERROR] スタックトレース: #0 {main}
[2025-06-01 08:42:04] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-06-01 08:42:04] [ERROR] スタックトレース: #0 {main}
[2025-06-01 08:42:04] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-06-01 08:42:04] [INFO] エラーJSONレスポンスを送信完了
[2025-06-01 08:42:04] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-06-01 08:42:04] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-06-01 08:42:04] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-06-01 08:42:04] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 08:42:04] [INFO] 処理完了
[2025-06-01 08:42:04] [INFO] --- 登録API処理開始 ---
[2025-06-01 08:42:04] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 08:42:04] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJlNmE2OTE5Mzg2MTY5YmE1NGRlOWRkMzM2YjQxNDc5YTAxMDEyZGMwYzQyOGJhYWUyZGUxOGU1OWVlMjE0NmRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODczODUxMiwiaWF0IjoxNzQ4NzM0OTEyLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.RKJsXDmM4wYhO2XyzaTF1TO4G9Acy8jbV8QvgpW6ka0nvL86q7AksRs3hwXey0c0ZuAvx6ZwS4_cUAH0njrViw","room_number":"fg#07","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00","force":true}
[2025-06-01 08:42:04] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJlNmE2OTE5Mzg2MTY5YmE1NGRlOWRkMzM2YjQxNDc5YTAxMDEyZGMwYzQyOGJhYWUyZGUxOGU1OWVlMjE0NmRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODczODUxMiwiaWF0IjoxNzQ4NzM0OTEyLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.RKJsXDmM4wYhO2XyzaTF1TO4G9Acy8jbV8QvgpW6ka0nvL86q7AksRs3hwXey0c0ZuAvx6ZwS4_cUAH0njrViw
    [room_number] => fg#07
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
    [force] => 1
)

[2025-06-01 08:42:04] [INFO] forceフラグ: true
[2025-06-01 08:42:04] [INFO] 処理パラメータ: room=fg#07, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 08:42:04] [INFO] IDトークンを検証: eyJraWQiOiJlNmE2OTE5...
[2025-06-01 08:42:04] [DEBUG] トークン検証開始: eyJraWQiOiJlNmE2OTE5...
[2025-06-01 08:42:04] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748738512
    [iat] => 1748734912
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 08:42:04] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 08:42:04] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 08:42:04] [INFO] データベース接続を開始します
[2025-06-01 08:42:04] [INFO] データベース接続成功
[2025-06-01 08:42:04] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 08:42:04] [INFO] line_room_linksテーブルが存在します
[2025-06-01 08:42:04] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 08:42:04] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 08:42:04] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=228 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 08:42:04] [INFO] line_room_linksテーブルのレコード数: 3
[2025-06-01 08:42:04] [INFO] 最新のレコード: {"id":209,"line_user_id":"U0d2a833b07ff8da6e111440a103c9e37","room_number":"fg#09","order_session_id":"250531205149768947569","user_name":"\u3068\u3082\u307f","check_in_date":"2025-05-31","check_out_date":"2025-06-01","access_token":null,"is_active":1,"created_at":"2025-05-31 20:50:52","updated_at":"2025-05-31 20:51:49"}
[2025-06-01 08:42:04] [INFO] トランザクション開始
[2025-06-01 08:42:04] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 08:42:04] [DEBUG] パラメータバインド: roomNumber=fg#07
[2025-06-01 08:42:04] [INFO] 部屋検索クエリ実行完了
[2025-06-01 08:42:04] [INFO] 部屋検索結果: 部屋あり ID=7, アクティブ=1
[2025-06-01 08:42:04] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 08:42:04] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 08:42:04] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 08:42:04] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 08:42:04] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 08:42:04] [INFO] 非アクティブ化した登録数: 0
[2025-06-01 08:42:04] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-01 08:42:04] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 08:42:04] [DEBUG] プリペアドステートメント作成成功
[2025-06-01 08:42:04] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-01, checkOut=2025-05-31
[2025-06-01 08:42:04] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#07, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-05-31
[2025-06-01 08:42:04] [INFO] SQLを実行します
[2025-06-01 08:42:04] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#07","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-05-31"}
[2025-06-01 08:42:04] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-01 08:42:04] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 08:42:04] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 08:42:04] [ERROR] エラーコード: 23000
[2025-06-01 08:42:04] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-06-01 08:42:04] [ERROR] SQLステート: 23000
[2025-06-01 08:42:04] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-06-01 08:42:04] [INFO] 重複したユーザーIDの既存レコードを発見: ID=207
[2025-06-01 08:42:04] [INFO] 重複ユーザーの登録情報を更新しました: ID=207
[2025-06-01 08:42:04] [INFO] トランザクションコミット成功
[2025-06-01 08:42:04] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"updated"}
[2025-06-01 08:42:04] [INFO] JSONレスポンスを送信完了
[2025-06-01 08:42:04] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":207,"registration_type":"updated"}
2025-06-01 08:42:04 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#07 - 期間: 2025-06-01 から 2025-05-31
[2025-06-01 08:42:04] [DEBUG] 出力バッファに171バイトのデータがあります
[2025-06-01 08:42:04] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"updated"}
[2025-06-01 08:42:04] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 08:42:04] [INFO] 処理完了
[2025-06-01 09:36:15] [INFO] --- 登録API処理開始 ---
[2025-06-01 09:36:15] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 09:36:15] [INFO] --- 登録API処理開始 ---
[2025-06-01 09:36:15] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 09:36:15] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI2YWE4YWQwN2NkMmFhYWRjYzY1NmY3ZTIxMzljY2U4YjhjNGE2YzgxYzI5MDQyZjQ4MTY4MDY3MmZkMDNjOTY5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0MTc3MSwiaWF0IjoxNzQ4NzM4MTcxLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.20qTkWGxJGAF8b0eq6MkyVAhbSLi8X3gnodrG9F8BAIkz7mntYKnlyi8iuFWmX3xzEcD81JqA8hNra3kCjHChw","room_number":"fg#06","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00"}
[2025-06-01 09:36:15] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI2YWE4YWQwN2NkMmFhYWRjYzY1NmY3ZTIxMzljY2U4YjhjNGE2YzgxYzI5MDQyZjQ4MTY4MDY3MmZkMDNjOTY5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0MTc3MSwiaWF0IjoxNzQ4NzM4MTcxLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.20qTkWGxJGAF8b0eq6MkyVAhbSLi8X3gnodrG9F8BAIkz7mntYKnlyi8iuFWmX3xzEcD81JqA8hNra3kCjHChw
    [room_number] => fg#06
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
)

[2025-06-01 09:36:15] [INFO] forceフラグ: false
[2025-06-01 09:36:15] [INFO] 処理パラメータ: room=fg#06, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 09:36:15] [INFO] IDトークンを検証: eyJraWQiOiI2YWE4YWQw...
[2025-06-01 09:36:15] [DEBUG] トークン検証開始: eyJraWQiOiI2YWE4YWQw...
[2025-06-01 09:36:15] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748741771
    [iat] => 1748738171
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 09:36:15] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 09:36:15] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 09:36:15] [INFO] データベース接続を開始します
[2025-06-01 09:36:15] [INFO] データベース接続成功
[2025-06-01 09:36:15] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 09:36:15] [INFO] line_room_linksテーブルが存在します
[2025-06-01 09:36:15] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 09:36:15] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 09:36:15] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=230 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 09:36:15] [INFO] line_room_linksテーブルのレコード数: 3
[2025-06-01 09:36:15] [INFO] 最新のレコード: {"id":209,"line_user_id":"U0d2a833b07ff8da6e111440a103c9e37","room_number":"fg#09","order_session_id":"250531205149768947569","user_name":"\u3068\u3082\u307f","check_in_date":"2025-05-31","check_out_date":"2025-06-01","access_token":null,"is_active":1,"created_at":"2025-05-31 20:50:52","updated_at":"2025-05-31 20:51:49"}
[2025-06-01 09:36:15] [INFO] トランザクション開始
[2025-06-01 09:36:15] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 09:36:15] [DEBUG] パラメータバインド: roomNumber=fg#06
[2025-06-01 09:36:15] [INFO] 部屋検索クエリ実行完了
[2025-06-01 09:36:15] [INFO] 部屋検索結果: 部屋あり ID=6, アクティブ=1
[2025-06-01 09:36:15] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 09:36:15] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 09:36:15] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 09:36:15] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 09:36:15] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 09:36:15] [INFO] 非アクティブ化した登録数: 0
[2025-06-01 09:36:15] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-01 09:36:15] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 09:36:15] [DEBUG] プリペアドステートメント作成成功
[2025-06-01 09:36:15] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-01, checkOut=2025-05-31
[2025-06-01 09:36:15] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#06, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-05-31
[2025-06-01 09:36:15] [INFO] SQLを実行します
[2025-06-01 09:36:15] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#06","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-05-31"}
[2025-06-01 09:36:15] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-01 09:36:15] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 09:36:15] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 09:36:15] [ERROR] エラーコード: 23000
[2025-06-01 09:36:15] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-06-01 09:36:15] [ERROR] SQLステート: 23000
[2025-06-01 09:36:15] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-06-01 09:36:15] [ERROR] スタックトレース: #0 {main}
[2025-06-01 09:36:15] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-06-01 09:36:15] [ERROR] スタックトレース: #0 {main}
[2025-06-01 09:36:15] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-06-01 09:36:15] [INFO] エラーJSONレスポンスを送信完了
[2025-06-01 09:36:15] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-06-01 09:36:15] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-06-01 09:36:15] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-06-01 09:36:15] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 09:36:15] [INFO] 処理完了
[2025-06-01 09:36:15] [INFO] --- 登録API処理開始 ---
[2025-06-01 09:36:15] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 09:36:15] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI2YWE4YWQwN2NkMmFhYWRjYzY1NmY3ZTIxMzljY2U4YjhjNGE2YzgxYzI5MDQyZjQ4MTY4MDY3MmZkMDNjOTY5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0MTc3MSwiaWF0IjoxNzQ4NzM4MTcxLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.20qTkWGxJGAF8b0eq6MkyVAhbSLi8X3gnodrG9F8BAIkz7mntYKnlyi8iuFWmX3xzEcD81JqA8hNra3kCjHChw","room_number":"fg#06","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00","force":true}
[2025-06-01 09:36:15] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI2YWE4YWQwN2NkMmFhYWRjYzY1NmY3ZTIxMzljY2U4YjhjNGE2YzgxYzI5MDQyZjQ4MTY4MDY3MmZkMDNjOTY5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0MTc3MSwiaWF0IjoxNzQ4NzM4MTcxLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.20qTkWGxJGAF8b0eq6MkyVAhbSLi8X3gnodrG9F8BAIkz7mntYKnlyi8iuFWmX3xzEcD81JqA8hNra3kCjHChw
    [room_number] => fg#06
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
    [force] => 1
)

[2025-06-01 09:36:15] [INFO] forceフラグ: true
[2025-06-01 09:36:15] [INFO] 処理パラメータ: room=fg#06, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 09:36:15] [INFO] IDトークンを検証: eyJraWQiOiI2YWE4YWQw...
[2025-06-01 09:36:15] [DEBUG] トークン検証開始: eyJraWQiOiI2YWE4YWQw...
[2025-06-01 09:36:15] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748741771
    [iat] => 1748738171
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 09:36:15] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 09:36:15] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 09:36:15] [INFO] データベース接続を開始します
[2025-06-01 09:36:15] [INFO] データベース接続成功
[2025-06-01 09:36:15] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 09:36:15] [INFO] line_room_linksテーブルが存在します
[2025-06-01 09:36:15] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 09:36:15] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 09:36:15] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=232 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 09:36:15] [INFO] line_room_linksテーブルのレコード数: 3
[2025-06-01 09:36:15] [INFO] 最新のレコード: {"id":209,"line_user_id":"U0d2a833b07ff8da6e111440a103c9e37","room_number":"fg#09","order_session_id":"250531205149768947569","user_name":"\u3068\u3082\u307f","check_in_date":"2025-05-31","check_out_date":"2025-06-01","access_token":null,"is_active":1,"created_at":"2025-05-31 20:50:52","updated_at":"2025-05-31 20:51:49"}
[2025-06-01 09:36:15] [INFO] トランザクション開始
[2025-06-01 09:36:15] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 09:36:15] [DEBUG] パラメータバインド: roomNumber=fg#06
[2025-06-01 09:36:15] [INFO] 部屋検索クエリ実行完了
[2025-06-01 09:36:15] [INFO] 部屋検索結果: 部屋あり ID=6, アクティブ=1
[2025-06-01 09:36:15] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 09:36:15] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 09:36:15] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 09:36:15] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 09:36:15] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 09:36:15] [INFO] 非アクティブ化した登録数: 0
[2025-06-01 09:36:15] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-01 09:36:15] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 09:36:15] [DEBUG] プリペアドステートメント作成成功
[2025-06-01 09:36:15] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-01, checkOut=2025-05-31
[2025-06-01 09:36:15] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#06, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-05-31
[2025-06-01 09:36:15] [INFO] SQLを実行します
[2025-06-01 09:36:15] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#06","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-05-31"}
[2025-06-01 09:36:15] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-01 09:36:15] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 09:36:15] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 09:36:15] [ERROR] エラーコード: 23000
[2025-06-01 09:36:15] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-06-01 09:36:15] [ERROR] SQLステート: 23000
[2025-06-01 09:36:15] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-06-01 09:36:15] [INFO] 重複したユーザーIDの既存レコードを発見: ID=207
[2025-06-01 09:36:15] [INFO] 重複ユーザーの登録情報を更新しました: ID=207
[2025-06-01 09:36:15] [INFO] トランザクションコミット成功
[2025-06-01 09:36:15] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"updated"}
[2025-06-01 09:36:15] [INFO] JSONレスポンスを送信完了
[2025-06-01 09:36:15] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":207,"registration_type":"updated"}
2025-06-01 09:36:15 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#06 - 期間: 2025-06-01 から 2025-05-31
[2025-06-01 09:36:15] [DEBUG] 出力バッファに171バイトのデータがあります
[2025-06-01 09:36:15] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"updated"}
[2025-06-01 09:36:15] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 09:36:15] [INFO] 処理完了
[2025-06-01 10:12:23] [INFO] --- 登録API処理開始 ---
[2025-06-01 10:12:23] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 10:12:23] [INFO] --- 登録API処理開始 ---
[2025-06-01 10:12:23] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 10:12:23] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI5MjkxZTZiNmEzOGM3ZDhhZjY4YzUyNjZmYWEyODIwOGQ2ZGQ1OTg0NWZhYTAyNGU1NDFiZGIzOWZlMTM1ZDRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0MzkzNiwiaWF0IjoxNzQ4NzQwMzM2LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.ORavSIbJ6o4uGNkNezLA0XYbuutw16hBdPJHT3zVBPKmD5E0H8AtU7UWtpx_wGjGzXDAm3fmGxn-mSi6qNXBOg","room_number":"fg#07","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00"}
[2025-06-01 10:12:23] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI5MjkxZTZiNmEzOGM3ZDhhZjY4YzUyNjZmYWEyODIwOGQ2ZGQ1OTg0NWZhYTAyNGU1NDFiZGIzOWZlMTM1ZDRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0MzkzNiwiaWF0IjoxNzQ4NzQwMzM2LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.ORavSIbJ6o4uGNkNezLA0XYbuutw16hBdPJHT3zVBPKmD5E0H8AtU7UWtpx_wGjGzXDAm3fmGxn-mSi6qNXBOg
    [room_number] => fg#07
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
)

[2025-06-01 10:12:23] [INFO] forceフラグ: false
[2025-06-01 10:12:23] [INFO] 処理パラメータ: room=fg#07, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 10:12:23] [INFO] IDトークンを検証: eyJraWQiOiI5MjkxZTZi...
[2025-06-01 10:12:23] [DEBUG] トークン検証開始: eyJraWQiOiI5MjkxZTZi...
[2025-06-01 10:12:23] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748743936
    [iat] => 1748740336
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 10:12:23] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 10:12:23] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 10:12:23] [INFO] データベース接続を開始します
[2025-06-01 10:12:23] [INFO] データベース接続成功
[2025-06-01 10:12:23] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 10:12:23] [INFO] line_room_linksテーブルが存在します
[2025-06-01 10:12:23] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 10:12:23] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 10:12:23] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=234 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 10:12:23] [INFO] line_room_linksテーブルのレコード数: 3
[2025-06-01 10:12:23] [INFO] 最新のレコード: {"id":209,"line_user_id":"U0d2a833b07ff8da6e111440a103c9e37","room_number":"fg#09","order_session_id":"250531205149768947569","user_name":"\u3068\u3082\u307f","check_in_date":"2025-05-31","check_out_date":"2025-06-01","access_token":null,"is_active":1,"created_at":"2025-05-31 20:50:52","updated_at":"2025-05-31 20:51:49"}
[2025-06-01 10:12:23] [INFO] トランザクション開始
[2025-06-01 10:12:23] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 10:12:23] [DEBUG] パラメータバインド: roomNumber=fg#07
[2025-06-01 10:12:23] [INFO] 部屋検索クエリ実行完了
[2025-06-01 10:12:23] [INFO] 部屋検索結果: 部屋あり ID=7, アクティブ=1
[2025-06-01 10:12:23] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 10:12:23] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 10:12:23] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 10:12:23] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 10:12:23] [INFO] 部屋変更要求を検出: 旧=fg#06 新=fg#07
[2025-06-01 10:12:23] [INFO] 未払いセッション件数: 0
[2025-06-01 10:12:23] [INFO] 旧リンクを is_active=0 に更新: id=207
[2025-06-01 10:12:23] [INFO] 旧 order_sessions をクローズ: room_number=fg#06
[2025-06-01 10:12:23] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 10:12:23] [INFO] 非アクティブ化した登録数: 0
[2025-06-01 10:12:23] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-01 10:12:23] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 10:12:23] [DEBUG] プリペアドステートメント作成成功
[2025-06-01 10:12:23] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-01, checkOut=2025-05-31
[2025-06-01 10:12:23] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#07, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-05-31
[2025-06-01 10:12:23] [INFO] SQLを実行します
[2025-06-01 10:12:23] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#07","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-05-31"}
[2025-06-01 10:12:23] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-01 10:12:23] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 10:12:23] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 10:12:23] [ERROR] エラーコード: 23000
[2025-06-01 10:12:23] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-06-01 10:12:23] [ERROR] SQLステート: 23000
[2025-06-01 10:12:23] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-06-01 10:12:23] [ERROR] スタックトレース: #0 {main}
[2025-06-01 10:12:23] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-06-01 10:12:23] [ERROR] スタックトレース: #0 {main}
[2025-06-01 10:12:23] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-06-01 10:12:23] [INFO] エラーJSONレスポンスを送信完了
[2025-06-01 10:12:23] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-06-01 10:12:23] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-06-01 10:12:23] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-06-01 10:12:23] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 10:12:23] [INFO] 処理完了
[2025-06-01 10:12:23] [INFO] --- 登録API処理開始 ---
[2025-06-01 10:12:23] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 10:12:23] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI5MjkxZTZiNmEzOGM3ZDhhZjY4YzUyNjZmYWEyODIwOGQ2ZGQ1OTg0NWZhYTAyNGU1NDFiZGIzOWZlMTM1ZDRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0MzkzNiwiaWF0IjoxNzQ4NzQwMzM2LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.ORavSIbJ6o4uGNkNezLA0XYbuutw16hBdPJHT3zVBPKmD5E0H8AtU7UWtpx_wGjGzXDAm3fmGxn-mSi6qNXBOg","room_number":"fg#07","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00","force":true}
[2025-06-01 10:12:23] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI5MjkxZTZiNmEzOGM3ZDhhZjY4YzUyNjZmYWEyODIwOGQ2ZGQ1OTg0NWZhYTAyNGU1NDFiZGIzOWZlMTM1ZDRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0MzkzNiwiaWF0IjoxNzQ4NzQwMzM2LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.ORavSIbJ6o4uGNkNezLA0XYbuutw16hBdPJHT3zVBPKmD5E0H8AtU7UWtpx_wGjGzXDAm3fmGxn-mSi6qNXBOg
    [room_number] => fg#07
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
    [force] => 1
)

[2025-06-01 10:12:23] [INFO] forceフラグ: true
[2025-06-01 10:12:23] [INFO] 処理パラメータ: room=fg#07, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 10:12:23] [INFO] IDトークンを検証: eyJraWQiOiI5MjkxZTZi...
[2025-06-01 10:12:23] [DEBUG] トークン検証開始: eyJraWQiOiI5MjkxZTZi...
[2025-06-01 10:12:23] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748743936
    [iat] => 1748740336
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 10:12:23] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 10:12:23] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 10:12:23] [INFO] データベース接続を開始します
[2025-06-01 10:12:23] [INFO] データベース接続成功
[2025-06-01 10:12:23] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 10:12:23] [INFO] line_room_linksテーブルが存在します
[2025-06-01 10:12:23] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 10:12:23] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 10:12:23] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=236 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 10:12:23] [INFO] line_room_linksテーブルのレコード数: 3
[2025-06-01 10:12:23] [INFO] 最新のレコード: {"id":209,"line_user_id":"U0d2a833b07ff8da6e111440a103c9e37","room_number":"fg#09","order_session_id":"250531205149768947569","user_name":"\u3068\u3082\u307f","check_in_date":"2025-05-31","check_out_date":"2025-06-01","access_token":null,"is_active":1,"created_at":"2025-05-31 20:50:52","updated_at":"2025-05-31 20:51:49"}
[2025-06-01 10:12:23] [INFO] トランザクション開始
[2025-06-01 10:12:23] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 10:12:23] [DEBUG] パラメータバインド: roomNumber=fg#07
[2025-06-01 10:12:23] [INFO] 部屋検索クエリ実行完了
[2025-06-01 10:12:23] [INFO] 部屋検索結果: 部屋あり ID=7, アクティブ=1
[2025-06-01 10:12:23] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 10:12:23] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 10:12:23] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 10:12:23] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 10:12:23] [INFO] 部屋変更要求を検出: 旧=fg#06 新=fg#07
[2025-06-01 10:12:23] [INFO] 未払いセッション件数: 0
[2025-06-01 10:12:23] [INFO] 旧リンクを is_active=0 に更新: id=207
[2025-06-01 10:12:23] [INFO] 旧 order_sessions をクローズ: room_number=fg#06
[2025-06-01 10:12:23] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 10:12:23] [INFO] 非アクティブ化した登録数: 0
[2025-06-01 10:12:23] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-01 10:12:23] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 10:12:23] [DEBUG] プリペアドステートメント作成成功
[2025-06-01 10:12:23] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-01, checkOut=2025-05-31
[2025-06-01 10:12:23] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#07, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-05-31
[2025-06-01 10:12:23] [INFO] SQLを実行します
[2025-06-01 10:12:23] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#07","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-05-31"}
[2025-06-01 10:12:23] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-01 10:12:23] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 10:12:23] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 10:12:23] [ERROR] エラーコード: 23000
[2025-06-01 10:12:23] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-06-01 10:12:23] [ERROR] SQLステート: 23000
[2025-06-01 10:12:23] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-06-01 10:12:23] [INFO] 重複したユーザーIDの既存レコードを発見: ID=207
[2025-06-01 10:12:23] [INFO] 重複ユーザーの登録情報を更新しました: ID=207
[2025-06-01 10:12:23] [INFO] トランザクションコミット成功
[2025-06-01 10:12:23] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"updated"}
[2025-06-01 10:12:23] [INFO] JSONレスポンスを送信完了
[2025-06-01 10:12:23] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":207,"registration_type":"updated"}
2025-06-01 10:12:23 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#07 - 期間: 2025-06-01 から 2025-05-31
[2025-06-01 10:12:23] [DEBUG] 出力バッファに171バイトのデータがあります
[2025-06-01 10:12:23] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"updated"}
[2025-06-01 10:12:23] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 10:12:23] [INFO] 処理完了
[2025-06-01 10:13:13] [INFO] --- 登録API処理開始 ---
[2025-06-01 10:13:13] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 10:13:14] [INFO] --- 登録API処理開始 ---
[2025-06-01 10:13:14] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 10:13:14] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0Mzk4OCwiaWF0IjoxNzQ4NzQwMzg4LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.8uOUuQ9QcIYoRNvW9YRMh-D6EWnra907FZiiIGVharKA0gxmwfhbnvnuKNMyaHMmIw1RIZGKQvYnpbD0_RSg_Q","room_number":"fg#06","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00"}
[2025-06-01 10:13:14] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0Mzk4OCwiaWF0IjoxNzQ4NzQwMzg4LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.8uOUuQ9QcIYoRNvW9YRMh-D6EWnra907FZiiIGVharKA0gxmwfhbnvnuKNMyaHMmIw1RIZGKQvYnpbD0_RSg_Q
    [room_number] => fg#06
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
)

[2025-06-01 10:13:14] [INFO] forceフラグ: false
[2025-06-01 10:13:14] [INFO] 処理パラメータ: room=fg#06, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 10:13:14] [INFO] IDトークンを検証: eyJraWQiOiJjY2Q1OGMy...
[2025-06-01 10:13:14] [DEBUG] トークン検証開始: eyJraWQiOiJjY2Q1OGMy...
[2025-06-01 10:13:14] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748743988
    [iat] => 1748740388
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 10:13:14] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 10:13:14] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 10:13:14] [INFO] データベース接続を開始します
[2025-06-01 10:13:14] [INFO] データベース接続成功
[2025-06-01 10:13:14] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 10:13:14] [INFO] line_room_linksテーブルが存在します
[2025-06-01 10:13:14] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 10:13:14] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 10:13:14] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=238 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 10:13:14] [INFO] line_room_linksテーブルのレコード数: 3
[2025-06-01 10:13:14] [INFO] 最新のレコード: {"id":209,"line_user_id":"U0d2a833b07ff8da6e111440a103c9e37","room_number":"fg#09","order_session_id":"250531205149768947569","user_name":"\u3068\u3082\u307f","check_in_date":"2025-05-31","check_out_date":"2025-06-01","access_token":null,"is_active":1,"created_at":"2025-05-31 20:50:52","updated_at":"2025-05-31 20:51:49"}
[2025-06-01 10:13:14] [INFO] トランザクション開始
[2025-06-01 10:13:14] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 10:13:14] [DEBUG] パラメータバインド: roomNumber=fg#06
[2025-06-01 10:13:14] [INFO] 部屋検索クエリ実行完了
[2025-06-01 10:13:14] [INFO] 部屋検索結果: 部屋あり ID=6, アクティブ=1
[2025-06-01 10:13:14] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 10:13:14] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 10:13:14] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 10:13:14] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 10:13:14] [INFO] 部屋変更要求を検出: 旧=fg#07 新=fg#06
[2025-06-01 10:13:14] [INFO] 未払いセッション件数: 0
[2025-06-01 10:13:14] [INFO] 旧リンクを is_active=0 に更新: id=207
[2025-06-01 10:13:14] [INFO] 旧 order_sessions をクローズ: room_number=fg#07
[2025-06-01 10:13:14] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 10:13:14] [INFO] 非アクティブ化した登録数: 0
[2025-06-01 10:13:14] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-01 10:13:14] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 10:13:14] [DEBUG] プリペアドステートメント作成成功
[2025-06-01 10:13:14] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-01, checkOut=2025-05-31
[2025-06-01 10:13:14] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#06, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-05-31
[2025-06-01 10:13:14] [INFO] SQLを実行します
[2025-06-01 10:13:14] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#06","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-05-31"}
[2025-06-01 10:13:14] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-01 10:13:14] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 10:13:14] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 10:13:14] [ERROR] エラーコード: 23000
[2025-06-01 10:13:14] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-06-01 10:13:14] [ERROR] SQLステート: 23000
[2025-06-01 10:13:14] [ERROR] 通常例外発生でロールバック: 同じユーザーIDが既に登録されています
[2025-06-01 10:13:14] [ERROR] スタックトレース: #0 {main}
[2025-06-01 10:13:14] [ERROR] 処理中に例外が発生: 同じユーザーIDが既に登録されています
[2025-06-01 10:13:14] [ERROR] スタックトレース: #0 {main}
[2025-06-01 10:13:14] [INFO] エラーレスポンスを返します: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-06-01 10:13:14] [INFO] エラーJSONレスポンスを送信完了
[2025-06-01 10:13:14] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"同じユーザーIDが既に登録されています"}
[2025-06-01 10:13:14] [DEBUG] 出力バッファに116バイトのデータがあります
[2025-06-01 10:13:14] [DEBUG] バッファの内容: {"error":"\u540c\u3058\u30e6\u30fc\u30b6\u30fcID\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059"}
[2025-06-01 10:13:14] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 10:13:14] [INFO] 処理完了
[2025-06-01 10:13:14] [INFO] --- 登録API処理開始 ---
[2025-06-01 10:13:14] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 10:13:14] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0Mzk4OCwiaWF0IjoxNzQ4NzQwMzg4LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.8uOUuQ9QcIYoRNvW9YRMh-D6EWnra907FZiiIGVharKA0gxmwfhbnvnuKNMyaHMmIw1RIZGKQvYnpbD0_RSg_Q","room_number":"fg#06","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00","force":true}
[2025-06-01 10:13:14] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0Mzk4OCwiaWF0IjoxNzQ4NzQwMzg4LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.8uOUuQ9QcIYoRNvW9YRMh-D6EWnra907FZiiIGVharKA0gxmwfhbnvnuKNMyaHMmIw1RIZGKQvYnpbD0_RSg_Q
    [room_number] => fg#06
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
    [force] => 1
)

[2025-06-01 10:13:14] [INFO] forceフラグ: true
[2025-06-01 10:13:14] [INFO] 処理パラメータ: room=fg#06, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 10:13:14] [INFO] IDトークンを検証: eyJraWQiOiJjY2Q1OGMy...
[2025-06-01 10:13:14] [DEBUG] トークン検証開始: eyJraWQiOiJjY2Q1OGMy...
[2025-06-01 10:13:14] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748743988
    [iat] => 1748740388
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 10:13:14] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 10:13:14] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 10:13:14] [INFO] データベース接続を開始します
[2025-06-01 10:13:14] [INFO] データベース接続成功
[2025-06-01 10:13:14] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 10:13:14] [INFO] line_room_linksテーブルが存在します
[2025-06-01 10:13:14] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 10:13:14] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 10:13:14] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=240 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 10:13:14] [INFO] line_room_linksテーブルのレコード数: 3
[2025-06-01 10:13:14] [INFO] 最新のレコード: {"id":209,"line_user_id":"U0d2a833b07ff8da6e111440a103c9e37","room_number":"fg#09","order_session_id":"250531205149768947569","user_name":"\u3068\u3082\u307f","check_in_date":"2025-05-31","check_out_date":"2025-06-01","access_token":null,"is_active":1,"created_at":"2025-05-31 20:50:52","updated_at":"2025-05-31 20:51:49"}
[2025-06-01 10:13:14] [INFO] トランザクション開始
[2025-06-01 10:13:14] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 10:13:14] [DEBUG] パラメータバインド: roomNumber=fg#06
[2025-06-01 10:13:14] [INFO] 部屋検索クエリ実行完了
[2025-06-01 10:13:14] [INFO] 部屋検索結果: 部屋あり ID=6, アクティブ=1
[2025-06-01 10:13:14] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 10:13:14] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 10:13:14] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 10:13:14] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 10:13:14] [INFO] 部屋変更要求を検出: 旧=fg#07 新=fg#06
[2025-06-01 10:13:14] [INFO] 未払いセッション件数: 0
[2025-06-01 10:13:14] [INFO] 旧リンクを is_active=0 に更新: id=207
[2025-06-01 10:13:14] [INFO] 旧 order_sessions をクローズ: room_number=fg#07
[2025-06-01 10:13:14] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 10:13:14] [INFO] 非アクティブ化した登録数: 0
[2025-06-01 10:13:14] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-01 10:13:14] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 10:13:14] [DEBUG] プリペアドステートメント作成成功
[2025-06-01 10:13:14] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-01, checkOut=2025-05-31
[2025-06-01 10:13:14] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#06, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-05-31
[2025-06-01 10:13:14] [INFO] SQLを実行します
[2025-06-01 10:13:14] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#06","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-05-31"}
[2025-06-01 10:13:14] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-01 10:13:14] [ERROR] 直接クエリ実行例外: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 10:13:14] [ERROR] SQL実行時にPDO例外が発生: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
[2025-06-01 10:13:14] [ERROR] エラーコード: 23000
[2025-06-01 10:13:14] [ERROR] SQLエラー情報: Array
(
    [0] => 23000
    [1] => 1062
    [2] => Duplicate entry 'U4d777614158c719515a7be91a41bc382' for key 'line_room_links.line_user_id'
)

[2025-06-01 10:13:14] [ERROR] SQLステート: 23000
[2025-06-01 10:13:14] [INFO] 重複エントリエラーが発生しましたが、forceフラグが有効なため処理を続行します
[2025-06-01 10:13:14] [INFO] 重複したユーザーIDの既存レコードを発見: ID=207
[2025-06-01 10:13:14] [INFO] 重複ユーザーの登録情報を更新しました: ID=207
[2025-06-01 10:13:14] [INFO] トランザクションコミット成功
[2025-06-01 10:13:14] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"updated"}
[2025-06-01 10:13:14] [INFO] JSONレスポンスを送信完了
[2025-06-01 10:13:14] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に更新されました","registration_id":207,"registration_type":"updated"}
2025-06-01 10:13:14 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#06 - 期間: 2025-06-01 から 2025-05-31
[2025-06-01 10:13:14] [DEBUG] 出力バッファに171バイトのデータがあります
[2025-06-01 10:13:14] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":207,"registration_type":"updated"}
[2025-06-01 10:13:14] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 10:13:14] [INFO] 処理完了
[2025-06-01 10:18:04] [INFO] --- 登録API処理開始 ---
[2025-06-01 10:18:04] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 10:18:04] [INFO] --- 登録API処理開始 ---
[2025-06-01 10:18:04] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 10:18:04] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0NDI4MSwiaWF0IjoxNzQ4NzQwNjgxLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.hk_uZ6GHrELXdoKhE-AAO5fy9-62vad2JY71T1S8t2aZwJhLPpVFFrDbEBiVXYp_Vc3HuGmGQ0NCbfRxQXfVOA","room_number":"fg#06","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00"}
[2025-06-01 10:18:04] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhMmE0NTlhZWM1YjY1ZmE0ZThhZGQ1Yzc2OTdjNzliZTQ0NWFlMzEyYmJjZDZlZWY4ZmUwOWI1YmI4MjZjZjNkIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0NDI4MSwiaWF0IjoxNzQ4NzQwNjgxLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.hk_uZ6GHrELXdoKhE-AAO5fy9-62vad2JY71T1S8t2aZwJhLPpVFFrDbEBiVXYp_Vc3HuGmGQ0NCbfRxQXfVOA
    [room_number] => fg#06
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
)

[2025-06-01 10:18:04] [INFO] forceフラグ: false
[2025-06-01 10:18:04] [INFO] 処理パラメータ: room=fg#06, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 10:18:04] [INFO] IDトークンを検証: eyJraWQiOiJhMmE0NTlh...
[2025-06-01 10:18:04] [DEBUG] トークン検証開始: eyJraWQiOiJhMmE0NTlh...
[2025-06-01 10:18:04] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748744281
    [iat] => 1748740681
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 10:18:04] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 10:18:04] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 10:18:04] [INFO] データベース接続を開始します
[2025-06-01 10:18:04] [INFO] データベース接続成功
[2025-06-01 10:18:04] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 10:18:04] [INFO] line_room_linksテーブルが存在します
[2025-06-01 10:18:04] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 10:18:04] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 10:18:04] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=242 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 10:18:04] [INFO] line_room_linksテーブルのレコード数: 0
[2025-06-01 10:18:04] [INFO] トランザクション開始
[2025-06-01 10:18:04] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 10:18:04] [DEBUG] パラメータバインド: roomNumber=fg#06
[2025-06-01 10:18:04] [INFO] 部屋検索クエリ実行完了
[2025-06-01 10:18:04] [INFO] 部屋検索結果: 部屋あり ID=6, アクティブ=1
[2025-06-01 10:18:04] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 10:18:04] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 10:18:04] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 10:18:04] [INFO] ユーザー全登録検索結果: 0件の登録あり
[2025-06-01 10:18:04] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-01 10:18:04] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 10:18:04] [DEBUG] プリペアドステートメント作成成功
[2025-06-01 10:18:04] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 10:18:04] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#06, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-06-02
[2025-06-01 10:18:04] [INFO] SQLを実行します
[2025-06-01 10:18:04] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#06","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-06-02"}
[2025-06-01 10:18:04] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-01 10:18:04] [DEBUG] 直接クエリ実行結果: 成功
[2025-06-01 10:18:04] [INFO] 直接クエリで新規登録ID: 242
[2025-06-01 10:18:04] [INFO] トランザクションコミット成功
[2025-06-01 10:18:04] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"242","registration_type":"new"}
[2025-06-01 10:18:04] [INFO] JSONレスポンスを送信完了
[2025-06-01 10:18:04] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に登録されました","registration_id":"242","registration_type":"new"}
2025-06-01 10:18:04 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号新規登録 - 部屋: fg#06 - 期間: 2025-06-01 から 2025-06-02
[2025-06-01 10:18:04] [DEBUG] 出力バッファに169バイトのデータがあります
[2025-06-01 10:18:04] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"242","registration_type":"new"}
[2025-06-01 10:18:04] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 10:18:04] [INFO] 処理完了
[2025-06-01 10:19:43] [INFO] --- 登録API処理開始 ---
[2025-06-01 10:19:43] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 10:19:43] [INFO] --- 登録API処理開始 ---
[2025-06-01 10:19:43] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 10:19:43] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhMmZkNTE4MTY5MmNjNmRhZjc5OTkwNWQwZGNkN2IwODI2YjQ1OGM5ZmU3OTRiOTA1NmZjN2I0ZGI2MWNmYmE0IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0NDM3OSwiaWF0IjoxNzQ4NzQwNzc5LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9._daQG9mE4fDkgAK_lt8OC58FNqrZn76LNcMTgPQcAqsRZeCDUwf22qlCjdmRLYmEoS7K8O2PJ2vXtIFLK6n0hQ","room_number":"fg#06","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00"}
[2025-06-01 10:19:43] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhMmZkNTE4MTY5MmNjNmRhZjc5OTkwNWQwZGNkN2IwODI2YjQ1OGM5ZmU3OTRiOTA1NmZjN2I0ZGI2MWNmYmE0IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0NDM3OSwiaWF0IjoxNzQ4NzQwNzc5LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9._daQG9mE4fDkgAK_lt8OC58FNqrZn76LNcMTgPQcAqsRZeCDUwf22qlCjdmRLYmEoS7K8O2PJ2vXtIFLK6n0hQ
    [room_number] => fg#06
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
)

[2025-06-01 10:19:43] [INFO] forceフラグ: false
[2025-06-01 10:19:43] [INFO] 処理パラメータ: room=fg#06, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 10:19:43] [INFO] IDトークンを検証: eyJraWQiOiJhMmZkNTE4...
[2025-06-01 10:19:43] [DEBUG] トークン検証開始: eyJraWQiOiJhMmZkNTE4...
[2025-06-01 10:19:43] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748744379
    [iat] => 1748740779
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 10:19:43] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 10:19:43] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 10:19:43] [INFO] データベース接続を開始します
[2025-06-01 10:19:43] [INFO] データベース接続成功
[2025-06-01 10:19:43] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 10:19:43] [INFO] line_room_linksテーブルが存在します
[2025-06-01 10:19:43] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 10:19:43] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 10:19:43] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=243 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 10:19:43] [INFO] line_room_linksテーブルのレコード数: 1
[2025-06-01 10:19:43] [INFO] 最新のレコード: {"id":242,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#06","order_session_id":null,"user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-06-02","access_token":null,"is_active":1,"created_at":"2025-06-01 10:18:04","updated_at":"2025-06-01 10:18:04"}
[2025-06-01 10:19:43] [INFO] トランザクション開始
[2025-06-01 10:19:43] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 10:19:43] [DEBUG] パラメータバインド: roomNumber=fg#06
[2025-06-01 10:19:43] [INFO] 部屋検索クエリ実行完了
[2025-06-01 10:19:43] [INFO] 部屋検索結果: 部屋あり ID=6, アクティブ=1
[2025-06-01 10:19:43] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 10:19:43] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 10:19:43] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 10:19:43] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 10:19:43] [INFO] 有効な登録ID: 242, チェックアウト日: 2025-06-02
[2025-06-01 10:19:43] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 10:19:43] [INFO] 非アクティブ化した登録数: 1
[2025-06-01 10:19:43] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate,
                    is_active = 1
                WHERE id = :id
            
[2025-06-01 10:19:43] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 10:19:43] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 10:19:43] [DEBUG] パラメータバインド: id=242, roomNumber=fg#06, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-06-02
[2025-06-01 10:19:43] [INFO] 更新クエリ実行完了: 成功
[2025-06-01 10:19:43] [INFO] 既存登録を更新: id=242
[2025-06-01 10:19:43] [INFO] トランザクションコミット成功
[2025-06-01 10:19:43] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":242,"registration_type":"update"}
[2025-06-01 10:19:43] [INFO] JSONレスポンスを送信完了
[2025-06-01 10:19:43] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":242,"registration_type":"update"}
2025-06-01 10:19:43 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#06 - 期間: 2025-06-01 から 2025-06-02
[2025-06-01 10:19:43] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-06-01 10:19:43] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":242,"registration_type":"update"}
[2025-06-01 10:19:43] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 10:19:43] [INFO] 処理完了
[2025-06-01 10:20:27] [INFO] --- 登録API処理開始 ---
[2025-06-01 10:20:27] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 10:20:27] [INFO] --- 登録API処理開始 ---
[2025-06-01 10:20:27] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 10:20:27] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI5NWU5MTE5ZjY1M2VhZTA5NWJiM2Q4NzFkNmJhOGZmNDY0NjdhYTMxNDU3NWE0NTQzNjE1ZjA1MWQ0YjczNWE2IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0NDQyMSwiaWF0IjoxNzQ4NzQwODIxLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.faWzbc3PqsAiE19jU6NQcN2NDgBaMNCtnZ8o_6etuS6N1jUdrinxcJDk8bSwS9Wd_rTVSdIEdGAHe1sOr5DhvA","room_number":"fg#06","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00"}
[2025-06-01 10:20:27] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI5NWU5MTE5ZjY1M2VhZTA5NWJiM2Q4NzFkNmJhOGZmNDY0NjdhYTMxNDU3NWE0NTQzNjE1ZjA1MWQ0YjczNWE2IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0NDQyMSwiaWF0IjoxNzQ4NzQwODIxLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.faWzbc3PqsAiE19jU6NQcN2NDgBaMNCtnZ8o_6etuS6N1jUdrinxcJDk8bSwS9Wd_rTVSdIEdGAHe1sOr5DhvA
    [room_number] => fg#06
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
)

[2025-06-01 10:20:27] [INFO] forceフラグ: false
[2025-06-01 10:20:27] [INFO] 処理パラメータ: room=fg#06, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 10:20:27] [INFO] IDトークンを検証: eyJraWQiOiI5NWU5MTE5...
[2025-06-01 10:20:27] [DEBUG] トークン検証開始: eyJraWQiOiI5NWU5MTE5...
[2025-06-01 10:20:27] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748744421
    [iat] => 1748740821
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 10:20:27] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 10:20:27] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 10:20:27] [INFO] データベース接続を開始します
[2025-06-01 10:20:27] [INFO] データベース接続成功
[2025-06-01 10:20:27] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 10:20:27] [INFO] line_room_linksテーブルが存在します
[2025-06-01 10:20:27] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 10:20:27] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 10:20:27] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=243 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 10:20:27] [INFO] line_room_linksテーブルのレコード数: 1
[2025-06-01 10:20:27] [INFO] 最新のレコード: {"id":242,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#06","order_session_id":null,"user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-06-02","access_token":null,"is_active":1,"created_at":"2025-06-01 10:18:04","updated_at":"2025-06-01 10:19:43"}
[2025-06-01 10:20:27] [INFO] トランザクション開始
[2025-06-01 10:20:27] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 10:20:27] [DEBUG] パラメータバインド: roomNumber=fg#06
[2025-06-01 10:20:27] [INFO] 部屋検索クエリ実行完了
[2025-06-01 10:20:27] [INFO] 部屋検索結果: 部屋あり ID=6, アクティブ=1
[2025-06-01 10:20:27] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 10:20:27] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 10:20:27] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 10:20:27] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 10:20:27] [INFO] 有効な登録ID: 242, チェックアウト日: 2025-06-02
[2025-06-01 10:20:27] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 10:20:27] [INFO] 非アクティブ化した登録数: 1
[2025-06-01 10:20:27] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate,
                    is_active = 1
                WHERE id = :id
            
[2025-06-01 10:20:27] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 10:20:27] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 10:20:27] [DEBUG] パラメータバインド: id=242, roomNumber=fg#06, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-06-02
[2025-06-01 10:20:27] [INFO] 更新クエリ実行完了: 成功
[2025-06-01 10:20:27] [INFO] 既存登録を更新: id=242
[2025-06-01 10:20:27] [INFO] トランザクションコミット成功
[2025-06-01 10:20:27] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":242,"registration_type":"update"}
[2025-06-01 10:20:27] [INFO] JSONレスポンスを送信完了
[2025-06-01 10:20:27] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":242,"registration_type":"update"}
2025-06-01 10:20:27 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#06 - 期間: 2025-06-01 から 2025-06-02
[2025-06-01 10:20:27] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-06-01 10:20:27] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":242,"registration_type":"update"}
[2025-06-01 10:20:27] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 10:20:27] [INFO] 処理完了
[2025-06-01 10:21:21] [INFO] --- 登録API処理開始 ---
[2025-06-01 10:21:21] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 10:21:21] [INFO] --- 登録API処理開始 ---
[2025-06-01 10:21:21] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 10:21:21] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI3ZjMxMTU5YTY1YWE0YmYxZGRmMzQyYjU3MTcwZGQ3NDY3ZTkyZDEyZTg0YzI0Y2EyMGUxNDQyNTUzYjNmMDhjIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0NDQ3NywiaWF0IjoxNzQ4NzQwODc3LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.4f9_sl608i5XmuJLyvVdS5OUla_t-iSn1UM9e_zqypN20fxK83Hofp2vmhL3E2rN5haVA9i1j2IyNBmhkw7lOg","room_number":"fg#11","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00"}
[2025-06-01 10:21:21] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI3ZjMxMTU5YTY1YWE0YmYxZGRmMzQyYjU3MTcwZGQ3NDY3ZTkyZDEyZTg0YzI0Y2EyMGUxNDQyNTUzYjNmMDhjIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0NDQ3NywiaWF0IjoxNzQ4NzQwODc3LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.4f9_sl608i5XmuJLyvVdS5OUla_t-iSn1UM9e_zqypN20fxK83Hofp2vmhL3E2rN5haVA9i1j2IyNBmhkw7lOg
    [room_number] => fg#11
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
)

[2025-06-01 10:21:21] [INFO] forceフラグ: false
[2025-06-01 10:21:21] [INFO] 処理パラメータ: room=fg#11, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 10:21:21] [INFO] IDトークンを検証: eyJraWQiOiI3ZjMxMTU5...
[2025-06-01 10:21:21] [DEBUG] トークン検証開始: eyJraWQiOiI3ZjMxMTU5...
[2025-06-01 10:21:21] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748744477
    [iat] => 1748740877
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 10:21:21] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 10:21:21] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 10:21:21] [INFO] データベース接続を開始します
[2025-06-01 10:21:21] [INFO] データベース接続成功
[2025-06-01 10:21:21] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 10:21:21] [INFO] line_room_linksテーブルが存在します
[2025-06-01 10:21:21] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 10:21:21] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 10:21:21] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=243 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 10:21:21] [INFO] line_room_linksテーブルのレコード数: 1
[2025-06-01 10:21:21] [INFO] 最新のレコード: {"id":242,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#06","order_session_id":null,"user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-06-02","access_token":null,"is_active":1,"created_at":"2025-06-01 10:18:04","updated_at":"2025-06-01 10:20:27"}
[2025-06-01 10:21:21] [INFO] トランザクション開始
[2025-06-01 10:21:21] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 10:21:21] [DEBUG] パラメータバインド: roomNumber=fg#11
[2025-06-01 10:21:21] [INFO] 部屋検索クエリ実行完了
[2025-06-01 10:21:21] [INFO] 部屋検索結果: 部屋あり ID=11, アクティブ=1
[2025-06-01 10:21:21] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 10:21:21] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 10:21:21] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 10:21:21] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 10:21:21] [INFO] 部屋変更要求を検出: 旧=fg#06 新=fg#11
[2025-06-01 10:21:21] [INFO] 未払いセッション件数: 0
[2025-06-01 10:21:21] [INFO] 旧リンクを is_active=0 に更新: id=242
[2025-06-01 10:21:21] [INFO] 旧 order_sessions をクローズ: room_number=fg#06
[2025-06-01 10:21:21] [INFO] 有効な登録ID: 242, チェックアウト日: 2025-06-02
[2025-06-01 10:21:21] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 10:21:21] [INFO] 非アクティブ化した登録数: 0
[2025-06-01 10:21:21] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate,
                    is_active = 1
                WHERE id = :id
            
[2025-06-01 10:21:21] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 10:21:21] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 10:21:21] [DEBUG] パラメータバインド: id=242, roomNumber=fg#11, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-06-02
[2025-06-01 10:21:21] [INFO] 更新クエリ実行完了: 成功
[2025-06-01 10:21:21] [INFO] 既存登録を更新: id=242
[2025-06-01 10:21:21] [INFO] トランザクションコミット成功
[2025-06-01 10:21:21] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":242,"registration_type":"update"}
[2025-06-01 10:21:21] [INFO] JSONレスポンスを送信完了
[2025-06-01 10:21:21] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":242,"registration_type":"update"}
2025-06-01 10:21:21 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#11 - 期間: 2025-06-01 から 2025-06-02
[2025-06-01 10:21:21] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-06-01 10:21:21] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":242,"registration_type":"update"}
[2025-06-01 10:21:21] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 10:21:21] [INFO] 処理完了
[2025-06-01 10:58:43] [INFO] --- 登録API処理開始 ---
[2025-06-01 10:58:43] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 10:58:44] [INFO] --- 登録API処理開始 ---
[2025-06-01 10:58:44] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 10:58:44] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI5YjExMTJiMDk4ZjMxODRjNmU4M2ZjM2QxYmU4ZmMyMTdkYjFlYjIwNzU2YTE1NmNiNjNjZThjZTllMjdkZmQyIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0NjcwNywiaWF0IjoxNzQ4NzQzMTA3LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.EV_ZwN88fiai-4fDqkKGTjbuu0niJHGNk8BtrtI_9myg90jy_U35uFd1vNoGwcl-1IOUlp5p59J7kHXKG6CXfQ","room_number":"fg#06","user_name":"テスト太郎","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00"}
[2025-06-01 10:58:44] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI5YjExMTJiMDk4ZjMxODRjNmU4M2ZjM2QxYmU4ZmMyMTdkYjFlYjIwNzU2YTE1NmNiNjNjZThjZTllMjdkZmQyIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0NjcwNywiaWF0IjoxNzQ4NzQzMTA3LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.EV_ZwN88fiai-4fDqkKGTjbuu0niJHGNk8BtrtI_9myg90jy_U35uFd1vNoGwcl-1IOUlp5p59J7kHXKG6CXfQ
    [room_number] => fg#06
    [user_name] => テスト太郎
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
)

[2025-06-01 10:58:44] [INFO] forceフラグ: false
[2025-06-01 10:58:44] [INFO] 処理パラメータ: room=fg#06, user=テスト太郎, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 10:58:44] [INFO] IDトークンを検証: eyJraWQiOiI5YjExMTJi...
[2025-06-01 10:58:44] [DEBUG] トークン検証開始: eyJraWQiOiI5YjExMTJi...
[2025-06-01 10:58:44] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748746707
    [iat] => 1748743107
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 10:58:44] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 10:58:44] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 10:58:44] [INFO] データベース接続を開始します
[2025-06-01 10:58:44] [INFO] データベース接続成功
[2025-06-01 10:58:44] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 10:58:44] [INFO] line_room_linksテーブルが存在します
[2025-06-01 10:58:44] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 10:58:44] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 10:58:44] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=243 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 10:58:44] [INFO] line_room_linksテーブルのレコード数: 0
[2025-06-01 10:58:44] [INFO] トランザクション開始
[2025-06-01 10:58:44] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 10:58:44] [DEBUG] パラメータバインド: roomNumber=fg#06
[2025-06-01 10:58:44] [INFO] 部屋検索クエリ実行完了
[2025-06-01 10:58:44] [INFO] 部屋検索結果: 部屋あり ID=6, アクティブ=1
[2025-06-01 10:58:44] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 10:58:44] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 10:58:44] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 10:58:44] [INFO] ユーザー全登録検索結果: 0件の登録あり
[2025-06-01 10:58:44] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-01 10:58:44] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 10:58:44] [DEBUG] プリペアドステートメント作成成功
[2025-06-01 10:58:44] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 10:58:44] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#06, userName=テスト太郎, checkInDate=2025-06-01, checkOutDate=2025-06-02
[2025-06-01 10:58:44] [INFO] SQLを実行します
[2025-06-01 10:58:44] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#06","user_name":"\u30c6\u30b9\u30c8\u592a\u90ce","check_in_date":"2025-06-01","check_out_date":"2025-06-02"}
[2025-06-01 10:58:44] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-01 10:58:44] [DEBUG] 直接クエリ実行結果: 成功
[2025-06-01 10:58:44] [INFO] 直接クエリで新規登録ID: 243
[2025-06-01 10:58:44] [INFO] トランザクションコミット成功
[2025-06-01 10:58:44] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"243","registration_type":"new"}
[2025-06-01 10:58:44] [INFO] JSONレスポンスを送信完了
[2025-06-01 10:58:44] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に登録されました","registration_id":"243","registration_type":"new"}
2025-06-01 10:58:44 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号新規登録 - 部屋: fg#06 - 期間: 2025-06-01 から 2025-06-02
[2025-06-01 10:58:44] [DEBUG] 出力バッファに169バイトのデータがあります
[2025-06-01 10:58:44] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"243","registration_type":"new"}
[2025-06-01 10:58:44] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 10:58:44] [INFO] 処理完了
[2025-06-01 11:14:39] [INFO] --- 登録API処理開始 ---
[2025-06-01 11:14:39] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 11:14:39] [INFO] --- 登録API処理開始 ---
[2025-06-01 11:14:39] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 11:14:39] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJhMmZkNTE4MTY5MmNjNmRhZjc5OTkwNWQwZGNkN2IwODI2YjQ1OGM5ZmU3OTRiOTA1NmZjN2I0ZGI2MWNmYmE0IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0NzY2NiwiaWF0IjoxNzQ4NzQ0MDY2LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.1U7Wr4vD6WM87TaUlHmgX4-0b-mtBXxp56kgDmK3mEC5pCXpEppI34elHct67nwxYX3RTAdCHNeDE9uZrL93xA","room_number":"fg#11","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00"}
[2025-06-01 11:14:39] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJhMmZkNTE4MTY5MmNjNmRhZjc5OTkwNWQwZGNkN2IwODI2YjQ1OGM5ZmU3OTRiOTA1NmZjN2I0ZGI2MWNmYmE0IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0NzY2NiwiaWF0IjoxNzQ4NzQ0MDY2LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.1U7Wr4vD6WM87TaUlHmgX4-0b-mtBXxp56kgDmK3mEC5pCXpEppI34elHct67nwxYX3RTAdCHNeDE9uZrL93xA
    [room_number] => fg#11
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
)

[2025-06-01 11:14:39] [INFO] forceフラグ: false
[2025-06-01 11:14:39] [INFO] 処理パラメータ: room=fg#11, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 11:14:39] [INFO] IDトークンを検証: eyJraWQiOiJhMmZkNTE4...
[2025-06-01 11:14:39] [DEBUG] トークン検証開始: eyJraWQiOiJhMmZkNTE4...
[2025-06-01 11:14:39] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748747666
    [iat] => 1748744066
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 11:14:39] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 11:14:39] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 11:14:39] [INFO] データベース接続を開始します
[2025-06-01 11:14:39] [INFO] データベース接続成功
[2025-06-01 11:14:39] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 11:14:39] [INFO] line_room_linksテーブルが存在します
[2025-06-01 11:14:39] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 11:14:39] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 11:14:39] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=244 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 11:14:39] [INFO] line_room_linksテーブルのレコード数: 0
[2025-06-01 11:14:39] [INFO] トランザクション開始
[2025-06-01 11:14:39] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 11:14:39] [DEBUG] パラメータバインド: roomNumber=fg#11
[2025-06-01 11:14:39] [INFO] 部屋検索クエリ実行完了
[2025-06-01 11:14:39] [INFO] 部屋検索結果: 部屋あり ID=11, アクティブ=1
[2025-06-01 11:14:39] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 11:14:39] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 11:14:39] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 11:14:39] [INFO] ユーザー全登録検索結果: 0件の登録あり
[2025-06-01 11:14:39] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-01 11:14:39] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 11:14:39] [DEBUG] プリペアドステートメント作成成功
[2025-06-01 11:14:39] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 11:14:39] [DEBUG] パラメータバインド完了: userId=U4d777614158c719515a7be91a41bc382, roomNumber=fg#11, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-06-02
[2025-06-01 11:14:39] [INFO] SQLを実行します
[2025-06-01 11:14:39] [DEBUG] 挿入予定の値: {"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#11","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-06-02"}
[2025-06-01 11:14:39] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-01 11:14:39] [DEBUG] 直接クエリ実行結果: 成功
[2025-06-01 11:14:39] [INFO] 直接クエリで新規登録ID: 244
[2025-06-01 11:14:39] [INFO] トランザクションコミット成功
[2025-06-01 11:14:39] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"244","registration_type":"new"}
[2025-06-01 11:14:39] [INFO] JSONレスポンスを送信完了
[2025-06-01 11:14:39] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に登録されました","registration_id":"244","registration_type":"new"}
2025-06-01 11:14:39 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号新規登録 - 部屋: fg#11 - 期間: 2025-06-01 から 2025-06-02
[2025-06-01 11:14:39] [DEBUG] 出力バッファに169バイトのデータがあります
[2025-06-01 11:14:39] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"244","registration_type":"new"}
[2025-06-01 11:14:39] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 11:14:39] [INFO] 処理完了
[2025-06-01 11:29:27] [INFO] --- 登録API処理開始 ---
[2025-06-01 11:29:27] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 11:29:27] [INFO] --- 登録API処理開始 ---
[2025-06-01 11:29:27] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 11:29:27] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJmZTFlOGQ4ODhlYzY2NGNkMmFmZWY0NzljNWRiNzk2OTJjZDAxYWFjZDE0MTQ4M2E1NDMzOTM1MWYzOTVmYTI3IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0ODU1OCwiaWF0IjoxNzQ4NzQ0OTU4LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.AvYgkuXBjBVogukYBx5QPSswJBNf_I2FPLXgJg5RmdHg0YTQld0l2t1MTjzQofP8WtJmR_QCKrCYVNu0jc-pew","room_number":"fg#11","user_name":"くらひで","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00"}
[2025-06-01 11:29:27] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJmZTFlOGQ4ODhlYzY2NGNkMmFmZWY0NzljNWRiNzk2OTJjZDAxYWFjZDE0MTQ4M2E1NDMzOTM1MWYzOTVmYTI3IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc0ODU1OCwiaWF0IjoxNzQ4NzQ0OTU4LCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.AvYgkuXBjBVogukYBx5QPSswJBNf_I2FPLXgJg5RmdHg0YTQld0l2t1MTjzQofP8WtJmR_QCKrCYVNu0jc-pew
    [room_number] => fg#11
    [user_name] => くらひで
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
)

[2025-06-01 11:29:27] [INFO] forceフラグ: false
[2025-06-01 11:29:27] [INFO] 処理パラメータ: room=fg#11, user=くらひで, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 11:29:27] [INFO] IDトークンを検証: eyJraWQiOiJmZTFlOGQ4...
[2025-06-01 11:29:27] [DEBUG] トークン検証開始: eyJraWQiOiJmZTFlOGQ4...
[2025-06-01 11:29:27] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1748748558
    [iat] => 1748744958
    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-01 11:29:27] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-01 11:29:27] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 11:29:27] [INFO] データベース接続を開始します
[2025-06-01 11:29:27] [INFO] データベース接続成功
[2025-06-01 11:29:27] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 11:29:27] [INFO] line_room_linksテーブルが存在します
[2025-06-01 11:29:27] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 11:29:27] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 11:29:27] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=245 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 11:29:27] [INFO] line_room_linksテーブルのレコード数: 1
[2025-06-01 11:29:27] [INFO] 最新のレコード: {"id":244,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#11","order_session_id":"250601111519008399961","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-06-02","access_token":null,"is_active":1,"created_at":"2025-06-01 11:14:39","updated_at":"2025-06-01 11:15:19"}
[2025-06-01 11:29:27] [INFO] トランザクション開始
[2025-06-01 11:29:27] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 11:29:27] [DEBUG] パラメータバインド: roomNumber=fg#11
[2025-06-01 11:29:27] [INFO] 部屋検索クエリ実行完了
[2025-06-01 11:29:27] [INFO] 部屋検索結果: 部屋あり ID=11, アクティブ=1
[2025-06-01 11:29:27] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 11:29:27] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-01 11:29:27] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 11:29:27] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 11:29:27] [INFO] 有効な登録ID: 244, チェックアウト日: 2025-06-02
[2025-06-01 11:29:27] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 11:29:27] [INFO] 非アクティブ化した登録数: 1
[2025-06-01 11:29:27] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate,
                    is_active = 1
                WHERE id = :id
            
[2025-06-01 11:29:27] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 11:29:27] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 11:29:27] [DEBUG] パラメータバインド: id=244, roomNumber=fg#11, userName=くらひで, checkInDate=2025-06-01, checkOutDate=2025-06-02
[2025-06-01 11:29:27] [INFO] 更新クエリ実行完了: 成功
[2025-06-01 11:29:27] [INFO] 既存登録を更新: id=244
[2025-06-01 11:29:27] [INFO] トランザクションコミット成功
[2025-06-01 11:29:27] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":244,"registration_type":"update"}
[2025-06-01 11:29:27] [INFO] JSONレスポンスを送信完了
[2025-06-01 11:29:27] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":244,"registration_type":"update"}
2025-06-01 11:29:27 - ユーザーID: U4d777614158c719515a7be91a41bc382 - 部屋番号更新 - 部屋: fg#11 - 期間: 2025-06-01 から 2025-06-02
[2025-06-01 11:29:27] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-06-01 11:29:27] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":244,"registration_type":"update"}
[2025-06-01 11:29:27] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 11:29:27] [INFO] 処理完了
[2025-06-01 22:02:23] [INFO] --- 登録API処理開始 ---
[2025-06-01 22:02:23] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 22:02:23] [INFO] --- 登録API処理開始 ---
[2025-06-01 22:02:23] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 22:02:23] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI5MjkxZTZiNmEzOGM3ZDhhZjY4YzUyNjZmYWEyODIwOGQ2ZGQ1OTg0NWZhYTAyNGU1NDFiZGIzOWZlMTM1ZDRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTMzZjVmOWFhZDcxZTgxYTU5MTdkZGM3Y2Q4M2JiOGY4IiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc4NjU0MCwiaWF0IjoxNzQ4NzgyOTQwLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi5re75baL57SY5Y-ySGlyb2Z1bWkgQml6IiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoWDBhTE5Ja3FCeDljTlJGcGZySjRTR0J3Q1hJckd3RlhKRmNZS1NwbUN5bHpBMFFjWTFGQUtuaGlDaTUzQmtRYVkxcEtleW8wVUgxMSJ9.RJ7g7llroCGo2uc0kgZKn5qZO0hAtakUloFZappNZ1iMH-9VPcds7OhwjRNr5SSLrPx09aZpDKP8lHTsBjPq6g","room_number":"fg#09","user_name":"添嶋紘史Hirofumi Biz","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00"}
[2025-06-01 22:02:23] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI5MjkxZTZiNmEzOGM3ZDhhZjY4YzUyNjZmYWEyODIwOGQ2ZGQ1OTg0NWZhYTAyNGU1NDFiZGIzOWZlMTM1ZDRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTMzZjVmOWFhZDcxZTgxYTU5MTdkZGM3Y2Q4M2JiOGY4IiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc4NjU0MCwiaWF0IjoxNzQ4NzgyOTQwLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi5re75baL57SY5Y-ySGlyb2Z1bWkgQml6IiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoWDBhTE5Ja3FCeDljTlJGcGZySjRTR0J3Q1hJckd3RlhKRmNZS1NwbUN5bHpBMFFjWTFGQUtuaGlDaTUzQmtRYVkxcEtleW8wVUgxMSJ9.RJ7g7llroCGo2uc0kgZKn5qZO0hAtakUloFZappNZ1iMH-9VPcds7OhwjRNr5SSLrPx09aZpDKP8lHTsBjPq6g
    [room_number] => fg#09
    [user_name] => 添嶋紘史Hirofumi Biz
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
)

[2025-06-01 22:02:23] [INFO] forceフラグ: false
[2025-06-01 22:02:23] [INFO] 処理パラメータ: room=fg#09, user=添嶋紘史Hirofumi Biz, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 22:02:23] [INFO] IDトークンを検証: eyJraWQiOiI5MjkxZTZi...
[2025-06-01 22:02:23] [DEBUG] トークン検証開始: eyJraWQiOiI5MjkxZTZi...
[2025-06-01 22:02:23] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U33f5f9aad71e81a5917ddc7cd83bb8f8
    [aud] => 2007363986
    [exp] => 1748786540
    [iat] => 1748782940
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => 添嶋紘史Hirofumi Biz
    [picture] => https://profile.line-scdn.net/0hX0aLNIkqBx9cNRFpfrJ4SGBwCXIrGwFXJFcYKSpmCylzA0QcY1FAKnhiCi53BkQaY1pKeyo0UH11
)

[2025-06-01 22:02:23] [INFO] トークン検証成功: ユーザーID U33f5f9aad71e81a5917ddc7cd83bb8f8
[2025-06-01 22:02:23] [INFO] IDトークン検証成功: userId=U33f5f9aad71e81a5917ddc7cd83bb8f8
[2025-06-01 22:02:23] [INFO] データベース接続を開始します
[2025-06-01 22:02:23] [INFO] データベース接続成功
[2025-06-01 22:02:23] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 22:02:23] [INFO] line_room_linksテーブルが存在します
[2025-06-01 22:02:23] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 22:02:23] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 22:02:23] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=245 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 22:02:23] [INFO] line_room_linksテーブルのレコード数: 1
[2025-06-01 22:02:23] [INFO] 最新のレコード: {"id":244,"line_user_id":"U4d777614158c719515a7be91a41bc382","room_number":"fg#11","order_session_id":"250601111519008399961","user_name":"\u304f\u3089\u3072\u3067","check_in_date":"2025-06-01","check_out_date":"2025-06-02","access_token":null,"is_active":1,"created_at":"2025-06-01 11:14:39","updated_at":"2025-06-01 11:29:27"}
[2025-06-01 22:02:23] [INFO] トランザクション開始
[2025-06-01 22:02:23] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 22:02:23] [DEBUG] パラメータバインド: roomNumber=fg#09
[2025-06-01 22:02:23] [INFO] 部屋検索クエリ実行完了
[2025-06-01 22:02:23] [INFO] 部屋検索結果: 部屋あり ID=9, アクティブ=1
[2025-06-01 22:02:23] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 22:02:23] [DEBUG] パラメータバインド: userId=U33f5f9aad71e81a5917ddc7cd83bb8f8
[2025-06-01 22:02:23] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 22:02:23] [INFO] ユーザー全登録検索結果: 0件の登録あり
[2025-06-01 22:02:23] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-01 22:02:23] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 22:02:23] [DEBUG] プリペアドステートメント作成成功
[2025-06-01 22:02:23] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 22:02:23] [DEBUG] パラメータバインド完了: userId=U33f5f9aad71e81a5917ddc7cd83bb8f8, roomNumber=fg#09, userName=添嶋紘史Hirofumi Biz, checkInDate=2025-06-01, checkOutDate=2025-06-02
[2025-06-01 22:02:23] [INFO] SQLを実行します
[2025-06-01 22:02:23] [DEBUG] 挿入予定の値: {"line_user_id":"U33f5f9aad71e81a5917ddc7cd83bb8f8","room_number":"fg#09","user_name":"\u6dfb\u5d8b\u7d18\u53f2Hirofumi Biz","check_in_date":"2025-06-01","check_out_date":"2025-06-02"}
[2025-06-01 22:02:23] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-01 22:02:23] [DEBUG] 直接クエリ実行結果: 成功
[2025-06-01 22:02:23] [INFO] 直接クエリで新規登録ID: 245
[2025-06-01 22:02:23] [INFO] トランザクションコミット成功
[2025-06-01 22:02:23] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"245","registration_type":"new"}
[2025-06-01 22:02:23] [INFO] JSONレスポンスを送信完了
[2025-06-01 22:02:23] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に登録されました","registration_id":"245","registration_type":"new"}
2025-06-01 22:02:23 - ユーザーID: U33f5f9aad71e81a5917ddc7cd83bb8f8 - 部屋番号新規登録 - 部屋: fg#09 - 期間: 2025-06-01 から 2025-06-02
[2025-06-01 22:02:23] [DEBUG] 出力バッファに169バイトのデータがあります
[2025-06-01 22:02:23] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"245","registration_type":"new"}
[2025-06-01 22:02:23] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 22:02:23] [INFO] 処理完了
[2025-06-01 22:03:39] [INFO] --- 登録API処理開始 ---
[2025-06-01 22:03:39] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 22:03:39] [INFO] --- 登録API処理開始 ---
[2025-06-01 22:03:39] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 22:03:39] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI2YWE4YWQwN2NkMmFhYWRjYzY1NmY3ZTIxMzljY2U4YjhjNGE2YzgxYzI5MDQyZjQ4MTY4MDY3MmZkMDNjOTY5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTMzZjVmOWFhZDcxZTgxYTU5MTdkZGM3Y2Q4M2JiOGY4IiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc4NjYwOSwiaWF0IjoxNzQ4NzgzMDA5LCJuYW1lIjoi5re75baL57SY5Y-ySGlyb2Z1bWkgQml6IiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoWDBhTE5Ja3FCeDljTlJGcGZySjRTR0J3Q1hJckd3RlhKRmNZS1NwbUN5bHpBMFFjWTFGQUtuaGlDaTUzQmtRYVkxcEtleW8wVUgxMSJ9.vU4RG41hlpwg2otZY5h7K8JBNunB-vlOn1dGBOj_nt_ln2CUlK2X2tBO-UO_VzGiV4waYicac_cNZCYpfJaL4g","room_number":"fg#09","user_name":"添嶋紘史Hirofumi Biz","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00"}
[2025-06-01 22:03:39] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI2YWE4YWQwN2NkMmFhYWRjYzY1NmY3ZTIxMzljY2U4YjhjNGE2YzgxYzI5MDQyZjQ4MTY4MDY3MmZkMDNjOTY5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTMzZjVmOWFhZDcxZTgxYTU5MTdkZGM3Y2Q4M2JiOGY4IiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc4NjYwOSwiaWF0IjoxNzQ4NzgzMDA5LCJuYW1lIjoi5re75baL57SY5Y-ySGlyb2Z1bWkgQml6IiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoWDBhTE5Ja3FCeDljTlJGcGZySjRTR0J3Q1hJckd3RlhKRmNZS1NwbUN5bHpBMFFjWTFGQUtuaGlDaTUzQmtRYVkxcEtleW8wVUgxMSJ9.vU4RG41hlpwg2otZY5h7K8JBNunB-vlOn1dGBOj_nt_ln2CUlK2X2tBO-UO_VzGiV4waYicac_cNZCYpfJaL4g
    [room_number] => fg#09
    [user_name] => 添嶋紘史Hirofumi Biz
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
)

[2025-06-01 22:03:39] [INFO] forceフラグ: false
[2025-06-01 22:03:39] [INFO] 処理パラメータ: room=fg#09, user=添嶋紘史Hirofumi Biz, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 22:03:39] [INFO] IDトークンを検証: eyJraWQiOiI2YWE4YWQw...
[2025-06-01 22:03:39] [DEBUG] トークン検証開始: eyJraWQiOiI2YWE4YWQw...
[2025-06-01 22:03:39] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U33f5f9aad71e81a5917ddc7cd83bb8f8
    [aud] => 2007363986
    [exp] => 1748786609
    [iat] => 1748783009
    [name] => 添嶋紘史Hirofumi Biz
    [picture] => https://profile.line-scdn.net/0hX0aLNIkqBx9cNRFpfrJ4SGBwCXIrGwFXJFcYKSpmCylzA0QcY1FAKnhiCi53BkQaY1pKeyo0UH11
)

[2025-06-01 22:03:39] [INFO] トークン検証成功: ユーザーID U33f5f9aad71e81a5917ddc7cd83bb8f8
[2025-06-01 22:03:39] [INFO] IDトークン検証成功: userId=U33f5f9aad71e81a5917ddc7cd83bb8f8
[2025-06-01 22:03:39] [INFO] データベース接続を開始します
[2025-06-01 22:03:39] [INFO] データベース接続成功
[2025-06-01 22:03:39] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 22:03:39] [INFO] line_room_linksテーブルが存在します
[2025-06-01 22:03:39] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 22:03:39] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 22:03:39] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=246 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 22:03:39] [INFO] line_room_linksテーブルのレコード数: 2
[2025-06-01 22:03:39] [INFO] 最新のレコード: {"id":245,"line_user_id":"U33f5f9aad71e81a5917ddc7cd83bb8f8","room_number":"fg#09","order_session_id":null,"user_name":"\u6dfb\u5d8b\u7d18\u53f2Hirofumi Biz","check_in_date":"2025-06-01","check_out_date":"2025-06-02","access_token":null,"is_active":1,"created_at":"2025-06-01 22:02:23","updated_at":"2025-06-01 22:02:23"}
[2025-06-01 22:03:39] [INFO] トランザクション開始
[2025-06-01 22:03:39] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 22:03:39] [DEBUG] パラメータバインド: roomNumber=fg#09
[2025-06-01 22:03:39] [INFO] 部屋検索クエリ実行完了
[2025-06-01 22:03:39] [INFO] 部屋検索結果: 部屋あり ID=9, アクティブ=1
[2025-06-01 22:03:39] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 22:03:39] [DEBUG] パラメータバインド: userId=U33f5f9aad71e81a5917ddc7cd83bb8f8
[2025-06-01 22:03:39] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 22:03:39] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 22:03:39] [INFO] 有効な登録ID: 245, チェックアウト日: 2025-06-02
[2025-06-01 22:03:39] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 22:03:39] [INFO] 非アクティブ化した登録数: 1
[2025-06-01 22:03:39] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate,
                    is_active = 1
                WHERE id = :id
            
[2025-06-01 22:03:39] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 22:03:39] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 22:03:39] [DEBUG] パラメータバインド: id=245, roomNumber=fg#09, userName=添嶋紘史Hirofumi Biz, checkInDate=2025-06-01, checkOutDate=2025-06-02
[2025-06-01 22:03:39] [INFO] 更新クエリ実行完了: 成功
[2025-06-01 22:03:39] [INFO] 既存登録を更新: id=245
[2025-06-01 22:03:39] [INFO] トランザクションコミット成功
[2025-06-01 22:03:39] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":245,"registration_type":"update"}
[2025-06-01 22:03:39] [INFO] JSONレスポンスを送信完了
[2025-06-01 22:03:39] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":245,"registration_type":"update"}
2025-06-01 22:03:39 - ユーザーID: U33f5f9aad71e81a5917ddc7cd83bb8f8 - 部屋番号更新 - 部屋: fg#09 - 期間: 2025-06-01 から 2025-06-02
[2025-06-01 22:03:39] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-06-01 22:03:39] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":245,"registration_type":"update"}
[2025-06-01 22:03:39] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 22:03:39] [INFO] 処理完了
[2025-06-01 22:05:25] [INFO] --- 登録API処理開始 ---
[2025-06-01 22:05:25] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 22:05:25] [INFO] --- 登録API処理開始 ---
[2025-06-01 22:05:25] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 22:05:25] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI5MjkxZTZiNmEzOGM3ZDhhZjY4YzUyNjZmYWEyODIwOGQ2ZGQ1OTg0NWZhYTAyNGU1NDFiZGIzOWZlMTM1ZDRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTMzZjVmOWFhZDcxZTgxYTU5MTdkZGM3Y2Q4M2JiOGY4IiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc4NjU0MCwiaWF0IjoxNzQ4NzgyOTQwLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi5re75baL57SY5Y-ySGlyb2Z1bWkgQml6IiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoWDBhTE5Ja3FCeDljTlJGcGZySjRTR0J3Q1hJckd3RlhKRmNZS1NwbUN5bHpBMFFjWTFGQUtuaGlDaTUzQmtRYVkxcEtleW8wVUgxMSJ9.RJ7g7llroCGo2uc0kgZKn5qZO0hAtakUloFZappNZ1iMH-9VPcds7OhwjRNr5SSLrPx09aZpDKP8lHTsBjPq6g","room_number":"fg#09","user_name":"添嶋紘史Hirofumi Biz","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00"}
[2025-06-01 22:05:25] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI5MjkxZTZiNmEzOGM3ZDhhZjY4YzUyNjZmYWEyODIwOGQ2ZGQ1OTg0NWZhYTAyNGU1NDFiZGIzOWZlMTM1ZDRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTMzZjVmOWFhZDcxZTgxYTU5MTdkZGM3Y2Q4M2JiOGY4IiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc4NjU0MCwiaWF0IjoxNzQ4NzgyOTQwLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi5re75baL57SY5Y-ySGlyb2Z1bWkgQml6IiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoWDBhTE5Ja3FCeDljTlJGcGZySjRTR0J3Q1hJckd3RlhKRmNZS1NwbUN5bHpBMFFjWTFGQUtuaGlDaTUzQmtRYVkxcEtleW8wVUgxMSJ9.RJ7g7llroCGo2uc0kgZKn5qZO0hAtakUloFZappNZ1iMH-9VPcds7OhwjRNr5SSLrPx09aZpDKP8lHTsBjPq6g
    [room_number] => fg#09
    [user_name] => 添嶋紘史Hirofumi Biz
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
)

[2025-06-01 22:05:25] [INFO] forceフラグ: false
[2025-06-01 22:05:25] [INFO] 処理パラメータ: room=fg#09, user=添嶋紘史Hirofumi Biz, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 22:05:25] [INFO] IDトークンを検証: eyJraWQiOiI5MjkxZTZi...
[2025-06-01 22:05:25] [DEBUG] トークン検証開始: eyJraWQiOiI5MjkxZTZi...
[2025-06-01 22:05:25] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U33f5f9aad71e81a5917ddc7cd83bb8f8
    [aud] => 2007363986
    [exp] => 1748786540
    [iat] => 1748782940
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => 添嶋紘史Hirofumi Biz
    [picture] => https://profile.line-scdn.net/0hX0aLNIkqBx9cNRFpfrJ4SGBwCXIrGwFXJFcYKSpmCylzA0QcY1FAKnhiCi53BkQaY1pKeyo0UH11
)

[2025-06-01 22:05:25] [INFO] トークン検証成功: ユーザーID U33f5f9aad71e81a5917ddc7cd83bb8f8
[2025-06-01 22:05:25] [INFO] IDトークン検証成功: userId=U33f5f9aad71e81a5917ddc7cd83bb8f8
[2025-06-01 22:05:25] [INFO] データベース接続を開始します
[2025-06-01 22:05:25] [INFO] データベース接続成功
[2025-06-01 22:05:25] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 22:05:25] [INFO] line_room_linksテーブルが存在します
[2025-06-01 22:05:25] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 22:05:25] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 22:05:25] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=246 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 22:05:25] [INFO] line_room_linksテーブルのレコード数: 2
[2025-06-01 22:05:25] [INFO] 最新のレコード: {"id":245,"line_user_id":"U33f5f9aad71e81a5917ddc7cd83bb8f8","room_number":"fg#09","order_session_id":null,"user_name":"\u6dfb\u5d8b\u7d18\u53f2Hirofumi Biz","check_in_date":"2025-06-01","check_out_date":"2025-06-02","access_token":null,"is_active":1,"created_at":"2025-06-01 22:02:23","updated_at":"2025-06-01 22:03:39"}
[2025-06-01 22:05:25] [INFO] トランザクション開始
[2025-06-01 22:05:25] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 22:05:25] [DEBUG] パラメータバインド: roomNumber=fg#09
[2025-06-01 22:05:25] [INFO] 部屋検索クエリ実行完了
[2025-06-01 22:05:25] [INFO] 部屋検索結果: 部屋あり ID=9, アクティブ=1
[2025-06-01 22:05:25] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 22:05:25] [DEBUG] パラメータバインド: userId=U33f5f9aad71e81a5917ddc7cd83bb8f8
[2025-06-01 22:05:25] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 22:05:25] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 22:05:25] [INFO] 有効な登録ID: 245, チェックアウト日: 2025-06-02
[2025-06-01 22:05:25] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 22:05:25] [INFO] 非アクティブ化した登録数: 1
[2025-06-01 22:05:25] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate,
                    is_active = 1
                WHERE id = :id
            
[2025-06-01 22:05:25] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 22:05:25] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 22:05:25] [DEBUG] パラメータバインド: id=245, roomNumber=fg#09, userName=添嶋紘史Hirofumi Biz, checkInDate=2025-06-01, checkOutDate=2025-06-02
[2025-06-01 22:05:25] [INFO] 更新クエリ実行完了: 成功
[2025-06-01 22:05:25] [INFO] 既存登録を更新: id=245
[2025-06-01 22:05:25] [INFO] トランザクションコミット成功
[2025-06-01 22:05:25] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":245,"registration_type":"update"}
[2025-06-01 22:05:25] [INFO] JSONレスポンスを送信完了
[2025-06-01 22:05:25] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":245,"registration_type":"update"}
2025-06-01 22:05:25 - ユーザーID: U33f5f9aad71e81a5917ddc7cd83bb8f8 - 部屋番号更新 - 部屋: fg#09 - 期間: 2025-06-01 から 2025-06-02
[2025-06-01 22:05:25] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-06-01 22:05:25] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":245,"registration_type":"update"}
[2025-06-01 22:05:25] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 22:05:25] [INFO] 処理完了
[2025-06-01 22:08:40] [INFO] --- 登録API処理開始 ---
[2025-06-01 22:08:40] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 22:08:40] [INFO] --- 登録API処理開始 ---
[2025-06-01 22:08:40] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 22:08:40] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJmYTEzNDA0Mjk5M2E0YTE3MTdlNGVlMTZiMGM0OGYzNTRkZTYxNzFmODUwMTU1OTcxODg1MDM4Mjg4ZmI5MmM5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTk0MDYzZGY4MWFkYTdhZDczNGJjNmY5OTlhYTU4ZDJhIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc4Njg5MCwiaWF0IjoxNzQ4NzgzMjkwLCJuYW1lIjoi5Y2X6ZuyIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoVzc4aXp3TUhDQmdGRUJqNDAwQjNUemxWQm5WeVBnNVFmWEpHZkNKRVYzOHZjQnRMTVg4WGVTWVNBWHdySTAxT2FpSkNkaUpGVmk5OCJ9.sA1GILS_7DlqfvsaFeg_7955S6sjkjv3gpk_Jm01U45rrSy8o8JhKFKEfHnWFDIEu4YmDjSJiiZUWGzrYEKacQ","room_number":"fg#09","user_name":"南雲","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00"}
[2025-06-01 22:08:40] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJmYTEzNDA0Mjk5M2E0YTE3MTdlNGVlMTZiMGM0OGYzNTRkZTYxNzFmODUwMTU1OTcxODg1MDM4Mjg4ZmI5MmM5IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTk0MDYzZGY4MWFkYTdhZDczNGJjNmY5OTlhYTU4ZDJhIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc4Njg5MCwiaWF0IjoxNzQ4NzgzMjkwLCJuYW1lIjoi5Y2X6ZuyIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoVzc4aXp3TUhDQmdGRUJqNDAwQjNUemxWQm5WeVBnNVFmWEpHZkNKRVYzOHZjQnRMTVg4WGVTWVNBWHdySTAxT2FpSkNkaUpGVmk5OCJ9.sA1GILS_7DlqfvsaFeg_7955S6sjkjv3gpk_Jm01U45rrSy8o8JhKFKEfHnWFDIEu4YmDjSJiiZUWGzrYEKacQ
    [room_number] => fg#09
    [user_name] => 南雲
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
)

[2025-06-01 22:08:40] [INFO] forceフラグ: false
[2025-06-01 22:08:40] [INFO] 処理パラメータ: room=fg#09, user=南雲, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 22:08:40] [INFO] IDトークンを検証: eyJraWQiOiJmYTEzNDA0...
[2025-06-01 22:08:40] [DEBUG] トークン検証開始: eyJraWQiOiJmYTEzNDA0...
[2025-06-01 22:08:40] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U94063df81ada7ad734bc6f999aa58d2a
    [aud] => 2007363986
    [exp] => 1748786890
    [iat] => 1748783290
    [name] => 南雲
    [picture] => https://profile.line-scdn.net/0hW78izwMHCBgFEBj400B3TzlVBnVyPg5QfXJGfCJEV38vcBtLMX8XeSYSAXwrI01OaiJCdiJFVi98
)

[2025-06-01 22:08:40] [INFO] トークン検証成功: ユーザーID U94063df81ada7ad734bc6f999aa58d2a
[2025-06-01 22:08:40] [INFO] IDトークン検証成功: userId=U94063df81ada7ad734bc6f999aa58d2a
[2025-06-01 22:08:40] [INFO] データベース接続を開始します
[2025-06-01 22:08:40] [INFO] データベース接続成功
[2025-06-01 22:08:40] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 22:08:40] [INFO] line_room_linksテーブルが存在します
[2025-06-01 22:08:40] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 22:08:40] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 22:08:40] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=246 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 22:08:40] [INFO] line_room_linksテーブルのレコード数: 2
[2025-06-01 22:08:40] [INFO] 最新のレコード: {"id":245,"line_user_id":"U33f5f9aad71e81a5917ddc7cd83bb8f8","room_number":"fg#09","order_session_id":null,"user_name":"\u6dfb\u5d8b\u7d18\u53f2Hirofumi Biz","check_in_date":"2025-06-01","check_out_date":"2025-06-02","access_token":null,"is_active":1,"created_at":"2025-06-01 22:02:23","updated_at":"2025-06-01 22:05:25"}
[2025-06-01 22:08:40] [INFO] トランザクション開始
[2025-06-01 22:08:40] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 22:08:40] [DEBUG] パラメータバインド: roomNumber=fg#09
[2025-06-01 22:08:40] [INFO] 部屋検索クエリ実行完了
[2025-06-01 22:08:40] [INFO] 部屋検索結果: 部屋あり ID=9, アクティブ=1
[2025-06-01 22:08:40] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 22:08:40] [DEBUG] パラメータバインド: userId=U94063df81ada7ad734bc6f999aa58d2a
[2025-06-01 22:08:40] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 22:08:40] [INFO] ユーザー全登録検索結果: 0件の登録あり
[2025-06-01 22:08:40] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-01 22:08:40] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 22:08:40] [DEBUG] プリペアドステートメント作成成功
[2025-06-01 22:08:40] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 22:08:40] [DEBUG] パラメータバインド完了: userId=U94063df81ada7ad734bc6f999aa58d2a, roomNumber=fg#09, userName=南雲, checkInDate=2025-06-01, checkOutDate=2025-06-02
[2025-06-01 22:08:40] [INFO] SQLを実行します
[2025-06-01 22:08:40] [DEBUG] 挿入予定の値: {"line_user_id":"U94063df81ada7ad734bc6f999aa58d2a","room_number":"fg#09","user_name":"\u5357\u96f2","check_in_date":"2025-06-01","check_out_date":"2025-06-02"}
[2025-06-01 22:08:40] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-01 22:08:40] [DEBUG] 直接クエリ実行結果: 成功
[2025-06-01 22:08:40] [INFO] 直接クエリで新規登録ID: 246
[2025-06-01 22:08:40] [INFO] トランザクションコミット成功
[2025-06-01 22:08:40] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"246","registration_type":"new"}
[2025-06-01 22:08:40] [INFO] JSONレスポンスを送信完了
[2025-06-01 22:08:40] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に登録されました","registration_id":"246","registration_type":"new"}
2025-06-01 22:08:40 - ユーザーID: U94063df81ada7ad734bc6f999aa58d2a - 部屋番号新規登録 - 部屋: fg#09 - 期間: 2025-06-01 から 2025-06-02
[2025-06-01 22:08:40] [DEBUG] 出力バッファに169バイトのデータがあります
[2025-06-01 22:08:40] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"246","registration_type":"new"}
[2025-06-01 22:08:40] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 22:08:40] [INFO] 処理完了
[2025-06-01 22:09:02] [INFO] --- 登録API処理開始 ---
[2025-06-01 22:09:02] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 22:09:02] [INFO] --- 登録API処理開始 ---
[2025-06-01 22:09:02] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-01 22:09:02] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTk0MDYzZGY4MWFkYTdhZDczNGJjNmY5OTlhYTU4ZDJhIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc4NjkzNywiaWF0IjoxNzQ4NzgzMzM3LCJuYW1lIjoi5Y2X6ZuyIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoVzc4aXp3TUhDQmdGRUJqNDAwQjNUemxWQm5WeVBnNVFmWEpHZkNKRVYzOHZjQnRMTVg4WGVTWVNBWHdySTAxT2FpSkNkaUpGVmk5OCJ9.FUTZE3OCovwrfnumsGIftOLL4dQiTHnOUGkWJeiag_cVq-fbkJINDPbLfmZM1M48XYyjzMiEfPysmmdn1QzImg","room_number":"fg#09","user_name":"南雲","check_in":"2025-06-01","check_out":"2025-06-02","check_out_time":"11:00"}
[2025-06-01 22:09:02] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJjY2Q1OGMyZjI2NDZmNDVmZTBiNGJiYjAyMzdkNjJmMGRkN2JiMTY2OWQ0MGMxMjFiODQ4OGYxMGJmMzYzOTAwIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTk0MDYzZGY4MWFkYTdhZDczNGJjNmY5OTlhYTU4ZDJhIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0ODc4NjkzNywiaWF0IjoxNzQ4NzgzMzM3LCJuYW1lIjoi5Y2X6ZuyIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBoVzc4aXp3TUhDQmdGRUJqNDAwQjNUemxWQm5WeVBnNVFmWEpHZkNKRVYzOHZjQnRMTVg4WGVTWVNBWHdySTAxT2FpSkNkaUpGVmk5OCJ9.FUTZE3OCovwrfnumsGIftOLL4dQiTHnOUGkWJeiag_cVq-fbkJINDPbLfmZM1M48XYyjzMiEfPysmmdn1QzImg
    [room_number] => fg#09
    [user_name] => 南雲
    [check_in] => 2025-06-01
    [check_out] => 2025-06-02
    [check_out_time] => 11:00
)

[2025-06-01 22:09:02] [INFO] forceフラグ: false
[2025-06-01 22:09:02] [INFO] 処理パラメータ: room=fg#09, user=南雲, checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 22:09:02] [INFO] IDトークンを検証: eyJraWQiOiJjY2Q1OGMy...
[2025-06-01 22:09:02] [DEBUG] トークン検証開始: eyJraWQiOiJjY2Q1OGMy...
[2025-06-01 22:09:02] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U94063df81ada7ad734bc6f999aa58d2a
    [aud] => 2007363986
    [exp] => 1748786937
    [iat] => 1748783337
    [name] => 南雲
    [picture] => https://profile.line-scdn.net/0hW78izwMHCBgFEBj400B3TzlVBnVyPg5QfXJGfCJEV38vcBtLMX8XeSYSAXwrI01OaiJCdiJFVi98
)

[2025-06-01 22:09:02] [INFO] トークン検証成功: ユーザーID U94063df81ada7ad734bc6f999aa58d2a
[2025-06-01 22:09:02] [INFO] IDトークン検証成功: userId=U94063df81ada7ad734bc6f999aa58d2a
[2025-06-01 22:09:02] [INFO] データベース接続を開始します
[2025-06-01 22:09:02] [INFO] データベース接続成功
[2025-06-01 22:09:02] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-01 22:09:02] [INFO] line_room_linksテーブルが存在します
[2025-06-01 22:09:02] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-01 22:09:02] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-01 22:09:02] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=247 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-01 22:09:02] [INFO] line_room_linksテーブルのレコード数: 3
[2025-06-01 22:09:02] [INFO] 最新のレコード: {"id":246,"line_user_id":"U94063df81ada7ad734bc6f999aa58d2a","room_number":"fg#09","order_session_id":null,"user_name":"\u5357\u96f2","check_in_date":"2025-06-01","check_out_date":"2025-06-02","access_token":null,"is_active":1,"created_at":"2025-06-01 22:08:40","updated_at":"2025-06-01 22:08:40"}
[2025-06-01 22:09:02] [INFO] トランザクション開始
[2025-06-01 22:09:02] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-01 22:09:02] [DEBUG] パラメータバインド: roomNumber=fg#09
[2025-06-01 22:09:02] [INFO] 部屋検索クエリ実行完了
[2025-06-01 22:09:02] [INFO] 部屋検索結果: 部屋あり ID=9, アクティブ=1
[2025-06-01 22:09:02] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-01 22:09:02] [DEBUG] パラメータバインド: userId=U94063df81ada7ad734bc6f999aa58d2a
[2025-06-01 22:09:02] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-01 22:09:02] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-01 22:09:02] [INFO] 有効な登録ID: 246, チェックアウト日: 2025-06-02
[2025-06-01 22:09:02] [DEBUG] 既存登録非アクティブ化SQL: 
                UPDATE line_room_links
                SET is_active = 0
                WHERE line_user_id = :userId
            
[2025-06-01 22:09:02] [INFO] 非アクティブ化した登録数: 1
[2025-06-01 22:09:02] [DEBUG] 更新SQL: 
                UPDATE line_room_links 
                SET room_number = :roomNumber,
                    user_name = :userName,
                    check_in_date = :checkInDate,
                    check_out_date = :checkOutDate,
                    is_active = 1
                WHERE id = :id
            
[2025-06-01 22:09:02] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-01 22:09:02] [DEBUG] DateTimeを文字列に変換（更新処理）: checkIn=2025-06-01, checkOut=2025-06-02
[2025-06-01 22:09:02] [DEBUG] パラメータバインド: id=246, roomNumber=fg#09, userName=南雲, checkInDate=2025-06-01, checkOutDate=2025-06-02
[2025-06-01 22:09:02] [INFO] 更新クエリ実行完了: 成功
[2025-06-01 22:09:02] [INFO] 既存登録を更新: id=246
[2025-06-01 22:09:02] [INFO] トランザクションコミット成功
[2025-06-01 22:09:02] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":246,"registration_type":"update"}
[2025-06-01 22:09:02] [INFO] JSONレスポンスを送信完了
[2025-06-01 22:09:02] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号情報が更新されました","registration_id":246,"registration_type":"update"}
2025-06-01 22:09:02 - ユーザーID: U94063df81ada7ad734bc6f999aa58d2a - 部屋番号更新 - 部屋: fg#09 - 期間: 2025-06-01 から 2025-06-02
[2025-06-01 22:09:02] [DEBUG] 出力バッファに164バイトのデータがあります
[2025-06-01 22:09:02] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f","registration_id":246,"registration_type":"update"}
[2025-06-01 22:09:02] [DEBUG] 出力バッファをフラッシュします
[2025-06-01 22:09:02] [INFO] 処理完了
[2025-06-04 16:46:38] [INFO] --- 登録API処理開始 ---
[2025-06-04 16:46:38] [INFO] リクエスト元IPアドレス: 222.224.253.151
[2025-06-04 16:46:38] [INFO] --- 登録API処理開始 ---
[2025-06-04 16:46:38] [INFO] リクエスト元IPアドレス: 222.224.253.151
[2025-06-04 16:46:38] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiJlNmE2OTE5Mzg2MTY5YmE1NGRlOWRkMzM2YjQxNDc5YTAxMDEyZGMwYzQyOGJhYWUyZGUxOGU1OWVlMjE0NmRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWI2OTFhZDZkOTgzNmM4MjVmMGQyMWI3MTMyNDQzMTlmIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0OTAyNjc3NCwiaWF0IjoxNzQ5MDIzMTc0LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi5Zac55Sw5LiA5oiQKOOBquOCi-OBjOOBvykiLCJwaWN0dXJlIjoiaHR0cHM6Ly9wcm9maWxlLmxpbmUtc2Nkbi5uZXQvMG0wMDQ3OWJmODcyNTExZjQzMTBlODAzZDM1NDA5Zjk0Y2RkMzhjNTZiMTE2MSJ9.cigd0uqIIntkE3Rjb_YsFxQn7MD9wpIqZtPwfAIQYKbjBQgHuQ7mMnYjPoiZ0hP6mKUewxOQSw9yK5TuMeX2qg","room_number":"fg#04","user_name":"喜田一成","check_in":"2025-06-04","check_out":"2025-06-05","check_out_time":"10:00"}
[2025-06-04 16:46:38] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiJlNmE2OTE5Mzg2MTY5YmE1NGRlOWRkMzM2YjQxNDc5YTAxMDEyZGMwYzQyOGJhYWUyZGUxOGU1OWVlMjE0NmRiIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVWI2OTFhZDZkOTgzNmM4MjVmMGQyMWI3MTMyNDQzMTlmIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0OTAyNjc3NCwiaWF0IjoxNzQ5MDIzMTc0LCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi5Zac55Sw5LiA5oiQKOOBquOCi-OBjOOBvykiLCJwaWN0dXJlIjoiaHR0cHM6Ly9wcm9maWxlLmxpbmUtc2Nkbi5uZXQvMG0wMDQ3OWJmODcyNTExZjQzMTBlODAzZDM1NDA5Zjk0Y2RkMzhjNTZiMTE2MSJ9.cigd0uqIIntkE3Rjb_YsFxQn7MD9wpIqZtPwfAIQYKbjBQgHuQ7mMnYjPoiZ0hP6mKUewxOQSw9yK5TuMeX2qg
    [room_number] => fg#04
    [user_name] => 喜田一成
    [check_in] => 2025-06-04
    [check_out] => 2025-06-05
    [check_out_time] => 10:00
)

[2025-06-04 16:46:38] [INFO] forceフラグ: false
[2025-06-04 16:46:38] [INFO] 処理パラメータ: room=fg#04, user=喜田一成, checkIn=2025-06-04, checkOut=2025-06-05
[2025-06-04 16:46:38] [INFO] IDトークンを検証: eyJraWQiOiJlNmE2OTE5...
[2025-06-04 16:46:38] [DEBUG] トークン検証開始: eyJraWQiOiJlNmE2OTE5...
[2025-06-04 16:46:38] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => Ub691ad6d9836c825f0d21b713244319f
    [aud] => 2007363986
    [exp] => 1749026774
    [iat] => 1749023174
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => 喜田一成(なるがみ)
    [picture] => https://profile.line-scdn.net/0m00479bf872511f4310e803d35409f94cdd38c56b1161
)

[2025-06-04 16:46:38] [INFO] トークン検証成功: ユーザーID Ub691ad6d9836c825f0d21b713244319f
[2025-06-04 16:46:38] [INFO] IDトークン検証成功: userId=Ub691ad6d9836c825f0d21b713244319f
[2025-06-04 16:46:38] [INFO] データベース接続を開始します
[2025-06-04 16:46:38] [INFO] データベース接続成功
[2025-06-04 16:46:38] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-04 16:46:38] [INFO] line_room_linksテーブルが存在します
[2025-06-04 16:46:38] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-04 16:46:38] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-04 16:46:38] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=247 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-04 16:46:38] [INFO] line_room_linksテーブルのレコード数: 3
[2025-06-04 16:46:38] [INFO] 最新のレコード: {"id":246,"line_user_id":"U94063df81ada7ad734bc6f999aa58d2a","room_number":"fg#09","order_session_id":null,"user_name":"\u5357\u96f2","check_in_date":"2025-06-01","check_out_date":"2025-06-02","access_token":null,"is_active":1,"created_at":"2025-06-01 22:08:40","updated_at":"2025-06-01 22:09:02"}
[2025-06-04 16:46:38] [INFO] トランザクション開始
[2025-06-04 16:46:38] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-04 16:46:38] [DEBUG] パラメータバインド: roomNumber=fg#04
[2025-06-04 16:46:38] [INFO] 部屋検索クエリ実行完了
[2025-06-04 16:46:38] [INFO] 部屋検索結果: 部屋あり ID=4, アクティブ=1
[2025-06-04 16:46:38] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-04 16:46:38] [DEBUG] パラメータバインド: userId=Ub691ad6d9836c825f0d21b713244319f
[2025-06-04 16:46:38] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-04 16:46:38] [INFO] ユーザー全登録検索結果: 0件の登録あり
[2025-06-04 16:46:38] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-04 16:46:38] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-04 16:46:38] [DEBUG] プリペアドステートメント作成成功
[2025-06-04 16:46:38] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-04, checkOut=2025-06-05
[2025-06-04 16:46:38] [DEBUG] パラメータバインド完了: userId=Ub691ad6d9836c825f0d21b713244319f, roomNumber=fg#04, userName=喜田一成, checkInDate=2025-06-04, checkOutDate=2025-06-05
[2025-06-04 16:46:38] [INFO] SQLを実行します
[2025-06-04 16:46:38] [DEBUG] 挿入予定の値: {"line_user_id":"Ub691ad6d9836c825f0d21b713244319f","room_number":"fg#04","user_name":"\u559c\u7530\u4e00\u6210","check_in_date":"2025-06-04","check_out_date":"2025-06-05"}
[2025-06-04 16:46:38] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-04 16:46:38] [DEBUG] 直接クエリ実行結果: 成功
[2025-06-04 16:46:38] [INFO] 直接クエリで新規登録ID: 247
[2025-06-04 16:46:38] [INFO] トランザクションコミット成功
[2025-06-04 16:46:38] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"247","registration_type":"new"}
[2025-06-04 16:46:38] [INFO] JSONレスポンスを送信完了
[2025-06-04 16:46:38] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に登録されました","registration_id":"247","registration_type":"new"}
2025-06-04 16:46:38 - ユーザーID: Ub691ad6d9836c825f0d21b713244319f - 部屋番号新規登録 - 部屋: fg#04 - 期間: 2025-06-04 から 2025-06-05
[2025-06-04 16:46:38] [DEBUG] 出力バッファに169バイトのデータがあります
[2025-06-04 16:46:38] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"247","registration_type":"new"}
[2025-06-04 16:46:38] [DEBUG] 出力バッファをフラッシュします
[2025-06-04 16:46:38] [INFO] 処理完了
[2025-06-04 21:03:32] [INFO] --- 登録API処理開始 ---
[2025-06-04 21:03:32] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-04 21:03:32] [INFO] --- 登録API処理開始 ---
[2025-06-04 21:03:32] [INFO] リクエスト元IPアドレス: 180.25.136.184
[2025-06-04 21:03:32] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiIyNmNmMzk1ZjQ4MTYyZTRhMzc3MzM5Yjk1MjBjNzA2NzI5ZTFmZGMzYTY0NWI3YTlhZTc3YWMyYTQ4NzVhODA4IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0OTA0MjIwMSwiaWF0IjoxNzQ5MDM4NjAxLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.UWqNeF3CrdGtQBLHXWo8ZS4hfjrD01f9fUXma3Y6xGY-G0sf6kPSzaCHJyUYSz01KvIaek-JYM0yXfoYVA1OsQ","room_number":"fg#12","user_name":"くらひで","check_in":"2025-06-04","check_out":"2025-06-05","check_out_time":"11:00"}
[2025-06-04 21:03:32] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiIyNmNmMzk1ZjQ4MTYyZTRhMzc3MzM5Yjk1MjBjNzA2NzI5ZTFmZGMzYTY0NWI3YTlhZTc3YWMyYTQ4NzVhODA4IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTRkNzc3NjE0MTU4YzcxOTUxNWE3YmU5MWE0MWJjMzgyIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0OTA0MjIwMSwiaWF0IjoxNzQ5MDM4NjAxLCJhbXIiOlsibGluZWF1dG9sb2dpbiJdLCJuYW1lIjoi44GP44KJ44Gy44GnIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBob1AwR09NcEpNSDhOUGhoSS11NVBLREY3UGhKNkVEWTNkUXQzSFNGc2FFb29YU0FnWTFsX0hTZy1QaDhoQ0NNdllnb3RIaWctYUI5MSJ9.UWqNeF3CrdGtQBLHXWo8ZS4hfjrD01f9fUXma3Y6xGY-G0sf6kPSzaCHJyUYSz01KvIaek-JYM0yXfoYVA1OsQ
    [room_number] => fg#12
    [user_name] => くらひで
    [check_in] => 2025-06-04
    [check_out] => 2025-06-05
    [check_out_time] => 11:00
)

[2025-06-04 21:03:32] [INFO] forceフラグ: false
[2025-06-04 21:03:32] [INFO] 処理パラメータ: room=fg#12, user=くらひで, checkIn=2025-06-04, checkOut=2025-06-05
[2025-06-04 21:03:32] [INFO] IDトークンを検証: eyJraWQiOiIyNmNmMzk1...
[2025-06-04 21:03:32] [DEBUG] トークン検証開始: eyJraWQiOiIyNmNmMzk1...
[2025-06-04 21:03:32] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U4d777614158c719515a7be91a41bc382
    [aud] => 2007363986
    [exp] => 1749042201
    [iat] => 1749038601
    [amr] => Array
        (
            [0] => lineautologin
        )

    [name] => くらひで
    [picture] => https://profile.line-scdn.net/0hoP0GOMpJMH8NPhhI-u5PKDF7PhJ6EDY3dQt3HSFsaEooXSAgY1l_HSg-Ph8hCCMvYgotHig-aB91
)

[2025-06-04 21:03:32] [INFO] トークン検証成功: ユーザーID U4d777614158c719515a7be91a41bc382
[2025-06-04 21:03:32] [INFO] IDトークン検証成功: userId=U4d777614158c719515a7be91a41bc382
[2025-06-04 21:03:32] [INFO] データベース接続を開始します
[2025-06-04 21:03:32] [INFO] データベース接続成功
[2025-06-04 21:03:32] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-04 21:03:32] [INFO] line_room_linksテーブルが存在します
[2025-06-04 21:03:32] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-04 21:03:32] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-04 21:03:32] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=248 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-04 21:03:32] [INFO] line_room_linksテーブルのレコード数: 4
[2025-06-04 21:03:32] [INFO] 最新のレコード: {"id":247,"line_user_id":"Ub691ad6d9836c825f0d21b713244319f","room_number":"fg#04","order_session_id":"250604165449601312435","user_name":"\u559c\u7530\u4e00\u6210","check_in_date":"2025-06-04","check_out_date":"2025-06-05","access_token":null,"is_active":1,"created_at":"2025-06-04 16:46:38","updated_at":"2025-06-04 16:54:49"}
[2025-06-04 21:03:32] [INFO] トランザクション開始
[2025-06-04 21:03:32] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-04 21:03:32] [DEBUG] パラメータバインド: roomNumber=fg#12
[2025-06-04 21:03:32] [INFO] 部屋検索クエリ実行完了
[2025-06-04 21:03:32] [INFO] 部屋検索結果: 部屋あり ID=12, アクティブ=1
[2025-06-04 21:03:32] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-04 21:03:32] [DEBUG] パラメータバインド: userId=U4d777614158c719515a7be91a41bc382
[2025-06-04 21:03:32] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-04 21:03:32] [INFO] ユーザー全登録検索結果: 1件の登録あり
[2025-06-04 21:03:32] [INFO] 部屋変更要求を検出: 旧=fg#11 新=fg#12
[2025-06-04 21:03:32] [INFO] 未払いセッション件数: 2
[2025-06-04 21:03:32] [ERROR] 通常例外発生でロールバック: 未払いの注文が残っているため部屋変更はできません
[2025-06-04 21:03:32] [ERROR] スタックトレース: #0 {main}
[2025-06-04 21:03:32] [ERROR] 処理中に例外が発生: 未払いの注文が残っているため部屋変更はできません
[2025-06-04 21:03:32] [ERROR] スタックトレース: #0 {main}
[2025-06-04 21:03:32] [INFO] エラーレスポンスを返します: {"error":"\u672a\u6255\u3044\u306e\u6ce8\u6587\u304c\u6b8b\u3063\u3066\u3044\u308b\u305f\u3081\u90e8\u5c4b\u5909\u66f4\u306f\u3067\u304d\u307e\u305b\u3093"}
[2025-06-04 21:03:32] [INFO] エラーJSONレスポンスを送信完了
[2025-06-04 21:03:32] [INFO] クライアントに送信したエラーレスポンス内容: {"error":"未払いの注文が残っているため部屋変更はできません"}
[2025-06-04 21:03:32] [DEBUG] 出力バッファに156バイトのデータがあります
[2025-06-04 21:03:32] [DEBUG] バッファの内容: {"error":"\u672a\u6255\u3044\u306e\u6ce8\u6587\u304c\u6b8b\u3063\u3066\u3044\u308b\u305f\u3081\u90e8\u5c4b\u5909\u66f4\u306f\u3067\u304d\u307e\u305b\u3093"}
[2025-06-04 21:03:32] [DEBUG] 出力バッファをフラッシュします
[2025-06-04 21:03:32] [INFO] 処理完了
[2025-06-06 12:21:07] [INFO] --- 登録API処理開始 ---
[2025-06-06 12:21:07] [INFO] リクエスト元IPアドレス: 124.45.160.90
[2025-06-06 12:21:07] [INFO] --- 登録API処理開始 ---
[2025-06-06 12:21:07] [INFO] リクエスト元IPアドレス: 124.45.160.90
[2025-06-06 12:21:07] [DEBUG] 受信POSTデータ: {"token":"eyJraWQiOiI3ZjMxMTU5YTY1YWE0YmYxZGRmMzQyYjU3MTcwZGQ3NDY3ZTkyZDEyZTg0YzI0Y2EyMGUxNDQyNTUzYjNmMDhjIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTA5YWUyZGVmYzcwZmFmN2Y4ODcyMTQwMTQ0NjEwMmVkIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0OTE4MzY0MCwiaWF0IjoxNzQ5MTgwMDQwLCJuYW1lIjoi44KG44GL44KKIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBtMDE4MTkzYzg3MjUxNmJiOGQyMTI4M2E2OGE5OTcxYjhmMmExOTE5MjRiZTIifQ.p2HQk6cMTkBFkWAhwLldwC0qD_V_oKmrLwUjBPEpw8mABTvHL7CGhOY-Yg9XqxHxZnZeldb1X57Jw8YL4mE3Vw","room_number":"fg#12","user_name":"ゆかり","check_in":"2025-06-06","check_out":"2025-06-07","check_out_time":"11:00"}
[2025-06-06 12:21:07] [DEBUG] デコードされたデータ: Array
(
    [token] => eyJraWQiOiI3ZjMxMTU5YTY1YWE0YmYxZGRmMzQyYjU3MTcwZGQ3NDY3ZTkyZDEyZTg0YzI0Y2EyMGUxNDQyNTUzYjNmMDhjIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lIiwic3ViIjoiVTA5YWUyZGVmYzcwZmFmN2Y4ODcyMTQwMTQ0NjEwMmVkIiwiYXVkIjoiMjAwNzM2Mzk4NiIsImV4cCI6MTc0OTE4MzY0MCwiaWF0IjoxNzQ5MTgwMDQwLCJuYW1lIjoi44KG44GL44KKIiwicGljdHVyZSI6Imh0dHBzOi8vcHJvZmlsZS5saW5lLXNjZG4ubmV0LzBtMDE4MTkzYzg3MjUxNmJiOGQyMTI4M2E2OGE5OTcxYjhmMmExOTE5MjRiZTIifQ.p2HQk6cMTkBFkWAhwLldwC0qD_V_oKmrLwUjBPEpw8mABTvHL7CGhOY-Yg9XqxHxZnZeldb1X57Jw8YL4mE3Vw
    [room_number] => fg#12
    [user_name] => ゆかり
    [check_in] => 2025-06-06
    [check_out] => 2025-06-07
    [check_out_time] => 11:00
)

[2025-06-06 12:21:07] [INFO] forceフラグ: false
[2025-06-06 12:21:07] [INFO] 処理パラメータ: room=fg#12, user=ゆかり, checkIn=2025-06-06, checkOut=2025-06-07
[2025-06-06 12:21:07] [INFO] IDトークンを検証: eyJraWQiOiI3ZjMxMTU5...
[2025-06-06 12:21:07] [DEBUG] トークン検証開始: eyJraWQiOiI3ZjMxMTU5...
[2025-06-06 12:21:07] [DEBUG] トークンペイロード: Array
(
    [iss] => https://access.line.me
    [sub] => U09ae2defc70faf7f88721401446102ed
    [aud] => 2007363986
    [exp] => 1749183640
    [iat] => 1749180040
    [name] => ゆかり
    [picture] => https://profile.line-scdn.net/0m018193c872516bb8d21283a68a9971b8f2a191924be2
)

[2025-06-06 12:21:07] [INFO] トークン検証成功: ユーザーID U09ae2defc70faf7f88721401446102ed
[2025-06-06 12:21:07] [INFO] IDトークン検証成功: userId=U09ae2defc70faf7f88721401446102ed
[2025-06-06 12:21:07] [INFO] データベース接続を開始します
[2025-06-06 12:21:07] [INFO] データベース接続成功
[2025-06-06 12:21:07] [INFO] line_room_linksテーブルの構造を確認します
[2025-06-06 12:21:07] [INFO] line_room_linksテーブルが存在します
[2025-06-06 12:21:07] [INFO] line_room_linksテーブルのカラム構造: id (int, NULL: NO, Default: NULL), line_user_id (varchar(255), NULL: NO, Default: NULL), room_number (varchar(20), NULL: YES, Default: NULL), order_session_id (char(21), NULL: YES, Default: NULL), user_name (varchar(255), NULL: YES, Default: NULL), check_in_date (date, NULL: YES, Default: NULL), check_out_date (date, NULL: YES, Default: NULL), access_token (varchar(64), NULL: YES, Default: NULL), is_active (tinyint(1), NULL: YES, Default: 1), created_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP), updated_at (timestamp, NULL: YES, Default: CURRENT_TIMESTAMP)
[2025-06-06 12:21:07] [INFO] line_room_linksテーブルのインデックス: PRIMARY: id (UNIQUE), line_user_id: line_user_id (UNIQUE), line_user_id_2: line_user_id, room_number: room_number, access_token: access_token, order_session_id: order_session_id
[2025-06-06 12:21:07] [DEBUG] line_room_linksテーブルのCREATE文: CREATE TABLE `line_room_links` (
  `id` int NOT NULL AUTO_INCREMENT,
  `line_user_id` varchar(255) NOT NULL,
  `room_number` varchar(20) DEFAULT NULL,
  `order_session_id` char(21) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `check_in_date` date DEFAULT NULL,
  `check_out_date` date DEFAULT NULL,
  `access_token` varchar(64) DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `line_user_id` (`line_user_id`),
  KEY `line_user_id_2` (`line_user_id`),
  KEY `room_number` (`room_number`),
  KEY `access_token` (`access_token`),
  KEY `order_session_id` (`order_session_id`)
) ENGINE=InnoDB AUTO_INCREMENT=248 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
[2025-06-06 12:21:07] [INFO] line_room_linksテーブルのレコード数: 4
[2025-06-06 12:21:07] [INFO] 最新のレコード: {"id":247,"line_user_id":"Ub691ad6d9836c825f0d21b713244319f","room_number":"fg#04","order_session_id":"250604165449601312435","user_name":"\u559c\u7530\u4e00\u6210","check_in_date":"2025-06-04","check_out_date":"2025-06-05","access_token":null,"is_active":0,"created_at":"2025-06-04 16:46:38","updated_at":"2025-06-05 10:20:45"}
[2025-06-06 12:21:07] [INFO] トランザクション開始
[2025-06-06 12:21:07] [DEBUG] 部屋存在確認SQL: 
            SELECT id, is_active 
            FROM roomdatasettings 
            WHERE room_number = :roomNumber
        
[2025-06-06 12:21:07] [DEBUG] パラメータバインド: roomNumber=fg#12
[2025-06-06 12:21:07] [INFO] 部屋検索クエリ実行完了
[2025-06-06 12:21:07] [INFO] 部屋検索結果: 部屋あり ID=12, アクティブ=1
[2025-06-06 12:21:07] [DEBUG] ユーザー全登録確認SQL: 
            SELECT id, room_number, is_active, check_out_date 
            FROM line_room_links 
            WHERE line_user_id = :userId
        
[2025-06-06 12:21:07] [DEBUG] パラメータバインド: userId=U09ae2defc70faf7f88721401446102ed
[2025-06-06 12:21:07] [INFO] ユーザー全登録検索クエリ実行完了
[2025-06-06 12:21:07] [INFO] ユーザー全登録検索結果: 0件の登録あり
[2025-06-06 12:21:07] [DEBUG] 挿入SQL: 
                INSERT INTO line_room_links 
                (line_user_id, room_number, user_name, check_in_date, check_out_date, is_active)
                VALUES 
                (:userId, :roomNumber, :userName, :checkInDate, :checkOutDate, 1)
            
[2025-06-06 12:21:07] [DEBUG] line_room_linksテーブルのカラム: id, line_user_id, room_number, order_session_id, user_name, check_in_date, check_out_date, access_token, is_active, created_at, updated_at
[2025-06-06 12:21:07] [DEBUG] プリペアドステートメント作成成功
[2025-06-06 12:21:07] [DEBUG] DateTimeを文字列に変換: checkIn=2025-06-06, checkOut=2025-06-07
[2025-06-06 12:21:07] [DEBUG] パラメータバインド完了: userId=U09ae2defc70faf7f88721401446102ed, roomNumber=fg#12, userName=ゆかり, checkInDate=2025-06-06, checkOutDate=2025-06-07
[2025-06-06 12:21:07] [INFO] SQLを実行します
[2025-06-06 12:21:07] [DEBUG] 挿入予定の値: {"line_user_id":"U09ae2defc70faf7f88721401446102ed","room_number":"fg#12","user_name":"\u3086\u304b\u308a","check_in_date":"2025-06-06","check_out_date":"2025-06-07"}
[2025-06-06 12:21:07] [DEBUG] 直接クエリ実行を試みます（テスト用）
[2025-06-06 12:21:07] [DEBUG] 直接クエリ実行結果: 成功
[2025-06-06 12:21:07] [INFO] 直接クエリで新規登録ID: 248
[2025-06-06 12:21:07] [INFO] トランザクションコミット成功
[2025-06-06 12:21:07] [INFO] 成功レスポンス: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"248","registration_type":"new"}
[2025-06-06 12:21:07] [INFO] JSONレスポンスを送信完了
[2025-06-06 12:21:07] [INFO] クライアントに送信したレスポンス内容: {"success":true,"message":"部屋番号が正常に登録されました","registration_id":"248","registration_type":"new"}
2025-06-06 12:21:07 - ユーザーID: U09ae2defc70faf7f88721401446102ed - 部屋番号新規登録 - 部屋: fg#12 - 期間: 2025-06-06 から 2025-06-07
[2025-06-06 12:21:07] [DEBUG] 出力バッファに169バイトのデータがあります
[2025-06-06 12:21:07] [DEBUG] バッファの内容: {"success":true,"message":"\u90e8\u5c4b\u756a\u53f7\u304c\u6b63\u5e38\u306b\u767b\u9332\u3055\u308c\u307e\u3057\u305f","registration_id":"248","registration_type":"new"}
[2025-06-06 12:21:07] [DEBUG] 出力バッファをフラッシュします
[2025-06-06 12:21:07] [INFO] 処理完了
