# LacisMobileOrderシステム実装報告書

## システム概要確認

LacisMobileOrderシステムは、LINEを活用したモバイルオーダーシステムで、Squareと連携して商品管理や注文処理を行うシステムです。システムのフローは以下の通りです：

1. ゲストがLINE公式アカウントを友だち追加
2. ゲストが部屋番号を入力し、アクセストークンを取得
3. モバイルアプリで商品を閲覧・注文
4. 注文情報がSquareに送信され、同時にデータベースに保存
5. 注文完了通知がLINEで送信
6. スタッフがSquare POSで注文を確認・処理

## 実装状況

現在の実装状況を確認したところ、基本的な機能は実装されています：

- APIエンドポイント（/api/v1/index.php）
- Square連携サービス（SquareService.php）
- LINE連携サービス（LineService.php）
- 商品管理サービス（ProductService.php）
- 注文管理サービス（OrderService.php）
- Square Webhook処理（/api/webhook/square.php）

## Square連携に関する懸念点

Square連携について詳細に分析したところ、以下の懸念点が見つかりました：

### 1. 在庫管理の二重処理リスク

`OrderService.php`の実装を確認したところ、注文作成時に以下のコードがコメントアウトされています：

```php
// 在庫を減らす（オプション）
// 注意: Square APIでは通常、注文が COMPLETED 状態になった時点で
// 自動的に在庫が減少します。ここで在庫を手動で減らすと、
// 二重に在庫が減少する可能性があります。
// $productService->updateStock($item['square_item_id'], $product['stock_quantity'] - $item['quantity']);
```

コメントの指摘通り、Square APIは注文完了時に自動的に在庫を減らす機能があります。このコメントアウトは適切ですが、以下の点に注意が必要です：

- Square側で在庫自動減少が有効になっているか確認が必要
- 在庫減少タイミングが「注文作成時」か「決済完了時」かによってフローが変わる

### 2. Square API連携のエラーハンドリング

SquareService.phpではAPI呼び出し時の例外処理が実装されていますが、以下の点に懸念があります：

- エラー発生時のリトライ処理が実装されていない
- Square APIのレート制限に対する対応が明示されていない
- APIダウン時の代替処理（フォールバックロジック）がない

### 3. Webhookの安定性と信頼性

Square Webhookを使用して在庫更新やカタログ更新を同期していますが：

- Webhookの受信失敗時のリカバリーメカニズムがない
- Webhookイベントの重複処理防止策が明示されていない
- `validateWebhookSignature`メソッドは実装されているが、タイムスタンプの検証（リプレイアタック対策）が不十分

### 4. メタデータフィルタリングの互換性問題

`searchOrdersByRoom`メソッドに以下のコードがあります：

```php
// メタデータフィルターを追加（Square APIバージョンによっては異なる場合があります）
if (method_exists($orderApi, 'searchOrdersWithMetadata')) {
    $body['query']['filter']['metadata'] = [
        'room_number' => $roomNumber
    ];
}
```

このコードはSquare APIバージョンによる互換性問題に対応しようとしていますが：

- `searchOrdersWithMetadata`メソッドの存在確認は実際のSquare SDKの実装に依存するため、正確ではない可能性
- Square APIの更新によりこのロジックが機能しなくなるリスク

### 5. 同期処理の実装

`sync.html`ページとAPIエンドポイントにより商品同期機能が実装されていますが：

- 同期処理が単一リクエストで行われており、大量データ処理時にタイムアウトするリスク
- バックグラウンドジョブやキューイングシステムが使用されていない
- 同期の進捗状況をリアルタイムで確認する機能がない

### 6. トランザクション分離レベル

注文作成処理でトランザクションを使用していますが：

- トランザクション分離レベルが明示的に設定されていない
- 同時実行時の競合状態（特に在庫数）への対策が不十分

## 改善提案

### 1. 在庫管理の明確化

- Square側の在庫減少設定を確認し、ドキュメント化
- 必要に応じて在庫同期バッチ処理を実装して不整合を定期的に修正

### 2. エラーハンドリングの強化

- 重要なAPI呼び出しにリトライメカニズムを実装
- レート制限への対応（指数バックオフなど）を追加
- 障害時の代替フローを実装

### 3. Webhook処理の改善

- Webhookイベントをキューに格納してから非同期処理
- 重複イベント検出のためのイベントIDログを実装
- Webhookのセキュリティ強化（タイムスタンプ検証など）

### 4. Square APIバージョン対応

- 使用しているSquare SDKのバージョンを明確に管理
- APIの互換性チェックを自動テストに含める
- 将来のAPI変更に備えたアダプターパターンの検討

### 5. 同期処理の最適化

- 大量データ同期用のバッチ処理実装
- 進捗表示機能の追加
- 定期的な自動同期の実装

### 6. トランザクション管理の改善

- 適切なトランザクション分離レベルの設定
- 競合状態を検出・解決するロジックの追加

## 結論

LacisMobileOrderシステムは基本機能は実装されていますが、Square連携に関して上記の懸念点があります。特に在庫管理、エラーハンドリング、Webhookの信頼性について重点的な改善が推奨されます。これらの改善により、システムの安定性と信頼性が向上し、ユーザー体験が改善されるでしょう。
