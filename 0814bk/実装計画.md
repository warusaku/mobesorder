# LacisMobileOrderシステム実装計画書

**【絶対命令】**
- 実装者は毎回この実装計画書を参照すること
- 実装過程において、内容修正が発生した項目や計画変更が必要な項目について、必ず都度この計画書を修正すること
- 新たなPHPモジュールを作成・実装した場合は、テスト用フロントエンドの修正も必要であることを認識し対応すること
- 実装を始める前に必ず C:\Users\yu001\OneDrive\デスクトップ\MobileOrder 内の実装状況を確認してから作業を行うこと
- すべてのテストや実装においてモックやダミーを絶対に使用せず、実際のテストを実施すること

## 開発概要

本システムは、LINE Front-end Framework（LIFF）を使用したモバイルオーダーシステムである。宿泊施設の利用者がLINEアプリからルームサービスの注文を行い、チェックアウト時に一括精算できる仕組みを提供する。

### 構築の目的
- リッチメニューからモバイルオーダーへのリンクを設置し、手軽に注文できる環境を提供
- 部屋番号ごとに注文を管理し、利用者に部屋番号を手入力させずに済むようにする
- ログイン画面を実装せず、LINE認証のみで使用できるようにして離脱率を低減する
- チェックアウト後のリンク悪用防止のセキュリティ対策を実装する

### システム全体像
1. Squareから商品情報を取得しモバイルオーダーで表示
2. 注文データを保留会計として部屋番号に紐づけてデータベースで管理
3. チェックアウト時に保留会計をまとめてSquareで支払い処理

## フェーズ0: テスト用フロントエンド開発（最優先）

システム実装に先立ち、テスト環境の整備を最優先で行います。ロリポップ環境ではサーバーエラーログの詳細確認が困難なため、開発効率向上のためのテスト用フロントエンドを先行開発します。

### ステップ0.1: テストダッシュボード設計と実装
- 管理者認証機能を持つテスト用ダッシュボードの作成
- 以下のテスト機能を統合した俯瞰的な管理画面の構築:
  - 単体テスト実行・結果表示
  - 機能別結合テスト実行・結果表示
  - システム結合テスト実行・結果表示
  - E2Eテスト実行・結果表示
  - テスト履歴の保存と参照機能

### ステップ0.2: ログとデバッグ機能実装
- PHPログをフロントエンドで閲覧するための機能実装:
  - カスタムログハンドラーの作成
  - ログレベル別フィルタリング機能
  - リアルタイムログ表示機能
- Square API通信ログの詳細記録と表示機能
- ロリポップ環境でのエラーキャプチャとログ保存機能

### ステップ0.3: データベース管理機能
- MySQLデータの閲覧と検索機能:
  - テーブル一覧表示
  - レコード閲覧・検索機能
  - テーブル関連図表示
- 保留伝票データの視覚的表示機能
- Square連携状態の確認機能

### ステップ0.4: テストケース作成
- 各エンドポイントの単体テストケース作成:
  - 認証テスト
  - 商品取得テスト
  - 注文作成テスト
  - 伝票管理テスト
- 機能別結合テストケース作成:
  - LINE連携テスト
  - Square連携テスト
  - 注文フローテスト
- E2Eテストシナリオ作成:
  - 顧客注文シナリオ
  - スタッフ管理シナリオ
  - チェックアウト処理シナリオ

## フェーズ1: LIFF連携とフロントエンド基盤の構築

### ステップ1.1: LINE開発者コンソール設定
- LINE Developersコンソールでの設定:
  - LINEログインチャネル作成
  - LIFF設定（スコープ：profile）
  - ボットリンク設定
  - エンドポイントURL設定
  - LIFFサイズ設定（Full）

### ステップ1.2: LIFF初期化処理の実装
- LIFF SDKのインテグレーション:
  - CDNパスの指定またはnpmパッケージ使用
  - LIFF初期化処理の実装
  - ユーザー認証フローの実装
  - エラーハンドリング

### ステップ1.3: UI基本フレームワーク実装
- モバイルファーストのレスポンシブデザイン:
  - 画面レイアウト設計実装
  - ヘッダー・フッター実装
  - 左側カテゴリ選択バー実装
  - メインコンテンツ領域実装
  - 右下「注文する」ボタン実装
- カラースキームとスタイルガイドの適用

## フェーズ2: Square保留伝票管理の実装

### ステップ2.1: 保留伝票構造の設計と実装
- Square側で各客室に対応する保留伝票テンプレートを作成
- DBにroom_ticketsテーブルを作成し、部屋番号とSquare伝票IDを関連付け
- SquareServiceに保留伝票管理メソッドを追加：
  - `createRoomTicket(roomNumber)`: 部屋用の保留伝票を作成
  - `getRoomTicket(roomNumber)`: 部屋に関連付けられた伝票を取得
  - `addItemToRoomTicket(roomNumber, item)`: 伝票に商品を追加
- 単体テスト: 各メソッドの動作確認とテストケース追加

### ステップ2.2: Webhook処理の拡張
- `order.created`と`order.updated`イベントのハンドラーを実装
- 保留伝票の状態変更を検知・同期する処理を追加
- 既存のWebhook処理を修正してイベントの重複チェックを実装
- テスト: Webhookエミュレーターを使用した結合テスト

## フェーズ3: モバイルオーダーフロントエンド実装

### ステップ3.1: 商品表示・カテゴリ機能実装
- カテゴリ選択バーの機能実装:
  - 垂直スクロール可能なカテゴリリスト
  - カテゴリ選択によるフィルタリング
  - 選択中カテゴリのハイライト表示
- 商品カード表示の実装:
  - 商品画像・名前・価格・説明の表示
  - 在庫状況の表示
  - 数量選択機能（+/-ボタン）
  - カートに追加ボタン実装

### ステップ3.2: カート機能実装
- カートデータ管理:
  - LocalStorageを活用した一時保存機能
  - カート内商品追加・削除機能
  - 数量変更機能
  - 合計金額リアルタイム計算機能
- 注文ボタン実装:
  - 右下に固定表示
  - カート内商品がある場合のみ有効化
  - タップ時のカート確認画面表示

### ステップ3.3: 注文確定画面実装
- カート内容確認画面:
  - 注文商品一覧表示
  - 各商品の数量変更・削除機能
  - 合計金額表示（税込）
  - 備考入力欄
  - 「注文を確定する」ボタン
  - 「戻る」ボタン
- 注文確定処理:
  - 注文データのAPI送信
  - 確定時のローディング表示
  - 確定完了/エラー表示

### ステップ3.4: 注文履歴画面実装
- 注文履歴機能:
  - 当日の注文履歴一覧表示
  - 各注文の詳細表示機能
  - 注文状況表示（準備中/配達中/完了）
  - 合計金額表示
- 状態更新機能:
  - 定期的な状態更新チェック
  - プッシュ通知対応（可能な場合）

## フェーズ4: モバイルオーダーフローの修正

### ステップ4.1: 注文処理の修正
- `OrderService.php`の`createOrder`メソッドを変更し、既存の保留伝票に追加するロジックに修正
- 在庫管理ロジックを見直し、Square側の自動減少と整合性を取る
- 単体テスト: 注文処理の各ステップのテストケース実装

### ステップ4.2: 注文履歴表示の実装
- 客室ごとの保留伝票内容表示機能の実装
- 注文状況のリアルタイム更新機能の実装
- キャンセルや修正機能の実装
- 結合テスト: 注文フローの一連のテストケース実装

## フェーズ5: LINE連携の最適化

### ステップ5.1: LINEユーザーと部屋紐づけ機能強化
- LINE User IDと部屋番号の紐づけ機能強化:
  - フロントデスクでのQRコード提供
  - LINEメッセージでの部屋番号紐づけ
  - 紐づけ解除処理の自動化
- セキュリティ強化:
  - トークン管理の最適化
  - 不正アクセス防止機能の実装

### ステップ5.2: LINE通知機能拡張
- 注文確認通知のテンプレート改善
- 注文状況変更通知の実装
- チェックアウト前の注文一覧通知機能の実装
- 単体テスト: 各通知テンプレートのテスト

## フェーズ6: チェックアウト処理の実装

### ステップ6.1: チェックアウト連携
- チェックアウト時の保留伝票清算処理の実装
- Square POSでのチェックアウト処理と連携
- 清算完了後のデータクリーンアップ処理
- 結合テスト: チェックアウトフロー全体のテスト

### ステップ6.2: 管理機能実装
- スタッフ向け伝票管理インターフェース実装
- チェックアウト処理の手動実行機能
- エラー時の復旧処理機能
- E2Eテスト: スタッフ操作シナリオのテスト

## フェーズ7: エラー処理と安定性向上

### ステップ7.1: エラーハンドリング強化
- リトライ機構の実装
- エラーログ詳細化と通知システム
- 障害時の代替フロー実装
- 単体テスト: エラー状況のシミュレーションテスト

### ステップ7.2: 同期処理の最適化
- バッチ処理による定期同期の実装
- 大量データ処理の最適化
- キャッシュ機構の導入
- 負荷テスト: 同時多数アクセス時の動作検証

## APIエンドポイント設計

### フロントエンド⇔バックエンド間API

1. **認証・部屋情報取得API**
   - `GET /api/v1/auth`: LINE UserIDから部屋情報取得
   - `POST /api/v1/link`: LINEユーザーと部屋番号の紐づけ

2. **商品関連API**
   - `GET /api/v1/categories`: カテゴリ一覧取得
   - `GET /api/v1/products`: 商品一覧取得
   - `GET /api/v1/products/{id}`: 商品詳細取得

3. **注文関連API**
   - `POST /api/v1/orders`: 注文作成
   - `GET /api/v1/orders`: 注文履歴取得
   - `GET /api/v1/orders/{id}`: 注文詳細取得

4. **カート関連API**
   - `POST /api/v1/cart`: カート内容保存
   - `GET /api/v1/cart`: カート内容取得
   - `DELETE /api/v1/cart`: カート内容クリア

## データベース変更

既存のテーブル構成を活用し、必要に応じて以下のテーブルを修正・追加します。

```sql
-- システムログ管理用テーブル
CREATE TABLE system_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    timestamp DATETIME NOT NULL,
    level VARCHAR(20) NOT NULL,
    context VARCHAR(50) NOT NULL,
    message TEXT NOT NULL,
    INDEX (timestamp),
    INDEX (level),
    INDEX (context)
);

-- テスト実行結果管理用テーブル
CREATE TABLE test_results (
    id INT AUTO_INCREMENT PRIMARY KEY,
    test_type ENUM('UNIT', 'INTEGRATION', 'E2E') NOT NULL,
    test_name VARCHAR(100) NOT NULL,
    status ENUM('PASS', 'FAIL', 'ERROR') NOT NULL,
    message TEXT,
    execution_time FLOAT NOT NULL,
    executed_at DATETIME NOT NULL,
    INDEX (test_type),
    INDEX (status),
    INDEX (executed_at)
);

-- 保留伝票管理用テーブル (既存テーブルが無い場合のみ)
CREATE TABLE IF NOT EXISTS room_tickets (
    id INT AUTO_INCREMENT PRIMARY KEY,
    room_number VARCHAR(20) NOT NULL,
    square_order_id VARCHAR(100) NOT NULL,
    status ENUM('OPEN', 'COMPLETED', 'CANCELED') DEFAULT 'OPEN',
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    checkout_at DATETIME NULL,
    UNIQUE KEY (room_number)
);

-- LINE連携テーブル (既存テーブルが無い場合のみ)
CREATE TABLE IF NOT EXISTS line_room_links (
    id INT AUTO_INCREMENT PRIMARY KEY,
    line_user_id VARCHAR(255) UNIQUE NOT NULL,
    room_number VARCHAR(20),
    access_token VARCHAR(64),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX (line_user_id),
    INDEX (room_number),
    INDEX (access_token)
);

-- Webhookイベント管理用テーブル
CREATE TABLE webhook_events (
    id INT AUTO_INCREMENT PRIMARY KEY,
    event_id VARCHAR(100) NOT NULL,
    event_type VARCHAR(50) NOT NULL,
    processed_at DATETIME NOT NULL,
    UNIQUE KEY (event_id)
);
```

## 実装スケジュール

1. フェーズ0: 1週間（テスト環境の構築）
2. フェーズ1: 1週間（LIFF連携とフロントエンド基盤）
3. フェーズ2: 1週間（Square保留伝票管理）
4. フェーズ3: 2週間（モバイルオーダーフロントエンド）
5. フェーズ4: 1週間（モバイルオーダーフロー修正）
6. フェーズ5: 1週間（LINE連携最適化）
7. フェーズ6: 1週間（チェックアウト処理）
8. フェーズ7: 1週間（エラー処理と安定性向上）

合計: 約2ヶ月

## 注意事項

1. 各フェーズの実装後は必ずテスト用フロントエンドでテストを実施する
2. 新規PHPモジュール作成時はテスト用フロントエンドの対応するテストケースも追加する
3. Square APIの制限とレート制限に注意する
4. 伝票の同期は定期的に行い、不整合を防止する
5. エラー発生時は必ずログを取り、リカバリー手段を用意する
6. セキュリティに配慮し、認証と権限管理を適切に行う
7. 実装の各段階でテストを行い、機能の正常動作を確認する
8. LIFFアプリの制約事項（外部ブラウザでの動作制限など）を考慮する
9. LINE Messaging APIの制限（メッセージ送信上限など）に注意する
10. レスポンシブデザインを徹底し、様々なデバイスでの表示を最適化する

## 開発環境

1. テスト環境のSquare砂場アカウントを使用
2. LINE Developersコンソールでテスト用チャネル作成
3. ステージング環境でホテルスタッフによる実地テスト
4. 本番環境への移行は全機能テスト完了後に実施

## まとめ

本計画書に基づいて実装を進め、LIFFを活用したモバイルオーダーシステムを構築します。左側カテゴリ選択バー、右下「注文する」ボタン、注文履歴と合計金額が確認できる機能を備えた使いやすいインターフェースを提供し、LINE認証による簡便なアクセスと部屋番号との自動紐づけにより、ユーザーにとって使いやすく、スタッフの業務効率化を図るシステムを実現します。

**【再確認】** 実装過程で変更が必要な場合は、必ずこの計画書を更新してください。また、新たなPHPモジュールを追加した場合は、テスト用フロントエンドの更新も必ず行ってください。
