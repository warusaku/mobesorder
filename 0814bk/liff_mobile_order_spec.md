# LIFF モバイルオーダーシステム仕様書

## 1. 概要

本システムは、LINE Front-end Framework（LIFF）を使用したモバイルオーダーシステムである。宿泊施設の利用者がLINEアプリからルームサービスの注文を行い、チェックアウト時に一括精算できる仕組みを提供する。

### 1.1 構築の目的

- リッチメニューからモバイルオーダーへのリンクを設置し、手軽に注文できる環境を提供
- 部屋番号ごとに注文を管理し、利用者に部屋番号を手入力させずに済むようにする
- ログイン画面を実装せず、LINE認証のみで使用できるようにして離脱率を低減する
- チェックアウト後のリンク悪用防止のセキュリティ対策を実装する

### 1.2 システム全体像

1. Squareから商品情報を取得しモバイルオーダーで表示
2. 注文データを保留会計として部屋番号に紐づけてデータベースで管理
3. チェックアウト時に保留会計をまとめてSquareで支払い処理

## 2. 技術仕様

### 2.1 使用技術

- **フロントエンド**：HTML, CSS, JavaScript, LINE LIFF SDK
- **バックエンド**：PHP, MySQL
- **決済システム連携**：Square API
- **メッセージングプラットフォーム**：LINE Messaging API

### 2.2 必要なLIFF設定

- **LIFF ID**：LINE Developersコンソールで発行
- **スコープ**：profile（ユーザー情報取得用）
- **ボットリンク**：オン（LINE公式アカウントと連携するため）
- **エンドポイントURL**：モバイルオーダーWebアプリのURL
- **LIFFサイズ**：Full（フル機能が使用できるように）

## 3. データベース設計

既存のテーブル構成を活用し、以下のテーブルを使用する。

### 3.1 主要テーブル

1. **room_tickets**：部屋番号とSquare注文IDを関連付ける中間テーブル
   - id（PK）
   - room_number：部屋番号
   - square_order_id：SquareのオーダーID
   - status：注文ステータス（OPEN/COMPLETED/CANCELED）
   - created_at：作成日時
   - updated_at：更新日時

2. **orders**：注文の詳細情報を保存
   - id（PK）
   - square_order_id：SquareのオーダーID
   - room_number：部屋番号
   - guest_name：ゲスト名
   - order_status：注文状態
   - total_amount：合計金額
   - note：備考
   - order_datetime：注文日時
   - checkout_datetime：チェックアウト日時
   - created_at：作成日時
   - updated_at：更新日時

3. **order_details**：注文内の個別商品データを保存
   - id（PK）
   - order_id（FK）：注文ID
   - square_item_id：商品ID
   - product_name：商品名
   - unit_price：単価
   - quantity：数量
   - subtotal：小計
   - note：備考
   - created_at：作成日時

4. **line_room_links**：LINEユーザーと部屋を紐づけるテーブル
   - id（PK）
   - line_user_id：LINEのユーザーID
   - room_number：部屋番号
   - access_token：アクセストークン
   - is_active：有効フラグ
   - created_at：作成日時
   - updated_at：更新日時

### 3.2 テーブル間の関連

- **room_tickets**と**orders**：square_order_idで紐づけ
- **orders**と**order_details**：order_idで紐づけ
- **line_room_links**と**room_tickets**：room_numberで紐づけ

## 4. 画面設計（UI/UX）

### 4.1 モバイルオーダー画面

#### ヘッダー部分
- サイト名/ロゴ表示
- 部屋番号表示（LINEユーザーIDから自動取得）

#### メインコンテンツ
- **左側**：カテゴリ選択バー
  - 縦スクロール可能なカテゴリリスト
  - 選択中のカテゴリはハイライト表示

- **中央/右側**：商品リスト
  - カテゴリごとの商品を表示
  - 商品カード表示（画像、名前、価格、説明）
  - 数量選択機能（+/-ボタン）
  - カートに追加ボタン

#### フッター部分
- **右下**：「注文する」ボタン
  - カート内商品がある場合のみ有効化
  - タップでカート確認・注文確定画面へ遷移

### 4.2 カート確認・注文確定画面

- 注文商品一覧
- 各商品の数量変更・削除機能
- 合計金額表示（税込）
- 備考入力欄
- 「注文を確定する」ボタン
- 「戻る」ボタン

### 4.3 注文履歴・状況確認画面

- 注文履歴一覧（当日分）
- 各注文の詳細確認機能
- 注文状況表示（準備中/配達中/完了）
- 合計金額表示

## 5. 機能要件

### 5.1 ユーザー認証・部屋紐づけ機能

1. **LINE認証**
   - LIFFアプリ起動時にLINE認証を自動実行
   - ユーザーIDを取得し、バックエンドへ送信

2. **部屋紐づけ**
   - LINE User IDと部屋番号をデータベースで紐づけ
   - 紐づけがない場合のエラー処理・案内

3. **チェックアウト連携**
   - チェックアウト時に紐づけを解除
   - 解除後は同じLINEアカウントでも注文不可に

### 5.2 商品表示・カート機能

1. **商品表示**
   - Squareと連携した商品データの取得・表示
   - カテゴリ別表示
   - 商品詳細表示
   - 在庫状況反映
   - 価格表示（税込表示）

2. **カート機能**
   - 商品追加・削除
   - 数量変更
   - カート内容の一時保存
   - 合計金額リアルタイム計算

### 5.3 注文・保留会計機能

1. **注文処理**
   - 注文データのバックエンド送信
   - Square APIとの連携による注文登録
   - 注文確認メッセージ表示

2. **保留会計**
   - 部屋番号に紐づく保留伝票の管理
   - 同一部屋への複数注文の累積処理
   - 金額計算・管理

3. **注文履歴**
   - 過去注文の表示
   - 注文状況のリアルタイム更新
   - 注文詳細の確認機能

### 5.4 通知機能

1. **LINE通知**
   - 注文完了時のLINE通知
   - 注文受理・準備開始の通知
   - 配達完了の通知

## 6. セキュリティ設計

### 6.1 ユーザー認証セキュリティ

- LIFFのセキュアな認証機能の活用
- トークンの適切な管理（サーバーサイドでの検証）
- XSS対策・CSRF対策の実装

### 6.2 データアクセス制御

- 部屋番号に紐づくデータのみアクセス可能に制限
- チェックアウト後のアクセス制限
- API呼び出しの認証要求

### 6.3 決済セキュリティ

- 決済情報はSquare側で処理（PCI DSS対応）
- 保留会計データの適切な保護
- 通信の暗号化（HTTPS必須）

## 7. APIエンドポイント設計

### 7.1 フロントエンド⇔バックエンド間API

1. **認証・部屋情報取得API**
   - `GET /api/v1/auth`: LINE UserIDから部屋情報取得
   - `POST /api/v1/link`: LINEユーザーと部屋番号の紐づけ

2. **商品関連API**
   - `GET /api/v1/categories`: カテゴリ一覧取得
   - `GET /api/v1/products`: 商品一覧取得
   - `GET /api/v1/products/{id}`: 商品詳細取得

3. **注文関連API**
   - `POST /api/v1/orders`: 注文作成
   - `GET /api/v1/orders`: 注文履歴取得
   - `GET /api/v1/orders/{id}`: 注文詳細取得

4. **カート関連API**
   - `POST /api/v1/cart`: カート内容保存
   - `GET /api/v1/cart`: カート内容取得
   - `DELETE /api/v1/cart`: カート内容クリア

### 7.2 外部連携API

1. **Square API連携**
   - 商品情報取得
   - 注文処理
   - 在庫確認・更新

2. **LINE Messaging API連携**
   - ユーザー情報取得
   - メッセージ送信

## 8. 実装ステップ

### 8.1 準備フェーズ

1. LINE Developersコンソールでの設定
   - チャネル作成
   - LIFF設定
   - Webhook設定

2. 開発環境構築
   - リポジトリ準備
   - 依存パッケージインストール
   - 設定ファイル作成

### 8.2 実装フェーズ

1. **バックエンド実装**
   - データベースマイグレーション（既存のものを活用）
   - APIエンドポイント実装
   - Square連携機能実装
   - LINE連携機能実装

2. **フロントエンド実装**
   - LIFF初期化処理
   - UI実装（モバイルファースト）
   - API連携処理
   - エラーハンドリング

### 8.3 テスト・デプロイフェーズ

1. テスト
   - 各機能単体テスト
   - 統合テスト
   - ユーザビリティテスト

2. デプロイ
   - ステージング環境でのテスト
   - 本番環境へのデプロイ
   - 動作確認

## 9. 運用・メンテナンス

1. モニタリング
   - エラーログの監視
   - パフォーマンス監視
   - 利用状況の分析

2. アップデート計画
   - 機能追加・改善のロードマップ
   - セキュリティアップデート
   - API互換性の維持

## 10. 特記事項・制約

1. LINE関連
   - LIFFの制約（外部ブラウザでの動作制限など）
   - LINE Messaging APIの制限（メッセージ送信上限など）

2. Square関連
   - API呼び出し制限
   - 決済処理の制約

3. モバイルデバイスの対応
   - 対応ブラウザ・OSの明確化
   - レスポンシブデザインの実装必須 